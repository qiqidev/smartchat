var d5=Object.defineProperty;var Hu=n=>{throw TypeError(n)};var f5=(n,t,e)=>t in n?d5(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var h=(n,t,e)=>f5(n,typeof t!="symbol"?t+"":t,e),Pc=(n,t,e)=>t.has(n)||Hu("Cannot "+e);var E=(n,t,e)=>(Pc(n,t,"read from private field"),e?e.call(n):t.get(n)),j=(n,t,e)=>t.has(n)?Hu("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),ee=(n,t,e,r)=>(Pc(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),O=(n,t,e)=>(Pc(n,t,"access private method"),e);var Po=(n,t,e,r)=>({set _(s){ee(n,t,s,e)},get _(){return E(n,t,r)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();//! WebpeerJS -- https://github.com/nuzulul/webpeerjs
const po="webpeerjs",xi=po,sn="/"+po+"/1.0.0",g5=po+"-dbstore",zu=100,p5=0,m5=1,y5="universal-connectivity-browser-peer-discovery",w5="_peer-discovery._p2p._pubsub",b5=po+"-peer-discovery",E5=[w5,y5,b5],ko=["_"+po+"-peer-data_"],No="https://delegated-ipfs.dev",kc="https://dns.google/resolve",Wu="_dnsaddr.bootstrap.libp2p.io",Mo=15e3,c2=["QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"],Ci=["12D3KooWFhXabKDwALpzqMbto94sB7rvmZ6M28hs9Y9xSopDKwQr"],Mr=c2.concat(Ci),Nc=[{Peers:[{Addrs:["/dns6/sv15.bootstrap.libp2p.io/tcp/443/wss","/dns4/sv15.bootstrap.libp2p.io/tcp/443/wss"],ID:"QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN",Schema:"peer"}]},{Peers:[{Addrs:["/dns4/am6.bootstrap.libp2p.io/tcp/443/wss","/dns6/am6.bootstrap.libp2p.io/tcp/443/wss"],ID:"QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb",Schema:"peer"}]},{Peers:[{Addrs:["/dns6/sg1.bootstrap.libp2p.io/tcp/443/wss","/dns4/sg1.bootstrap.libp2p.io/tcp/443/wss"],ID:"QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt",Schema:"peer"}]}];function Ue(n=0){return new Uint8Array(n)}function fr(n=0){return new Uint8Array(n)}const v5=Math.pow(2,7),_5=Math.pow(2,14),S5=Math.pow(2,21),E1=Math.pow(2,28),v1=Math.pow(2,35),_1=Math.pow(2,42),S1=Math.pow(2,49),Se=128,ht=127;function Vt(n){if(n<v5)return 1;if(n<_5)return 2;if(n<S5)return 3;if(n<E1)return 4;if(n<v1)return 5;if(n<_1)return 6;if(n<S1)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function l2(n,t,e=0){switch(Vt(n)){case 8:t[e++]=n&255|Se,n/=128;case 7:t[e++]=n&255|Se,n/=128;case 6:t[e++]=n&255|Se,n/=128;case 5:t[e++]=n&255|Se,n/=128;case 4:t[e++]=n&255|Se,n>>>=7;case 3:t[e++]=n&255|Se,n>>>=7;case 2:t[e++]=n&255|Se,n>>>=7;case 1:{t[e++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return t}function I5(n,t,e=0){switch(Vt(n)){case 8:t.set(e++,n&255|Se),n/=128;case 7:t.set(e++,n&255|Se),n/=128;case 6:t.set(e++,n&255|Se),n/=128;case 5:t.set(e++,n&255|Se),n/=128;case 4:t.set(e++,n&255|Se),n>>>=7;case 3:t.set(e++,n&255|Se),n>>>=7;case 2:t.set(e++,n&255|Se),n>>>=7;case 1:{t.set(e++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return t}function u2(n,t){let e=n[t],r=0;if(r+=e&ht,e<Se||(e=n[t+1],r+=(e&ht)<<7,e<Se)||(e=n[t+2],r+=(e&ht)<<14,e<Se)||(e=n[t+3],r+=(e&ht)<<21,e<Se)||(e=n[t+4],r+=(e&ht)*E1,e<Se)||(e=n[t+5],r+=(e&ht)*v1,e<Se)||(e=n[t+6],r+=(e&ht)*_1,e<Se)||(e=n[t+7],r+=(e&ht)*S1,e<Se))return r;throw new RangeError("Could not decode varint")}function R5(n,t){let e=n.get(t),r=0;if(r+=e&ht,e<Se||(e=n.get(t+1),r+=(e&ht)<<7,e<Se)||(e=n.get(t+2),r+=(e&ht)<<14,e<Se)||(e=n.get(t+3),r+=(e&ht)<<21,e<Se)||(e=n.get(t+4),r+=(e&ht)*E1,e<Se)||(e=n.get(t+5),r+=(e&ht)*v1,e<Se)||(e=n.get(t+6),r+=(e&ht)*_1,e<Se)||(e=n.get(t+7),r+=(e&ht)*S1,e<Se))return r;throw new RangeError("Could not decode varint")}function ur(n,t,e=0){return t==null&&(t=fr(Vt(n))),t instanceof Uint8Array?l2(n,t,e):I5(n,t,e)}function Bn(n,t=0){return n instanceof Uint8Array?u2(n,t):R5(n,t)}const I1=new Float32Array([-0]),Sn=new Uint8Array(I1.buffer);function A5(n,t,e){I1[0]=n,t[e]=Sn[0],t[e+1]=Sn[1],t[e+2]=Sn[2],t[e+3]=Sn[3]}function T5(n,t){return Sn[0]=n[t],Sn[1]=n[t+1],Sn[2]=n[t+2],Sn[3]=n[t+3],I1[0]}const R1=new Float64Array([-0]),dt=new Uint8Array(R1.buffer);function D5(n,t,e){R1[0]=n,t[e]=dt[0],t[e+1]=dt[1],t[e+2]=dt[2],t[e+3]=dt[3],t[e+4]=dt[4],t[e+5]=dt[5],t[e+6]=dt[6],t[e+7]=dt[7]}function x5(n,t){return dt[0]=n[t],dt[1]=n[t+1],dt[2]=n[t+2],dt[3]=n[t+3],dt[4]=n[t+4],dt[5]=n[t+5],dt[6]=n[t+6],dt[7]=n[t+7],R1[0]}const C5=BigInt(Number.MAX_SAFE_INTEGER),P5=BigInt(Number.MIN_SAFE_INTEGER);class ft{constructor(t,e){h(this,"lo");h(this,"hi");this.lo=t|0,this.hi=e|0}toNumber(t=!1){if(!t&&this.hi>>>31>0){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(e+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(t=!1){if(t)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const e=~this.lo+1>>>0;let r=~this.hi>>>0;return e===0&&(r=r+1>>>0),-(BigInt(e)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(t=!1){return this.toBigInt(t).toString()}zzEncode(){const t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this}zzDecode(){const t=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this}length(){const t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?e===0?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:r<128?9:10}static fromBigInt(t){if(t===0n)return Jn;if(t<C5&&t>P5)return this.fromNumber(Number(t));const e=t<0n;e&&(t=-t);let r=t>>32n,s=t-(r<<32n);return e&&(r=~r|0n,s=~s|0n,++s>qu&&(s=0n,++r>qu&&(r=0n))),new ft(Number(s),Number(r))}static fromNumber(t){if(t===0)return Jn;const e=t<0;e&&(t=-t);let r=t>>>0,s=(t-r)/4294967296>>>0;return e&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new ft(r,s)}static from(t){return typeof t=="number"?ft.fromNumber(t):typeof t=="bigint"?ft.fromBigInt(t):typeof t=="string"?ft.fromBigInt(BigInt(t)):t.low!=null||t.high!=null?new ft(t.low>>>0,t.high>>>0):Jn}}const Jn=new ft(0,0);Jn.toBigInt=function(){return 0n};Jn.zzEncode=Jn.zzDecode=function(){return this};Jn.length=function(){return 1};const qu=4294967296n;function k5(n){let t=0,e=0;for(let r=0;r<n.length;++r)e=n.charCodeAt(r),e<128?t+=1:e<2048?t+=2:(e&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,t+=4):t+=3;return t}function N5(n,t,e){if(e-t<1)return"";let s;const i=[];let o=0,a;for(;t<e;)a=n[t++],a<128?i[o++]=a:a>191&&a<224?i[o++]=(a&31)<<6|n[t++]&63:a>239&&a<365?(a=((a&7)<<18|(n[t++]&63)<<12|(n[t++]&63)<<6|n[t++]&63)-65536,i[o++]=55296+(a>>10),i[o++]=56320+(a&1023)):i[o++]=(a&15)<<12|(n[t++]&63)<<6|n[t++]&63,o>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),o=0);return s!=null?(o>0&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))}function h2(n,t,e){const r=e;let s,i;for(let o=0;o<n.length;++o)s=n.charCodeAt(o),s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(o+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++o,t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128);return e-r}function sr(n,t){return RangeError(`index out of range: ${n.pos} + ${t??1} > ${n.len}`)}function Oo(n,t){return(n[t-4]|n[t-3]<<8|n[t-2]<<16|n[t-1]<<24)>>>0}class M5{constructor(t){h(this,"buf");h(this,"pos");h(this,"len");h(this,"_slice",Uint8Array.prototype.subarray);this.buf=t,this.pos=0,this.len=t.length}uint32(){let t=4294967295;if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,sr(this,10);return t}int32(){return this.uint32()|0}sint32(){const t=this.uint32();return t>>>1^-(t&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw sr(this,4);return Oo(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw sr(this,4);return Oo(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw sr(this,4);const t=T5(this.buf,this.pos);return this.pos+=4,t}double(){if(this.pos+8>this.len)throw sr(this,4);const t=x5(this.buf,this.pos);return this.pos+=8,t}bytes(){const t=this.uint32(),e=this.pos,r=this.pos+t;if(r>this.len)throw sr(this,t);return this.pos+=t,e===r?new Uint8Array(0):this.buf.subarray(e,r)}string(){const t=this.bytes();return N5(t,0,t.length)}skip(t){if(typeof t=="number"){if(this.pos+t>this.len)throw sr(this,t);this.pos+=t}else do if(this.pos>=this.len)throw sr(this);while(this.buf[this.pos++]&128);return this}skipType(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(t=this.uint32()&7)!==4;)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${t} at offset ${this.pos}`)}return this}readLongVarint(){const t=new ft(0,0);let e=0;if(this.len-this.pos>4){for(;e<4;++e)if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(this.buf[this.pos]&127)<<28)>>>0,t.hi=(t.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return t;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw sr(this);if(t.lo=(t.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,t}if(this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw sr(this);if(t.hi=(t.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw sr(this,8);const t=Oo(this.buf,this.pos+=4),e=Oo(this.buf,this.pos+=4);return new ft(t,e)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const t=u2(this.buf,this.pos);return this.pos+=Vt(t),t}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function O5(n){return new M5(n instanceof Uint8Array?n:n.subarray())}function ue(n,t,e){const r=O5(n);return t.decode(r,void 0,e)}function L5(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function rc(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function B5(n){return new TextEncoder().encode(n)}function U5(n){return new TextDecoder().decode(n)}function F5(n,t){if(n.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),r=0;r<e.length;r++)e[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),o=i.charCodeAt(0);if(e[o]!==255)throw new TypeError(i+" is ambiguous");e[o]=s}var a=n.length,c=n.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function d(y){if(y instanceof Uint8Array||(ArrayBuffer.isView(y)?y=new Uint8Array(y.buffer,y.byteOffset,y.byteLength):Array.isArray(y)&&(y=Uint8Array.from(y))),!(y instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(y.length===0)return"";for(var g=0,m=0,w=0,_=y.length;w!==_&&y[w]===0;)w++,g++;for(var b=(_-w)*u+1>>>0,S=new Uint8Array(b);w!==_;){for(var I=y[w],A=0,P=b-1;(I!==0||A<m)&&P!==-1;P--,A++)I+=256*S[P]>>>0,S[P]=I%a>>>0,I=I/a>>>0;if(I!==0)throw new Error("Non-zero carry");m=A,w++}for(var T=b-m;T!==b&&S[T]===0;)T++;for(var R=c.repeat(g);T<b;++T)R+=n.charAt(S[T]);return R}function f(y){if(typeof y!="string")throw new TypeError("Expected String");if(y.length===0)return new Uint8Array;var g=0;if(y[g]!==" "){for(var m=0,w=0;y[g]===c;)m++,g++;for(var _=(y.length-g)*l+1>>>0,b=new Uint8Array(_);y[g];){var S=e[y.charCodeAt(g)];if(S===255)return;for(var I=0,A=_-1;(S!==0||I<w)&&A!==-1;A--,I++)S+=a*b[A]>>>0,b[A]=S%256>>>0,S=S/256>>>0;if(S!==0)throw new Error("Non-zero carry");w=I,g++}if(y[g]!==" "){for(var P=_-w;P!==_&&b[P]===0;)P++;for(var T=new Uint8Array(m+(_-P)),R=m;P!==_;)T[R++]=b[P++];return T}}}function p(y){var g=f(y);if(g)return g;throw new Error(`Non-${t} character`)}return{encode:d,decodeUnsafe:f,decode:p}}var V5=F5,$5=V5;class K5{constructor(t,e,r){h(this,"name");h(this,"prefix");h(this,"baseEncode");this.name=t,this.prefix=e,this.baseEncode=r}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}}let H5=class{constructor(t,e,r){h(this,"name");h(this,"prefix");h(this,"baseDecode");h(this,"prefixCodePoint");if(this.name=t,this.prefix=e,e.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=e.codePointAt(0),this.baseDecode=r}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return d2(this,t)}};class z5{constructor(t){h(this,"decoders");this.decoders=t}or(t){return d2(this,t)}decode(t){const e=t[0],r=this.decoders[e];if(r!=null)return r.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function d2(n,t){return new z5({...n.decoders??{[n.prefix]:n},...t.decoders??{[t.prefix]:t}})}class W5{constructor(t,e,r,s){h(this,"name");h(this,"prefix");h(this,"baseEncode");h(this,"baseDecode");h(this,"encoder");h(this,"decoder");this.name=t,this.prefix=e,this.baseEncode=r,this.baseDecode=s,this.encoder=new K5(t,e,r),this.decoder=new H5(t,e,s)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}}function nc({name:n,prefix:t,encode:e,decode:r}){return new W5(n,t,e,r)}function mo({name:n,prefix:t,alphabet:e}){const{encode:r,decode:s}=$5(e,n);return nc({prefix:t,name:n,encode:r,decode:i=>rc(s(i))})}function q5(n,t,e,r){const s={};for(let u=0;u<t.length;++u)s[t[u]]=u;let i=n.length;for(;n[i-1]==="=";)--i;const o=new Uint8Array(i*e/8|0);let a=0,c=0,l=0;for(let u=0;u<i;++u){const d=s[n[u]];if(d===void 0)throw new SyntaxError(`Non-${r} character`);c=c<<e|d,a+=e,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=e||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function G5(n,t,e){const r=t[t.length-1]==="=",s=(1<<e)-1;let i="",o=0,a=0;for(let c=0;c<n.length;++c)for(a=a<<8|n[c],o+=8;o>e;)o-=e,i+=t[s&a>>o];if(o!==0&&(i+=t[s&a<<e-o]),r)for(;i.length*e&7;)i+="=";return i}function ct({name:n,prefix:t,bitsPerChar:e,alphabet:r}){return nc({prefix:t,name:n,encode(s){return G5(s,r,e)},decode(s){return q5(s,r,e,n)}})}const Y5=mo({prefix:"9",name:"base10",alphabet:"0123456789"}),Q5=Object.freeze(Object.defineProperty({__proto__:null,base10:Y5},Symbol.toStringTag,{value:"Module"})),X5=ct({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Z5=ct({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),J5=Object.freeze(Object.defineProperty({__proto__:null,base16:X5,base16upper:Z5},Symbol.toStringTag,{value:"Module"})),j5=ct({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),e8=Object.freeze(Object.defineProperty({__proto__:null,base2:j5},Symbol.toStringTag,{value:"Module"})),f2=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),t8=f2.reduce((n,t,e)=>(n[e]=t,n),[]),r8=f2.reduce((n,t,e)=>(n[t.codePointAt(0)]=e,n),[]);function n8(n){return n.reduce((t,e)=>(t+=t8[e],t),"")}function s8(n){const t=[];for(const e of n){const r=r8[e.codePointAt(0)];if(r===void 0)throw new Error(`Non-base256emoji character: ${e}`);t.push(r)}return new Uint8Array(t)}const i8=nc({prefix:"ðŸš€",name:"base256emoji",encode:n8,decode:s8}),o8=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:i8},Symbol.toStringTag,{value:"Module"})),Qr=ct({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),a8=ct({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),c8=ct({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),l8=ct({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),u8=ct({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),h8=ct({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),d8=ct({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),f8=ct({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),g8=ct({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),p8=Object.freeze(Object.defineProperty({__proto__:null,base32:Qr,base32hex:u8,base32hexpad:d8,base32hexpadupper:f8,base32hexupper:h8,base32pad:c8,base32padupper:l8,base32upper:a8,base32z:g8},Symbol.toStringTag,{value:"Module"})),gl=mo({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),m8=mo({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),y8=Object.freeze(Object.defineProperty({__proto__:null,base36:gl,base36upper:m8},Symbol.toStringTag,{value:"Module"})),gt=mo({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),w8=mo({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),b8=Object.freeze(Object.defineProperty({__proto__:null,base58btc:gt,base58flickr:w8},Symbol.toStringTag,{value:"Module"})),A1=ct({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),E8=ct({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),g2=ct({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),v8=ct({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),_8=Object.freeze(Object.defineProperty({__proto__:null,base64:A1,base64pad:E8,base64url:g2,base64urlpad:v8},Symbol.toStringTag,{value:"Module"})),S8=ct({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),I8=Object.freeze(Object.defineProperty({__proto__:null,base8:S8},Symbol.toStringTag,{value:"Module"})),R8=nc({prefix:"\0",name:"identity",encode:n=>U5(n),decode:n=>B5(n)}),A8=Object.freeze(Object.defineProperty({__proto__:null,identity:R8},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;var T8=p2,Gu=128,D8=127,x8=~D8,C8=Math.pow(2,31);function p2(n,t,e){t=t||[],e=e||0;for(var r=e;n>=C8;)t[e++]=n&255|Gu,n/=128;for(;n&x8;)t[e++]=n&255|Gu,n>>>=7;return t[e]=n|0,p2.bytes=e-r+1,t}var P8=pl,k8=128,Yu=127;function pl(n,r){var e=0,r=r||0,s=0,i=r,o,a=n.length;do{if(i>=a)throw pl.bytes=0,new RangeError("Could not decode varint");o=n[i++],e+=s<28?(o&Yu)<<s:(o&Yu)*Math.pow(2,s),s+=7}while(o>=k8);return pl.bytes=i-r,e}var N8=Math.pow(2,7),M8=Math.pow(2,14),O8=Math.pow(2,21),L8=Math.pow(2,28),B8=Math.pow(2,35),U8=Math.pow(2,42),F8=Math.pow(2,49),V8=Math.pow(2,56),$8=Math.pow(2,63),K8=function(n){return n<N8?1:n<M8?2:n<O8?3:n<L8?4:n<B8?5:n<U8?6:n<F8?7:n<V8?8:n<$8?9:10},H8={encode:T8,decode:P8,encodingLength:K8},ma=H8;function ml(n,t=0){return[ma.decode(n,t),ma.decode.bytes]}function ya(n,t,e=0){return ma.encode(n,t,e),t}function wa(n){return ma.encodingLength(n)}function zs(n,t){const e=t.byteLength,r=wa(n),s=r+wa(e),i=new Uint8Array(s+e);return ya(n,i,0),ya(e,i,r),i.set(t,s),new T1(n,e,t,i)}function yo(n){const t=rc(n),[e,r]=ml(t),[s,i]=ml(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new T1(e,s,o,t)}function z8(n,t){if(n===t)return!0;{const e=t;return n.code===e.code&&n.size===e.size&&e.bytes instanceof Uint8Array&&L5(n.bytes,e.bytes)}}class T1{constructor(t,e,r,s){h(this,"code");h(this,"size");h(this,"digest");h(this,"bytes");this.code=t,this.size=e,this.digest=r,this.bytes=s}}const m2=0,W8="identity",y2=rc;function q8(n){return zs(m2,y2(n))}const Hi={code:m2,name:W8,encode:y2,digest:q8};function G8({name:n,code:t,encode:e}){return new Y8(n,t,e)}class Y8{constructor(t,e,r){h(this,"name");h(this,"code");h(this,"encode");this.name=t,this.code=e,this.encode=r}digest(t){if(t instanceof Uint8Array){const e=this.encode(t);return e instanceof Uint8Array?zs(this.code,e):e.then(r=>zs(this.code,r))}else throw Error("Unknown type, must be binary type")}}function Q8(n){return async t=>new Uint8Array(await crypto.subtle.digest(n,t))}const mt=G8({name:"sha2-256",code:18,encode:Q8("SHA-256")});function Qu(n,t){const{bytes:e,version:r}=n;switch(r){case 0:return Z8(e,yl(n),t??gt.encoder);default:return J8(e,yl(n),t??Qr.encoder)}}const Xu=new WeakMap;function yl(n){const t=Xu.get(n);if(t==null){const e=new Map;return Xu.set(n,e),e}return t}var l0;class Me{constructor(t,e,r,s){h(this,"code");h(this,"version");h(this,"multihash");h(this,"bytes");h(this,"/");h(this,l0,"CID");this.code=e,this.version=t,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:t,multihash:e}=this;if(t!==_i)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(e.code!==j8)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Me.createV0(e)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:t,digest:e}=this.multihash,r=zs(t,e);return Me.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return Me.equals(this,t)}static equals(t,e){const r=e;return r!=null&&t.code===r.code&&t.version===r.version&&z8(t.multihash,r.multihash)}toString(t){return Qu(this,t)}toJSON(){return{"/":Qu(this)}}link(){return this}[(l0=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;const e=t;if(e instanceof Me)return e;if(e["/"]!=null&&e["/"]===e.bytes||e.asCID===e){const{version:r,code:s,multihash:i,bytes:o}=e;return new Me(r,s,i,o??Zu(r,s,i.bytes))}else if(e[e7]===!0){const{version:r,multihash:s,code:i}=e,o=yo(s);return Me.create(r,i,o)}else return null}static create(t,e,r){if(typeof e!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(e!==_i)throw new Error(`Version 0 CID must use dag-pb (code: ${_i}) block encoding`);return new Me(t,e,r,r.bytes)}case 1:{const s=Zu(t,e,r.bytes);return new Me(t,e,r,s)}default:throw new Error("Invalid version")}}static createV0(t){return Me.create(0,_i,t)}static createV1(t,e){return Me.create(1,t,e)}static decode(t){const[e,r]=Me.decodeFirst(t);if(r.length!==0)throw new Error("Incorrect length");return e}static decodeFirst(t){const e=Me.inspectBytes(t),r=e.size-e.multihashSize,s=rc(t.subarray(r,r+e.multihashSize));if(s.byteLength!==e.multihashSize)throw new Error("Incorrect length");const i=s.subarray(e.multihashSize-e.digestSize),o=new T1(e.multihashCode,e.digestSize,i,s);return[e.version===0?Me.createV0(o):Me.createV1(e.codec,o),t.subarray(e.size)]}static inspectBytes(t){let e=0;const r=()=>{const[d,f]=ml(t.subarray(e));return e+=f,d};let s=r(),i=_i;if(s===18?(s=0,e=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=e,a=r(),c=r(),l=e+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(t,e){const[r,s]=X8(t,e),i=Me.decode(s);if(i.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return yl(i).set(r,t),i}}function X8(n,t){switch(n[0]){case"Q":{const e=t??gt;return[gt.prefix,e.decode(`${gt.prefix}${n}`)]}case gt.prefix:{const e=t??gt;return[gt.prefix,e.decode(n)]}case Qr.prefix:{const e=t??Qr;return[Qr.prefix,e.decode(n)]}default:{if(t==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[n[0],t.decode(n)]}}}function Z8(n,t,e){const{prefix:r}=e;if(r!==gt.prefix)throw Error(`Cannot string encode V0 in ${e.name} encoding`);const s=t.get(r);if(s==null){const i=e.encode(n).slice(1);return t.set(r,i),i}else return s}function J8(n,t,e){const{prefix:r}=e,s=t.get(r);if(s==null){const i=e.encode(n);return t.set(r,i),i}else return s}const _i=112,j8=18;function Zu(n,t,e){const r=wa(n),s=r+wa(t),i=new Uint8Array(s+e.byteLength);return ya(n,i,0),ya(t,i,r),i.set(e,s),i}const e7=Symbol.for("@ipld/js-cid/CID"),Ws={...A8,...e8,...I8,...Q5,...J5,...p8,...y8,...b8,..._8,...o8};function w2(n,t,e,r){return{name:n,prefix:t,encoder:{name:n,prefix:t,encode:e},decoder:{decode:r}}}const Ju=w2("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),Mc=w2("ascii","a",n=>{let t="a";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return t},n=>{n=n.substring(1);const t=fr(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}),b2={utf8:Ju,"utf-8":Ju,hex:Ws.base16,latin1:Mc,ascii:Mc,binary:Mc,...Ws};function Y(n,t="utf8"){const e=b2[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.decoder.decode(`${e.prefix}${n}`)}function t7(n){let r,s=8192;return function(o){if(o<1||o>4096)return fr(o);s+o>8192&&(r=fr(8192),s=0);const a=r.subarray(s,s+=o);return s&7&&(s=(s|7)+1),a}}class Pi{constructor(t,e,r){h(this,"fn");h(this,"len");h(this,"next");h(this,"val");this.fn=t,this.len=e,this.next=void 0,this.val=r}}function Oc(){}class r7{constructor(t){h(this,"head");h(this,"tail");h(this,"len");h(this,"next");this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}}const n7=t7();function s7(n){return globalThis.Buffer!=null?fr(n):n7(n)}class wl{constructor(){h(this,"len");h(this,"head");h(this,"tail");h(this,"states");this.len=0,this.head=new Pi(Oc,0,0),this.tail=this.head,this.states=null}_push(t,e,r){return this.tail=this.tail.next=new Pi(t,e,r),this.len+=e,this}uint32(t){return this.len+=(this.tail=this.tail.next=new o7((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this}int32(t){return t<0?this._push(Lo,10,ft.fromNumber(t)):this.uint32(t)}sint32(t){return this.uint32((t<<1^t>>31)>>>0)}uint64(t){const e=ft.fromBigInt(t);return this._push(Lo,e.length(),e)}uint64Number(t){return this._push(l2,Vt(t),t)}uint64String(t){return this.uint64(BigInt(t))}int64(t){return this.uint64(t)}int64Number(t){return this.uint64Number(t)}int64String(t){return this.uint64String(t)}sint64(t){const e=ft.fromBigInt(t).zzEncode();return this._push(Lo,e.length(),e)}sint64Number(t){const e=ft.fromNumber(t).zzEncode();return this._push(Lo,e.length(),e)}sint64String(t){return this.sint64(BigInt(t))}bool(t){return this._push(Lc,1,t?1:0)}fixed32(t){return this._push(Si,4,t>>>0)}sfixed32(t){return this.fixed32(t)}fixed64(t){const e=ft.fromBigInt(t);return this._push(Si,4,e.lo)._push(Si,4,e.hi)}fixed64Number(t){const e=ft.fromNumber(t);return this._push(Si,4,e.lo)._push(Si,4,e.hi)}fixed64String(t){return this.fixed64(BigInt(t))}sfixed64(t){return this.fixed64(t)}sfixed64Number(t){return this.fixed64Number(t)}sfixed64String(t){return this.fixed64String(t)}float(t){return this._push(A5,4,t)}double(t){return this._push(D5,8,t)}bytes(t){const e=t.length>>>0;return e===0?this._push(Lc,1,0):this.uint32(e)._push(a7,e,t)}string(t){const e=k5(t);return e!==0?this.uint32(e)._push(h2,e,t):this._push(Lc,1,0)}fork(){return this.states=new r7(this),this.head=this.tail=new Pi(Oc,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Pi(Oc,0,0),this.len=0),this}ldelim(){const t=this.head,e=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=t.next,this.tail=e,this.len+=r),this}finish(){let t=this.head.next;const e=s7(this.len);let r=0;for(;t!=null;)t.fn(t.val,e,r),r+=t.len,t=t.next;return e}}function Lc(n,t,e){t[e]=n&255}function i7(n,t,e){for(;n>127;)t[e++]=n&127|128,n>>>=7;t[e]=n}class o7 extends Pi{constructor(e,r){super(i7,e,r);h(this,"next");this.next=void 0}}function Lo(n,t,e){for(;n.hi!==0;)t[e++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)t[e++]=n.lo&127|128,n.lo=n.lo>>>7;t[e++]=n.lo}function Si(n,t,e){t[e]=n&255,t[e+1]=n>>>8&255,t[e+2]=n>>>16&255,t[e+3]=n>>>24}function a7(n,t,e){t.set(n,e)}globalThis.Buffer!=null&&(wl.prototype.bytes=function(n){const t=n.length>>>0;return this.uint32(t),t>0&&this._push(c7,t,n),this},wl.prototype.string=function(n){const t=globalThis.Buffer.byteLength(n);return this.uint32(t),t>0&&this._push(l7,t,n),this});function c7(n,t,e){t.set(n,e)}function l7(n,t,e){n.length<40?h2(n,t,e):t.utf8Write!=null?t.utf8Write(n,e):t.set(Y(n),e)}function u7(){return new wl}function he(n,t){const e=u7();return t.encode(n,e,{lengthDelimited:!1}),e.finish()}var ba;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(ba||(ba={}));function E2(n,t,e,r){return{name:n,type:t,encode:e,decode:r}}function kr(n){function t(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const e=function(i,o){const a=t(i);o.int32(a)},r=function(i){const o=i.int32();return t(o)};return E2("enum",ba.VARINT,e,r)}function de(n,t){return E2("message",ba.LENGTH_DELIMITED,n,t)}let Bt=class extends Error{constructor(e,r,s){super(e,s);h(this,"code");this.code=r}};var Rs;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={publicKey:Ue(0),addrs:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.publicKey=e.bytes();break}case 2:{s.addrs.push(e.bytes());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Rs||(Rs={}));function X(n,t="utf8"){const e=b2[t];if(e==null)throw new Error(`Unsupported encoding "${t}"`);return e.encoder.encode(n).substring(1)}const Fr="/",v2=new TextEncoder().encode(Fr),Bo=v2[0];class Be{constructor(t,e){h(this,"_buf");if(typeof t=="string")this._buf=Y(t);else if(t instanceof Uint8Array)this._buf=t;else throw new Error("Invalid key, should be String of Uint8Array");if(e==null&&(e=!0),e&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Bo)throw new Error("Invalid key")}toString(t="utf8"){return X(this._buf,t)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new Be(t.join(Fr))}static random(){return new Be(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||typeof t=="string"?new Be(t):typeof t.uint8Array=="function"?new Be(t.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=v2),this._buf[0]!==Bo){const t=new Uint8Array(this._buf.byteLength+1);t.fill(Bo,0,1),t.set(this._buf,1),this._buf=t}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Bo;)this._buf=this._buf.subarray(0,-1)}less(t){const e=this.list(),r=t.list();for(let s=0;s<e.length;s++){if(r.length<s+1)return!1;const i=e[s],o=r[s];if(i<o)return!0;if(i>o)return!1}return e.length<r.length}reverse(){return Be.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const t=this.namespaces();return t[t.length-1]}list(){return this.toString().split(Fr).slice(1)}type(){return h7(this.baseNamespace())}name(){return d7(this.baseNamespace())}instance(t){return new Be(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(Fr)||(t+=Fr),t+=this.type(),new Be(t)}parent(){const t=this.list();return t.length===1?new Be(Fr):new Be(t.slice(0,-1).join(Fr))}child(t){return this.toString()===Fr?t:t.toString()===Fr?this:new Be(this.toString()+t.toString(),!1)}isAncestorOf(t){return t.toString()===this.toString()?!1:t.toString().startsWith(this.toString())}isDecendantOf(t){return t.toString()===this.toString()?!1:this.toString().startsWith(t.toString())}isTopLevel(){return this.list().length===1}concat(...t){return Be.withNamespaces([...this.namespaces(),...f7(t.map(e=>e.namespaces()))])}}function h7(n){const t=n.split(":");return t.length<2?"":t.slice(0,-1).join(":")}function d7(n){const t=n.split(":");return t[t.length-1]}function f7(n){return[].concat(...n)}const g7=Symbol.for("@libp2p/connection"),Ea=Symbol.for("@libp2p/content-routing"),va=Symbol.for("@libp2p/peer-discovery"),_2=Symbol.for("@libp2p/peer-id");function D1(n){return n!=null&&!!n[_2]}const _a=Symbol.for("@libp2p/peer-routing"),p7="keep-alive",Sa="StrictSign",x1="StrictNoSign";var Yt;(function(n){n.Accept="accept",n.Ignore="ignore",n.Reject="reject"})(Yt||(Yt={}));const sc=Symbol.for("@libp2p/transport");var Cs;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Cs||(Cs={}));var Yr;let ts=(Yr=class extends Error{constructor(e="The operation was aborted"){super(e);h(this,"code");h(this,"type");this.name="AbortError",this.code=Yr.code,this.type=Yr.type}},h(Yr,"code","ABORT_ERR"),h(Yr,"type","aborted"),Yr),v=class extends Error{constructor(e,r,s){super(e);h(this,"code");h(this,"props");this.code=r,this.name=(s==null?void 0:s.name)??"CodeError",this.props=s??{}}};class m7 extends AggregateError{constructor(e,r,s,i){super(e,r);h(this,"code");h(this,"props");this.code=s,this.name=(i==null?void 0:i.name)??"AggregateCodeError",this.props=i??{}}}const S2="ERR_TIMEOUT",vs="ERR_INVALID_MESSAGE";const ge=(n,...t)=>{try{[...t]}catch{}};var _r;class Et extends EventTarget{constructor(){super();j(this,_r,new Map);ge(1/0,this)}listenerCount(e){const r=E(this,_r).get(e);return r==null?0:r.length}addEventListener(e,r,s){super.addEventListener(e,r,s);let i=E(this,_r).get(e);i==null&&(i=[],E(this,_r).set(e,i)),i.push({callback:r,once:(s!==!0&&s!==!1&&(s==null?void 0:s.once))??!1})}removeEventListener(e,r,s){super.removeEventListener(e.toString(),r??null,s);let i=E(this,_r).get(e);i!=null&&(i=i.filter(({callback:o})=>o!==r),E(this,_r).set(e,i))}dispatchEvent(e){const r=super.dispatchEvent(e);let s=E(this,_r).get(e.type);return s==null||(s=s.filter(({once:i})=>!i),E(this,_r).set(e.type,s)),r}safeDispatchEvent(e,r={}){return this.dispatchEvent(new pt(e,r))}}_r=new WeakMap;class y7 extends Event{constructor(e,r){super(e,r);h(this,"detail");this.detail=r==null?void 0:r.detail}}const pt=globalThis.CustomEvent??y7;function C1(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function I2(...n){const t=[];for(const e of n)C1(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async function R2(...n){const t=[];for(const e of n)C1(e)&&t.push(e);await Promise.all(t.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{e.afterStop!=null&&await e.afterStop()}))}const jt=Symbol.for("@libp2p/service-capabilities"),rs=Symbol.for("@libp2p/service-dependencies");function ke(n,t){if(n===t)return!0;if(n.byteLength!==t.byteLength)return!1;for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return!1;return!0}function at(n,t){t==null&&(t=n.reduce((s,i)=>s+i.length,0));const e=fr(t);let r=0;for(const s of n)e.set(s,r),r+=s.length;return e}class w7{constructor(){h(this,"index",0);h(this,"input","")}new(t){return this.index=0,this.input=t,this}readAtomically(t){const e=this.index,r=t();return r===void 0&&(this.index=e),r}parseWith(t){const e=t();if(this.index===this.input.length)return e}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(t){return this.readAtomically(()=>{const e=this.readChar();if(e===t)return e})}readSeparator(t,e,r){return this.readAtomically(()=>{if(!(e>0&&this.readGivenChar(t)===void 0))return r()})}readNumber(t,e,r,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*s)-1;for(;;){const u=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const f=Number.parseInt(d,t);if(!Number.isNaN(f))return f});if(u===void 0)break;if(i*=t,i+=u,i>l||(o+=1,e!==void 0&&o>e))return}if(o!==0)return!r&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const t=new Uint8Array(4);for(let e=0;e<t.length;e++){const r=this.readSeparator(".",e,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;t[e]=r}return t})}readIPv6Addr(){const t=e=>{for(let r=0;r<e.length/2;r++){const s=r*2;if(r<e.length-3){const o=this.readSeparator(":",r,()=>this.readIPv4Addr());if(o!==void 0)return e[s]=o[0],e[s+1]=o[1],e[s+2]=o[2],e[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];e[s]=i>>8,e[s+1]=i&255}return[e.length,!1]};return this.readAtomically(()=>{const e=new Uint8Array(16),[r,s]=t(e);if(r===16)return e;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(r+2),[a]=t(i.subarray(0,o));return e.set(i.subarray(0,a),16-a),e})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const A2=45,b7=15,qs=new w7;function E7(n){if(!(n.length>b7))return qs.new(n).parseWith(()=>qs.readIPv4Addr())}function v7(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>A2))return qs.new(n).parseWith(()=>qs.readIPv6Addr())}function _7(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>A2))return qs.new(n).parseWith(()=>qs.readIPAddr())}function P1(n){return!!E7(n)}function k1(n){return!!v7(n)}function T2(n){return!!_7(n)}const ju=P1,S7=k1,D2=function(n){let t=0;if(n=n.toString().trim(),ju(n)){const e=new Uint8Array(t+4);return n.split(/\./g).forEach(r=>{e[t++]=parseInt(r,10)&255}),e}if(S7(n)){const e=n.split(":",8);let r;for(r=0;r<e.length;r++){const i=ju(e[r]);let o;i&&(o=D2(e[r]),e[r]=X(o.slice(0,2),"base16")),o!=null&&++r<8&&e.splice(r,0,X(o.slice(2,4),"base16"))}if(e[0]==="")for(;e.length<8;)e.unshift("0");else if(e[e.length-1]==="")for(;e.length<8;)e.push("0");else if(e.length<8){for(r=0;r<e.length&&e[r]!=="";r++);const i=[r,1];for(r=9-e.length;r>0;r--)i.push("0");e.splice.apply(e,i)}const s=new Uint8Array(t+16);for(r=0;r<e.length;r++){const i=parseInt(e[r],16);s[t++]=i>>8&255,s[t++]=i&255}return s}throw new Error("invalid ip address")},I7=function(n,t=0,e){t=~~t,e=e??n.length-t;const r=new DataView(n.buffer);if(e===4){const s=[];for(let i=0;i<e;i++)s.push(n[t+i]);return s.join(".")}if(e===16){const s=[];for(let i=0;i<e;i+=2)s.push(r.getUint16(t+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},kt=-1,zi={},bl={},R7=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,kt,"ip6zone"],[43,8,"ipcidr"],[53,kt,"dns",!0],[54,kt,"dns4",!0],[55,kt,"dns6",!0],[56,kt,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,kt,"unix",!1,!0],[421,kt,"ipfs"],[421,kt,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,kt,"garlic64"],[448,0,"tls"],[449,kt,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,kt,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,kt,"http-path"],[777,kt,"memory"]];R7.forEach(n=>{const t=A7(...n);bl[t.code]=t,zi[t.name]=t});function A7(n,t,e,r,s){return{code:n,size:t,name:e,resolvable:!!r,path:!!s}}function ce(n){if(typeof n=="number"){if(bl[n]!=null)return bl[n];throw new Error(`no protocol with code: ${n}`)}else if(typeof n=="string"){if(zi[n]!=null)return zi[n];throw new Error(`no protocol with name: ${n}`)}throw new Error(`invalid protocol id type: ${typeof n}`)}ce("ip4");ce("ip6");ce("ipcidr");function N1(n,t){switch(ce(n).code){case 4:case 41:return D7(t);case 42:return Fc(t);case 6:case 273:case 33:case 132:return x2(t).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Fc(t);case 421:return k7(t);case 444:return rh(t);case 445:return rh(t);case 466:return P7(t);case 481:return globalThis.encodeURIComponent(Fc(t));default:return X(t,"base16")}}function eh(n,t){switch(ce(n).code){case 4:return th(t);case 41:return th(t);case 42:return Uc(t);case 6:case 273:case 33:case 132:return M1(parseInt(t,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Uc(t);case 421:return x7(t);case 444:return N7(t);case 445:return M7(t);case 466:return C7(t);case 481:return Uc(globalThis.decodeURIComponent(t));default:return Y(t,"base16")}}const Bc=Object.values(Ws).map(n=>n.decoder),T7=function(){let n=Bc[0].or(Bc[1]);return Bc.slice(2).forEach(t=>n=n.or(t)),n}();function th(n){if(!T2(n))throw new Error("invalid ip address");return D2(n)}function D7(n){const t=I7(n,0,n.length);if(t==null)throw new Error("ipBuff is required");if(!T2(t))throw new Error("invalid ip address");return t}function M1(n){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,n),new Uint8Array(t)}function x2(n){return new DataView(n.buffer).getUint16(n.byteOffset)}function Uc(n){const t=Y(n),e=Uint8Array.from(ur(t.length));return at([e,t],e.length+t.length)}function Fc(n){const t=Bn(n);if(n=n.slice(Vt(t)),n.length!==t)throw new Error("inconsistent lengths");return X(n)}function x7(n){let t;n[0]==="Q"||n[0]==="1"?t=yo(gt.decode(`z${n}`)).bytes:t=Me.parse(n).multihash.bytes;const e=Uint8Array.from(ur(t.length));return at([e,t],e.length+t.length)}function C7(n){const t=T7.decode(n),e=Uint8Array.from(ur(t.length));return at([e,t],e.length+t.length)}function P7(n){const t=Bn(n),e=n.slice(Vt(t));if(e.length!==t)throw new Error("inconsistent lengths");return"u"+X(e,"base64url")}function k7(n){const t=Bn(n),e=n.slice(Vt(t));if(e.length!==t)throw new Error("inconsistent lengths");return X(e,"base58btc")}function N7(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==16)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const e=Qr.decode("b"+t[0]),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=M1(r);return at([e,s],e.length+s.length)}function M7(n){const t=n.split(":");if(t.length!==2)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(t[0].length!==56)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const e=Qr.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=M1(r);return at([e,s],e.length+s.length)}function rh(n){const t=n.slice(0,n.length-2),e=n.slice(n.length-2),r=X(t,"base32"),s=x2(e);return`${r}:${s}`}function O7(n){n=El(n);const t=[],e=[];let r=null;const s=n.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=ce(o);if(a.size===0){t.push([a.code]),e.push([a.code]);continue}if(i++,i>=s.length)throw k2("invalid address: "+n);if(a.path===!0){r=El(s.slice(i).join("/")),t.push([a.code,eh(a.code,r)]),e.push([a.code,r]);break}const c=eh(a.code,s[i]);t.push([a.code,c]),e.push([a.code,N1(a.code,c)])}return{string:C2(e),bytes:P2(t),tuples:t,stringTuples:e,path:r}}function nh(n){const t=[],e=[];let r=null,s=0;for(;s<n.length;){const i=Bn(n,s),o=Vt(i),a=ce(i),c=L7(a,n.slice(s+o));if(c===0){t.push([i]),e.push([i]),s+=o;continue}const l=n.slice(s+o,s+o+c);if(s+=c+o,s>n.length)throw k2("Invalid address Uint8Array: "+X(n,"base16"));t.push([i,l]);const u=N1(i,l);if(e.push([i,u]),a.path===!0){r=u;break}}return{bytes:Uint8Array.from(n),string:C2(e),tuples:t,stringTuples:e,path:r}}function C2(n){const t=[];return n.map(e=>{const r=ce(e[0]);return t.push(r.name),e.length>1&&e[1]!=null&&t.push(e[1]),null}),El(t.join("/"))}function P2(n){return at(n.map(t=>{const e=ce(t[0]);let r=Uint8Array.from(ur(e.code));return t.length>1&&t[1]!=null&&(r=at([r,t[1]])),r}))}function L7(n,t){if(n.size>0)return n.size/8;if(n.size===0)return 0;{const e=Bn(t instanceof Uint8Array?t:Uint8Array.from(t));return e+Vt(e)}}function El(n){return"/"+n.trim().split("/").filter(t=>t).join("/")}function k2(n){return new Error("Error parsing address: "+n)}const B7=Symbol.for("nodejs.util.inspect.custom"),N2=Symbol.for("@multiformats/js-multiaddr/multiaddr"),U7=[ce("dns").code,ce("dns4").code,ce("dns6").code,ce("dnsaddr").code];var u0,Ms,mn,io,oo;const xs=class xs{constructor(t){h(this,"bytes");j(this,Ms);j(this,mn);j(this,io);j(this,oo);h(this,u0,!0);t==null&&(t="");let e;if(t instanceof Uint8Array)e=nh(t);else if(typeof t=="string"){if(t.length>0&&t.charAt(0)!=="/")throw new Error(`multiaddr "${t}" must start with a "/"`);e=O7(t)}else if(ic(t))e=nh(t.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=e.bytes,ee(this,Ms,e.string),ee(this,mn,e.tuples),ee(this,io,e.stringTuples),ee(this,oo,e.path)}toString(){return E(this,Ms)}toJSON(){return this.toString()}toOptions(){let t,e,r,s,i="";const o=ce("tcp"),a=ce("udp"),c=ce("ip4"),l=ce("ip6"),u=ce("dns6"),d=ce("ip6zone");for(const[p,y]of this.stringTuples())p===d.code&&(i=`%${y??""}`),U7.includes(p)&&(e=o.name,s=443,r=`${y??""}${i}`,t=p===u.code?6:4),(p===o.code||p===a.code)&&(e=ce(p).name,s=parseInt(y??"")),(p===c.code||p===l.code)&&(e=ce(p).name,r=`${y??""}${i}`,t=p===l.code?6:4);if(t==null||e==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:t,host:r,transport:e,port:s}}protos(){return E(this,mn).map(([t])=>Object.assign({},ce(t)))}protoCodes(){return E(this,mn).map(([t])=>t)}protoNames(){return E(this,mn).map(([t])=>ce(t).name)}tuples(){return E(this,mn)}stringTuples(){return E(this,io)}encapsulate(t){return t=new xs(t),new xs(this.toString()+t.toString())}decapsulate(t){const e=t.toString(),r=this.toString(),s=r.lastIndexOf(e);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new xs(r.slice(0,s))}decapsulateCode(t){const e=this.tuples();for(let r=e.length-1;r>=0;r--)if(e[r][0]===t)return new xs(P2(e.slice(0,r)));return this}getPeerId(){try{let t=[];this.stringTuples().forEach(([r,s])=>{r===zi.p2p.code&&t.push([r,s]),r===zi["p2p-circuit"].code&&(t=[])});const e=t.pop();if((e==null?void 0:e[1])!=null){const r=e[1];return r[0]==="Q"||r[0]==="1"?X(gt.decode(`z${r}`),"base58btc"):X(Me.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return E(this,oo)}equals(t){return ke(this.bytes,t.bytes)}async resolve(t){const e=this.protos().find(i=>i.resolvable);if(e==null)return[this];const r=O1.get(e.name);if(r==null)throw new v(`no available resolver for ${e.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await r(this,t)).map(i=>G(i))}nodeAddress(){const t=this.toOptions();if(t.transport!=="tcp"&&t.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${t.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:t.family,address:t.host,port:t.port}}isThinWaistAddress(t){const e=(t??this).protos();return!(e.length!==2||e[0].code!==4&&e[0].code!==41||e[1].code!==6&&e[1].code!==273)}[(u0=N2,B7)](){return`Multiaddr(${E(this,Ms)})`}};Ms=new WeakMap,mn=new WeakMap,io=new WeakMap,oo=new WeakMap;let vl=xs;const O1=new Map;function ic(n){return!!(n!=null&&n[N2])}function G(n){return new vl(n)}function me(){const n={};return n.promise=new Promise((t,e)=>{n.resolve=t,n.reject=e}),n}class sh{constructor(t){h(this,"buffer");h(this,"mask");h(this,"top");h(this,"btm");h(this,"next");if(!(t>0)||t-1&t)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(t),this.mask=t-1,this.top=0,this.btm=0,this.next=null}push(t){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=t,this.top=this.top+1&this.mask,!0)}shift(){const t=this.buffer[this.btm];if(t!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,t}isEmpty(){return this.buffer[this.btm]===void 0}}class Vc{constructor(t={}){h(this,"size");h(this,"hwm");h(this,"head");h(this,"tail");this.hwm=t.splitLimit??16,this.head=new sh(this.hwm),this.tail=this.head,this.size=0}calculateSize(t){return(t==null?void 0:t.byteLength)!=null?t.byteLength:1}push(t){if((t==null?void 0:t.value)!=null&&(this.size+=this.calculateSize(t.value)),!this.head.push(t)){const e=this.head;this.head=e.next=new sh(2*this.head.buffer.length),this.head.push(t)}}shift(){let t=this.tail.shift();if(t===void 0&&this.tail.next!=null){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return(t==null?void 0:t.value)!=null&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}let F7=class extends Error{constructor(e,r){super(e??"The operation was aborted");h(this,"type");h(this,"code");this.type="aborted",this.code=r??"ABORT_ERR"}};function jr(n={}){return V7(e=>{const r=e.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function V7(n,t){t=t??{};let e=t.onEnd,r=new Vc,s,i,o,a=me();const c=async()=>{try{return r.isEmpty()?o?{done:!0}:await new Promise((m,w)=>{i=_=>{i=null,r.push(_);try{m(n(r))}catch(b){w(b)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=me()})}},l=m=>i!=null?i(m):(r.push(m),s),u=m=>(r=new Vc,i!=null?i({error:m}):(r.push({error:m}),s)),d=m=>{if(o)return s;if((t==null?void 0:t.objectMode)!==!0&&(m==null?void 0:m.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:m})},f=m=>o?s:(o=!0,m!=null?u(m):l({done:!0})),p=()=>(r=new Vc,f(),{done:!0}),y=m=>(f(m),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:p,throw:y,push:d,end:f,get readableLength(){return r.size},onEmpty:async m=>{const w=m==null?void 0:m.signal;if(w==null||w.throwIfAborted(),r.isEmpty())return;let _,b;w!=null&&(_=new Promise((S,I)=>{b=()=>{I(new F7)},w.addEventListener("abort",b)}));try{await Promise.race([a.promise,_])}finally{b!=null&&w!=null&&(w==null||w.removeEventListener("abort",b))}}},e==null)return s;const g=s;return s={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(m){return g.throw(m),e!=null&&(e(m),e=void 0),{done:!0}},return(){return g.return(),e!=null&&(e(),e=void 0),{done:!0}},push:d,end(m){return g.end(m),e!=null&&(e(m),e=void 0),s},get readableLength(){return g.readableLength},onEmpty:m=>g.onEmpty(m)},s}function $7(n){return n[Symbol.asyncIterator]!=null}function Wi(...n){const t=[];for(const e of n)$7(e)||t.push(e);return t.length===n.length?function*(){for(const e of t)yield*e}():async function*(){const e=jr({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(n.map(async r=>{for await(const s of r)e.push(s)})),e.end()}catch(r){e.end(r)}}),yield*e}()}function Zt(n,...t){if(n==null)throw new Error("Empty pipeline");if($c(n)){const r=n;n=()=>r.source}else if(O2(n)||M2(n)){const r=n;n=()=>r}const e=[n,...t];if(e.length>1&&$c(e[e.length-1])&&(e[e.length-1]=e[e.length-1].sink),e.length>2)for(let r=1;r<e.length-1;r++)$c(e[r])&&(e[r]=H7(e[r]));return K7(...e)}const K7=(...n)=>{let t;for(;n.length>0;)t=n.shift()(t);return t},M2=n=>(n==null?void 0:n[Symbol.asyncIterator])!=null,O2=n=>(n==null?void 0:n[Symbol.iterator])!=null,$c=n=>n==null?!1:n.sink!=null&&n.source!=null,H7=n=>t=>{const e=n.sink(t);if((e==null?void 0:e.then)!=null){const r=jr({objectMode:!0});e.then(()=>{r.end()},o=>{r.end(o)});let s;const i=n.source;if(M2(i))s=async function*(){yield*i,r.end()};else if(O2(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Wi(r,s())}return n.source};let ih=class extends Error{constructor(e,r){super(e??"The operation was aborted");h(this,"type");h(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}};async function it(n,t,e){if(t==null)return n;if(t.aborted)return Promise.reject(new ih(e==null?void 0:e.errorMessage,e==null?void 0:e.errorCode));let r;const s=new ih(e==null?void 0:e.errorMessage,e==null?void 0:e.errorCode);try{return await Promise.race([n,new Promise((i,o)=>{r=()=>{o(s)},t.addEventListener("abort",r)})])}finally{r!=null&&t.removeEventListener("abort",r)}}class z7{constructor(){h(this,"readNext");h(this,"haveNext");h(this,"ended");h(this,"nextResult");this.ended=!1,this.readNext=me(),this.haveNext=me()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const t=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=me(),t}async throw(t){return this.ended=!0,t!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(t)),{done:!0,value:void 0}}async return(){const t={done:!0,value:void 0};return await this._push(void 0),t}async push(t,e){await this._push(t,e)}async end(t,e){t!=null?await this.throw(t):await this._push(void 0,e)}async _push(t,e){if(t!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;t!=null?this.nextResult={done:!1,value:t}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=me(),await it(this.readNext.promise,e==null?void 0:e.signal,e)}}function W7(){return new z7}const L2=Symbol.for("@achingbrain/uint8arraylist");function oh(n,t){if(t==null||t<0)throw new RangeError("index is out of bounds");let e=0;for(const r of n){const s=e+r.byteLength;if(t<s)return{buf:r,index:t-e};e=s}throw new RangeError("index is out of bounds")}function Uo(n){return!!(n!=null&&n[L2])}var h0;class Oe{constructor(...t){h(this,"bufs");h(this,"length");h(this,h0,!0);this.bufs=[],this.length=0,t.length>0&&this.appendAll(t)}*[(h0=L2,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...t){this.appendAll(t)}appendAll(t){let e=0;for(const r of t)if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.push(r);else if(Uo(r))e+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}prepend(...t){this.prependAll(t)}prependAll(t){let e=0;for(const r of t.reverse())if(r instanceof Uint8Array)e+=r.byteLength,this.bufs.unshift(r);else if(Uo(r))e+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=e}get(t){const e=oh(this.bufs,t);return e.buf[e.index]}set(t,e){const r=oh(this.bufs,t);r.buf[r.index]=e}write(t,e=0){if(t instanceof Uint8Array)for(let r=0;r<t.length;r++)this.set(e+r,t[r]);else if(Uo(t))for(let r=0;r<t.length;r++)this.set(e+r,t.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(t){if(t=Math.trunc(t),!(Number.isNaN(t)||t<=0)){if(t===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(t>=this.bufs[0].byteLength)t-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(t),this.length-=t;break}}}slice(t,e){const{bufs:r,length:s}=this._subList(t,e);return at(r,s)}subarray(t,e){const{bufs:r,length:s}=this._subList(t,e);return r.length===1?r[0]:at(r,s)}sublist(t,e){const{bufs:r,length:s}=this._subList(t,e),i=new Oe;return i.length=s,i.bufs=[...r],i}_subList(t,e){if(t=t??0,e=e??this.length,t<0&&(t=this.length+t),e<0&&(e=this.length+e),t<0||e>this.length)throw new RangeError("index is out of bounds");if(t===e)return{bufs:[],length:0};if(t===0&&e===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,t>=c)continue;const l=t>=a&&t<c,u=e>a&&e<=c;if(l&&u){if(t===a&&e===c){r.push(o);break}const d=t-a;r.push(o.subarray(d,d+(e-t)));break}if(l){if(t===0){r.push(o);continue}r.push(o.subarray(t-a));continue}if(u){if(e===c){r.push(o);break}r.push(o.subarray(0,e-a));break}r.push(o)}return{bufs:r,length:e-t}}indexOf(t,e=0){if(!Uo(t)&&!(t instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=t instanceof Uint8Array?t:t.subarray();if(e=Number(e??0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),t.length===0)return e>this.length?this.length:e;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let d=0;d<i;d++)o[d]=-1;for(let d=0;d<s;d++)o[r[d]]=d;const a=o,c=this.byteLength-r.byteLength,l=r.byteLength-1;let u;for(let d=e;d<=c;d+=u){u=0;for(let f=l;f>=0;f--){const p=this.get(d+f);if(r[f]!==p){u=Math.max(1,f-a[p]);break}}if(u===0)return d}return-1}getInt8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt8(0)}setInt8(t,e){const r=fr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,e),this.write(r,t)}getInt16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,e)}setInt16(t,e,r){const s=Ue(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,e,r),this.write(s,t)}getInt32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,e)}setInt32(t,e,r){const s=Ue(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,e,r),this.write(s,t)}getBigInt64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,e)}setBigInt64(t,e,r){const s=Ue(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,e,r),this.write(s,t)}getUint8(t){const e=this.subarray(t,t+1);return new DataView(e.buffer,e.byteOffset,e.byteLength).getUint8(0)}setUint8(t,e){const r=fr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,e),this.write(r,t)}getUint16(t,e){const r=this.subarray(t,t+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,e)}setUint16(t,e,r){const s=Ue(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,e,r),this.write(s,t)}getUint32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,e)}setUint32(t,e,r){const s=Ue(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,e,r),this.write(s,t)}getBigUint64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,e)}setBigUint64(t,e,r){const s=Ue(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,e,r),this.write(s,t)}getFloat32(t,e){const r=this.subarray(t,t+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,e)}setFloat32(t,e,r){const s=Ue(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,e,r),this.write(s,t)}getFloat64(t,e){const r=this.subarray(t,t+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,e)}setFloat64(t,e,r){const s=Ue(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,e,r),this.write(s,t)}equals(t){if(t==null||!(t instanceof Oe)||t.bufs.length!==this.bufs.length)return!1;for(let e=0;e<this.bufs.length;e++)if(!ke(this.bufs[e],t.bufs[e]))return!1;return!0}static fromUint8Arrays(t,e){const r=new Oe;return r.bufs=t,e==null&&(e=t.reduce((s,i)=>s+i.byteLength,0)),r.length=e,r}}let B2=class extends Error{constructor(e,r){super(e);h(this,"code");this.code=r}},q7=class extends B2{constructor(e){super(e,"ABORT_ERR");h(this,"type");this.type="aborted"}};function G7(n,t){const e=W7();n.sink(e).catch(async o=>{await e.end(o)}),n.sink=async o=>{for await(const a of o)await e.push(a);await e.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new Oe;return{read:async(o,a)=>{var u,d;(u=a==null?void 0:a.signal)==null||u.throwIfAborted();let c;const l=new Promise((f,p)=>{var y;c=()=>{p(new q7("Read aborted"))},(y=a==null?void 0:a.signal)==null||y.addEventListener("abort",c)});try{if(o==null){const{done:p,value:y}=await Promise.race([r.next(),l]);return p===!0?new Oe:y}for(;s.byteLength<o;){const{value:p,done:y}=await Promise.race([r.next(),l]);if(y===!0)throw new B2("unexpected end of input","ERR_UNEXPECTED_EOF");s.append(p)}const f=s.sublist(0,o);return s.consume(o),f}finally{c!=null&&((d=a==null?void 0:a.signal)==null||d.removeEventListener("abort",c))}},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await e.push(o,a):await e.push(o.subarray(),a)},unwrap:()=>{if(s.byteLength>0){const o=n.source;n.source=async function*(){(t==null?void 0:t.yieldBytes)===!1?yield s:yield*s,yield*o}()}return n}}}class ah extends Error{constructor(e,r){super(e);h(this,"code");this.code=r}}function Gs(n,t={}){const e=G7(n,t);t.maxDataLength!=null&&t.maxLengthLength==null&&(t.maxLengthLength=Vt(t.maxDataLength));const r=(t==null?void 0:t.lengthDecoder)??Bn,s=(t==null?void 0:t.lengthEncoder)??ur;return{read:async o=>{let a=-1;const c=new Oe;for(;;){c.append(await e.read(1,o));try{a=r(c)}catch(l){if(l instanceof RangeError)continue;throw l}if((t==null?void 0:t.maxLengthLength)!=null&&c.byteLength>t.maxLengthLength)throw new ah("message length length too long","ERR_MSG_LENGTH_TOO_LONG");if(a>-1)break}if((t==null?void 0:t.maxDataLength)!=null&&a>t.maxDataLength)throw new ah("message length too long","ERR_MSG_DATA_TOO_LONG");return e.read(a,o)},write:async(o,a)=>{await e.write(new Oe(s(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Oe(...o.flatMap(l=>[s(l.byteLength),l]));await e.write(c,a)},unwrap:()=>e.unwrap()}}function U2(n){return n[Symbol.asyncIterator]!=null}const oc=n=>{const t=Vt(n),e=fr(t);return ur(n,e),oc.bytes=t,e};oc.bytes=0;function en(n,t){t=t??{};const e=t.lengthEncoder??oc;function*r(s){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return U2(n)?async function*(){for await(const s of n)yield*r(s)}():function*(){for(const s of n)yield*r(s)}()}en.single=(n,t)=>{t=t??{};const e=t.lengthEncoder??oc;return new Oe(e(n.byteLength),n)};var F2=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function tn(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function ch(n,t){for(const e in t)Object.defineProperty(n,e,{value:t[e],enumerable:!0,configurable:!0});return n}function Y7(n,t,e){if(!n||typeof n=="string")throw new TypeError("Please pass an Error to err-code");e||(e={}),typeof t=="object"&&(e=t,t=""),t&&(e.code=t);try{return ch(n,e)}catch{e.message=n.message,e.stack=n.stack;const s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(n)),ch(new s,e)}}var Q7=Y7;const Ce=tn(Q7),X7=8,Z7=1024*1024*4;var Wn;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Wn||(Wn={}));const L1=n=>{const t=Bn(n);return L1.bytes=Vt(t),t};L1.bytes=0;function kn(n,t){const e=new Oe;let r=Wn.LENGTH,s=-1;const i=(t==null?void 0:t.lengthDecoder)??L1,o=(t==null?void 0:t.maxLengthLength)??X7,a=(t==null?void 0:t.maxDataLength)??Z7;function*c(){for(;e.byteLength>0;){if(r===Wn.LENGTH)try{if(s=i(e),s<0)throw Ce(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>a)throw Ce(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=i.bytes;e.consume(l),(t==null?void 0:t.onLength)!=null&&t.onLength(s),r=Wn.DATA}catch(l){if(l instanceof RangeError){if(e.byteLength>o)throw Ce(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(r===Wn.DATA){if(e.byteLength<s)break;const l=e.sublist(0,s);e.consume(s),(t==null?void 0:t.onData)!=null&&t.onData(l),yield l,r=Wn.LENGTH}}}return U2(n)?async function*(){for await(const l of n)e.append(l),yield*c();if(e.byteLength>0)throw Ce(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const l of n)e.append(l),yield*c();if(e.byteLength>0)throw Ce(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}kn.fromReader=(n,t)=>{let e=1;const r=async function*(){for(;;)try{const{done:i,value:o}=await n.next(e);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{e=1}}();return kn(r,{...t??{},onLength:i=>{e=i}})};function B1(n){const[t,e]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[e](){return this}}}function J7(n){return n[Symbol.asyncIterator]!=null}function In(n,t){let e=0;if(J7(n))return async function*(){for await(const c of n)yield t(c,e++)}();const r=B1(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){yield await o;for await(const c of r)yield t(c,e++)}();const a=t;return function*(){yield o;for(const c of r)yield a(c,e++)}()}const j7=xi,eg=n=>new Error(`${j7}: ${n}`);function Kc(n){return new TextDecoder().decode(n)}function Ii(n){return new TextEncoder().encode(n)}async function Fo(n){for await(const t of n)return t}async function tg(n){var t=new TextEncoder;const e=n,r=t.encode(e.sequenceNumber.toString());return await mt.encode(r)}let ir={readyErrored:0,noiseErrored:0,upgradeErrored:0,readyTimedout:0,noiseTimedout:0,success:0},We={pending:0,open:0,ready_error:0,noise_error:0,upgrade_error:0,ready_timeout:0,noise_timeout:0,close:0,abort:0,remote_close:0},Kt={pending:0,ready_error:0,noise_error:0,upgrade_error:0,close:0,remote_close:0,ready:0,abort:0,ready_timeout:0,noise_timeout:0,open:0},Vn=!0,Vo=0,_s=0;function rg(n){try{const t=n.libp2p_webtransport_dialer_events_total,e=(t.pending??0)-(Kt.pending??0),r=(t.ready_error??0)-(Kt.ready_error??0),s=(t.noise_error??0)-(Kt.noise_error??0),i=(t.upgrade_error??0)-(Kt.upgrade_error??0),o=(t.close??0)-(Kt.close??0),a=(t.ready??0)-(Kt.ready??0),c=(t.abort??0)-(Kt.abort??0),l=(t.ready_timeout??0)-(Kt.ready_timeout??0),u=(t.noise_timeout??0)-(Kt.noise_timeout??0),d=(t.open??0)-(Kt.open??0),f=(t.remote_close??0)-(Kt.remote_close??0);We.pending+=e,We.pending-=l,We.pending-=u,We.pending-=r,We.pending-=s,We.pending-=i,We.pending-=d,We.open+=d,We.open-=o,We.open-=f,We.open-=c,We.ready_error=r,We.noise_error=s,We.upgrade_error=i,We.ready_timeout=l,We.noise_timeout=u,We.close=o,We.abort=c,We.remote_close=f,ir.success+=a,ir.readyErrored+=r,ir.noiseErrored+=s,ir.upgradeErrored+=i,ir.readyTimedout+=l,ir.noiseTimedout+=u;const p=ir.readyErrored+ir.noiseErrored+ir.upgradeErrored,y=ir.readyTimedout+ir.noiseTimedout;if(Kt=t,_s=p+y,p+y+We.open+We.pending>30,_s>30,_s-Vo>30&&Vn){Vn=!1;const m=JSON.stringify({isDialEnabled:Vn,fail:_s,lastfailtreshold:Vo});console.warn("dial disabled"),setTimeout(()=>{if(!Vn){Vn=!0,Vo=_s;const w=JSON.stringify({isDialEnabled:Vn,fail:_s,lastfailtreshold:Vo});console.warn("dial enabled")}},6*60*1e3)}return Vn}catch{console.debug("Metrics error")}}var _l={exports:{}},Hc,lh;function ng(){if(lh)return Hc;lh=1;var n=1e3,t=n*60,e=t*60,r=e*24,s=r*7,i=r*365.25;Hc=function(u,d){d=d||{};var f=typeof u;if(f==="string"&&u.length>0)return o(u);if(f==="number"&&isFinite(u))return d.long?c(u):a(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function o(u){if(u=String(u),!(u.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(d){var f=parseFloat(d[1]),p=(d[2]||"ms").toLowerCase();switch(p){case"years":case"year":case"yrs":case"yr":case"y":return f*i;case"weeks":case"week":case"w":return f*s;case"days":case"day":case"d":return f*r;case"hours":case"hour":case"hrs":case"hr":case"h":return f*e;case"minutes":case"minute":case"mins":case"min":case"m":return f*t;case"seconds":case"second":case"secs":case"sec":case"s":return f*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return f;default:return}}}}function a(u){var d=Math.abs(u);return d>=r?Math.round(u/r)+"d":d>=e?Math.round(u/e)+"h":d>=t?Math.round(u/t)+"m":d>=n?Math.round(u/n)+"s":u+"ms"}function c(u){var d=Math.abs(u);return d>=r?l(u,d,r,"day"):d>=e?l(u,d,e,"hour"):d>=t?l(u,d,t,"minute"):d>=n?l(u,d,n,"second"):u+" ms"}function l(u,d,f,p){var y=d>=f*1.5;return Math.round(u/f)+" "+p+(y?"s":"")}return Hc}function sg(n){e.debug=e,e.default=e,e.coerce=c,e.disable=i,e.enable=s,e.enabled=o,e.humanize=ng(),e.destroy=l,Object.keys(n).forEach(u=>{e[u]=n[u]}),e.names=[],e.skips=[],e.formatters={};function t(u){let d=0;for(let f=0;f<u.length;f++)d=(d<<5)-d+u.charCodeAt(f),d|=0;return e.colors[Math.abs(d)%e.colors.length]}e.selectColor=t;function e(u){let d,f=null,p,y;function g(...m){if(!g.enabled)return;const w=g,_=Number(new Date),b=_-(d||_);w.diff=b,w.prev=d,w.curr=_,d=_,m[0]=e.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let S=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(A,P)=>{if(A==="%%")return"%";S++;const T=e.formatters[P];if(typeof T=="function"){const R=m[S];A=T.call(w,R),m.splice(S,1),S--}return A}),e.formatArgs.call(w,m),(w.log||e.log).apply(w,m)}return g.namespace=u,g.useColors=e.useColors(),g.color=e.selectColor(u),g.extend=r,g.destroy=e.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>f!==null?f:(p!==e.namespaces&&(p=e.namespaces,y=e.enabled(u)),y),set:m=>{f=m}}),typeof e.init=="function"&&e.init(g),g}function r(u,d){const f=e(this.namespace+(typeof d>"u"?":":d)+u);return f.log=this.log,f}function s(u){e.save(u),e.namespaces=u,e.names=[],e.skips=[];let d;const f=(typeof u=="string"?u:"").split(/[\s,]+/),p=f.length;for(d=0;d<p;d++)f[d]&&(u=f[d].replace(/\*/g,".*?"),u[0]==="-"?e.skips.push(new RegExp("^"+u.slice(1)+"$")):e.names.push(new RegExp("^"+u+"$")))}function i(){const u=[...e.names.map(a),...e.skips.map(a).map(d=>"-"+d)].join(",");return e.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let d,f;for(d=0,f=e.skips.length;d<f;d++)if(e.skips[d].test(u))return!1;for(d=0,f=e.names.length;d<f;d++)if(e.names[d].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}var ig=sg;(function(n,t){var e={};t.formatArgs=s,t.save=i,t.load=o,t.useColors=r,t.storage=a(),t.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;l.splice(1,0,u,"color: inherit");let d=0,f=0;l[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(d++,p==="%c"&&(f=d))}),l.splice(f,0,u)}t.log=console.debug||console.log||(()=>{});function i(l){try{l?t.storage.setItem("debug",l):t.storage.removeItem("debug")}catch{}}function o(){let l;try{l=t.storage.getItem("debug")}catch{}return!l&&typeof process<"u"&&"env"in process&&(l=e.DEBUG),l}function a(){try{return localStorage}catch{}}n.exports=ig(t);const{formatters:c}=n.exports;c.j=function(l){try{return JSON.stringify(l)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(_l,_l.exports);var og=_l.exports;const Qt=tn(og);Qt.formatters.b=n=>n==null?"undefined":gt.baseEncode(n);Qt.formatters.t=n=>n==null?"undefined":Qr.baseEncode(n);Qt.formatters.m=n=>n==null?"undefined":A1.baseEncode(n);Qt.formatters.p=n=>n==null?"undefined":n.toString();Qt.formatters.c=n=>n==null?"undefined":n.toString();Qt.formatters.k=n=>n==null?"undefined":n.toString();Qt.formatters.a=n=>n==null?"undefined":n.toString();function ag(n){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=n,t.destroy=()=>!0,t.extend=()=>t,t}function V2(){return{forComponent(n){return di(n)}}}function di(n){let t=ag(`${n}:trace`);return Qt.enabled(`${n}:trace`)&&Qt.names.map(e=>e.toString()).find(e=>e.includes(":trace"))!=null&&(t=Qt(`${n}:trace`)),Object.assign(Qt(n),{error:Qt(`${n}:error`),trace:t})}const cg=Symbol.for("nodejs.util.inspect.custom"),uh=Object.values(Ws).map(n=>n.decoder).reduce((n,t)=>n.or(t),Ws.identity.decoder),$2=114,U1=36,F1=37;var d0;class V1{constructor(t){h(this,"type");h(this,"multihash");h(this,"privateKey");h(this,"publicKey");h(this,"string");h(this,d0,!0);this.type=t.type,this.multihash=t.multihash,this.privateKey=t.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=gt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Me.createV1($2,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(t){var e;if(t==null)return!1;if(t instanceof Uint8Array)return ke(this.multihash.bytes,t);if(typeof t=="string")return ye(t).equals(this);if(((e=t==null?void 0:t.multihash)==null?void 0:e.bytes)!=null)return ke(this.multihash.bytes,t.multihash.bytes);throw new Error("not valid Id")}[(d0=_2,cg)](){return`PeerId(${this.toString()})`}}class wo extends V1{constructor(e){super({...e,type:"RSA"});h(this,"type","RSA");h(this,"publicKey");this.publicKey=e.publicKey}}class bo extends V1{constructor(e){super({...e,type:"Ed25519"});h(this,"type","Ed25519");h(this,"publicKey");this.publicKey=e.multihash.digest}}class Eo extends V1{constructor(e){super({...e,type:"secp256k1"});h(this,"type","secp256k1");h(this,"publicKey");this.publicKey=e.multihash.digest}}function lg(n){if(n.type==="RSA")return new wo(n);if(n.type==="Ed25519")return new bo(n);if(n.type==="secp256k1")return new Eo(n);throw new v("Not a PeerId","ERR_INVALID_PARAMETERS")}function ye(n,t){if(t=t??uh,n.charAt(0)==="1"||n.charAt(0)==="Q"){const e=yo(gt.decode(`z${n}`));return n.startsWith("12D")?new bo({multihash:e}):n.startsWith("16U")?new Eo({multihash:e}):new wo({multihash:e})}return tr(uh.decode(n))}function tr(n){try{const t=yo(n);if(t.code===Hi.code){if(t.digest.length===U1)return new bo({multihash:t});if(t.digest.length===F1)return new Eo({multihash:t})}if(t.code===mt.code)return new wo({multihash:t})}catch{return ug(Me.decode(n))}throw new Error("Supplied PeerID CID is invalid")}function ug(n){if(n==null||n.multihash==null||n.version==null||n.version===1&&n.code!==$2)throw new Error("Supplied PeerID CID is invalid");const t=n.multihash;if(t.code===mt.code)return new wo({multihash:n.multihash});if(t.code===Hi.code){if(t.digest.length===U1)return new bo({multihash:n.multihash});if(t.digest.length===F1)return new Eo({multihash:n.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function Cr(n,t){return n.length===U1?new bo({multihash:zs(Hi.code,n),privateKey:t}):n.length===F1?new Eo({multihash:zs(Hi.code,n),privateKey:t}):new wo({multihash:await mt.digest(n),publicKey:n,privateKey:t})}function Xt(n){const t=new globalThis.AbortController;function e(){t.abort();for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",e)}for(const i of n){if((i==null?void 0:i.aborted)===!0){e();break}(i==null?void 0:i.addEventListener)!=null&&i.addEventListener("abort",e)}function r(){for(const i of n)(i==null?void 0:i.removeEventListener)!=null&&i.removeEventListener("abort",e)}const s=t.signal;return s.clear=r,s}async function*hh(n,t={}){const e=n.getReader();try{for(;;){const r=await e.read();if(r.done)return;yield r.value}}finally{t.preventCancel!==!0&&await e.cancel(),e.releaseLock()}}function Un(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function Ps(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function hg(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function ac(n,...t){if(!hg(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${n.length}`)}function cc(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Ps(n.outputLen),Ps(n.blockLen)}function Ia(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function dg(n,t){ac(n);const e=t.outputLen;if(n.length<e)throw new Error(`digestInto() expects output buffer of length at least ${e}`)}const zc=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ra=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),mr=(n,t)=>n<<32-t|n>>>t;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const fg=async()=>{};async function gg(n,t,e){let r=Date.now();for(let s=0;s<n;s++){e(s);const i=Date.now()-r;i>=0&&i<t||(await fg(),r+=i)}}function K2(n){if(typeof n!="string")throw new Error(`utf8ToBytes expected string, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function ns(n){return typeof n=="string"&&(n=K2(n)),ac(n),n}function H2(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];ac(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}class z2{clone(){return this._cloneInto()}}const pg={}.toString;function mg(n,t){if(t!==void 0&&pg.call(t)!=="[object Object]")throw new Error("Options should be object or undefined");return Object.assign(n,t)}function W2(n){const t=r=>n().update(ns(r)).digest(),e=n();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>n(),t}function lc(n=32){if(zc&&typeof zc.getRandomValues=="function")return zc.getRandomValues(new Uint8Array(n));throw new Error("crypto.getRandomValues must be defined")}function yg(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),c=r?4:0,l=r?0:4;n.setUint32(t+c,o,r),n.setUint32(t+l,a,r)}const wg=(n,t,e)=>n&t^~n&e,bg=(n,t,e)=>n&t^n&e^t&e;class q2 extends z2{constructor(t,e,r,s){super(),this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=ra(this.buffer)}update(t){Ia(this);const{view:e,buffer:r,blockLen:s}=this;t=ns(t);const i=t.length;for(let o=0;o<i;){const a=Math.min(s-this.pos,i-o);if(a===s){const c=ra(t);for(;s<=i-o;o+=s)this.process(c,o);continue}r.set(t.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Ia(this),dg(t,this),this.finished=!0;const{buffer:e,view:r,blockLen:s,isLE:i}=this;let{pos:o}=this;e[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(r,0),o=0);for(let d=o;d<s;d++)e[d]=0;yg(r,s-8,BigInt(this.length*8),i),this.process(r,0);const a=ra(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<l;d++)a.setUint32(4*d,u[d],i)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:r,length:s,finished:i,destroyed:o,pos:a}=this;return t.length=s,t.pos=a,t.finished=i,t.destroyed=o,s%e&&t.buffer.set(r),t}}const $o=BigInt(2**32-1),Sl=BigInt(32);function G2(n,t=!1){return t?{h:Number(n&$o),l:Number(n>>Sl&$o)}:{h:Number(n>>Sl&$o)|0,l:Number(n&$o)|0}}function Eg(n,t=!1){let e=new Uint32Array(n.length),r=new Uint32Array(n.length);for(let s=0;s<n.length;s++){const{h:i,l:o}=G2(n[s],t);[e[s],r[s]]=[i,o]}return[e,r]}const vg=(n,t)=>BigInt(n>>>0)<<Sl|BigInt(t>>>0),_g=(n,t,e)=>n>>>e,Sg=(n,t,e)=>n<<32-e|t>>>e,Ig=(n,t,e)=>n>>>e|t<<32-e,Rg=(n,t,e)=>n<<32-e|t>>>e,Ag=(n,t,e)=>n<<64-e|t>>>e-32,Tg=(n,t,e)=>n>>>e-32|t<<64-e,Dg=(n,t)=>t,xg=(n,t)=>n,Cg=(n,t,e)=>n<<e|t>>>32-e,Pg=(n,t,e)=>t<<e|n>>>32-e,kg=(n,t,e)=>t<<e-32|n>>>64-e,Ng=(n,t,e)=>n<<e-32|t>>>64-e;function Mg(n,t,e,r){const s=(t>>>0)+(r>>>0);return{h:n+e+(s/2**32|0)|0,l:s|0}}const Og=(n,t,e)=>(n>>>0)+(t>>>0)+(e>>>0),Lg=(n,t,e,r)=>t+e+r+(n/2**32|0)|0,Bg=(n,t,e,r)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0),Ug=(n,t,e,r,s)=>t+e+r+s+(n/2**32|0)|0,Fg=(n,t,e,r,s)=>(n>>>0)+(t>>>0)+(e>>>0)+(r>>>0)+(s>>>0),Vg=(n,t,e,r,s,i)=>t+e+r+s+i+(n/2**32|0)|0,ae={fromBig:G2,split:Eg,toBig:vg,shrSH:_g,shrSL:Sg,rotrSH:Ig,rotrSL:Rg,rotrBH:Ag,rotrBL:Tg,rotr32H:Dg,rotr32L:xg,rotlSH:Cg,rotlSL:Pg,rotlBH:kg,rotlBL:Ng,add:Mg,add3L:Og,add3H:Lg,add4L:Bg,add4H:Ug,add5H:Vg,add5L:Fg},[$g,Kg]=ae.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),on=new Uint32Array(80),an=new Uint32Array(80);class Hg extends q2{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:t,Al:e,Bh:r,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:d,Fl:f,Gh:p,Gl:y,Hh:g,Hl:m}=this;return[t,e,r,s,i,o,a,c,l,u,d,f,p,y,g,m]}set(t,e,r,s,i,o,a,c,l,u,d,f,p,y,g,m){this.Ah=t|0,this.Al=e|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=d|0,this.Fl=f|0,this.Gh=p|0,this.Gl=y|0,this.Hh=g|0,this.Hl=m|0}process(t,e){for(let b=0;b<16;b++,e+=4)on[b]=t.getUint32(e),an[b]=t.getUint32(e+=4);for(let b=16;b<80;b++){const S=on[b-15]|0,I=an[b-15]|0,A=ae.rotrSH(S,I,1)^ae.rotrSH(S,I,8)^ae.shrSH(S,I,7),P=ae.rotrSL(S,I,1)^ae.rotrSL(S,I,8)^ae.shrSL(S,I,7),T=on[b-2]|0,R=an[b-2]|0,C=ae.rotrSH(T,R,19)^ae.rotrBH(T,R,61)^ae.shrSH(T,R,6),k=ae.rotrSL(T,R,19)^ae.rotrBL(T,R,61)^ae.shrSL(T,R,6),B=ae.add4L(P,k,an[b-7],an[b-16]),L=ae.add4H(B,A,C,on[b-7],on[b-16]);on[b]=L|0,an[b]=B|0}let{Ah:r,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:d,El:f,Fh:p,Fl:y,Gh:g,Gl:m,Hh:w,Hl:_}=this;for(let b=0;b<80;b++){const S=ae.rotrSH(d,f,14)^ae.rotrSH(d,f,18)^ae.rotrBH(d,f,41),I=ae.rotrSL(d,f,14)^ae.rotrSL(d,f,18)^ae.rotrBL(d,f,41),A=d&p^~d&g,P=f&y^~f&m,T=ae.add5L(_,I,P,Kg[b],an[b]),R=ae.add5H(T,w,S,A,$g[b],on[b]),C=T|0,k=ae.rotrSH(r,s,28)^ae.rotrBH(r,s,34)^ae.rotrBH(r,s,39),B=ae.rotrSL(r,s,28)^ae.rotrBL(r,s,34)^ae.rotrBL(r,s,39),L=r&i^r&a^i&a,z=s&o^s&c^o&c;w=g|0,_=m|0,g=p|0,m=y|0,p=d|0,y=f|0,{h:d,l:f}=ae.add(l|0,u|0,R|0,C|0),l=a|0,u=c|0,a=i|0,c=o|0,i=r|0,o=s|0;const x=ae.add3L(C,B,z);r=ae.add3H(x,R,k,L),s=x|0}({h:r,l:s}=ae.add(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:o}=ae.add(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=ae.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=ae.add(this.Dh|0,this.Dl|0,l|0,u|0),{h:d,l:f}=ae.add(this.Eh|0,this.El|0,d|0,f|0),{h:p,l:y}=ae.add(this.Fh|0,this.Fl|0,p|0,y|0),{h:g,l:m}=ae.add(this.Gh|0,this.Gl|0,g|0,m|0),{h:w,l:_}=ae.add(this.Hh|0,this.Hl|0,w|0,_|0),this.set(r,s,i,o,a,c,l,u,d,f,p,y,g,m,w,_)}roundClean(){on.fill(0),an.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const $1=W2(()=>new Hg);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Y2=BigInt(0),uc=BigInt(1),zg=BigInt(2);function ss(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function vo(n){if(!ss(n))throw new Error("Uint8Array expected")}const Wg=Array.from({length:256},(n,t)=>t.toString(16).padStart(2,"0"));function is(n){vo(n);let t="";for(let e=0;e<n.length;e++)t+=Wg[n[e]];return t}function Q2(n){const t=n.toString(16);return t.length&1?`0${t}`:t}function K1(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return BigInt(n===""?"0":`0x${n}`)}const Or={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function dh(n){if(n>=Or._0&&n<=Or._9)return n-Or._0;if(n>=Or._A&&n<=Or._F)return n-(Or._A-10);if(n>=Or._a&&n<=Or._f)return n-(Or._a-10)}function Ys(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);const t=n.length,e=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(e);for(let s=0,i=0;s<e;s++,i+=2){const o=dh(n.charCodeAt(i)),a=dh(n.charCodeAt(i+1));if(o===void 0||a===void 0){const c=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+i)}r[s]=o*16+a}return r}function jn(n){return K1(is(n))}function An(n){return vo(n),K1(is(Uint8Array.from(n).reverse()))}function Qs(n,t){return Ys(n.toString(16).padStart(t*2,"0"))}function Xs(n,t){return Qs(n,t).reverse()}function qg(n){return Ys(Q2(n))}function Ye(n,t,e){let r;if(typeof t=="string")try{r=Ys(t)}catch(i){throw new Error(`${n} must be valid hex string, got "${t}". Cause: ${i}`)}else if(ss(t))r=Uint8Array.from(t);else throw new Error(`${n} must be hex string or Uint8Array`);const s=r.length;if(typeof e=="number"&&s!==e)throw new Error(`${n} expected ${e} bytes, got ${s}`);return r}function os(...n){let t=0;for(let r=0;r<n.length;r++){const s=n[r];vo(s),t+=s.length}const e=new Uint8Array(t);for(let r=0,s=0;r<n.length;r++){const i=n[r];e.set(i,s),s+=i.length}return e}function Gg(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}function Yg(n){if(typeof n!="string")throw new Error(`utf8ToBytes expected string, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function Qg(n){let t;for(t=0;n>Y2;n>>=uc,t+=1);return t}function Xg(n,t){return n>>BigInt(t)&uc}function Zg(n,t,e){return n|(e?uc:Y2)<<BigInt(t)}const H1=n=>(zg<<BigInt(n-1))-uc,Wc=n=>new Uint8Array(n),fh=n=>Uint8Array.from(n);function X2(n,t,e){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof e!="function")throw new Error("hmacFn must be a function");let r=Wc(n),s=Wc(n),i=0;const o=()=>{r.fill(1),s.fill(0),i=0},a=(...d)=>e(s,r,...d),c=(d=Wc())=>{s=a(fh([0]),d),r=a(),d.length!==0&&(s=a(fh([1]),d),r=a())},l=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const f=[];for(;d<t;){r=a();const p=r.slice();f.push(p),d+=r.length}return os(...f)};return(d,f)=>{o(),c(d);let p;for(;!(p=f(l()));)c();return o(),p}}const Jg={bigint:n=>typeof n=="bigint",function:n=>typeof n=="function",boolean:n=>typeof n=="boolean",string:n=>typeof n=="string",stringOrUint8Array:n=>typeof n=="string"||ss(n),isSafeInteger:n=>Number.isSafeInteger(n),array:n=>Array.isArray(n),field:(n,t)=>t.Fp.isValid(n),hash:n=>typeof n=="function"&&Number.isSafeInteger(n.outputLen)};function ds(n,t,e={}){const r=(s,i,o)=>{const a=Jg[i];if(typeof a!="function")throw new Error(`Invalid validator "${i}", expected function`);const c=n[s];if(!(o&&c===void 0)&&!a(c,n))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${i}`)};for(const[s,i]of Object.entries(t))r(s,i,!1);for(const[s,i]of Object.entries(e))r(s,i,!0);return n}const jg=Object.freeze(Object.defineProperty({__proto__:null,abytes:vo,bitGet:Xg,bitLen:Qg,bitMask:H1,bitSet:Zg,bytesToHex:is,bytesToNumberBE:jn,bytesToNumberLE:An,concatBytes:os,createHmacDrbg:X2,ensureBytes:Ye,equalBytes:Gg,hexToBytes:Ys,hexToNumber:K1,isBytes:ss,numberToBytesBE:Qs,numberToBytesLE:Xs,numberToHexUnpadded:Q2,numberToVarBytesBE:qg,utf8ToBytes:Yg,validateObject:ds},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const je=BigInt(0),Fe=BigInt(1),qn=BigInt(2),e9=BigInt(3),Il=BigInt(4),gh=BigInt(5),ph=BigInt(8);BigInt(9);BigInt(16);function xe(n,t){const e=n%t;return e>=je?e:t+e}function Z2(n,t,e){if(e<=je||t<je)throw new Error("Expected power/modulo > 0");if(e===Fe)return je;let r=Fe;for(;t>je;)t&Fe&&(r=r*n%e),n=n*n%e,t>>=Fe;return r}function Le(n,t,e){let r=n;for(;t-- >je;)r*=r,r%=e;return r}function Rl(n,t){if(n===je||t<=je)throw new Error(`invert: expected positive integers, got n=${n} mod=${t}`);let e=xe(n,t),r=t,s=je,i=Fe;for(;e!==je;){const a=r/e,c=r%e,l=s-i*a;r=e,e=c,s=i,i=l}if(r!==Fe)throw new Error("invert: does not exist");return xe(s,t)}function t9(n){const t=(n-Fe)/qn;let e,r,s;for(e=n-Fe,r=0;e%qn===je;e/=qn,r++);for(s=qn;s<n&&Z2(s,t,n)!==n-Fe;s++);if(r===1){const o=(n+Fe)/Il;return function(c,l){const u=c.pow(l,o);if(!c.eql(c.sqr(u),l))throw new Error("Cannot find square root");return u}}const i=(e+Fe)/qn;return function(a,c){if(a.pow(c,t)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=r,u=a.pow(a.mul(a.ONE,s),e),d=a.pow(c,i),f=a.pow(c,e);for(;!a.eql(f,a.ONE);){if(a.eql(f,a.ZERO))return a.ZERO;let p=1;for(let g=a.sqr(f);p<l&&!a.eql(g,a.ONE);p++)g=a.sqr(g);const y=a.pow(u,Fe<<BigInt(l-p-1));u=a.sqr(y),d=a.mul(d,y),f=a.mul(f,u),l=p}return d}}function r9(n){if(n%Il===e9){const t=(n+Fe)/Il;return function(r,s){const i=r.pow(s,t);if(!r.eql(r.sqr(i),s))throw new Error("Cannot find square root");return i}}if(n%ph===gh){const t=(n-gh)/ph;return function(r,s){const i=r.mul(s,qn),o=r.pow(i,t),a=r.mul(s,o),c=r.mul(r.mul(a,qn),o),l=r.mul(a,r.sub(c,r.ONE));if(!r.eql(r.sqr(l),s))throw new Error("Cannot find square root");return l}}return t9(n)}const n9=(n,t)=>(xe(n,t)&Fe)===Fe,s9=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function i9(n){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},e=s9.reduce((r,s)=>(r[s]="function",r),t);return ds(n,e)}function o9(n,t,e){if(e<je)throw new Error("Expected power > 0");if(e===je)return n.ONE;if(e===Fe)return t;let r=n.ONE,s=t;for(;e>je;)e&Fe&&(r=n.mul(r,s)),s=n.sqr(s),e>>=Fe;return r}function a9(n,t){const e=new Array(t.length),r=t.reduce((i,o,a)=>n.is0(o)?i:(e[a]=i,n.mul(i,o)),n.ONE),s=n.inv(r);return t.reduceRight((i,o,a)=>n.is0(o)?i:(e[a]=n.mul(i,e[a]),n.mul(i,o)),s),e}function J2(n,t){const e=t!==void 0?t:n.toString(2).length,r=Math.ceil(e/8);return{nBitLength:e,nByteLength:r}}function j2(n,t,e=!1,r={}){if(n<=je)throw new Error(`Expected Field ORDER > 0, got ${n}`);const{nBitLength:s,nByteLength:i}=J2(n,t);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");const o=r9(n),a=Object.freeze({ORDER:n,BITS:s,BYTES:i,MASK:H1(s),ZERO:je,ONE:Fe,create:c=>xe(c,n),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return je<=c&&c<n},is0:c=>c===je,isOdd:c=>(c&Fe)===Fe,neg:c=>xe(-c,n),eql:(c,l)=>c===l,sqr:c=>xe(c*c,n),add:(c,l)=>xe(c+l,n),sub:(c,l)=>xe(c-l,n),mul:(c,l)=>xe(c*l,n),pow:(c,l)=>o9(a,c,l),div:(c,l)=>xe(c*Rl(l,n),n),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>Rl(c,n),sqrt:r.sqrt||(c=>o(a,c)),invertBatch:c=>a9(a,c),cmov:(c,l,u)=>u?l:c,toBytes:c=>e?Xs(c,i):Qs(c,i),fromBytes:c=>{if(c.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${c.length}`);return e?An(c):jn(c)}});return Object.freeze(a)}function c9(n,t){if(!n.isOdd)throw new Error("Field doesn't have isOdd");const e=n.sqrt(t);return n.isOdd(e)?n.neg(e):e}function ef(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const t=n.toString(2).length;return Math.ceil(t/8)}function tf(n){const t=ef(n);return t+Math.ceil(t/2)}function l9(n,t,e=!1){const r=n.length,s=ef(t),i=tf(t);if(r<16||r<i||r>1024)throw new Error(`expected ${i}-1024 bytes of input, got ${r}`);const o=e?jn(n):An(n),a=xe(o,t-Fe)+Fe;return e?Xs(a,s):Qs(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u9=BigInt(0),qc=BigInt(1);function rf(n,t){const e=(s,i)=>{const o=i.negate();return s?o:i},r=s=>{const i=Math.ceil(t/s)+1,o=2**(s-1);return{windows:i,windowSize:o}};return{constTimeNegate:e,unsafeLadder(s,i){let o=n.ZERO,a=s;for(;i>u9;)i&qc&&(o=o.add(a)),a=a.double(),i>>=qc;return o},precomputeWindow(s,i){const{windows:o,windowSize:a}=r(i),c=[];let l=s,u=l;for(let d=0;d<o;d++){u=l,c.push(u);for(let f=1;f<a;f++)u=u.add(l),c.push(u);l=u.double()}return c},wNAF(s,i,o){const{windows:a,windowSize:c}=r(s);let l=n.ZERO,u=n.BASE;const d=BigInt(2**s-1),f=2**s,p=BigInt(s);for(let y=0;y<a;y++){const g=y*c;let m=Number(o&d);o>>=p,m>c&&(m-=f,o+=qc);const w=g,_=g+Math.abs(m)-1,b=y%2!==0,S=m<0;m===0?u=u.add(e(b,i[w])):l=l.add(e(S,i[_]))}return{p:l,f:u}},wNAFCached(s,i,o,a){const c=s._WINDOW_SIZE||1;let l=i.get(s);return l||(l=this.precomputeWindow(s,c),c!==1&&i.set(s,a(l))),this.wNAF(c,l,o)}}}function z1(n){return i9(n.Fp),ds(n,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...J2(n.n,n.nBitLength),...n,p:n.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const or=BigInt(0),Nt=BigInt(1),Ko=BigInt(2),h9=BigInt(8),d9={zip215:!0};function f9(n){const t=z1(n);return ds(n,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...t})}function W1(n){const t=f9(n),{Fp:e,n:r,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:c}=t,l=Ko<<BigInt(a*8)-Nt,u=e.create,d=t.uvRatio||((M,D)=>{try{return{isValid:!0,value:e.sqrt(M*e.inv(D))}}catch{return{isValid:!1,value:or}}}),f=t.adjustScalarBytes||(M=>M),p=t.domain||((M,D,V)=>{if(D.length||V)throw new Error("Contexts/pre-hash are not supported");return M}),y=M=>typeof M=="bigint"&&or<M,g=(M,D)=>y(M)&&y(D)&&M<D,m=M=>M===or||g(M,l);function w(M,D){if(g(M,D))return M;throw new Error(`Expected valid scalar < ${D}, got ${typeof M} ${M}`)}function _(M){return M===or?M:w(M,r)}const b=new Map;function S(M){if(!(M instanceof I))throw new Error("ExtendedPoint expected")}class I{constructor(D,V,K,W){if(this.ex=D,this.ey=V,this.ez=K,this.et=W,!m(D))throw new Error("x required");if(!m(V))throw new Error("y required");if(!m(K))throw new Error("z required");if(!m(W))throw new Error("t required")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(D){if(D instanceof I)throw new Error("extended point not allowed");const{x:V,y:K}=D||{};if(!m(V)||!m(K))throw new Error("invalid affine point");return new I(V,K,Nt,u(V*K))}static normalizeZ(D){const V=e.invertBatch(D.map(K=>K.ez));return D.map((K,W)=>K.toAffine(V[W])).map(I.fromAffine)}_setWindowSize(D){this._WINDOW_SIZE=D,b.delete(this)}assertValidity(){const{a:D,d:V}=t;if(this.is0())throw new Error("bad point: ZERO");const{ex:K,ey:W,ez:te,et:re}=this,ie=u(K*K),ne=u(W*W),se=u(te*te),Ae=u(se*se),Ie=u(ie*D),et=u(se*u(Ie+ne)),tt=u(Ae+u(V*u(ie*ne)));if(et!==tt)throw new Error("bad point: equation left != right (1)");const yt=u(K*W),ze=u(te*re);if(yt!==ze)throw new Error("bad point: equation left != right (2)")}equals(D){S(D);const{ex:V,ey:K,ez:W}=this,{ex:te,ey:re,ez:ie}=D,ne=u(V*ie),se=u(te*W),Ae=u(K*ie),Ie=u(re*W);return ne===se&&Ae===Ie}is0(){return this.equals(I.ZERO)}negate(){return new I(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){const{a:D}=t,{ex:V,ey:K,ez:W}=this,te=u(V*V),re=u(K*K),ie=u(Ko*u(W*W)),ne=u(D*te),se=V+K,Ae=u(u(se*se)-te-re),Ie=ne+re,et=Ie-ie,tt=ne-re,yt=u(Ae*et),ze=u(Ie*tt),nr=u(Ae*tt),Fn=u(et*Ie);return new I(yt,ze,Fn,nr)}add(D){S(D);const{a:V,d:K}=t,{ex:W,ey:te,ez:re,et:ie}=this,{ex:ne,ey:se,ez:Ae,et:Ie}=D;if(V===BigInt(-1)){const Lu=u((te-W)*(se+ne)),Bu=u((te+W)*(se-ne)),Cc=u(Bu-Lu);if(Cc===or)return this.double();const Uu=u(re*Ko*Ie),Fu=u(ie*Ko*Ae),Vu=Fu+Uu,$u=Bu+Lu,Ku=Fu-Uu,c5=u(Vu*Cc),l5=u($u*Ku),u5=u(Vu*Ku),h5=u(Cc*$u);return new I(c5,l5,h5,u5)}const et=u(W*ne),tt=u(te*se),yt=u(ie*K*Ie),ze=u(re*Ae),nr=u((W+te)*(ne+se)-et-tt),Fn=ze-yt,vi=ze+yt,Ou=u(tt-V*et),s5=u(nr*Fn),i5=u(vi*Ou),o5=u(nr*Ou),a5=u(Fn*vi);return new I(s5,i5,a5,o5)}subtract(D){return this.add(D.negate())}wNAF(D){return T.wNAFCached(this,b,D,I.normalizeZ)}multiply(D){const{p:V,f:K}=this.wNAF(w(D,r));return I.normalizeZ([V,K])[0]}multiplyUnsafe(D){let V=_(D);return V===or?P:this.equals(P)||V===Nt?this:this.equals(A)?this.wNAF(V).p:T.unsafeLadder(this,V)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return T.unsafeLadder(this,r).is0()}toAffine(D){const{ex:V,ey:K,ez:W}=this,te=this.is0();D==null&&(D=te?h9:e.inv(W));const re=u(V*D),ie=u(K*D),ne=u(W*D);if(te)return{x:or,y:Nt};if(ne!==Nt)throw new Error("invZ was invalid");return{x:re,y:ie}}clearCofactor(){const{h:D}=t;return D===Nt?this:this.multiplyUnsafe(D)}static fromHex(D,V=!1){const{d:K,a:W}=t,te=e.BYTES;D=Ye("pointHex",D,te);const re=D.slice(),ie=D[te-1];re[te-1]=ie&-129;const ne=An(re);ne===or||(V?w(ne,l):w(ne,e.ORDER));const se=u(ne*ne),Ae=u(se-Nt),Ie=u(K*se-W);let{isValid:et,value:tt}=d(Ae,Ie);if(!et)throw new Error("Point.fromHex: invalid y coordinate");const yt=(tt&Nt)===Nt,ze=(ie&128)!==0;if(!V&&tt===or&&ze)throw new Error("Point.fromHex: x=0 and x_0=1");return ze!==yt&&(tt=u(-tt)),I.fromAffine({x:tt,y:ne})}static fromPrivateKey(D){return k(D).point}toRawBytes(){const{x:D,y:V}=this.toAffine(),K=Xs(V,e.BYTES);return K[K.length-1]|=D&Nt?128:0,K}toHex(){return is(this.toRawBytes())}}I.BASE=new I(t.Gx,t.Gy,Nt,u(t.Gx*t.Gy)),I.ZERO=new I(or,Nt,Nt,or);const{BASE:A,ZERO:P}=I,T=rf(I,a*8);function R(M){return xe(M,r)}function C(M){return R(An(M))}function k(M){const D=a;M=Ye("private key",M,D);const V=Ye("hashed private key",i(M),2*D),K=f(V.slice(0,D)),W=V.slice(D,2*D),te=C(K),re=A.multiply(te),ie=re.toRawBytes();return{head:K,prefix:W,scalar:te,point:re,pointBytes:ie}}function B(M){return k(M).pointBytes}function L(M=new Uint8Array,...D){const V=os(...D);return C(i(p(V,Ye("context",M),!!s)))}function z(M,D,V={}){M=Ye("message",M),s&&(M=s(M));const{prefix:K,scalar:W,pointBytes:te}=k(D),re=L(V.context,K,M),ie=A.multiply(re).toRawBytes(),ne=L(V.context,ie,te,M),se=R(re+ne*W);_(se);const Ae=os(ie,Xs(se,e.BYTES));return Ye("result",Ae,a*2)}const x=d9;function N(M,D,V,K=x){const{context:W,zip215:te}=K,re=e.BYTES;M=Ye("signature",M,2*re),D=Ye("message",D),s&&(D=s(D));const ie=An(M.slice(re,2*re));let ne,se,Ae;try{ne=I.fromHex(V,te),se=I.fromHex(M.slice(0,re),te),Ae=A.multiplyUnsafe(ie)}catch{return!1}if(!te&&ne.isSmallOrder())return!1;const Ie=L(W,se.toRawBytes(),ne.toRawBytes(),D);return se.add(ne.multiplyUnsafe(Ie)).subtract(Ae).clearCofactor().equals(I.ZERO)}return A._setWindowSize(8),{CURVE:t,getPublicKey:B,sign:z,verify:N,ExtendedPoint:I,utils:{getExtendedPublicKey:k,randomPrivateKey:()=>o(e.BYTES),precompute(M=8,D=I.BASE){return D._setWindowSize(M),D.multiply(BigInt(3)),D}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ri=BigInt(0),Gc=BigInt(1);function g9(n){return ds(n,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...n})}function p9(n){const t=g9(n),{P:e}=t,r=b=>xe(b,e),s=t.montgomeryBits,i=Math.ceil(s/8),o=t.nByteLength,a=t.adjustScalarBytes||(b=>b),c=t.powPminus2||(b=>Z2(b,e-BigInt(2),e));function l(b,S,I){const A=r(b*(S-I));return S=r(S-A),I=r(I+A),[S,I]}function u(b){if(typeof b=="bigint"&&Ri<=b&&b<e)return b;throw new Error("Expected valid scalar 0 < scalar < CURVE.P")}const d=(t.a-BigInt(2))/BigInt(4);function f(b,S){const I=u(b),A=u(S),P=I;let T=Gc,R=Ri,C=I,k=Gc,B=Ri,L;for(let x=BigInt(s-1);x>=Ri;x--){const N=A>>x&Gc;B^=N,L=l(B,T,C),T=L[0],C=L[1],L=l(B,R,k),R=L[0],k=L[1],B=N;const $=T+R,M=r($*$),D=T-R,V=r(D*D),K=M-V,W=C+k,te=C-k,re=r(te*$),ie=r(W*D),ne=re+ie,se=re-ie;C=r(ne*ne),k=r(P*r(se*se)),T=r(M*V),R=r(K*(M+r(d*K)))}L=l(B,T,C),T=L[0],C=L[1],L=l(B,R,k),R=L[0],k=L[1];const z=c(R);return r(T*z)}function p(b){return Xs(r(b),i)}function y(b){const S=Ye("u coordinate",b,i);return o===32&&(S[31]&=127),An(S)}function g(b){const S=Ye("scalar",b),I=S.length;if(I!==i&&I!==o)throw new Error(`Expected ${i} or ${o} bytes, got ${I}`);return An(a(S))}function m(b,S){const I=y(S),A=g(b),P=f(I,A);if(P===Ri)throw new Error("Invalid private or public key received");return p(P)}const w=p(t.Gu);function _(b){return m(b,w)}return{scalarMult:m,scalarMultBase:_,getSharedSecret:(b,S)=>m(b,S),getPublicKey:b=>_(b),utils:{randomPrivateKey:()=>t.randomBytes(t.nByteLength)},GuBytes:w}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const qi=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),mh=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const m9=BigInt(1),Al=BigInt(2),y9=BigInt(5),yh=BigInt(10),w9=BigInt(20),b9=BigInt(40),wh=BigInt(80);function nf(n){const t=qi,r=n*n%t*n%t,s=Le(r,Al,t)*r%t,i=Le(s,m9,t)*n%t,o=Le(i,y9,t)*i%t,a=Le(o,yh,t)*o%t,c=Le(a,w9,t)*a%t,l=Le(c,b9,t)*c%t,u=Le(l,wh,t)*l%t,d=Le(u,wh,t)*l%t,f=Le(d,yh,t)*o%t;return{pow_p_5_8:Le(f,Al,t)*n%t,b2:r}}function sf(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}function E9(n,t){const e=qi,r=xe(t*t*t,e),s=xe(r*r*t,e),i=nf(n*s).pow_p_5_8;let o=xe(n*r*i,e);const a=xe(t*o*o,e),c=o,l=xe(o*mh,e),u=a===n,d=a===xe(-n,e),f=a===xe(-n*mh,e);return u&&(o=c),(d||f)&&(o=l),n9(o,e)&&(o=xe(-o,e)),{isValid:u||d,value:o}}const Xr=j2(qi,void 0,!0),q1={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:Xr,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:$1,randomBytes:lc,adjustScalarBytes:sf,uvRatio:E9},Gi=W1(q1);function of(n,t,e){if(t.length>255)throw new Error("Context is too big");return H2(K2("SigEd25519 no Ed25519 collisions"),new Uint8Array([e?1:0,t.length]),t,n)}({...q1});({...q1});const Ho=p9({P:qi,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:n=>{const t=qi,{pow_p_5_8:e,b2:r}=nf(n);return xe(Le(e,BigInt(3),t)*r,t)},adjustScalarBytes:sf,randomBytes:lc}),v9=(Xr.ORDER+BigInt(3))/BigInt(8);Xr.pow(Al,v9);Xr.sqrt(Xr.neg(Xr.ONE));(Xr.ORDER-BigInt(5))/BigInt(8);BigInt(486662);c9(Xr,Xr.neg(BigInt(486664)));BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235");BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578");BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838");BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");const Yi=32,hn=64,Ra=32;function _9(){const n=Gi.utils.randomPrivateKey(),t=Gi.getPublicKey(n);return{privateKey:af(n,t),publicKey:t}}function S9(n){if(n.length!==Ra)throw new TypeError('"seed" must be 32 bytes in length.');if(!(n instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=n,e=Gi.getPublicKey(t);return{privateKey:af(t,e),publicKey:e}}function I9(n,t){const e=n.subarray(0,Ra);return Gi.sign(t instanceof Uint8Array?t:t.subarray(),e)}function R9(n,t,e){return Gi.verify(t,e instanceof Uint8Array?e:e.subarray(),n)}function af(n,t){const e=new Uint8Array(hn);for(let r=0;r<Ra;r++)e[r]=n[r],e[Ra+r]=t[r];return e}const gr={get(n=globalThis){const t=n.crypto;if(t==null||t.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return t}},Yc={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function A9(n){const t="AES-GCM";let e=16;const r=12,s="SHA-256",i=16,o=32767,a=gr.get();e*=8;async function c(d,f){const p=a.getRandomValues(new Uint8Array(i)),y=a.getRandomValues(new Uint8Array(r)),g={name:t,iv:y};typeof f=="string"&&(f=Y(f));let m;if(f.length===0){m=await a.subtle.importKey("jwk",Yc,{name:"AES-GCM"},!0,["encrypt"]);try{const _={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,b,{name:t,length:e},!0,["encrypt"])}catch{m=await a.subtle.importKey("jwk",Yc,{name:"AES-GCM"},!0,["encrypt"])}}else{const _={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},b=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);m=await a.subtle.deriveKey(_,b,{name:t,length:e},!0,["encrypt"])}const w=await a.subtle.encrypt(g,m,d);return at([p,g.iv,new Uint8Array(w)])}async function l(d,f){const p=d.subarray(0,i),y=d.subarray(i,i+r),g=d.subarray(i+r),m={name:t,iv:y};typeof f=="string"&&(f=Y(f));let w;if(f.length===0)try{const b={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,S,{name:t,length:e},!0,["decrypt"])}catch{w=await a.subtle.importKey("jwk",Yc,{name:"AES-GCM"},!0,["decrypt"])}else{const b={name:"PBKDF2",salt:p,iterations:o,hash:{name:s}},S=await a.subtle.importKey("raw",f,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,S,{name:t,length:e},!0,["decrypt"])}const _=await a.subtle.decrypt(m,w,g);return new Uint8Array(_)}return{encrypt:c,decrypt:l}}async function G1(n,t){const r=await A9().encrypt(n,t);return A1.encode(r)}var Qe;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.Secp256k1="Secp256k1"})(Qe||(Qe={}));var Tl;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.Secp256k1=2]="Secp256k1"})(Tl||(Tl={}));(function(n){n.codec=()=>kr(Tl)})(Qe||(Qe={}));var Zs;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),Qe.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.Type=Qe.codec().decode(e);break;case 2:s.Data=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Zs||(Zs={}));var Js;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.Type!=null&&(r.uint32(8),Qe.codec().encode(e.Type,r)),e.Data!=null&&(r.uint32(18),r.bytes(e.Data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.Type=Qe.codec().decode(e);break;case 2:s.Data=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Js||(Js={}));class Y1{constructor(t){h(this,"_key");this._key=js(t,Yi)}verify(t,e){return R9(this._key,e,t)}marshal(){return this._key}get bytes(){return Zs.encode({Type:Qe.Ed25519,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}hash(){const t=mt.digest(this.bytes);return Un(t)?t.then(({bytes:e})=>e):t.bytes}}class Qi{constructor(t,e){h(this,"_key");h(this,"_publicKey");this._key=js(t,hn),this._publicKey=js(e,Yi)}sign(t){return I9(this._key,t)}get public(){return new Y1(this._publicKey)}marshal(){return this._key}get bytes(){return Js.encode({Type:Qe.Ed25519,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}async hash(){const t=mt.digest(this.bytes);let e;return Un(t)?{bytes:e}=await t:e=t.bytes,e}async id(){const t=Hi.digest(this.public.bytes);return gt.encode(t.bytes).substring(1)}async export(t,e="libp2p-key"){if(e==="libp2p-key")return G1(this.bytes,t);throw new v(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function T9(n){if(n.length>hn){n=js(n,hn+Yi);const r=n.subarray(0,hn),s=n.subarray(hn,n.length);return new Qi(r,s)}n=js(n,hn);const t=n.subarray(0,hn),e=n.subarray(Yi);return new Qi(t,e)}function D9(n){return n=js(n,Yi),new Y1(n)}async function x9(){const{privateKey:n,publicKey:t}=_9();return new Qi(n,t)}async function C9(n){const{privateKey:t,publicKey:e}=S9(n);return new Qi(t,e)}function js(n,t){if(n=Uint8Array.from(n??[]),n.length!==t)throw new v(`Key must be a Uint8Array of length ${t}, got ${n.length}`,"ERR_INVALID_KEY_TYPE");return n}const P9=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:Qi,Ed25519PublicKey:Y1,generateKeyPair:x9,generateKeyPairFromSeed:C9,unmarshalEd25519PrivateKey:T9,unmarshalEd25519PublicKey:D9},Symbol.toStringTag,{value:"Module"}));function as(n){if(isNaN(n)||n<=0)throw new v("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return lc(n)}class cf extends z2{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,cc(t);const r=ns(e);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?t.create().update(r).digest():r);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=t.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(t){return Ia(this),this.iHash.update(t),this}digestInto(t){Ia(this),ac(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:e,iHash:r,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return t=t,t.finished=s,t.destroyed=i,t.blockLen=o,t.outputLen=a,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const _o=(n,t,e)=>new cf(n,t).update(e).digest();_o.create=(n,t)=>new cf(n,t);function k9(n,t,e,r){cc(n);const s=mg({dkLen:32,asyncTick:10},r),{c:i,dkLen:o,asyncTick:a}=s;if(Ps(i),Ps(o),Ps(a),i<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const c=ns(t),l=ns(e),u=new Uint8Array(o),d=_o.create(n,c),f=d._cloneInto().update(l);return{c:i,dkLen:o,asyncTick:a,DK:u,PRF:d,PRFSalt:f}}function N9(n,t,e,r,s){return n.destroy(),t.destroy(),r&&r.destroy(),s.fill(0),e}async function M9(n,t,e,r){const{c:s,dkLen:i,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=k9(n,t,e,r);let u;const d=new Uint8Array(4),f=ra(d),p=new Uint8Array(c.outputLen);for(let y=1,g=0;g<i;y++,g+=c.outputLen){const m=a.subarray(g,g+c.outputLen);f.setInt32(0,y,!1),(u=l._cloneInto(u)).update(d).digestInto(p),m.set(p.subarray(0,m.length)),await gg(s-1,o,()=>{c._cloneInto(u).update(p).digestInto(p);for(let w=0;w<m.length;w++)m[w]^=p[w]})}return N9(c,l,a,u,p)}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2022 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const O9="[object ArrayBuffer]";class De{static isArrayBuffer(t){return Object.prototype.toString.call(t)===O9}static toArrayBuffer(t){return this.isArrayBuffer(t)?t:t.byteLength===t.buffer.byteLength||t.byteOffset===0&&t.byteLength===t.buffer.byteLength?t.buffer:this.toUint8Array(t.buffer).slice(t.byteOffset,t.byteOffset+t.byteLength).buffer}static toUint8Array(t){return this.toView(t,Uint8Array)}static toView(t,e){if(t.constructor===e)return t;if(this.isArrayBuffer(t))return new e(t);if(this.isArrayBufferView(t))return new e(t.buffer,t.byteOffset,t.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(t){return this.isArrayBufferView(t)||this.isArrayBuffer(t)}static isArrayBufferView(t){return ArrayBuffer.isView(t)||t&&this.isArrayBuffer(t.buffer)}static isEqual(t,e){const r=De.toUint8Array(t),s=De.toUint8Array(e);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...t){let e;Array.isArray(t[0])&&!(t[1]instanceof Function)||Array.isArray(t[0])&&t[1]instanceof Function?e=t[0]:t[t.length-1]instanceof Function?e=t.slice(0,t.length-1):e=t;let r=0;for(const o of e)r+=o.byteLength;const s=new Uint8Array(r);let i=0;for(const o of e){const a=this.toUint8Array(o);s.set(a,i),i+=a.length}return t[t.length-1]instanceof Function?this.toView(s,t[t.length-1]):s.buffer}}const Qc="string",L9=/^[0-9a-f]+$/i,B9=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,U9=/^[a-zA-Z0-9-_]+$/;class bh{static fromString(t){const e=unescape(encodeURIComponent(t)),r=new Uint8Array(e.length);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return r.buffer}static toString(t){const e=De.toUint8Array(t);let r="";for(let i=0;i<e.length;i++)r+=String.fromCharCode(e[i]);return decodeURIComponent(escape(r))}}class yr{static toString(t,e=!1){const r=De.toArrayBuffer(t),s=new DataView(r);let i="";for(let o=0;o<r.byteLength;o+=2){const a=s.getUint16(o,e);i+=String.fromCharCode(a)}return i}static fromString(t,e=!1){const r=new ArrayBuffer(t.length*2),s=new DataView(r);for(let i=0;i<t.length;i++)s.setUint16(i*2,t.charCodeAt(i),e);return r}}class He{static isHex(t){return typeof t===Qc&&L9.test(t)}static isBase64(t){return typeof t===Qc&&B9.test(t)}static isBase64Url(t){return typeof t===Qc&&U9.test(t)}static ToString(t,e="utf8"){const r=De.toUint8Array(t);switch(e.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return yr.toString(r,!0);case"utf16":case"utf16be":return yr.toString(r);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromString(t,e="utf8"){if(!t)return new ArrayBuffer(0);switch(e.toLowerCase()){case"utf8":return this.FromUtf8String(t);case"binary":return this.FromBinary(t);case"hex":return this.FromHex(t);case"base64":return this.FromBase64(t);case"base64url":return this.FromBase64Url(t);case"utf16le":return yr.fromString(t,!0);case"utf16":case"utf16be":return yr.fromString(t);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToBase64(t){const e=De.toUint8Array(t);if(typeof btoa<"u"){const r=this.ToString(e,"binary");return btoa(r)}else return Buffer.from(e).toString("base64")}static FromBase64(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!He.isBase64(e))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(e)):new Uint8Array(Buffer.from(e,"base64")).buffer}static FromBase64Url(t){const e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!He.isBase64Url(e))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(t){return this.ToBase64(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(t,e=He.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.FromBinary(t);case"utf8":return bh.fromString(t);case"utf16":case"utf16be":return yr.fromString(t);case"utf16le":case"usc2":return yr.fromString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static ToUtf8String(t,e=He.DEFAULT_UTF8_ENCODING){switch(e){case"ascii":return this.ToBinary(t);case"utf8":return bh.toString(t);case"utf16":case"utf16be":return yr.toString(t);case"utf16le":case"usc2":return yr.toString(t,!0);default:throw new Error(`Unknown type of encoding '${e}'`)}}static FromBinary(t){const e=t.length,r=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);return r.buffer}static ToBinary(t){const e=De.toUint8Array(t);let r="";for(let s=0;s<e.length;s++)r+=String.fromCharCode(e[s]);return r}static ToHex(t){const e=De.toUint8Array(t);let r="";const s=e.length;for(let i=0;i<s;i++){const o=e[i];o<16&&(r+="0"),r+=o.toString(16)}return r}static FromHex(t){let e=this.formatString(t);if(!e)return new ArrayBuffer(0);if(!He.isHex(e))throw new TypeError("Argument 'hexString' is not HEX encoded");e.length%2&&(e=`0${e}`);const r=new Uint8Array(e.length/2);for(let s=0;s<e.length;s=s+2){const i=e.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(t,e=!1){return yr.toString(t,e)}static FromUtf16String(t,e=!1){return yr.fromString(t,e)}static Base64Padding(t){const e=4-t.length%4;if(e<4)for(let r=0;r<e;r++)t+="=";return t}static formatString(t){return(t==null?void 0:t.replace(/[\n\r\t ]/g,""))||""}}He.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function ei(n,t){let e=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)e+=n[n.length-1-r]*Math.pow(2,t*r);return e}function cs(n,t,e=-1){const r=e;let s=n,i=0,o=Math.pow(2,t);for(let a=1;a<8;a++){if(n<o){let c;if(r<0)c=new ArrayBuffer(a),i=a;else{if(r<a)return new ArrayBuffer(0);c=new ArrayBuffer(r),i=r}const l=new Uint8Array(c);for(let u=a-1;u>=0;u--){const d=Math.pow(2,u*t);l[i-u-1]=Math.floor(s/d),s-=l[i-u-1]*d}return c}o*=Math.pow(2,t)}return new ArrayBuffer(0)}function Dl(...n){let t=0,e=0;for(const i of n)t+=i.length;const r=new ArrayBuffer(t),s=new Uint8Array(r);for(const i of n)s.set(i,e),e+=i.length;return s}function lf(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=n[0]===255&&n[1]&128,c=n[0]===0&&(n[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const t=new ArrayBuffer(this.valueHex.byteLength),e=new Uint8Array(t);for(let a=0;a<this.valueHex.byteLength;a++)e[a]=0;e[0]=n[0]&128;const r=ei(e,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let a=0;a<this.valueHex.byteLength;a++)i[a]=n[a];return i[0]&=127,ei(i,8)-r}function F9(n){const t=n<0?n*-1:n;let e=128;for(let r=1;r<8;r++){if(t<=e){if(n<0){const o=e-t,a=cs(o,8,r),c=new Uint8Array(a);return c[0]|=128,a}let s=cs(t,8,r),i=new Uint8Array(s);if(i[0]&128){const o=s.slice(0),a=new Uint8Array(o);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let c=0;c<o.byteLength;c++)i[c+1]=a[c];i[0]=0}return s}e*=Math.pow(2,8)}return new ArrayBuffer(0)}function V9(n,t){if(n.byteLength!==t.byteLength)return!1;const e=new Uint8Array(n),r=new Uint8Array(t);for(let s=0;s<e.length;s++)if(e[s]!==r[s])return!1;return!0}function Ut(n,t){const e=n.toString(10);if(t<e.length)return"";const r=t-e.length,s=new Array(r);for(let o=0;o<r;o++)s[o]="0";return s.join("").concat(e)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Aa(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Q1(n){let t=0,e=0;for(let s=0;s<n.length;s++){const i=n[s];t+=i.byteLength}const r=new Uint8Array(t);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),e),e+=i.byteLength}return r.buffer}function rn(n,t,e,r){return t instanceof Uint8Array?t.byteLength?e<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):t.byteLength-e-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class X1{constructor(){this.items=[]}write(t){this.items.push(t)}final(){return Q1(this.items)}}const Ai=[new Uint8Array([1])],Eh="0123456789",fi="",pr=new ArrayBuffer(0),Z1=new Uint8Array(0),Xi="EndOfContent",uf="OCTET STRING",hf="BIT STRING";function nn(n){var t;return t=class extends n{constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?De.toUint8Array(i.valueHex):Z1}get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}fromBER(r,s,i){const o=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!rn(this,o,s,i))return-1;const a=s+i;return this.valueHexView=o.subarray(s,a),this.valueHexView.length?(this.blockLength=i,a):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",pr)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:He.ToHex(this.valueHexView)}}},t.NAME="hexBlock",t}class fs{constructor({blockLength:t=0,error:e=fi,warnings:r=[],valueBeforeDecode:s=Z1}={}){this.blockLength=t,this.error=e,this.warnings=r,this.valueBeforeDecodeView=De.toUint8Array(s)}static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(t){this.valueBeforeDecodeView=new Uint8Array(t)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:He.ToHex(this.valueBeforeDecodeView)}}}fs.NAME="baseBlock";class Pt extends fs{fromBER(t,e,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(t,e){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Pt.NAME="valueBlock";class df extends nn(fs){constructor({idBlock:t={}}={}){var e,r,s,i;super(),t?(this.isHexOnly=(e=t.isHexOnly)!==null&&e!==void 0?e:!1,this.valueHexView=t.valueHex?De.toUint8Array(t.valueHex):Z1,this.tagClass=(r=t.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=t.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=t.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(t=!1){let e=0;switch(this.tagClass){case 1:e|=0;break;case 2:e|=64;break;case 3:e|=128;break;case 4:e|=192;break;default:return this.error="Unknown tag class",pr}if(this.isConstructed&&(e|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!t){let i=this.tagNumber;i&=31,e|=i,s[0]=e}return s.buffer}if(!this.isHexOnly){const s=cs(this.tagNumber,7),i=new Uint8Array(s),o=s.byteLength,a=new Uint8Array(o+1);if(a[0]=e|31,!t){for(let c=0;c<o-1;c++)a[c+1]=i[c]|128;a[o]=i[o-1]}return a.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=e|31,!t){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(t,e,r){const s=De.toUint8Array(t);if(!rn(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const a=i[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),u=255;for(;i[c]&128;){if(l[c-1]=i[c]&127,c++,c>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(c===u){u+=255;const f=new Uint8Array(u);for(let p=0;p<l.length;p++)f[p]=l[p];l=this.valueHexView=new Uint8Array(u)}}this.blockLength=c+1,l[c-1]=i[c]&127;const d=new Uint8Array(c);for(let f=0;f<c;f++)d[f]=l[f];l=this.valueHexView=new Uint8Array(c),l.set(d),this.blockLength<=9?this.tagNumber=ei(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return e+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}df.NAME="identificationBlock";class ff extends fs{constructor({lenBlock:t={}}={}){var e,r,s;super(),this.isIndefiniteForm=(e=t.isIndefiniteForm)!==null&&e!==void 0?e:!1,this.longFormUsed=(r=t.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=t.length)!==null&&s!==void 0?s:0}fromBER(t,e,r){const s=De.toUint8Array(t);if(!rn(this,s,e,r))return-1;const i=s.subarray(e,e+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,e+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,e+this.blockLength;const o=i[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const a=e+1,c=s.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=ei(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,e+this.blockLength}toBER(t=!1){let e,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=128),e;if(this.longFormUsed){const s=cs(this.length,8);if(s.byteLength>127)return this.error="Too big length",pr;if(e=new ArrayBuffer(s.byteLength+1),t)return e;const i=new Uint8Array(s);r=new Uint8Array(e),r[0]=s.byteLength|128;for(let o=0;o<s.byteLength;o++)r[o+1]=i[o];return e}return e=new ArrayBuffer(1),t===!1&&(r=new Uint8Array(e),r[0]=this.length),e}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}ff.NAME="lengthBlock";const q={};class vt extends fs{constructor({name:t=fi,optional:e=!1,primitiveSchema:r,...s}={},i){super(s),this.name=t,this.optional=e,r&&(this.primitiveSchema=r),this.idBlock=new df(s),this.lenBlock=new ff(s),this.valueBlock=i?new i(s):new Pt(s)}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(t,e){const r=e||new X1;e||gf(this);const s=this.idBlock.toBER(t);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(t,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(t);this.lenBlock.length=i.byteLength;const o=this.lenBlock.toBER(t);r.write(o),r.write(i)}return e?pr:r.final()}toJSON(){const t={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(t.primitiveSchema=this.primitiveSchema.toJSON()),t}toString(t="ascii"){return t==="ascii"?this.onAsciiEncoding():He.ToHex(this.toBER())}onAsciiEncoding(){return`${this.constructor.NAME} : ${He.ToHex(this.valueBlock.valueBeforeDecodeView)}`}isEqual(t){if(this===t)return!0;if(!(t instanceof this.constructor))return!1;const e=this.toBER(),r=t.toBER();return V9(e,r)}}vt.NAME="BaseBlock";function gf(n){if(n instanceof q.Constructed)for(const t of n.valueBlock.value)gf(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!n.lenBlock.isIndefiniteForm}class pf extends vt{constructor({value:t=fi,...e}={},r){super(e,r),t&&this.fromString(t)}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}fromBER(t,e,r){const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}pf.NAME="BaseStringBlock";class mf extends nn(Pt){constructor({isHexOnly:t=!0,...e}={}){super(e),this.isHexOnly=t}}mf.NAME="PrimitiveValueBlock";var yf;class wf extends vt{constructor(t={}){super(t,mf),this.idBlock.isConstructed=!1}}yf=wf;q.Primitive=yf;wf.NAME="PRIMITIVE";function $9(n,t){if(n instanceof t)return n;const e=new t;return e.idBlock=n.idBlock,e.lenBlock=n.lenBlock,e.warnings=n.warnings,e.valueBeforeDecodeView=n.valueBeforeDecodeView,e}function hc(n,t=0,e=n.length){const r=t;let s=new vt({},Pt);const i=new fs;if(!rn(i,n,t,e))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(t,t+e).length)return s.error="Zero buffer length",{offset:-1,result:s};let a=s.idBlock.fromBER(n,t,e);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),a===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(t=a,e-=s.idBlock.blockLength,a=s.lenBlock.fromBER(n,t,e),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),a===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(t=a,e-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let c=vt;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};c=q.EndOfContent;break;case 1:c=q.Boolean;break;case 2:c=q.Integer;break;case 3:c=q.BitString;break;case 4:c=q.OctetString;break;case 5:c=q.Null;break;case 6:c=q.ObjectIdentifier;break;case 10:c=q.Enumerated;break;case 12:c=q.Utf8String;break;case 13:c=q.RelativeObjectIdentifier;break;case 14:c=q.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:c=q.Sequence;break;case 17:c=q.Set;break;case 18:c=q.NumericString;break;case 19:c=q.PrintableString;break;case 20:c=q.TeletexString;break;case 21:c=q.VideotexString;break;case 22:c=q.IA5String;break;case 23:c=q.UTCTime;break;case 24:c=q.GeneralizedTime;break;case 25:c=q.GraphicString;break;case 26:c=q.VisibleString;break;case 27:c=q.GeneralString;break;case 28:c=q.UniversalString;break;case 29:c=q.CharacterString;break;case 30:c=q.BmpString;break;case 31:c=q.DATE;break;case 32:c=q.TimeOfDay;break;case 33:c=q.DateTime;break;case 34:c=q.Duration;break;default:{const l=s.idBlock.isConstructed?new q.Constructed:new q.Primitive;l.idBlock=s.idBlock,l.lenBlock=s.lenBlock,l.warnings=s.warnings,s=l}}break;case 2:case 3:case 4:default:c=s.idBlock.isConstructed?q.Constructed:q.Primitive}return s=$9(s,c),a=s.fromBER(n,t,s.lenBlock.isIndefiniteForm?e:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:a,result:s}}function bf(n){if(!n.byteLength){const t=new vt({},Pt);return t.error="Input buffer has zero length",{offset:-1,result:t}}return hc(De.toUint8Array(n).slice(),0,n.byteLength)}function K9(n,t){return n?1:t}class Tn extends Pt{constructor({value:t=[],isIndefiniteForm:e=!1,...r}={}){super(r),this.value=t,this.isIndefiniteForm=e}fromBER(t,e,r){const s=De.toUint8Array(t);if(!rn(this,s,e,r))return-1;if(this.valueBeforeDecodeView=s.subarray(e,e+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),e;let i=e;for(;K9(this.isIndefiniteForm,r)>0;){const o=hc(s,i,r);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(i=o.offset,this.blockLength+=o.result.blockLength,r-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===Xi)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===Xi?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(t,e){const r=e||new X1;for(let s=0;s<this.value.length;s++)this.value[s].toBER(t,r);return e?pr:r.final()}toJSON(){const t={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const e of this.value)t.value.push(e.toJSON());return t}}Tn.NAME="ConstructedValueBlock";var Ef;class gi extends vt{constructor(t={}){super(t,Tn),this.idBlock.isConstructed=!0}fromBER(t,e,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(t,e,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const t=[];for(const r of this.valueBlock.value)t.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const e=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return t.length?`${e} :
${t.join(`
`)}`:`${e} :`}}Ef=gi;q.Constructed=Ef;gi.NAME="CONSTRUCTED";class vf extends Pt{fromBER(t,e,r){return e}toBER(t){return pr}}vf.override="EndOfContentValueBlock";var _f;class Sf extends vt{constructor(t={}){super(t,vf),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}_f=Sf;q.EndOfContent=_f;Sf.NAME=Xi;var If;class Zi extends vt{constructor(t={}){super(t,Pt),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(t,e,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,e+r>t.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):e+r}toBER(t,e){const r=new ArrayBuffer(2);if(!t){const s=new Uint8Array(r);s[0]=5,s[1]=0}return e&&e.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}If=Zi;q.Null=If;Zi.NAME="NULL";class Rf extends nn(Pt){constructor({value:t,...e}={}){super(e),e.valueHex?this.valueHexView=De.toUint8Array(e.valueHex):this.valueHexView=new Uint8Array(1),t&&(this.value=t)}get value(){for(const t of this.valueHexView)if(t>0)return!0;return!1}set value(t){this.valueHexView[0]=t?255:0}fromBER(t,e,r){const s=De.toUint8Array(t);return rn(this,s,e,r)?(this.valueHexView=s.subarray(e,e+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,lf.call(this),this.blockLength=r,e+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}Rf.NAME="BooleanValueBlock";var Af;let Tf=class extends vt{constructor(t={}){super(t,Rf),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}getValue(){return this.valueBlock.value}setValue(t){this.valueBlock.value=t}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};Af=Tf;q.Boolean=Af;Tf.NAME="BOOLEAN";class Df extends nn(Tn){constructor({isConstructed:t=!1,...e}={}){super(e),this.isConstructed=t}fromBER(t,e,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=Tn.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const o=this.value[i].constructor.NAME;if(o===Xi){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==uf)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(t,e,r),this.blockLength=r;return s}toBER(t,e){return this.isConstructed?Tn.prototype.toBER.call(this,t,e):t?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}Df.NAME="OctetStringValueBlock";var xf;class Rn extends vt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},Df),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(t,e,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),e;if(!this.valueBlock.isConstructed){const i=(t instanceof ArrayBuffer?new Uint8Array(t):t).subarray(e,e+r);try{if(i.byteLength){const o=hc(i,0,i.byteLength);o.offset!==-1&&o.offset===r&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(t,e,r)}onAsciiEncoding(){return this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length?gi.prototype.onAsciiEncoding.call(this):`${this.constructor.NAME} : ${He.ToHex(this.valueBlock.valueHexView)}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const t=[];for(const e of this.valueBlock.value)e instanceof Rn&&t.push(e.valueBlock.valueHexView);return De.concat(t)}}xf=Rn;q.OctetString=xf;Rn.NAME=uf;class Cf extends nn(Tn){constructor({unusedBits:t=0,isConstructed:e=!1,...r}={}){super(r),this.unusedBits=t,this.isConstructed=e,this.blockLength=this.valueHexView.byteLength}fromBER(t,e,r){if(!r)return e;let s=-1;if(this.isConstructed){if(s=Tn.prototype.fromBER.call(this,t,e,r),s===-1)return s;for(const a of this.value){const c=a.constructor.NAME;if(c===Xi){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==hf)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return s}const i=De.toUint8Array(t);if(!rn(this,i,e,r))return-1;const o=i.subarray(e,e+r);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=hc(a,0,a.byteLength);c.offset!==-1&&c.offset===r-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,e+r}toBER(t,e){if(this.isConstructed)return Tn.prototype.toBER.call(this,t,e);if(t)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return pr;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}Cf.NAME="BitStringValueBlock";var Pf;class J1 extends vt{constructor({idBlock:t={},lenBlock:e={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...t},lenBlock:{...e,isIndefiniteForm:!!r.isIndefiniteForm},...r},Cf),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(t,e,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(t,e,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return gi.prototype.onAsciiEncoding.call(this);{const t=[],e=this.valueBlock.valueHexView;for(const s of e)t.push(s.toString(2).padStart(8,"0"));const r=t.join("");return`${this.constructor.NAME} : ${r.substring(0,r.length-this.valueBlock.unusedBits)}`}}}Pf=J1;q.BitString=Pf;J1.NAME=hf;var kf;function H9(n,t){const e=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(t);let i=r.slice(0);const o=i.length-1,a=s.slice(0),c=a.length-1;let l=0;const u=c<o?o:c;let d=0;for(let f=u;f>=0;f--,d++){switch(!0){case d<a.length:l=i[o-d]+a[c-d]+e[0];break;default:l=i[o-d]+e[0]}switch(e[0]=l/10,!0){case d>=i.length:i=Dl(new Uint8Array([l%10]),i);break;default:i[o-d]=l%10}}return e[0]>0&&(i=Dl(e,i)),i}function vh(n){if(n>=Ai.length)for(let t=Ai.length;t<=n;t++){const e=new Uint8Array([0]);let r=Ai[t-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+e[0]]);e[0]=i[0]/10,r[s]=i[0]%10}e[0]>0&&(r=Dl(e,r)),Ai.push(r)}return Ai[n]}function z9(n,t){let e=0;const r=new Uint8Array(n),s=new Uint8Array(t),i=r.slice(0),o=i.length-1,a=s.slice(0),c=a.length-1;let l,u=0;for(let d=c;d>=0;d--,u++)switch(l=i[o-u]-a[c-u]-e,!0){case l<0:e=1,i[o-u]=l+10;break;default:e=0,i[o-u]=l}if(e>0)for(let d=o-c+1;d>=0;d--,u++)if(l=i[o-u]-e,l<0)e=1,i[o-u]=l+10;else{e=0,i[o-u]=l;break}return i.slice()}class j1 extends nn(Pt){constructor({value:t,...e}={}){super(e),this._valueDec=0,e.valueHex&&this.setValueHex(),t!==void 0&&(this.valueDec=t)}setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=lf.call(this)))}set valueDec(t){this._valueDec=t,this.isHexOnly=!1,this.valueHexView=new Uint8Array(F9(t))}get valueDec(){return this._valueDec}fromDER(t,e,r,s=0){const i=this.fromBER(t,e,r);if(i===-1)return i;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):s!==0&&o.length<s&&(s-o.length>1&&(s=o.length+1),this.valueHexView=o.subarray(s-o.length)),i}toDER(t=!1){const e=this.valueHexView;switch(!0){case(e[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(e,1),this.valueHexView=r}break;case(e[0]===0&&(e[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(t)}fromBER(t,e,r){const s=super.fromBER(t,e,r);return s===-1||this.setValueHex(),s}toBER(t){return t?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const t=this.valueHexView.length*8-1;let e=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let o="",a=!1;for(let c=i.byteLength-1;c>=0;c--){s=i[c];for(let l=0;l<8;l++){if((s&1)===1)switch(r){case t:e=z9(vh(r),e),o="-";break;default:e=H9(e,vh(r))}r++,s>>=1}}for(let c=0;c<e.length;c++)e[c]&&(a=!0),a&&(o+=Eh.charAt(e[c]));return a===!1&&(o+=Eh.charAt(0)),o}}kf=j1;j1.NAME="IntegerValueBlock";Object.defineProperty(kf.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var Nf;class Ge extends vt{constructor(t={}){super(t,j1),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Aa(),BigInt(this.valueBlock.toString())}static fromBigInt(t){Aa();const e=BigInt(t),r=new X1,s=e.toString(16).replace(/^-/,""),i=new Uint8Array(He.FromHex(s));if(e<0){const a=new Uint8Array(i.length+(i[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${He.ToHex(a)}`)+e,u=De.toUint8Array(He.FromHex(l.toString(16)));u[0]|=128,r.write(u)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new Ge({valueHex:r.final()})}convertToDER(){const t=new Ge({valueHex:this.valueBlock.valueHexView});return t.valueBlock.toDER(),t}convertFromDER(){return new Ge({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}Nf=Ge;q.Integer=Nf;Ge.NAME="INTEGER";var Mf;class Of extends Ge{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}Mf=Of;q.Enumerated=Mf;Of.NAME="ENUMERATED";class xl extends nn(Pt){constructor({valueDec:t=-1,isFirstSid:e=!1,...r}={}){super(r),this.valueDec=t,this.isFirstSid=e}fromBER(t,e,r){if(!r)return e;const s=De.toUint8Array(t);if(!rn(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=ei(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}set valueBigInt(t){Aa();let e=BigInt(t).toString(2);for(;e.length%7;)e="0"+e;const r=new Uint8Array(e.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(e.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=cs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",pr;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r}toString(){let t="";if(this.isHexOnly)t=He.ToHex(this.valueHexView);else if(this.isFirstSid){let e=this.valueDec;this.valueDec<=39?t="0.":this.valueDec<=79?(t="1.",e-=40):(t="2.",e-=80),t+=e.toString()}else t=this.valueDec.toString();return t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}xl.NAME="sidBlock";class Lf extends Pt{constructor({value:t=fi,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new xl;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t){const e=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(t);if(s.byteLength===0)return this.error=this.value[r].error,pr;e.push(s)}return Q1(e)}fromString(t){this.value=[];let e=0,r=0,s="",i=!1;do if(r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1,i){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(s,10);if(isNaN(c))return;o.valueDec=c+a,i=!1}else{const o=new xl;if(s>Number.MAX_SAFE_INTEGER){Aa();const a=BigInt(s);o.valueBigInt=a}else if(o.valueDec=parseInt(s,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,i=!0),this.value.push(o)}while(r!==-1)}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e?(s=`{${s}}`,this.value[r].isFirstSid?t=`2.{${s} - 80}`:t+=s):t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}Lf.NAME="ObjectIdentifierValueBlock";var Bf;class gn extends vt{constructor(t={}){super(t,Lf),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Bf=gn;q.ObjectIdentifier=Bf;gn.NAME="OBJECT IDENTIFIER";class Cl extends nn(fs){constructor({valueDec:t=0,...e}={}){super(e),this.valueDec=t}fromBER(t,e,r){if(r===0)return e;const s=De.toUint8Array(t);if(!rn(this,s,e,r))return-1;const i=s.subarray(e,e+r);this.valueHexView=new Uint8Array(r);for(let a=0;a<r&&(this.valueHexView[a]=i[a]&127,this.blockLength++,!!(i[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,i[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=ei(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),e+this.blockLength)}toBER(t){if(this.isHexOnly){if(t)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)i[o]=s[o]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const e=cs(this.valueDec,7);if(e.byteLength===0)return this.error="Error during encoding SID value",pr;const r=new Uint8Array(e.byteLength);if(!t){const s=new Uint8Array(e),i=e.byteLength-1;for(let o=0;o<i;o++)r[o]=s[o]|128;r[i]=s[i]}return r.buffer}toString(){let t="";return this.isHexOnly?t=He.ToHex(this.valueHexView):t=this.valueDec.toString(),t}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Cl.NAME="relativeSidBlock";class Uf extends Pt{constructor({value:t=fi,...e}={}){super(e),this.value=[],t&&this.fromString(t)}fromBER(t,e,r){let s=e;for(;r>0;){const i=new Cl;if(s=i.fromBER(t,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(t,e){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(t);if(i.byteLength===0)return this.error=this.value[s].error,pr;r.push(i)}return Q1(r)}fromString(t){this.value=[];let e=0,r=0,s="";do{r=t.indexOf(".",e),r===-1?s=t.substring(e):s=t.substring(e,r),e=r+1;const i=new Cl;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let t="",e=!1;for(let r=0;r<this.value.length;r++){e=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(t=`${t}.`),e&&(s=`{${s}}`),t+=s}return t}toJSON(){const t={...super.toJSON(),value:this.toString(),sidArray:[]};for(let e=0;e<this.value.length;e++)t.sidArray.push(this.value[e].toJSON());return t}}Uf.NAME="RelativeObjectIdentifierValueBlock";var Ff;class Vf extends vt{constructor(t={}){super(t,Uf),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}getValue(){return this.valueBlock.toString()}setValue(t){this.valueBlock.fromString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}Ff=Vf;q.RelativeObjectIdentifier=Ff;Vf.NAME="RelativeObjectIdentifier";var $f;class wt extends gi{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}$f=wt;q.Sequence=$f;wt.NAME="SEQUENCE";var Kf;let Hf=class extends gi{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};Kf=Hf;q.Set=Kf;Hf.NAME="SET";class zf extends nn(Pt){constructor({...t}={}){super(t),this.isHexOnly=!0,this.value=fi}toJSON(){return{...super.toJSON(),value:this.value}}}zf.NAME="StringValueBlock";class Wf extends zf{}Wf.NAME="SimpleStringValueBlock";class $t extends pf{constructor({...t}={}){super(t,Wf)}fromBuffer(t){this.valueBlock.value=String.fromCharCode.apply(null,De.toUint8Array(t))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e);for(let s=0;s<e;s++)r[s]=t.charCodeAt(s);this.valueBlock.value=t}}$t.NAME="SIMPLE STRING";class qf extends $t{fromBuffer(t){this.valueBlock.valueHexView=De.toUint8Array(t);try{this.valueBlock.value=He.ToUtf8String(t)}catch(e){this.warnings.push(`Error during "decodeURIComponent": ${e}, using raw string`),this.valueBlock.value=He.ToBinary(t)}}fromString(t){this.valueBlock.valueHexView=new Uint8Array(He.FromUtf8String(t)),this.valueBlock.value=t}}qf.NAME="Utf8StringValueBlock";var Gf;class gs extends qf{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}Gf=gs;q.Utf8String=Gf;gs.NAME="UTF8String";class Yf extends $t{fromBuffer(t){this.valueBlock.value=He.ToUtf16String(t),this.valueBlock.valueHexView=De.toUint8Array(t)}fromString(t){this.valueBlock.value=t,this.valueBlock.valueHexView=new Uint8Array(He.FromUtf16String(t))}}Yf.NAME="BmpStringValueBlock";var Qf;class Xf extends Yf{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}Qf=Xf;q.BmpString=Qf;Xf.NAME="BMPString";class Zf extends $t{fromBuffer(t){const e=ArrayBuffer.isView(t)?t.slice().buffer:t.slice(0),r=new Uint8Array(e);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(e))}fromString(t){const e=t.length,r=this.valueBlock.valueHexView=new Uint8Array(e*4);for(let s=0;s<e;s++){const i=cs(t.charCodeAt(s),8),o=new Uint8Array(i);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)r[s*4+c+a]=o[c]}this.valueBlock.value=t}}Zf.NAME="UniversalStringValueBlock";var Jf;class jf extends Zf{constructor({...t}={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}Jf=jf;q.UniversalString=Jf;jf.NAME="UniversalString";var e3;class t3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}e3=t3;q.NumericString=e3;t3.NAME="NumericString";var r3;class n3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}r3=n3;q.PrintableString=r3;n3.NAME="PrintableString";var s3;class i3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}s3=i3;q.TeletexString=s3;i3.NAME="TeletexString";var o3;class a3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}o3=a3;q.VideotexString=o3;a3.NAME="VideotexString";var c3;class l3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}c3=l3;q.IA5String=c3;l3.NAME="IA5String";var u3;class h3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}u3=h3;q.GraphicString=u3;h3.NAME="GraphicString";var d3;class eu extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}d3=eu;q.VisibleString=d3;eu.NAME="VisibleString";var f3;class g3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}f3=g3;q.GeneralString=f3;g3.NAME="GeneralString";var p3;class m3 extends $t{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}p3=m3;q.CharacterString=p3;m3.NAME="CharacterString";var y3;class tu extends eu{constructor({value:t,valueDate:e,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,t){this.fromString(t),this.valueBlock.valueHexView=new Uint8Array(t.length);for(let s=0;s<t.length;s++)this.valueBlock.valueHexView[s]=t.charCodeAt(s)}e&&(this.fromDate(e),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(t){this.fromString(String.fromCharCode.apply(null,De.toUint8Array(t)))}toBuffer(){const t=this.toString(),e=new ArrayBuffer(t.length),r=new Uint8Array(e);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return e}fromDate(t){this.year=t.getUTCFullYear(),this.month=t.getUTCMonth()+1,this.day=t.getUTCDate(),this.hour=t.getUTCHours(),this.minute=t.getUTCMinutes(),this.second=t.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(t){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(t);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(t="iso"){if(t==="iso"){const e=new Array(7);return e[0]=Ut(this.year<2e3?this.year-1900:this.year-2e3,2),e[1]=Ut(this.month,2),e[2]=Ut(this.day,2),e[3]=Ut(this.hour,2),e[4]=Ut(this.minute,2),e[5]=Ut(this.second,2),e[6]="Z",e.join("")}return super.toString(t)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}y3=tu;q.UTCTime=y3;tu.NAME="UTCTime";var w3;class b3 extends tu{constructor(t={}){var e;super(t),(e=this.millisecond)!==null&&e!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(t){super.fromDate(t),this.millisecond=t.getUTCMilliseconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond))}fromString(t){let e=!1,r="",s="",i=0,o,a=0,c=0;if(t[t.length-1]==="Z")r=t.substring(0,t.length-1),e=!0;else{const d=new Number(t[t.length-1]);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");r=t}if(e){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let d=1,f=r.indexOf("+"),p="";if(f===-1&&(f=r.indexOf("-"),d=-1),f!==-1){if(p=r.substring(f+1),r=r.substring(0,f),p.length!==2&&p.length!==4)throw new Error("Wrong input string for conversion");let y=parseInt(p.substring(0,2),10);if(isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");if(a=d*y,p.length===4){if(y=parseInt(p.substring(2,4),10),isNaN(y.valueOf()))throw new Error("Wrong input string for conversion");c=d*y}}}let l=r.indexOf(".");if(l===-1&&(l=r.indexOf(",")),l!==-1){const d=new Number(`0${r.substring(l)}`);if(isNaN(d.valueOf()))throw new Error("Wrong input string for conversion");i=d.valueOf(),s=r.substring(0,l)}else s=r;switch(!0){case s.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*i;this.minute=Math.floor(d),d=60*(d-this.minute),this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let d=60*i;this.second=Math.floor(d),d=1e3*(d-this.second),this.millisecond=Math.floor(d)}break;case s.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const d=1e3*i;this.millisecond=Math.floor(d)}break;default:throw new Error("Wrong input string for conversion")}const u=o.exec(s);if(u===null)throw new Error("Wrong input string for conversion");for(let d=1;d<u.length;d++)switch(d){case 1:this.year=parseInt(u[d],10);break;case 2:this.month=parseInt(u[d],10);break;case 3:this.day=parseInt(u[d],10);break;case 4:this.hour=parseInt(u[d],10)+a;break;case 5:this.minute=parseInt(u[d],10)+c;break;case 6:this.second=parseInt(u[d],10);break;default:throw new Error("Wrong input string for conversion")}if(e===!1){const d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=d.getUTCFullYear(),this.month=d.getUTCMonth(),this.day=d.getUTCDay(),this.hour=d.getUTCHours(),this.minute=d.getUTCMinutes(),this.second=d.getUTCSeconds(),this.millisecond=d.getUTCMilliseconds()}}toString(t="iso"){if(t==="iso"){const e=[];return e.push(Ut(this.year,4)),e.push(Ut(this.month,2)),e.push(Ut(this.day,2)),e.push(Ut(this.hour,2)),e.push(Ut(this.minute,2)),e.push(Ut(this.second,2)),this.millisecond!==0&&(e.push("."),e.push(Ut(this.millisecond,3))),e.push("Z"),e.join("")}return super.toString(t)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}w3=b3;q.GeneralizedTime=w3;b3.NAME="GeneralizedTime";var E3;class v3 extends gs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}E3=v3;q.DATE=E3;v3.NAME="DATE";var _3;class S3 extends gs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}_3=S3;q.TimeOfDay=_3;S3.NAME="TimeOfDay";var I3;class R3 extends gs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}I3=R3;q.DateTime=I3;R3.NAME="DateTime";var A3;class T3 extends gs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}A3=T3;q.Duration=A3;T3.NAME="Duration";var D3;class x3 extends gs{constructor(t={}){super(t),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}D3=x3;q.TIME=D3;x3.NAME="TIME";function W9(n){const{result:t}=bf(n),e=t.valueBlock.value;return{n:X(wr(e[1].toBigInt()),"base64url"),e:X(wr(e[2].toBigInt()),"base64url"),d:X(wr(e[3].toBigInt()),"base64url"),p:X(wr(e[4].toBigInt()),"base64url"),q:X(wr(e[5].toBigInt()),"base64url"),dp:X(wr(e[6].toBigInt()),"base64url"),dq:X(wr(e[7].toBigInt()),"base64url"),qi:X(wr(e[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function q9(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new v("JWK was missing components","ERR_INVALID_PARAMETERS");const e=new wt({value:[new Ge({value:0}),Ge.fromBigInt(br(Y(n.n,"base64url"))),Ge.fromBigInt(br(Y(n.e,"base64url"))),Ge.fromBigInt(br(Y(n.d,"base64url"))),Ge.fromBigInt(br(Y(n.p,"base64url"))),Ge.fromBigInt(br(Y(n.q,"base64url"))),Ge.fromBigInt(br(Y(n.dp,"base64url"))),Ge.fromBigInt(br(Y(n.dq,"base64url"))),Ge.fromBigInt(br(Y(n.qi,"base64url")))]}).toBER();return new Uint8Array(e,0,e.byteLength)}function G9(n){const{result:t}=bf(n),e=t.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:X(wr(e[0].toBigInt()),"base64url"),e:X(wr(e[1].toBigInt()),"base64url")}}function Y9(n){if(n.n==null||n.e==null)throw new v("JWK was missing components","ERR_INVALID_PARAMETERS");const e=new wt({value:[new wt({value:[new gn({value:"1.2.840.113549.1.1.1"}),new Zi]}),new J1({valueHex:new wt({value:[Ge.fromBigInt(br(Y(n.n,"base64url"))),Ge.fromBigInt(br(Y(n.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(e,0,e.byteLength)}function wr(n){let t=n.toString(16);t.length%2>0&&(t=`0${t}`);const e=t.length/2,r=new Uint8Array(e);let s=0,i=0;for(;s<e;)r[s]=parseInt(t.slice(i,i+2),16),s+=1,i+=2;return r}function br(n){const t=[];return n.forEach(function(e){let r=e.toString(16);r.length%2>0&&(r=`0${r}`),t.push(r)}),BigInt("0x"+t.join(""))}const Q9=16,_h=32,Sh=1e4;async function X9(n,t){const e=gr.get(),s=new wt({value:[new Ge({value:0}),new wt({value:[new gn({value:"1.2.840.113549.1.1.1"}),new Zi]}),new Rn({valueHex:n.marshal()})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),o=as(Q9),a=await M9($1,t,o,{c:Sh,dkLen:_h}),c=as(16),l=await e.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),u=await e.subtle.encrypt({name:"AES-CBC",iv:c},l,i),d=new wt({value:[new Rn({valueHex:o}),new Ge({value:Sh}),new Ge({value:_h}),new wt({value:[new gn({value:"1.2.840.113549.2.11"}),new Zi]})]}),f=new wt({value:[new gn({value:"1.2.840.113549.1.5.13"}),new wt({value:[new wt({value:[new gn({value:"1.2.840.113549.1.5.12"}),d]}),new wt({value:[new gn({value:"2.16.840.1.101.3.4.1.42"}),new Rn({valueHex:c})]})]})]}),y=new wt({value:[f,new Rn({valueHex:u})]}).toBER(),g=new Uint8Array(y,0,y.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...X(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function Z9(n){const t=await gr.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),e=await P3(t);return{privateKey:e[0],publicKey:e[1]}}async function C3(n){const e=[await gr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await ep(n)],r=await P3({privateKey:e[0],publicKey:e[1]});return{privateKey:r[0],publicKey:r[1]}}async function J9(n,t){const e=await gr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await gr.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},e,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}async function j9(n,t,e){const r=await gr.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return gr.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,e instanceof Uint8Array?e:e.subarray())}async function P3(n){if(n.privateKey==null||n.publicKey==null)throw new v("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([gr.get().subtle.exportKey("jwk",n.privateKey),gr.get().subtle.exportKey("jwk",n.publicKey)])}async function ep(n){return gr.get().subtle.importKey("jwk",{kty:n.kty,n:n.n,e:n.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function ru(n){if(n.kty!=="RSA")throw new v("invalid key type","ERR_INVALID_KEY_TYPE");if(n.n==null)throw new v("invalid key modulus","ERR_INVALID_KEY_MODULUS");return Y(n.n,"base64url").length*8}const So=8192;class nu{constructor(t){h(this,"_key");this._key=t}verify(t,e){return j9(this._key,e,t)}marshal(){return Y9(this._key)}get bytes(){return Zs.encode({Type:Qe.RSA,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}hash(){const t=mt.digest(this.bytes);return Un(t)?t.then(({bytes:e})=>e):t.bytes}}class dc{constructor(t,e){h(this,"_key");h(this,"_publicKey");this._key=t,this._publicKey=e}genSecret(){return as(16)}sign(t){return J9(this._key,t)}get public(){if(this._publicKey==null)throw new v("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new nu(this._publicKey)}marshal(){return q9(this._key)}get bytes(){return Js.encode({Type:Qe.RSA,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}hash(){const t=mt.digest(this.bytes);return Un(t)?t.then(({bytes:e})=>e):t.bytes}async id(){const t=await this.public.hash();return X(t,"base58btc")}async export(t,e="pkcs-8"){if(e==="pkcs-8")return X9(this,t);if(e==="libp2p-key")return G1(this.bytes,t);throw new v(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function tp(n){const t=W9(n);if(ru(t)>So)throw new v("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await C3(t);return new dc(e.privateKey,e.publicKey)}function rp(n){const t=G9(n);if(ru(t)>So)throw new v("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new nu(t)}async function np(n){if(ru(n)>So)throw new v("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await C3(n);return new dc(t.privateKey,t.publicKey)}async function sp(n){if(n>So)throw new v("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await Z9(n);return new dc(t.privateKey,t.publicKey)}const ip=Object.freeze(Object.defineProperty({__proto__:null,MAX_RSA_KEY_SIZE:So,RsaPrivateKey:dc,RsaPublicKey:nu,fromJwk:np,generateKeyPair:sp,unmarshalRsaPrivateKey:tp,unmarshalRsaPublicKey:rp},Symbol.toStringTag,{value:"Module"})),op=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),cn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ln=new Uint32Array(64);class ap extends q2{constructor(){super(64,32,8,!1),this.A=cn[0]|0,this.B=cn[1]|0,this.C=cn[2]|0,this.D=cn[3]|0,this.E=cn[4]|0,this.F=cn[5]|0,this.G=cn[6]|0,this.H=cn[7]|0}get(){const{A:t,B:e,C:r,D:s,E:i,F:o,G:a,H:c}=this;return[t,e,r,s,i,o,a,c]}set(t,e,r,s,i,o,a,c){this.A=t|0,this.B=e|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(t,e){for(let d=0;d<16;d++,e+=4)ln[d]=t.getUint32(e,!1);for(let d=16;d<64;d++){const f=ln[d-15],p=ln[d-2],y=mr(f,7)^mr(f,18)^f>>>3,g=mr(p,17)^mr(p,19)^p>>>10;ln[d]=g+ln[d-7]+y+ln[d-16]|0}let{A:r,B:s,C:i,D:o,E:a,F:c,G:l,H:u}=this;for(let d=0;d<64;d++){const f=mr(a,6)^mr(a,11)^mr(a,25),p=u+f+wg(a,c,l)+op[d]+ln[d]|0,g=(mr(r,2)^mr(r,13)^mr(r,22))+bg(r,s,i)|0;u=l,l=c,c=a,a=o+p|0,o=i,i=s,s=r,r=p+g|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(r,s,i,o,a,c,l,u)}roundClean(){ln.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const na=W2(()=>new ap);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function cp(n){const t=z1(n);ds(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:e,Fp:r,a:s}=t;if(e){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof e!="object"||typeof e.beta!="bigint"||typeof e.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:lp,hexToBytes:up}=jg,Yn={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(n){const{Err:t}=Yn;if(n.length<2||n[0]!==2)throw new t("Invalid signature integer tag");const e=n[1],r=n.subarray(2,e+2);if(!e||r.length!==e)throw new t("Invalid signature integer: wrong length");if(r[0]&128)throw new t("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return{d:lp(r),l:n.subarray(e+2)}},toSig(n){const{Err:t}=Yn,e=typeof n=="string"?up(n):n;vo(e);let r=e.length;if(r<2||e[0]!=48)throw new t("Invalid signature tag");if(e[1]!==r-2)throw new t("Invalid signature: incorrect length");const{d:s,l:i}=Yn._parseInt(e.subarray(2)),{d:o,l:a}=Yn._parseInt(i);if(a.length)throw new t("Invalid signature: left bytes after parsing");return{r:s,s:o}},hexFromSig(n){const t=l=>Number.parseInt(l[0],16)&8?"00"+l:l,e=l=>{const u=l.toString(16);return u.length&1?`0${u}`:u},r=t(e(n.s)),s=t(e(n.r)),i=r.length/2,o=s.length/2,a=e(i),c=e(o);return`30${e(o+i+4)}02${c}${s}02${a}${r}`}},qr=BigInt(0),qt=BigInt(1);BigInt(2);const Ih=BigInt(3);BigInt(4);function hp(n){const t=cp(n),{Fp:e}=t,r=t.toBytes||((y,g,m)=>{const w=g.toAffine();return os(Uint8Array.from([4]),e.toBytes(w.x),e.toBytes(w.y))}),s=t.fromBytes||(y=>{const g=y.subarray(1),m=e.fromBytes(g.subarray(0,e.BYTES)),w=e.fromBytes(g.subarray(e.BYTES,2*e.BYTES));return{x:m,y:w}});function i(y){const{a:g,b:m}=t,w=e.sqr(y),_=e.mul(w,y);return e.add(e.add(_,e.mul(y,g)),m)}if(!e.eql(e.sqr(t.Gy),i(t.Gx)))throw new Error("bad generator point: equation left != right");function o(y){return typeof y=="bigint"&&qr<y&&y<t.n}function a(y){if(!o(y))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(y){const{allowedPrivateKeyLengths:g,nByteLength:m,wrapPrivateKey:w,n:_}=t;if(g&&typeof y!="bigint"){if(ss(y)&&(y=is(y)),typeof y!="string"||!g.includes(y.length))throw new Error("Invalid key");y=y.padStart(m*2,"0")}let b;try{b=typeof y=="bigint"?y:jn(Ye("private key",y,m))}catch{throw new Error(`private key must be ${m} bytes, hex or bigint, not ${typeof y}`)}return w&&(b=xe(b,_)),a(b),b}const l=new Map;function u(y){if(!(y instanceof d))throw new Error("ProjectivePoint expected")}class d{constructor(g,m,w){if(this.px=g,this.py=m,this.pz=w,g==null||!e.isValid(g))throw new Error("x required");if(m==null||!e.isValid(m))throw new Error("y required");if(w==null||!e.isValid(w))throw new Error("z required")}static fromAffine(g){const{x:m,y:w}=g||{};if(!g||!e.isValid(m)||!e.isValid(w))throw new Error("invalid affine point");if(g instanceof d)throw new Error("projective point not allowed");const _=b=>e.eql(b,e.ZERO);return _(m)&&_(w)?d.ZERO:new d(m,w,e.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(g){const m=e.invertBatch(g.map(w=>w.pz));return g.map((w,_)=>w.toAffine(m[_])).map(d.fromAffine)}static fromHex(g){const m=d.fromAffine(s(Ye("pointHex",g)));return m.assertValidity(),m}static fromPrivateKey(g){return d.BASE.multiply(c(g))}_setWindowSize(g){this._WINDOW_SIZE=g,l.delete(this)}assertValidity(){if(this.is0()){if(t.allowInfinityPoint&&!e.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:g,y:m}=this.toAffine();if(!e.isValid(g)||!e.isValid(m))throw new Error("bad point: x or y not FE");const w=e.sqr(m),_=i(g);if(!e.eql(w,_))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:g}=this.toAffine();if(e.isOdd)return!e.isOdd(g);throw new Error("Field doesn't support isOdd")}equals(g){u(g);const{px:m,py:w,pz:_}=this,{px:b,py:S,pz:I}=g,A=e.eql(e.mul(m,I),e.mul(b,_)),P=e.eql(e.mul(w,I),e.mul(S,_));return A&&P}negate(){return new d(this.px,e.neg(this.py),this.pz)}double(){const{a:g,b:m}=t,w=e.mul(m,Ih),{px:_,py:b,pz:S}=this;let I=e.ZERO,A=e.ZERO,P=e.ZERO,T=e.mul(_,_),R=e.mul(b,b),C=e.mul(S,S),k=e.mul(_,b);return k=e.add(k,k),P=e.mul(_,S),P=e.add(P,P),I=e.mul(g,P),A=e.mul(w,C),A=e.add(I,A),I=e.sub(R,A),A=e.add(R,A),A=e.mul(I,A),I=e.mul(k,I),P=e.mul(w,P),C=e.mul(g,C),k=e.sub(T,C),k=e.mul(g,k),k=e.add(k,P),P=e.add(T,T),T=e.add(P,T),T=e.add(T,C),T=e.mul(T,k),A=e.add(A,T),C=e.mul(b,S),C=e.add(C,C),T=e.mul(C,k),I=e.sub(I,T),P=e.mul(C,R),P=e.add(P,P),P=e.add(P,P),new d(I,A,P)}add(g){u(g);const{px:m,py:w,pz:_}=this,{px:b,py:S,pz:I}=g;let A=e.ZERO,P=e.ZERO,T=e.ZERO;const R=t.a,C=e.mul(t.b,Ih);let k=e.mul(m,b),B=e.mul(w,S),L=e.mul(_,I),z=e.add(m,w),x=e.add(b,S);z=e.mul(z,x),x=e.add(k,B),z=e.sub(z,x),x=e.add(m,_);let N=e.add(b,I);return x=e.mul(x,N),N=e.add(k,L),x=e.sub(x,N),N=e.add(w,_),A=e.add(S,I),N=e.mul(N,A),A=e.add(B,L),N=e.sub(N,A),T=e.mul(R,x),A=e.mul(C,L),T=e.add(A,T),A=e.sub(B,T),T=e.add(B,T),P=e.mul(A,T),B=e.add(k,k),B=e.add(B,k),L=e.mul(R,L),x=e.mul(C,x),B=e.add(B,L),L=e.sub(k,L),L=e.mul(R,L),x=e.add(x,L),k=e.mul(B,x),P=e.add(P,k),k=e.mul(N,x),A=e.mul(z,A),A=e.sub(A,k),k=e.mul(z,B),T=e.mul(N,T),T=e.add(T,k),new d(A,P,T)}subtract(g){return this.add(g.negate())}is0(){return this.equals(d.ZERO)}wNAF(g){return p.wNAFCached(this,l,g,m=>{const w=e.invertBatch(m.map(_=>_.pz));return m.map((_,b)=>_.toAffine(w[b])).map(d.fromAffine)})}multiplyUnsafe(g){const m=d.ZERO;if(g===qr)return m;if(a(g),g===qt)return this;const{endo:w}=t;if(!w)return p.unsafeLadder(this,g);let{k1neg:_,k1:b,k2neg:S,k2:I}=w.splitScalar(g),A=m,P=m,T=this;for(;b>qr||I>qr;)b&qt&&(A=A.add(T)),I&qt&&(P=P.add(T)),T=T.double(),b>>=qt,I>>=qt;return _&&(A=A.negate()),S&&(P=P.negate()),P=new d(e.mul(P.px,w.beta),P.py,P.pz),A.add(P)}multiply(g){a(g);let m=g,w,_;const{endo:b}=t;if(b){const{k1neg:S,k1:I,k2neg:A,k2:P}=b.splitScalar(m);let{p:T,f:R}=this.wNAF(I),{p:C,f:k}=this.wNAF(P);T=p.constTimeNegate(S,T),C=p.constTimeNegate(A,C),C=new d(e.mul(C.px,b.beta),C.py,C.pz),w=T.add(C),_=R.add(k)}else{const{p:S,f:I}=this.wNAF(m);w=S,_=I}return d.normalizeZ([w,_])[0]}multiplyAndAddUnsafe(g,m,w){const _=d.BASE,b=(I,A)=>A===qr||A===qt||!I.equals(_)?I.multiplyUnsafe(A):I.multiply(A),S=b(this,m).add(b(g,w));return S.is0()?void 0:S}toAffine(g){const{px:m,py:w,pz:_}=this,b=this.is0();g==null&&(g=b?e.ONE:e.inv(_));const S=e.mul(m,g),I=e.mul(w,g),A=e.mul(_,g);if(b)return{x:e.ZERO,y:e.ZERO};if(!e.eql(A,e.ONE))throw new Error("invZ was invalid");return{x:S,y:I}}isTorsionFree(){const{h:g,isTorsionFree:m}=t;if(g===qt)return!0;if(m)return m(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:g,clearCofactor:m}=t;return g===qt?this:m?m(d,this):this.multiplyUnsafe(t.h)}toRawBytes(g=!0){return this.assertValidity(),r(d,this,g)}toHex(g=!0){return is(this.toRawBytes(g))}}d.BASE=new d(t.Gx,t.Gy,e.ONE),d.ZERO=new d(e.ZERO,e.ONE,e.ZERO);const f=t.nBitLength,p=rf(d,t.endo?Math.ceil(f/2):f);return{CURVE:t,ProjectivePoint:d,normPrivateKeyToScalar:c,weierstrassEquation:i,isWithinCurveOrder:o}}function dp(n){const t=z1(n);return ds(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function fp(n){const t=dp(n),{Fp:e,n:r}=t,s=e.BYTES+1,i=2*e.BYTES+1;function o(x){return qr<x&&x<e.ORDER}function a(x){return xe(x,r)}function c(x){return Rl(x,r)}const{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:d,isWithinCurveOrder:f}=hp({...t,toBytes(x,N,$){const M=N.toAffine(),D=e.toBytes(M.x),V=os;return $?V(Uint8Array.from([N.hasEvenY()?2:3]),D):V(Uint8Array.from([4]),D,e.toBytes(M.y))},fromBytes(x){const N=x.length,$=x[0],M=x.subarray(1);if(N===s&&($===2||$===3)){const D=jn(M);if(!o(D))throw new Error("Point is not on curve");const V=d(D);let K;try{K=e.sqrt(V)}catch(re){const ie=re instanceof Error?": "+re.message:"";throw new Error("Point is not on curve"+ie)}const W=(K&qt)===qt;return($&1)===1!==W&&(K=e.neg(K)),{x:D,y:K}}else if(N===i&&$===4){const D=e.fromBytes(M.subarray(0,e.BYTES)),V=e.fromBytes(M.subarray(e.BYTES,2*e.BYTES));return{x:D,y:V}}else throw new Error(`Point of length ${N} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),p=x=>is(Qs(x,t.nByteLength));function y(x){const N=r>>qt;return x>N}function g(x){return y(x)?a(-x):x}const m=(x,N,$)=>jn(x.slice(N,$));class w{constructor(N,$,M){this.r=N,this.s=$,this.recovery=M,this.assertValidity()}static fromCompact(N){const $=t.nByteLength;return N=Ye("compactSignature",N,$*2),new w(m(N,0,$),m(N,$,2*$))}static fromDER(N){const{r:$,s:M}=Yn.toSig(Ye("DER",N));return new w($,M)}assertValidity(){if(!f(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!f(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(N){return new w(this.r,this.s,N)}recoverPublicKey(N){const{r:$,s:M,recovery:D}=this,V=P(Ye("msgHash",N));if(D==null||![0,1,2,3].includes(D))throw new Error("recovery id invalid");const K=D===2||D===3?$+t.n:$;if(K>=e.ORDER)throw new Error("recovery id 2 or 3 invalid");const W=D&1?"03":"02",te=l.fromHex(W+p(K)),re=c(K),ie=a(-V*re),ne=a(M*re),se=l.BASE.multiplyAndAddUnsafe(te,ie,ne);if(!se)throw new Error("point at infinify");return se.assertValidity(),se}hasHighS(){return y(this.s)}normalizeS(){return this.hasHighS()?new w(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return Ys(this.toDERHex())}toDERHex(){return Yn.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Ys(this.toCompactHex())}toCompactHex(){return p(this.r)+p(this.s)}}const _={isValidPrivateKey(x){try{return u(x),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{const x=tf(t.n);return l9(t.randomBytes(x),t.n)},precompute(x=8,N=l.BASE){return N._setWindowSize(x),N.multiply(BigInt(3)),N}};function b(x,N=!0){return l.fromPrivateKey(x).toRawBytes(N)}function S(x){const N=ss(x),$=typeof x=="string",M=(N||$)&&x.length;return N?M===s||M===i:$?M===2*s||M===2*i:x instanceof l}function I(x,N,$=!0){if(S(x))throw new Error("first arg must be private key");if(!S(N))throw new Error("second arg must be public key");return l.fromHex(N).multiply(u(x)).toRawBytes($)}const A=t.bits2int||function(x){const N=jn(x),$=x.length*8-t.nBitLength;return $>0?N>>BigInt($):N},P=t.bits2int_modN||function(x){return a(A(x))},T=H1(t.nBitLength);function R(x){if(typeof x!="bigint")throw new Error("bigint expected");if(!(qr<=x&&x<T))throw new Error(`bigint expected < 2^${t.nBitLength}`);return Qs(x,t.nByteLength)}function C(x,N,$=k){if(["recovered","canonical"].some(Ie=>Ie in $))throw new Error("sign() legacy options not supported");const{hash:M,randomBytes:D}=t;let{lowS:V,prehash:K,extraEntropy:W}=$;V==null&&(V=!0),x=Ye("msgHash",x),K&&(x=Ye("prehashed msgHash",M(x)));const te=P(x),re=u(N),ie=[R(re),R(te)];if(W!=null&&W!==!1){const Ie=W===!0?D(e.BYTES):W;ie.push(Ye("extraEntropy",Ie))}const ne=os(...ie),se=te;function Ae(Ie){const et=A(Ie);if(!f(et))return;const tt=c(et),yt=l.BASE.multiply(et).toAffine(),ze=a(yt.x);if(ze===qr)return;const nr=a(tt*a(se+ze*re));if(nr===qr)return;let Fn=(yt.x===ze?0:2)|Number(yt.y&qt),vi=nr;return V&&y(nr)&&(vi=g(nr),Fn^=1),new w(ze,vi,Fn)}return{seed:ne,k2sig:Ae}}const k={lowS:t.lowS,prehash:!1},B={lowS:t.lowS,prehash:!1};function L(x,N,$=k){const{seed:M,k2sig:D}=C(x,N,$),V=t;return X2(V.hash.outputLen,V.nByteLength,V.hmac)(M,D)}l.BASE._setWindowSize(8);function z(x,N,$,M=B){var yt;const D=x;if(N=Ye("msgHash",N),$=Ye("publicKey",$),"strict"in M)throw new Error("options.strict was renamed to lowS");const{lowS:V,prehash:K}=M;let W,te;try{if(typeof D=="string"||ss(D))try{W=w.fromDER(D)}catch(ze){if(!(ze instanceof Yn.Err))throw ze;W=w.fromCompact(D)}else if(typeof D=="object"&&typeof D.r=="bigint"&&typeof D.s=="bigint"){const{r:ze,s:nr}=D;W=new w(ze,nr)}else throw new Error("PARSE");te=l.fromHex($)}catch(ze){if(ze.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(V&&W.hasHighS())return!1;K&&(N=t.hash(N));const{r:re,s:ie}=W,ne=P(N),se=c(ie),Ae=a(ne*se),Ie=a(re*se),et=(yt=l.BASE.multiplyAndAddUnsafe(te,Ae,Ie))==null?void 0:yt.toAffine();return et?a(et.x)===re:!1}return{CURVE:t,getPublicKey:b,getSharedSecret:I,sign:L,verify:z,ProjectivePoint:l,Signature:w,utils:_}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function gp(n){return{hash:n,hmac:(t,...e)=>_o(n,t,H2(...e)),randomBytes:lc}}function pp(n,t){const e=r=>fp({...n,...gp(r)});return Object.freeze({...e(t),create:e})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const k3=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),Rh=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),mp=BigInt(1),Pl=BigInt(2),Ah=(n,t)=>(n+t/Pl)/t;function yp(n){const t=k3,e=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=n*n*n%t,u=l*l*n%t,d=Le(u,e,t)*u%t,f=Le(d,e,t)*u%t,p=Le(f,Pl,t)*l%t,y=Le(p,s,t)*p%t,g=Le(y,i,t)*y%t,m=Le(g,a,t)*g%t,w=Le(m,c,t)*m%t,_=Le(w,a,t)*g%t,b=Le(_,e,t)*u%t,S=Le(b,o,t)*y%t,I=Le(S,r,t)*l%t,A=Le(I,Pl,t);if(!kl.eql(kl.sqr(A),n))throw new Error("Cannot find square root");return A}const kl=j2(k3,void 0,void 0,{sqrt:yp}),Pr=pp({a:BigInt(0),b:BigInt(7),Fp:kl,n:Rh,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:n=>{const t=Rh,e=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-mp*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=e,o=BigInt("0x100000000000000000000000000000000"),a=Ah(i*n,t),c=Ah(-r*n,t);let l=xe(n-a*e-c*s,t),u=xe(-a*r-c*i,t);const d=l>o,f=u>o;if(d&&(l=t-l),f&&(u=t-u),l>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+n);return{k1neg:d,k1:l,k2neg:f,k2:u}}}},na);BigInt(0);Pr.ProjectivePoint;function wp(){return Pr.utils.randomPrivateKey()}function bp(n,t){const e=mt.digest(t instanceof Uint8Array?t:t.subarray());if(Un(e))return e.then(({digest:r})=>Pr.sign(r,n).toDERRawBytes()).catch(r=>{throw new v(String(r),"ERR_INVALID_INPUT")});try{return Pr.sign(e.digest,n).toDERRawBytes()}catch(r){throw new v(String(r),"ERR_INVALID_INPUT")}}function Ep(n,t,e){const r=mt.digest(e instanceof Uint8Array?e:e.subarray());if(Un(r))return r.then(({digest:s})=>Pr.verify(t,s,n)).catch(s=>{throw new v(String(s),"ERR_INVALID_INPUT")});try{return Pr.verify(t,r.digest,n)}catch(s){throw new v(String(s),"ERR_INVALID_INPUT")}}function vp(n){return Pr.ProjectivePoint.fromHex(n).toRawBytes(!0)}function _p(n){try{Pr.getPublicKey(n,!0)}catch(t){throw new v(String(t),"ERR_INVALID_PRIVATE_KEY")}}function N3(n){try{Pr.ProjectivePoint.fromHex(n)}catch(t){throw new v(String(t),"ERR_INVALID_PUBLIC_KEY")}}function Sp(n){try{return Pr.getPublicKey(n,!0)}catch(t){throw new v(String(t),"ERR_INVALID_PRIVATE_KEY")}}class su{constructor(t){h(this,"_key");N3(t),this._key=t}verify(t,e){return Ep(this._key,e,t)}marshal(){return vp(this._key)}get bytes(){return Zs.encode({Type:Qe.Secp256k1,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}async hash(){const t=mt.digest(this.bytes);let e;return Un(t)?{bytes:e}=await t:e=t.bytes,e}}class iu{constructor(t,e){h(this,"_key");h(this,"_publicKey");this._key=t,this._publicKey=e??Sp(t),_p(this._key),N3(this._publicKey)}sign(t){return bp(this._key,t)}get public(){return new su(this._publicKey)}marshal(){return this._key}get bytes(){return Js.encode({Type:Qe.Secp256k1,Data:this.marshal()}).subarray()}equals(t){return ke(this.bytes,t.bytes)}hash(){const t=mt.digest(this.bytes);return Un(t)?t.then(({bytes:e})=>e):t.bytes}async id(){const t=await this.public.hash();return X(t,"base58btc")}async export(t,e="libp2p-key"){if(e==="libp2p-key")return G1(this.bytes,t);throw new v(`export format '${e}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function Ip(n){return new iu(n)}function Rp(n){return new su(n)}async function Ap(){const n=wp();return new iu(n)}const Tp=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:iu,Secp256k1PublicKey:su,generateKeyPair:Ap,unmarshalSecp256k1PrivateKey:Ip,unmarshalSecp256k1PublicKey:Rp},Symbol.toStringTag,{value:"Module"})),Dn={rsa:ip,ed25519:P9,secp256k1:Tp};function ou(n){const t=Object.keys(Dn).join(" / ");return new v(`invalid or unsupported key type ${n}. Must be ${t}`,"ERR_UNSUPPORTED_KEY_TYPE")}function au(n){if(n=n.toLowerCase(),n==="rsa"||n==="ed25519"||n==="secp256k1")return Dn[n];throw ou(n)}async function Dp(n,t){return au(n).generateKeyPair(2048)}function ls(n){const t=Zs.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case Qe.RSA:return Dn.rsa.unmarshalRsaPublicKey(e);case Qe.Ed25519:return Dn.ed25519.unmarshalEd25519PublicKey(e);case Qe.Secp256k1:return Dn.secp256k1.unmarshalSecp256k1PublicKey(e);default:throw ou(t.Type??"unknown")}}function cu(n,t){return t=(t??"rsa").toLowerCase(),au(t),n.bytes}async function Ji(n){const t=Js.decode(n),e=t.Data??new Uint8Array;switch(t.Type){case Qe.RSA:return Dn.rsa.unmarshalRsaPrivateKey(e);case Qe.Ed25519:return Dn.ed25519.unmarshalEd25519PrivateKey(e);case Qe.Secp256k1:return Dn.secp256k1.unmarshalSecp256k1PrivateKey(e);default:throw ou(t.Type??"RSA")}}function xp(n,t){return t=(t??"rsa").toLowerCase(),au(t),n.bytes}var M3={exports:{}};(function(n){(function(){n.exports=m;var t=86400,e=3200,r=146097*e/400,s=t*r,i=1e3*s,o=864e13,a=4294967296,c=1e6,l="000000000",u=Math.trunc||function(R){var C=R-R%1;return C==0&&(R<0||R===0&&1/R!=1/0)?-0:C},d=m.prototype,f=(m.fromDate=function(R){return new m(+R)},m.fromInt64BE=I(0,1,2,3,0,4),m.fromInt64LE=I(3,2,1,0,4,0),m.fromString=function(B){var C,k=new m,B=(B+="").replace(/^\s*[+\-]?\d+/,function(z){var z=+z,x=1970+(z-1970)%400;return k.year=z-x,x}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(L,z,x){return z<0&&(x*=-1),C=6e4*(60*+z+ +x),""}).replace(/\.\d+$/,function(L){return k.nano=+(L+l).substr(1,9),""}).split(/\D+/);if(1<B.length?B[1]--:B[1]=0,k.time=C=Date.UTC.apply(Date,B)-(C||0),isNaN(C))throw new TypeError("Invalid Date");return w(k)},m.fromTimeT=function(R){return b(R,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(R){return this.nano+=+R||0,this},d.getNano=function(){var R=w(this);return(R.time%1e3*c+ +R.nano+1e9)%1e9},d.getTimeT=function(){var C=w(this),R=Math.floor(C.time/1e3),C=C.year;return C&&(R+=C*r*t/e),R},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return _(w(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(R){var C=this,k=C.toDate(),B={H:function(){return P(k.getUTCHours())},L:function(){return T(k.getUTCMilliseconds(),3)},M:function(){return P(k.getUTCMinutes())},N:function(){return T(C.getNano(),9)},S:function(){return P(k.getUTCSeconds())},Y:function(){var L=C.getYear();return 999999<L?"+"+L:9999<L?"+"+T(L,6):0<=L?T(L,4):-999999<=L?"-"+T(-L,6):L},a:function(){return y[k.getUTCDay()]},b:function(){return p[k.getUTCMonth()]},d:function(){return P(k.getUTCDate())},e:function(){return function(L){return(9<L?"":" ")+(0|L)}(k.getUTCDate())},m:function(){return P(k.getUTCMonth()+1)}};return function L(z){return z.replace(/%./g,function(x){var $=x[1],N=g[$],$=B[$];return N?L(N):$?$():x})}(R||f)},d.writeInt64BE=S(0,1,2,3,0,4),d.writeInt64LE=S(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],y=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return m;function m(R,C,k){var B=this;if(!(B instanceof m))return new m(R,C,k);B.time=+R||0,B.nano=+C||0,B.year=+k||0,w(B)}function w(R){var C,k,B,L=R.year,z=R.time,x=R.nano,N=((x<0||c<=x)&&(x-=(k=Math.floor(x/c))*c,z+=k,k=1),L%e);return(z<-o||o<z||N)&&((C=u(z/i))&&(L+=C*e,z-=C*i),(B=_(z)).setUTCFullYear(N+B.getUTCFullYear()),B=(z=+B)+(C=u((L-=N)/e))*i,C&&-o<=B&&B<=o&&(L-=C*e,z=B),k=1),k&&(R.year=L,R.time=z,R.nano=x),R}function _(R){var C=new Date(0);return C.setTime(R),C}function b(L,B){L=+L||0;var k=u((B=(B|0)*a)/s)+u(L/s),B=B%s+L%s,L=u(B/s);return L&&(k+=L,B-=L*s),new m(1e3*B,0,k*e)}function S(R,C,k,B,L,z){return function(N,$){var D=w(this);N=N||new Array(8),A(N,$|=0);var V=Math.floor(D.time/1e3),D=D.year*(r*t/e),M=u(D/a)+u(V/a),D=D%a+V%a,V=Math.floor(D/a);return V&&(M+=V,D-=V*a),x(N,$+L,M),x(N,$+z,D),N};function x(N,$,M){N[$+R]=M>>24&255,N[$+C]=M>>16&255,N[$+k]=M>>8&255,N[$+B]=255&M}}function I(R,C,k,B,L,z){return function(N,$){A(N,$|=0);var M=x(N,$+L);return b(x(N,$+z),M)};function x(N,$){return 16777216*N[$+R]+(N[$+C]<<16|N[$+k]<<8|N[$+B])}}function A(R,C){if(R=R&&R.length,R==null)throw new TypeError("Invalid Buffer");if(R<C+8)throw new RangeError("Out of range")}function P(R){return(9<R?"":"0")+(0|R)}function T(R,C){return(l+(0|R)).substr(-C)}})()})(M3);var Cp=M3.exports;const Pp=tn(Cp),kp="ERR_IPNS_EXPIRED_RECORD",O3="ERR_UNRECOGNIZED_VALIDITY",Gn="ERR_SIGNATURE_VERIFICATION",Th="ERR_UNDEFINED_PARAMETER",Np="ERR_INVALID_RECORD_DATA",Mp="ERR_INVALID_VALUE",Op="ERR_INVALID_EMBEDDED_KEY",Lp="ERR_RECORD_TOO_LARGE";var Zr;(function(n){(function(r){r.EOL="EOL"})(n.ValidityType||(n.ValidityType={}));let t;(function(r){r[r.EOL=0]="EOL"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.ValidityType||(n.ValidityType={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.value!=null&&(s.uint32(10),s.bytes(r.value)),r.signatureV1!=null&&(s.uint32(18),s.bytes(r.signatureV1)),r.validityType!=null&&(s.uint32(24),n.ValidityType.codec().encode(r.validityType,s)),r.validity!=null&&(s.uint32(34),s.bytes(r.validity)),r.sequence!=null&&(s.uint32(40),s.uint64(r.sequence)),r.ttl!=null&&(s.uint32(48),s.uint64(r.ttl)),r.pubKey!=null&&(s.uint32(58),s.bytes(r.pubKey)),r.signatureV2!=null&&(s.uint32(66),s.bytes(r.signatureV2)),r.data!=null&&(s.uint32(74),s.bytes(r.data)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.value=r.bytes();break;case 2:i.signatureV1=r.bytes();break;case 3:i.validityType=n.ValidityType.codec().decode(r);break;case 4:i.validity=r.bytes();break;case 5:i.sequence=r.uint64();break;case 6:i.ttl=r.uint64();break;case 7:i.pubKey=r.bytes();break;case 8:i.signatureV2=r.bytes();break;case 9:i.data=r.bytes();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(Zr||(Zr={}));const Bp=["string","number","bigint","symbol"],Up=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function Fp(n){if(n===null)return"null";if(n===void 0)return"undefined";if(n===!0||n===!1)return"boolean";const t=typeof n;if(Bp.includes(t))return t;if(t==="function")return"Function";if(Array.isArray(n))return"Array";if(Vp(n))return"Buffer";const e=$p(n);return e||"Object"}function Vp(n){return n&&n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer.call(null,n)}function $p(n){const t=Object.prototype.toString.call(n).slice(8,-1);if(Up.includes(t))return t}class F{constructor(t,e,r){this.major=t,this.majorEncoded=t<<5,this.name=e,this.terminal=r}toString(){return`Type[${this.major}].${this.name}`}compare(t){return this.major<t.major?-1:this.major>t.major?1:0}}F.uint=new F(0,"uint",!0);F.negint=new F(1,"negint",!0);F.bytes=new F(2,"bytes",!0);F.string=new F(3,"string",!0);F.array=new F(4,"array",!1);F.map=new F(5,"map",!1);F.tag=new F(6,"tag",!1);F.float=new F(7,"float",!0);F.false=new F(7,"false",!0);F.true=new F(7,"true",!0);F.null=new F(7,"null",!0);F.undefined=new F(7,"undefined",!0);F.break=new F(7,"break",!0);class J{constructor(t,e,r){this.type=t,this.value=e,this.encodedLength=r,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const fc=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",Kp=new TextDecoder,Hp=new TextEncoder;function Nl(n){return fc&&globalThis.Buffer.isBuffer(n)}const zp=fc?(n,t,e)=>e-t>64?globalThis.Buffer.from(n.subarray(t,e)).toString("utf8"):xh(n,t,e):(n,t,e)=>e-t>64?Kp.decode(n.subarray(t,e)):xh(n,t,e),Wp=fc?n=>n.length>64?globalThis.Buffer.from(n):Dh(n):n=>n.length>64?Hp.encode(n):Dh(n),L3=fc?(n,t,e)=>Nl(n)?new Uint8Array(n.subarray(t,e)):n.slice(t,e):(n,t,e)=>n.slice(t,e);function qp(n,t){if(Nl(n)&&Nl(t))return n.compare(t);for(let e=0;e<n.length;e++)if(n[e]!==t[e])return n[e]<t[e]?-1:1;return 0}function Dh(n){const t=[];let e=0;for(let r=0;r<n.length;r++){let s=n.charCodeAt(r);s<128?t[e++]=s:s<2048?(t[e++]=s>>6|192,t[e++]=s&63|128):(s&64512)===55296&&r+1<n.length&&(n.charCodeAt(r+1)&64512)===56320?(s=65536+((s&1023)<<10)+(n.charCodeAt(++r)&1023),t[e++]=s>>18|240,t[e++]=s>>12&63|128,t[e++]=s>>6&63|128,t[e++]=s&63|128):(t[e++]=s>>12|224,t[e++]=s>>6&63|128,t[e++]=s&63|128)}return t}function xh(n,t,e){const r=[];for(;t<e;){const s=n[t];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(t+o<=e){let a,c,l,u;switch(o){case 1:s<128&&(i=s);break;case 2:a=n[t+1],(a&192)===128&&(u=(s&31)<<6|a&63,u>127&&(i=u));break;case 3:a=n[t+1],c=n[t+2],(a&192)===128&&(c&192)===128&&(u=(s&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=n[t+1],c=n[t+2],l=n[t+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,r.push(i>>>10&1023|55296),i=56320|i&1023),r.push(i),t+=o}return Gp(r)}const Ch=4096;function Gp(n){const t=n.length;if(t<=Ch)return String.fromCharCode.apply(String,n);let e="",r=0;for(;r<t;)e+=String.fromCharCode.apply(String,n.slice(r,r+=Ch));return e}const pe="CBOR decode error:",B3="CBOR encode error:";function pi(n,t,e){if(n.length-t<e)throw new Error(`${pe} not enough data for type`)}const st=[24,256,65536,4294967296,BigInt("18446744073709551616")];function ps(n,t,e){pi(n,t,1);const r=n[t];if(e.strict===!0&&r<st[0])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return r}function ms(n,t,e){pi(n,t,2);const r=n[t]<<8|n[t+1];if(e.strict===!0&&r<st[1])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return r}function ys(n,t,e){pi(n,t,4);const r=n[t]*16777216+(n[t+1]<<16)+(n[t+2]<<8)+n[t+3];if(e.strict===!0&&r<st[2])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);return r}function ws(n,t,e){pi(n,t,8);const r=n[t]*16777216+(n[t+1]<<16)+(n[t+2]<<8)+n[t+3],s=n[t+4]*16777216+(n[t+5]<<16)+(n[t+6]<<8)+n[t+7],i=(BigInt(r)<<BigInt(32))+BigInt(s);if(e.strict===!0&&i<st[3])throw new Error(`${pe} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(e.allowBigInt===!0)return i;throw new Error(`${pe} integers outside of the safe integer range are not supported`)}function Yp(n,t,e,r){return new J(F.uint,ps(n,t+1,r),2)}function Qp(n,t,e,r){return new J(F.uint,ms(n,t+1,r),3)}function Xp(n,t,e,r){return new J(F.uint,ys(n,t+1,r),5)}function Zp(n,t,e,r){return new J(F.uint,ws(n,t+1,r),9)}function bs(n,t){return rr(n,0,t.value)}function rr(n,t,e){if(e<st[0]){const r=Number(e);n.push([t|r])}else if(e<st[1]){const r=Number(e);n.push([t|24,r])}else if(e<st[2]){const r=Number(e);n.push([t|25,r>>>8,r&255])}else if(e<st[3]){const r=Number(e);n.push([t|26,r>>>24&255,r>>>16&255,r>>>8&255,r&255])}else{const r=BigInt(e);if(r<st[4]){const s=[t|27,0,0,0,0,0,0,0];let i=Number(r&BigInt(4294967295)),o=Number(r>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,n.push(s)}else throw new Error(`${pe} encountered BigInt larger than allowable range`)}}bs.encodedSize=function(t){return rr.encodedSize(t.value)};rr.encodedSize=function(t){return t<st[0]?1:t<st[1]?2:t<st[2]?3:t<st[3]?5:9};bs.compareTokens=function(t,e){return t.value<e.value?-1:t.value>e.value?1:0};function Jp(n,t,e,r){return new J(F.negint,-1-ps(n,t+1,r),2)}function jp(n,t,e,r){return new J(F.negint,-1-ms(n,t+1,r),3)}function em(n,t,e,r){return new J(F.negint,-1-ys(n,t+1,r),5)}const lu=BigInt(-1),U3=BigInt(1);function tm(n,t,e,r){const s=ws(n,t+1,r);if(typeof s!="bigint"){const i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new J(F.negint,i,9)}if(r.allowBigInt!==!0)throw new Error(`${pe} integers outside of the safe integer range are not supported`);return new J(F.negint,lu-BigInt(s),9)}function uu(n,t){const e=t.value,r=typeof e=="bigint"?e*lu-U3:e*-1-1;rr(n,t.type.majorEncoded,r)}uu.encodedSize=function(t){const e=t.value,r=typeof e=="bigint"?e*lu-U3:e*-1-1;return r<st[0]?1:r<st[1]?2:r<st[2]?3:r<st[3]?5:9};uu.compareTokens=function(t,e){return t.value<e.value?1:t.value>e.value?-1:0};function Io(n,t,e,r){pi(n,t,e+r);const s=L3(n,t+e,t+e+r);return new J(F.bytes,s,e+r)}function rm(n,t,e,r){return Io(n,t,1,e)}function nm(n,t,e,r){return Io(n,t,2,ps(n,t+1,r))}function sm(n,t,e,r){return Io(n,t,3,ms(n,t+1,r))}function im(n,t,e,r){return Io(n,t,5,ys(n,t+1,r))}function om(n,t,e,r){const s=ws(n,t+1,r);if(typeof s=="bigint")throw new Error(`${pe} 64-bit integer bytes lengths not supported`);return Io(n,t,9,s)}function Ta(n){return n.encodedBytes===void 0&&(n.encodedBytes=n.type===F.string?Wp(n.value):n.value),n.encodedBytes}function gc(n,t){const e=Ta(t);rr(n,t.type.majorEncoded,e.length),n.push(e)}gc.encodedSize=function(t){const e=Ta(t);return rr.encodedSize(e.length)+e.length};gc.compareTokens=function(t,e){return am(Ta(t),Ta(e))};function am(n,t){return n.length<t.length?-1:n.length>t.length?1:qp(n,t)}function Ro(n,t,e,r,s){const i=e+r;pi(n,t,i);const o=new J(F.string,zp(n,t+e,t+i),i);return s.retainStringBytes===!0&&(o.byteValue=L3(n,t+e,t+i)),o}function cm(n,t,e,r){return Ro(n,t,1,e,r)}function lm(n,t,e,r){return Ro(n,t,2,ps(n,t+1,r),r)}function um(n,t,e,r){return Ro(n,t,3,ms(n,t+1,r),r)}function hm(n,t,e,r){return Ro(n,t,5,ys(n,t+1,r),r)}function dm(n,t,e,r){const s=ws(n,t+1,r);if(typeof s=="bigint")throw new Error(`${pe} 64-bit integer string lengths not supported`);return Ro(n,t,9,s,r)}const fm=gc;function mi(n,t,e,r){return new J(F.array,r,e)}function gm(n,t,e,r){return mi(n,t,1,e)}function pm(n,t,e,r){return mi(n,t,2,ps(n,t+1,r))}function mm(n,t,e,r){return mi(n,t,3,ms(n,t+1,r))}function ym(n,t,e,r){return mi(n,t,5,ys(n,t+1,r))}function wm(n,t,e,r){const s=ws(n,t+1,r);if(typeof s=="bigint")throw new Error(`${pe} 64-bit integer array lengths not supported`);return mi(n,t,9,s)}function bm(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return mi(n,t,1,1/0)}function hu(n,t){rr(n,F.array.majorEncoded,t.value)}hu.compareTokens=bs.compareTokens;hu.encodedSize=function(t){return rr.encodedSize(t.value)};function yi(n,t,e,r){return new J(F.map,r,e)}function Em(n,t,e,r){return yi(n,t,1,e)}function vm(n,t,e,r){return yi(n,t,2,ps(n,t+1,r))}function _m(n,t,e,r){return yi(n,t,3,ms(n,t+1,r))}function Sm(n,t,e,r){return yi(n,t,5,ys(n,t+1,r))}function Im(n,t,e,r){const s=ws(n,t+1,r);if(typeof s=="bigint")throw new Error(`${pe} 64-bit integer map lengths not supported`);return yi(n,t,9,s)}function Rm(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return yi(n,t,1,1/0)}function du(n,t){rr(n,F.map.majorEncoded,t.value)}du.compareTokens=bs.compareTokens;du.encodedSize=function(t){return rr.encodedSize(t.value)};function Am(n,t,e,r){return new J(F.tag,e,1)}function Tm(n,t,e,r){return new J(F.tag,ps(n,t+1,r),2)}function Dm(n,t,e,r){return new J(F.tag,ms(n,t+1,r),3)}function xm(n,t,e,r){return new J(F.tag,ys(n,t+1,r),5)}function Cm(n,t,e,r){return new J(F.tag,ws(n,t+1,r),9)}function fu(n,t){rr(n,F.tag.majorEncoded,t.value)}fu.compareTokens=bs.compareTokens;fu.encodedSize=function(t){return rr.encodedSize(t.value)};const Pm=20,km=21,Nm=22,Mm=23;function Om(n,t,e,r){if(r.allowUndefined===!1)throw new Error(`${pe} undefined values are not supported`);return r.coerceUndefinedToNull===!0?new J(F.null,null,1):new J(F.undefined,void 0,1)}function Lm(n,t,e,r){if(r.allowIndefinite===!1)throw new Error(`${pe} indefinite length items not allowed`);return new J(F.break,void 0,1)}function gu(n,t,e){if(e){if(e.allowNaN===!1&&Number.isNaN(n))throw new Error(`${pe} NaN values are not supported`);if(e.allowInfinity===!1&&(n===1/0||n===-1/0))throw new Error(`${pe} Infinity values are not supported`)}return new J(F.float,n,t)}function Bm(n,t,e,r){return gu(mu(n,t+1),3,r)}function Um(n,t,e,r){return gu(yu(n,t+1),5,r)}function Fm(n,t,e,r){return gu(K3(n,t+1),9,r)}function pu(n,t,e){const r=t.value;if(r===!1)n.push([F.float.majorEncoded|Pm]);else if(r===!0)n.push([F.float.majorEncoded|km]);else if(r===null)n.push([F.float.majorEncoded|Nm]);else if(r===void 0)n.push([F.float.majorEncoded|Mm]);else{let s,i=!1;(!e||e.float64!==!0)&&(V3(r),s=mu(ar,1),r===s||Number.isNaN(r)?(ar[0]=249,n.push(ar.slice(0,3)),i=!0):($3(r),s=yu(ar,1),r===s&&(ar[0]=250,n.push(ar.slice(0,5)),i=!0))),i||(Vm(r),s=K3(ar,1),ar[0]=251,n.push(ar.slice(0,9)))}}pu.encodedSize=function(t,e){const r=t.value;if(r===!1||r===!0||r===null||r===void 0)return 1;if(!e||e.float64!==!0){V3(r);let s=mu(ar,1);if(r===s||Number.isNaN(r))return 3;if($3(r),s=yu(ar,1),r===s)return 5}return 9};const F3=new ArrayBuffer(9),Ht=new DataView(F3,1),ar=new Uint8Array(F3,0);function V3(n){if(n===1/0)Ht.setUint16(0,31744,!1);else if(n===-1/0)Ht.setUint16(0,64512,!1);else if(Number.isNaN(n))Ht.setUint16(0,32256,!1);else{Ht.setFloat32(0,n);const t=Ht.getUint32(0),e=(t&2139095040)>>23,r=t&8388607;if(e===255)Ht.setUint16(0,31744,!1);else if(e===0)Ht.setUint16(0,(n&2147483648)>>16|r>>13,!1);else{const s=e-127;s<-24?Ht.setUint16(0,0):s<-14?Ht.setUint16(0,(t&2147483648)>>16|1<<24+s,!1):Ht.setUint16(0,(t&2147483648)>>16|s+15<<10|r>>13,!1)}}}function mu(n,t){if(n.length-t<2)throw new Error(`${pe} not enough data for float16`);const e=(n[t]<<8)+n[t+1];if(e===31744)return 1/0;if(e===64512)return-1/0;if(e===32256)return NaN;const r=e>>10&31,s=e&1023;let i;return r===0?i=s*2**-24:r!==31?i=(s+1024)*2**(r-25):i=s===0?1/0:NaN,e&32768?-i:i}function $3(n){Ht.setFloat32(0,n,!1)}function yu(n,t){if(n.length-t<4)throw new Error(`${pe} not enough data for float32`);const e=(n.byteOffset||0)+t;return new DataView(n.buffer,e,4).getFloat32(0,!1)}function Vm(n){Ht.setFloat64(0,n,!1)}function K3(n,t){if(n.length-t<8)throw new Error(`${pe} not enough data for float64`);const e=(n.byteOffset||0)+t;return new DataView(n.buffer,e,8).getFloat64(0,!1)}pu.compareTokens=bs.compareTokens;function Ee(n,t,e){throw new Error(`${pe} encountered invalid minor (${e}) for major ${n[t]>>>5}`)}function pc(n){return()=>{throw new Error(`${pe} ${n}`)}}const H=[];for(let n=0;n<=23;n++)H[n]=Ee;H[24]=Yp;H[25]=Qp;H[26]=Xp;H[27]=Zp;H[28]=Ee;H[29]=Ee;H[30]=Ee;H[31]=Ee;for(let n=32;n<=55;n++)H[n]=Ee;H[56]=Jp;H[57]=jp;H[58]=em;H[59]=tm;H[60]=Ee;H[61]=Ee;H[62]=Ee;H[63]=Ee;for(let n=64;n<=87;n++)H[n]=rm;H[88]=nm;H[89]=sm;H[90]=im;H[91]=om;H[92]=Ee;H[93]=Ee;H[94]=Ee;H[95]=pc("indefinite length bytes/strings are not supported");for(let n=96;n<=119;n++)H[n]=cm;H[120]=lm;H[121]=um;H[122]=hm;H[123]=dm;H[124]=Ee;H[125]=Ee;H[126]=Ee;H[127]=pc("indefinite length bytes/strings are not supported");for(let n=128;n<=151;n++)H[n]=gm;H[152]=pm;H[153]=mm;H[154]=ym;H[155]=wm;H[156]=Ee;H[157]=Ee;H[158]=Ee;H[159]=bm;for(let n=160;n<=183;n++)H[n]=Em;H[184]=vm;H[185]=_m;H[186]=Sm;H[187]=Im;H[188]=Ee;H[189]=Ee;H[190]=Ee;H[191]=Rm;for(let n=192;n<=215;n++)H[n]=Am;H[216]=Tm;H[217]=Dm;H[218]=xm;H[219]=Cm;H[220]=Ee;H[221]=Ee;H[222]=Ee;H[223]=Ee;for(let n=224;n<=243;n++)H[n]=pc("simple values are not supported");H[244]=Ee;H[245]=Ee;H[246]=Ee;H[247]=Om;H[248]=pc("simple values are not supported");H[249]=Bm;H[250]=Um;H[251]=Fm;H[252]=Ee;H[253]=Ee;H[254]=Ee;H[255]=Lm;const Nr=[];for(let n=0;n<24;n++)Nr[n]=new J(F.uint,n,1);for(let n=-1;n>=-24;n--)Nr[31-n]=new J(F.negint,n,1);Nr[64]=new J(F.bytes,new Uint8Array(0),1);Nr[96]=new J(F.string,"",1);Nr[128]=new J(F.array,0,1);Nr[160]=new J(F.map,0,1);Nr[244]=new J(F.false,!1,1);Nr[245]=new J(F.true,!0,1);Nr[246]=new J(F.null,null,1);function $m(){const n=[];return n[F.uint.major]=bs,n[F.negint.major]=uu,n[F.bytes.major]=gc,n[F.string.major]=fm,n[F.array.major]=hu,n[F.map.major]=du,n[F.tag.major]=fu,n[F.float.major]=pu,n}$m();class Da{constructor(t,e){this.obj=t,this.parent=e}includes(t){let e=this;do if(e.obj===t)return!0;while(e=e.parent);return!1}static createCheck(t,e){if(t&&t.includes(e))throw new Error(`${B3} object contains circular references`);return new Da(e,t)}}const un={null:new J(F.null,null),undefined:new J(F.undefined,void 0),true:new J(F.true,!0),false:new J(F.false,!1),emptyArray:new J(F.array,0),emptyMap:new J(F.map,0)},Nn={number(n,t,e,r){return!Number.isInteger(n)||!Number.isSafeInteger(n)?new J(F.float,n):n>=0?new J(F.uint,n):new J(F.negint,n)},bigint(n,t,e,r){return n>=BigInt(0)?new J(F.uint,n):new J(F.negint,n)},Uint8Array(n,t,e,r){return new J(F.bytes,n)},string(n,t,e,r){return new J(F.string,n)},boolean(n,t,e,r){return n?un.true:un.false},null(n,t,e,r){return un.null},undefined(n,t,e,r){return un.undefined},ArrayBuffer(n,t,e,r){return new J(F.bytes,new Uint8Array(n))},DataView(n,t,e,r){return new J(F.bytes,new Uint8Array(n.buffer,n.byteOffset,n.byteLength))},Array(n,t,e,r){if(!n.length)return e.addBreakTokens===!0?[un.emptyArray,new J(F.break)]:un.emptyArray;r=Da.createCheck(r,n);const s=[];let i=0;for(const o of n)s[i++]=Xc(o,e,r);return e.addBreakTokens?[new J(F.array,n.length),s,new J(F.break)]:[new J(F.array,n.length),s]},Object(n,t,e,r){const s=t!=="Object",i=s?n.keys():Object.keys(n),o=s?n.size:i.length;if(!o)return e.addBreakTokens===!0?[un.emptyMap,new J(F.break)]:un.emptyMap;r=Da.createCheck(r,n);const a=[];let c=0;for(const l of i)a[c++]=[Xc(l,e,r),Xc(s?n.get(l):n[l],e,r)];return Km(a,e),e.addBreakTokens?[new J(F.map,o),a,new J(F.break)]:[new J(F.map,o),a]}};Nn.Map=Nn.Object;Nn.Buffer=Nn.Uint8Array;for(const n of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Nn[`${n}Array`]=Nn.DataView;function Xc(n,t={},e){const r=Fp(n),s=t&&t.typeEncoders&&t.typeEncoders[r]||Nn[r];if(typeof s=="function"){const o=s(n,r,t,e);if(o!=null)return o}const i=Nn[r];if(!i)throw new Error(`${B3} unsupported type: ${r}`);return i(n,r,t,e)}function Km(n,t){t.mapSorter&&n.sort(t.mapSorter)}const Hm={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class zm{constructor(t,e={}){this._pos=0,this.data=t,this.options=e}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const t=this.data[this._pos];let e=Nr[t];if(e===void 0){const r=H[t];if(!r)throw new Error(`${pe} no decoder for major type ${t>>>5} (byte 0x${t.toString(16).padStart(2,"0")})`);const s=t&31;e=r(this.data,this._pos,s,this.options)}return this._pos+=e.encodedLength,e}}const ji=Symbol.for("DONE"),mc=Symbol.for("BREAK");function Wm(n,t,e){const r=[];for(let s=0;s<n.value;s++){const i=eo(t,e);if(i===mc){if(n.value===1/0)break;throw new Error(`${pe} got unexpected break to lengthed array`)}if(i===ji)throw new Error(`${pe} found array but not enough entries (got ${s}, expected ${n.value})`);r[s]=i}return r}function qm(n,t,e){const r=e.useMaps===!0,s=r?void 0:{},i=r?new Map:void 0;for(let o=0;o<n.value;o++){const a=eo(t,e);if(a===mc){if(n.value===1/0)break;throw new Error(`${pe} got unexpected break to lengthed map`)}if(a===ji)throw new Error(`${pe} found map but not enough entries (got ${o} [no key], expected ${n.value})`);if(r!==!0&&typeof a!="string")throw new Error(`${pe} non-string keys not supported (got ${typeof a})`);if(e.rejectDuplicateMapKeys===!0&&(r&&i.has(a)||!r&&a in s))throw new Error(`${pe} found repeat map key "${a}"`);const c=eo(t,e);if(c===ji)throw new Error(`${pe} found map but not enough entries (got ${o} [no value], expected ${n.value})`);r?i.set(a,c):s[a]=c}return r?i:s}function eo(n,t){if(n.done())return ji;const e=n.next();if(e.type===F.break)return mc;if(e.type.terminal)return e.value;if(e.type===F.array)return Wm(e,n,t);if(e.type===F.map)return qm(e,n,t);if(e.type===F.tag){if(t.tags&&typeof t.tags[e.value]=="function"){const r=eo(n,t);return t.tags[e.value](r)}throw new Error(`${pe} tag not supported (${e.value})`)}throw new Error("unsupported")}function Gm(n,t){if(!(n instanceof Uint8Array))throw new Error(`${pe} data to decode must be a Uint8Array`);t=Object.assign({},Hm,t);const e=t.tokenizer||new zm(n,t),r=eo(e,t);if(r===ji)throw new Error(`${pe} did not find any content to decode`);if(r===mc)throw new Error(`${pe} got unexpected break`);return[r,n.subarray(e.pos())]}function Ym(n,t){const[e,r]=Gm(n,t);if(r.length>0)throw new Error(`${pe} too many terminals, data makes no sense`);return e}const Ph=di("ipns:utils"),H3=Y("/ipns/"),Qm=114,Xm=async(n,t)=>{if(t==null||n==null){const r=new Error("one or more of the provided parameters are not defined");throw Ph.error(r),Ce(r,Th)}let e;if(t.pubKey!=null){try{e=ls(t.pubKey)}catch(s){throw Ph.error(s),s}if(!(await Cr(t.pubKey)).equals(n))throw Ce(new Error("Embedded public key did not match PeerID"),Op)}else n.publicKey!=null&&(e=ls(n.publicKey));if(e!=null)return e;throw Ce(new Error("no public key is available"),Th)},Zm=n=>{const t=Y("ipns-signature:");return at([t,n])},z3=n=>"signatureV1"in n?Zr.encode({value:Y(n.value),signatureV1:n.signatureV1,validityType:n.validityType,validity:Y(n.validity),sequence:n.sequence,ttl:n.ttl,pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data}):Zr.encode({pubKey:n.pubKey,signatureV2:n.signatureV2,data:n.data});function yc(n){const t=Zr.decode(n);if(t.sequence!=null&&(t.sequence=BigInt(t.sequence)),t.ttl!=null&&(t.ttl=BigInt(t.ttl)),t.signatureV2==null||t.data==null)throw Ce(new Error("missing data or signatureV2"),Gn);const e=W3(t.data),r=ey(e.Value),s=X(e.Validity);if(t.value!=null&&t.signatureV1!=null)return ty(t),{value:r,validityType:Zr.ValidityType.EOL,validity:s,sequence:e.Sequence,ttl:e.TTL,pubKey:t.pubKey,signatureV1:t.signatureV1,signatureV2:t.signatureV2,data:t.data};if(t.signatureV2!=null)return{value:r,validityType:Zr.ValidityType.EOL,validity:s,sequence:e.Sequence,ttl:e.TTL,pubKey:t.pubKey,signatureV2:t.signatureV2,data:t.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}const Jm=n=>at([H3,n.toBytes()]),jm=n=>tr(n.slice(H3.length)),W3=n=>{const t=Ym(n);if(t.ValidityType===0)t.ValidityType=Zr.ValidityType.EOL;else throw Ce(new Error("Unknown validity type"),O3);return Number.isInteger(t.Sequence)&&(t.Sequence=BigInt(t.Sequence)),Number.isInteger(t.TTL)&&(t.TTL=BigInt(t.TTL)),t},ey=n=>{if(n!=null){if(D1(n))return`/ipns/${n.toCID().toString(gl)}`;if(n instanceof Uint8Array){const r=X(n);r.startsWith("/")&&(n=r)}const t=n.toString().trim();if(t.startsWith("/")&&t.length>1)return t;const e=Me.asCID(n);if(e!=null)return e.code===Qm?`/ipns/${e.toString(gl)}`:`/ipfs/${e.toV1().toString()}`;try{return n instanceof Uint8Array?`/ipfs/${Me.decode(n).toV1().toString()}`:`/ipfs/${Me.parse(t).toV1().toString()}`}catch{}}throw Ce(new Error("Value must be a valid content path starting with /"),Mp)},ty=n=>{if(n.data==null)throw Ce(new Error("Record data is missing"),Np);const t=W3(n.data);if(!ke(t.Value,n.value??new Uint8Array(0)))throw Ce(new Error('Field "value" did not match between protobuf and CBOR'),Gn);if(!ke(t.Validity,n.validity??new Uint8Array(0)))throw Ce(new Error('Field "validity" did not match between protobuf and CBOR'),Gn);if(t.ValidityType!==n.validityType)throw Ce(new Error('Field "validityType" did not match between protobuf and CBOR'),Gn);if(t.Sequence!==n.sequence)throw Ce(new Error('Field "sequence" did not match between protobuf and CBOR'),Gn);if(t.TTL!==n.ttl)throw Ce(new Error('Field "ttl" did not match between protobuf and CBOR'),Gn)},zo=di("ipns:validator"),ry=1024*10,ny=async(n,t)=>{const e=yc(t);let r;try{const s=Zm(e.data);r=await n.verify(s,e.signatureV2)}catch{r=!1}if(!r)throw zo.error("record signature verification failed"),Ce(new Error("record signature verification failed"),Gn);if(e.validityType===Zr.ValidityType.EOL){if(Pp.fromString(e.validity).toDate().getTime()<Date.now())throw zo.error("record has expired"),Ce(new Error("record has expired"),kp)}else if(e.validityType!=null)throw zo.error("unrecognized validity type"),Ce(new Error("unrecognized validity type"),O3);zo("ipns record for %s is valid",e.value)};async function sy(n,t){if(t.byteLength>ry)throw Ce(new Error("record too large"),Lp);const e=jm(n),r=yc(t),s=await Xm(e,r);await ny(s,t)}async function*kh(n){const t=/\r?\n/,e=new TextDecoder("utf8");let r="";for await(let s of n){typeof s=="string"&&(s=new TextEncoder().encode(s)),r+=e.decode(s,{stream:!0});const i=r.split(t);r=i.pop()??"";for(let o=0;o<i.length;o++)yield JSON.parse(i[o])}r+=e.decode(),r!==""&&(yield JSON.parse(r))}var q3={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function i(c,l,u,d,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var p=new s(u,d||c,f),y=e?e+l:l;return c._events[y]?c._events[y].fn?c._events[y]=[c._events[y],p]:c._events[y].push(p):(c._events[y]=p,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function a(){this._events=new r,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,d;if(this._eventsCount===0)return l;for(d in u=this._events)t.call(u,d)&&l.push(e?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=e?e+l:l,d=this._events[u];if(!d)return[];if(d.fn)return[d.fn];for(var f=0,p=d.length,y=new Array(p);f<p;f++)y[f]=d[f].fn;return y},a.prototype.listenerCount=function(l){var u=e?e+l:l,d=this._events[u];return d?d.fn?1:d.length:0},a.prototype.emit=function(l,u,d,f,p,y){var g=e?e+l:l;if(!this._events[g])return!1;var m=this._events[g],w=arguments.length,_,b;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),w){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,u),!0;case 3:return m.fn.call(m.context,u,d),!0;case 4:return m.fn.call(m.context,u,d,f),!0;case 5:return m.fn.call(m.context,u,d,f,p),!0;case 6:return m.fn.call(m.context,u,d,f,p,y),!0}for(b=1,_=new Array(w-1);b<w;b++)_[b-1]=arguments[b];m.fn.apply(m.context,_)}else{var S=m.length,I;for(b=0;b<S;b++)switch(m[b].once&&this.removeListener(l,m[b].fn,void 0,!0),w){case 1:m[b].fn.call(m[b].context);break;case 2:m[b].fn.call(m[b].context,u);break;case 3:m[b].fn.call(m[b].context,u,d);break;case 4:m[b].fn.call(m[b].context,u,d,f);break;default:if(!_)for(I=1,_=new Array(w-1);I<w;I++)_[I-1]=arguments[I];m[b].fn.apply(m[b].context,_)}}return!0},a.prototype.on=function(l,u,d){return i(this,l,u,d,!1)},a.prototype.once=function(l,u,d){return i(this,l,u,d,!0)},a.prototype.removeListener=function(l,u,d,f){var p=e?e+l:l;if(!this._events[p])return this;if(!u)return o(this,p),this;var y=this._events[p];if(y.fn)y.fn===u&&(!f||y.once)&&(!d||y.context===d)&&o(this,p);else{for(var g=0,m=[],w=y.length;g<w;g++)(y[g].fn!==u||f&&!y[g].once||d&&y[g].context!==d)&&m.push(y[g]);m.length?this._events[p]=m.length===1?m[0]:m:o(this,p)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=e?e+l:l,this._events[u]&&o(this,u)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,n.exports=a})(q3);var iy=q3.exports;const oy=tn(iy);class wu extends Error{constructor(t){super(t),this.name="TimeoutError"}}let ay=class extends Error{constructor(t){super(),this.name="AbortError",this.message=t}};const Nh=n=>globalThis.DOMException===void 0?new ay(n):new DOMException(n),Mh=n=>{const t=n.reason===void 0?Nh("This operation was aborted."):n.reason;return t instanceof Error?t:Nh(t)};function Ao(n,t){const{milliseconds:e,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o;const c=new Promise((l,u)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){const{signal:f}=t;f.aborted&&u(Mh(f)),f.addEventListener("abort",()=>{u(Mh(f))})}if(e===Number.POSITIVE_INFINITY){n.then(l,u);return}const d=new wu;o=i.setTimeout.call(void 0,()=>{if(r){try{l(r())}catch(f){u(f)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?l():s instanceof Error?u(s):(d.message=s??`Promise timed out after ${e} milliseconds`,u(d))},e),(async()=>{try{l(await n)}catch(f){u(f)}})()}).finally(()=>{c.clear()});return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}function cy(n,t,e){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let o=r+i;e(n[o],t)<=0?(r=++o,s-=i+1):s=i}return r}var Sr,f0;let ly=(f0=class{constructor(){j(this,Sr,[])}enqueue(t,e){e={priority:0,...e};const r={priority:e.priority,run:t};if(this.size&&E(this,Sr)[this.size-1].priority>=e.priority){E(this,Sr).push(r);return}const s=cy(E(this,Sr),r,(i,o)=>o.priority-i.priority);E(this,Sr).splice(s,0,r)}dequeue(){const t=E(this,Sr).shift();return t==null?void 0:t.run}filter(t){return E(this,Sr).filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return E(this,Sr).length}},Sr=new WeakMap,f0);var Os,Ls,yn,ao,Bs,co,zt,Us,At,lo,Wt,Fs,Kr,uo,be,G3,Y3,Q3,X3,Z3,sa,Ml,Ol,ia,J3,oa;class to extends oy{constructor(e){var r,s;super();j(this,be);j(this,Os);j(this,Ls);j(this,yn,0);j(this,ao);j(this,Bs);j(this,co,0);j(this,zt);j(this,Us);j(this,At);j(this,lo);j(this,Wt,0);j(this,Fs);j(this,Kr);j(this,uo);h(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:ly,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((r=e.intervalCap)==null?void 0:r.toString())??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((s=e.interval)==null?void 0:s.toString())??""}\` (${typeof e.interval})`);ee(this,Os,e.carryoverConcurrencyCount),ee(this,Ls,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),ee(this,ao,e.intervalCap),ee(this,Bs,e.interval),ee(this,At,new e.queueClass),ee(this,lo,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,ee(this,uo,e.throwOnTimeout===!0),ee(this,Kr,e.autoStart===!1)}get concurrency(){return E(this,Fs)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);ee(this,Fs,e),O(this,be,ia).call(this)}async add(e,r={}){return r={timeout:this.timeout,throwOnTimeout:E(this,uo),...r},new Promise((s,i)=>{E(this,At).enqueue(async()=>{var o;Po(this,Wt)._++,Po(this,yn)._++;try{(o=r.signal)==null||o.throwIfAborted();let a=e({signal:r.signal});r.timeout&&(a=Ao(Promise.resolve(a),{milliseconds:r.timeout})),r.signal&&(a=Promise.race([a,O(this,be,J3).call(this,r.signal)]));const c=await a;s(c),this.emit("completed",c)}catch(a){if(a instanceof wu&&!r.throwOnTimeout){s();return}i(a),this.emit("error",a)}finally{O(this,be,Q3).call(this)}},r),this.emit("add"),O(this,be,sa).call(this)})}async addAll(e,r){return Promise.all(e.map(async s=>this.add(s,r)))}start(){return E(this,Kr)?(ee(this,Kr,!1),O(this,be,ia).call(this),this):this}pause(){ee(this,Kr,!0)}clear(){ee(this,At,new(E(this,lo)))}async onEmpty(){E(this,At).size!==0&&await O(this,be,oa).call(this,"empty")}async onSizeLessThan(e){E(this,At).size<e||await O(this,be,oa).call(this,"next",()=>E(this,At).size<e)}async onIdle(){E(this,Wt)===0&&E(this,At).size===0||await O(this,be,oa).call(this,"idle")}get size(){return E(this,At).size}sizeBy(e){return E(this,At).filter(e).length}get pending(){return E(this,Wt)}get isPaused(){return E(this,Kr)}}Os=new WeakMap,Ls=new WeakMap,yn=new WeakMap,ao=new WeakMap,Bs=new WeakMap,co=new WeakMap,zt=new WeakMap,Us=new WeakMap,At=new WeakMap,lo=new WeakMap,Wt=new WeakMap,Fs=new WeakMap,Kr=new WeakMap,uo=new WeakMap,be=new WeakSet,G3=function(){return E(this,Ls)||E(this,yn)<E(this,ao)},Y3=function(){return E(this,Wt)<E(this,Fs)},Q3=function(){Po(this,Wt)._--,O(this,be,sa).call(this),this.emit("next")},X3=function(){O(this,be,Ol).call(this),O(this,be,Ml).call(this),ee(this,Us,void 0)},Z3=function(){const e=Date.now();if(E(this,zt)===void 0){const r=E(this,co)-e;if(r<0)ee(this,yn,E(this,Os)?E(this,Wt):0);else return E(this,Us)===void 0&&ee(this,Us,setTimeout(()=>{O(this,be,X3).call(this)},r)),!0}return!1},sa=function(){if(E(this,At).size===0)return E(this,zt)&&clearInterval(E(this,zt)),ee(this,zt,void 0),this.emit("empty"),E(this,Wt)===0&&this.emit("idle"),!1;if(!E(this,Kr)){const e=!E(this,be,Z3);if(E(this,be,G3)&&E(this,be,Y3)){const r=E(this,At).dequeue();return r?(this.emit("active"),r(),e&&O(this,be,Ml).call(this),!0):!1}}return!1},Ml=function(){E(this,Ls)||E(this,zt)!==void 0||(ee(this,zt,setInterval(()=>{O(this,be,Ol).call(this)},E(this,Bs))),ee(this,co,Date.now()+E(this,Bs)))},Ol=function(){E(this,yn)===0&&E(this,Wt)===0&&E(this,zt)&&(clearInterval(E(this,zt)),ee(this,zt,void 0)),ee(this,yn,E(this,Os)?E(this,Wt):0),O(this,be,ia).call(this)},ia=function(){for(;O(this,be,sa).call(this););},J3=async function(e){return new Promise((r,s)=>{e.addEventListener("abort",()=>{s(e.reason)},{once:!0})})},oa=async function(e,r){return new Promise(s=>{const i=()=>{r&&!r()||(this.off(e,i),s())};this.on(e,i)})};function uy(n){return n[Symbol.asyncIterator]!=null}function hy(n){if(uy(n))return(async()=>{for await(const t of n)return t})();for(const t of n)return t}const Ll=Y("/ipns/");function Oh(n){return ke(n.subarray(0,Ll.byteLength),Ll)}const Lh=n=>tr(n.slice(Ll.length));class dy{constructor(t){h(this,"client");this.client=t}async*findProviders(t,e={}){yield*In(this.client.getProviders(t,e),r=>({id:r.ID,multiaddrs:r.Addrs??[]}))}async provide(){}async put(t,e,r){if(!Oh(t))return;const s=Lh(t),i=yc(e);await this.client.putIPNS(s,i,r)}async get(t,e){if(!Oh(t))throw new v("Not found","ERR_NOT_FOUND");const r=Lh(t);try{const s=await this.client.getIPNS(r,e);return z3(s)}catch(s){throw s.code==="ERR_BAD_RESPONSE"?new v("Not found","ERR_NOT_FOUND"):s}}}class fy{constructor(t){h(this,"client");this.client=t}async findPeer(t,e={}){const r=await hy(this.client.getPeers(t,e));if(r!=null)return{id:r.ID,multiaddrs:r.Addrs??[]};throw new v("Not found","ERR_NOT_FOUND")}async*getClosestPeers(t,e={}){}}const _t=di("delegated-routing-v1-http-api-client"),Bh={concurrentRequests:4,timeout:3e4};var Xn,ki;class gy{constructor(t,e={}){j(this,Xn);h(this,"started");h(this,"httpQueue");h(this,"shutDownController");h(this,"clientUrl");h(this,"timeout");h(this,"contentRouting");h(this,"peerRouting");this.started=!1,this.shutDownController=new AbortController,ge(1/0,this.shutDownController.signal),this.httpQueue=new to({concurrency:e.concurrentRequests??Bh.concurrentRequests}),this.clientUrl=t instanceof URL?t:new URL(t),this.timeout=e.timeout??Bh.timeout,this.contentRouting=new dy(this),this.peerRouting=new fy(this)}get[Ea](){return this.contentRouting}get[_a](){return this.peerRouting}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*getProviders(t,e={}){_t("getProviders starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Xt([this.shutDownController.signal,r,e.signal]);ge(1/0,r,s);const i=me(),o=me();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=`${this.clientUrl}routing/v1/providers/${t.toString()}`,l=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:s});if(l.status===404)throw new v("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new v("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new v("Routing response had no body","ERR_BAD_RESPONSE");if(l.headers.get("Content-Type")==="application/json"){const d=await l.json();for(const f of d.Providers){const p=O(this,Xn,ki).call(this,f);p!=null&&(yield p)}}else for await(const d of kh(hh(l.body))){const f=O(this,Xn,ki).call(this,d);f!=null&&(yield f)}}catch(a){_t.error("getProviders errored:",a)}finally{s.clear(),o.resolve(),_t("getProviders finished: %c",t)}}async*getPeers(t,e={}){_t("getPeers starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Xt([this.shutDownController.signal,r,e.signal]);ge(1/0,r,s);const i=me(),o=me();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise;const a=`${this.clientUrl}routing/v1/peers/${t.toCID().toString()}`,l=await fetch(a,{headers:{Accept:"application/x-ndjson"},signal:s});if(l.status===404)throw new v("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new v("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new v("Routing response had no body","ERR_BAD_RESPONSE");if(l.headers.get("Content-Type")==="application/json"){const d=await l.json();for(const f of d.Peers){const p=O(this,Xn,ki).call(this,f);p!=null&&(yield p)}}else for await(const d of kh(hh(l.body))){const f=O(this,Xn,ki).call(this,d);f!=null&&(yield f)}}catch(a){_t.error("getPeers errored:",a)}finally{s.clear(),o.resolve(),_t("getPeers finished: %c",t)}}async getIPNS(t,e={}){_t("getIPNS starts: %c",t);const r=AbortSignal.timeout(this.timeout),s=Xt([this.shutDownController.signal,r,e.signal]);ge(1/0,r,s);const i=me(),o=me();this.httpQueue.add(async()=>(i.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${t.toCID().toString()}`;try{await i.promise;const l=await fetch(a,{headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:s});if(_t("getIPNS GET %s %d",a,l.status),l.status===404)throw new v("No matching records found.","ERR_NOT_FOUND");if(l.status===422)throw new v("Request does not conform to schema or semantic constraints.","ERR_INVALID_REQUEST");if(l.body==null)throw new v("GET ipns response had no body","ERR_BAD_RESPONSE");const u=await l.arrayBuffer(),d=new Uint8Array(u,0,u.byteLength);return e.validate!==!1&&await sy(Jm(t),d),yc(d)}catch(c){throw _t.error("getIPNS GET %s error:",a,c),c}finally{s.clear(),o.resolve(),_t("getIPNS finished: %c",t)}}async putIPNS(t,e,r={}){_t("putIPNS starts: %c",t);const s=AbortSignal.timeout(this.timeout),i=Xt([this.shutDownController.signal,s,r.signal]);ge(1/0,s,i);const o=me(),a=me();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${t.toCID().toString()}`;try{await o.promise;const l=z3(e),d=await fetch(c,{method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:i});if(_t("putIPNS PUT %s %d",c,d.status),d.status!==200)throw new v("PUT ipns response had status other than 200","ERR_BAD_RESPONSE")}catch(l){throw _t.error("putIPNS PUT %s error:",c,l.stack),l}finally{i.clear(),a.resolve(),_t("putIPNS finished: %c",t)}}}Xn=new WeakSet,ki=function(t){var s;const e=[],r=((s=t.Addrs)==null?void 0:s.map(G))??[];return t.Protocols!=null&&e.push(...t.Protocols),t.Protocol!=null&&(e.push(t.Protocol),delete t.Protocol),{...t,Schema:"peer",ID:ye(t.ID),Addrs:r,Protocols:e}};function Wo(n,t={}){return new gy(new URL(n),t)}function xa(n,t){const e={[Symbol.iterator]:()=>e,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:t(s)}}};return e}class Es{constructor(t){h(this,"map");if(this.map=new Map,t!=null)for(const[e,r]of t.entries())this.map.set(e.toString(),r)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(t){return this.map.delete(t.toString())}entries(){return xa(this.map.entries(),t=>[ye(t[0]),t[1]])}forEach(t){this.map.forEach((e,r)=>{t(e,ye(r),this)})}get(t){return this.map.get(t.toString())}has(t){return this.map.has(t.toString())}set(t,e){this.map.set(t.toString(),e)}keys(){return xa(this.map.keys(),t=>ye(t))}values(){return this.map.values()}get size(){return this.map.size}}class hr{constructor(t){h(this,"set");if(this.set=new Set,t!=null)for(const e of t)this.set.add(e.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(t){this.set.add(t.toString())}clear(){this.set.clear()}delete(t){this.set.delete(t.toString())}entries(){return xa(this.set.entries(),t=>{const e=ye(t[0]);return[e,e]})}forEach(t){this.set.forEach(e=>{const r=ye(e);t(r,r,this)})}has(t){return this.set.has(t.toString())}values(){return xa(this.set.values(),t=>ye(t))}intersection(t){const e=new hr;for(const r of t)this.has(r)&&e.add(r);return e}difference(t){const e=new hr;for(const r of this)t.has(r)||e.add(r);return e}union(t){const e=new hr;for(const r of t)e.add(r);for(const r of this)e.add(r);return e}}var Bl={exports:{}};(function(n,t){(function(e,r){var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(g){if(!Array.isArray(g)&&!ArrayBuffer.isView(g))return!1;for(var m=0;m<g.length;m++)if(!Number.isInteger(g[m])||g[m]<0||g[m]>255)return!1;return!0}function o(g,m){return(g&65535)*m+(((g>>>16)*m&65535)<<16)}function a(g,m){return g<<m|g>>>32-m}function c(g){return g^=g>>>16,g=o(g,2246822507),g^=g>>>13,g=o(g,3266489909),g^=g>>>16,g}function l(g,m){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var w=[0,0,0,0];return w[3]+=g[3]+m[3],w[2]+=w[3]>>>16,w[3]&=65535,w[2]+=g[2]+m[2],w[1]+=w[2]>>>16,w[2]&=65535,w[1]+=g[1]+m[1],w[0]+=w[1]>>>16,w[1]&=65535,w[0]+=g[0]+m[0],w[0]&=65535,[w[0]<<16|w[1],w[2]<<16|w[3]]}function u(g,m){g=[g[0]>>>16,g[0]&65535,g[1]>>>16,g[1]&65535],m=[m[0]>>>16,m[0]&65535,m[1]>>>16,m[1]&65535];var w=[0,0,0,0];return w[3]+=g[3]*m[3],w[2]+=w[3]>>>16,w[3]&=65535,w[2]+=g[2]*m[3],w[1]+=w[2]>>>16,w[2]&=65535,w[2]+=g[3]*m[2],w[1]+=w[2]>>>16,w[2]&=65535,w[1]+=g[1]*m[3],w[0]+=w[1]>>>16,w[1]&=65535,w[1]+=g[2]*m[2],w[0]+=w[1]>>>16,w[1]&=65535,w[1]+=g[3]*m[1],w[0]+=w[1]>>>16,w[1]&=65535,w[0]+=g[0]*m[3]+g[1]*m[2]+g[2]*m[1]+g[3]*m[0],w[0]&=65535,[w[0]<<16|w[1],w[2]<<16|w[3]]}function d(g,m){return m%=64,m===32?[g[1],g[0]]:m<32?[g[0]<<m|g[1]>>>32-m,g[1]<<m|g[0]>>>32-m]:(m-=32,[g[1]<<m|g[0]>>>32-m,g[0]<<m|g[1]>>>32-m])}function f(g,m){return m%=64,m===0?g:m<32?[g[0]<<m|g[1]>>>32-m,g[1]<<m]:[g[1]<<m-32,0]}function p(g,m){return[g[0]^m[0],g[1]^m[1]]}function y(g){return g=p(g,[0,g[0]>>>1]),g=u(g,[4283543511,3981806797]),g=p(g,[0,g[0]>>>1]),g=u(g,[3301882366,444984403]),g=p(g,[0,g[0]>>>1]),g}s.x86.hash32=function(g,m){if(s.inputValidation&&!i(g))return r;m=m||0;for(var w=g.length%4,_=g.length-w,b=m,S=0,I=3432918353,A=461845907,P=0;P<_;P=P+4)S=g[P]|g[P+1]<<8|g[P+2]<<16|g[P+3]<<24,S=o(S,I),S=a(S,15),S=o(S,A),b^=S,b=a(b,13),b=o(b,5)+3864292196;switch(S=0,w){case 3:S^=g[P+2]<<16;case 2:S^=g[P+1]<<8;case 1:S^=g[P],S=o(S,I),S=a(S,15),S=o(S,A),b^=S}return b^=g.length,b=c(b),b>>>0},s.x86.hash128=function(g,m){if(s.inputValidation&&!i(g))return r;m=m||0;for(var w=g.length%16,_=g.length-w,b=m,S=m,I=m,A=m,P=0,T=0,R=0,C=0,k=597399067,B=2869860233,L=951274213,z=2716044179,x=0;x<_;x=x+16)P=g[x]|g[x+1]<<8|g[x+2]<<16|g[x+3]<<24,T=g[x+4]|g[x+5]<<8|g[x+6]<<16|g[x+7]<<24,R=g[x+8]|g[x+9]<<8|g[x+10]<<16|g[x+11]<<24,C=g[x+12]|g[x+13]<<8|g[x+14]<<16|g[x+15]<<24,P=o(P,k),P=a(P,15),P=o(P,B),b^=P,b=a(b,19),b+=S,b=o(b,5)+1444728091,T=o(T,B),T=a(T,16),T=o(T,L),S^=T,S=a(S,17),S+=I,S=o(S,5)+197830471,R=o(R,L),R=a(R,17),R=o(R,z),I^=R,I=a(I,15),I+=A,I=o(I,5)+2530024501,C=o(C,z),C=a(C,18),C=o(C,k),A^=C,A=a(A,13),A+=b,A=o(A,5)+850148119;switch(P=0,T=0,R=0,C=0,w){case 15:C^=g[x+14]<<16;case 14:C^=g[x+13]<<8;case 13:C^=g[x+12],C=o(C,z),C=a(C,18),C=o(C,k),A^=C;case 12:R^=g[x+11]<<24;case 11:R^=g[x+10]<<16;case 10:R^=g[x+9]<<8;case 9:R^=g[x+8],R=o(R,L),R=a(R,17),R=o(R,z),I^=R;case 8:T^=g[x+7]<<24;case 7:T^=g[x+6]<<16;case 6:T^=g[x+5]<<8;case 5:T^=g[x+4],T=o(T,B),T=a(T,16),T=o(T,L),S^=T;case 4:P^=g[x+3]<<24;case 3:P^=g[x+2]<<16;case 2:P^=g[x+1]<<8;case 1:P^=g[x],P=o(P,k),P=a(P,15),P=o(P,B),b^=P}return b^=g.length,S^=g.length,I^=g.length,A^=g.length,b+=S,b+=I,b+=A,S+=b,I+=b,A+=b,b=c(b),S=c(S),I=c(I),A=c(A),b+=S,b+=I,b+=A,S+=b,I+=b,A+=b,("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)+("00000000"+(I>>>0).toString(16)).slice(-8)+("00000000"+(A>>>0).toString(16)).slice(-8)},s.x64.hash128=function(g,m){if(s.inputValidation&&!i(g))return r;m=m||0;for(var w=g.length%16,_=g.length-w,b=[0,m],S=[0,m],I=[0,0],A=[0,0],P=[2277735313,289559509],T=[1291169091,658871167],R=0;R<_;R=R+16)I=[g[R+4]|g[R+5]<<8|g[R+6]<<16|g[R+7]<<24,g[R]|g[R+1]<<8|g[R+2]<<16|g[R+3]<<24],A=[g[R+12]|g[R+13]<<8|g[R+14]<<16|g[R+15]<<24,g[R+8]|g[R+9]<<8|g[R+10]<<16|g[R+11]<<24],I=u(I,P),I=d(I,31),I=u(I,T),b=p(b,I),b=d(b,27),b=l(b,S),b=l(u(b,[0,5]),[0,1390208809]),A=u(A,T),A=d(A,33),A=u(A,P),S=p(S,A),S=d(S,31),S=l(S,b),S=l(u(S,[0,5]),[0,944331445]);switch(I=[0,0],A=[0,0],w){case 15:A=p(A,f([0,g[R+14]],48));case 14:A=p(A,f([0,g[R+13]],40));case 13:A=p(A,f([0,g[R+12]],32));case 12:A=p(A,f([0,g[R+11]],24));case 11:A=p(A,f([0,g[R+10]],16));case 10:A=p(A,f([0,g[R+9]],8));case 9:A=p(A,[0,g[R+8]]),A=u(A,T),A=d(A,33),A=u(A,P),S=p(S,A);case 8:I=p(I,f([0,g[R+7]],56));case 7:I=p(I,f([0,g[R+6]],48));case 6:I=p(I,f([0,g[R+5]],40));case 5:I=p(I,f([0,g[R+4]],32));case 4:I=p(I,f([0,g[R+3]],24));case 3:I=p(I,f([0,g[R+2]],16));case 2:I=p(I,f([0,g[R+1]],8));case 1:I=p(I,[0,g[R]]),I=u(I,P),I=d(I,31),I=u(I,T),b=p(b,I)}return b=p(b,[0,g.length]),S=p(S,[0,g.length]),b=l(b,S),S=l(S,b),b=y(b),S=y(S),b=l(b,S),S=l(S,b),("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)+("00000000"+(S[0]>>>0).toString(16)).slice(-8)+("00000000"+(S[1]>>>0).toString(16)).slice(-8)},n.exports&&(t=n.exports=s),t.murmurHash3=s})()})(Bl,Bl.exports);var py=Bl.exports,my=py;const Uh=tn(my),yy=Math.LN2*Math.LN2;class wy{constructor(t={}){h(this,"seeds");h(this,"bits");h(this,"buffer");t.seeds!=null?this.seeds=t.seeds:this.seeds=vy(t.hashes??8),this.bits=t.bits??1024,this.buffer=Ue(Math.ceil(this.bits/8))}add(t){typeof t=="string"&&(t=Y(t));for(let e=0;e<this.seeds.length;e++){const s=Uh.x86.hash32(t,this.seeds[e])%this.bits;this.setbit(s)}}has(t){typeof t=="string"&&(t=Y(t));for(let e=0;e<this.seeds.length;e++){const s=Uh.x86.hash32(t,this.seeds[e])%this.bits;if(!this.getbit(s))return!1}return!0}clear(){this.buffer.fill(0)}setbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;let s=this.buffer[e];s|=1<<r,this.buffer[e]=s}getbit(t){let e=0,r=t;for(;r>7;)e++,r-=8;return(this.buffer[e]&1<<r)!==0}}function by(n,t=.005){const e=Ey(n,t);return new wy(e)}function Ey(n,t=.005){const e=Math.round(-1*n*Math.log(t)/yy),r=Math.round(e/n*Math.LN2);return{bits:e,hashes:r}}function vy(n){let t,e;const r=[];for(let s=0;s<n;s++)for(t=new Oe(as(4)),r[s]=t.getUint32(0,!0),e=0;e<s;e++)if(r[s]===r[e]){s--;break}return r}const j3=64;class Qn{constructor(t,e,r,s=2){h(this,"fp");h(this,"h");h(this,"seed");if(s>j3)throw new TypeError("Invalid Fingerprint Size");const i=e.hashV(t,r),o=Ue(s);for(let a=0;a<o.length;a++)o[a]=i[a];o.length===0&&(o[0]=7),this.fp=o,this.h=e,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(t){return(t==null?void 0:t.fp)instanceof Uint8Array?ke(this.fp,t.fp):!1}}function Ca(n,t){return Math.floor(Math.random()*(t-n))+n}class qo{constructor(t){h(this,"contents");this.contents=new Array(t).fill(null)}has(t){if(!(t instanceof Qn))throw new TypeError("Invalid Fingerprint");return this.contents.some(e=>t.equals(e))}add(t){if(!(t instanceof Qn))throw new TypeError("Invalid Fingerprint");for(let e=0;e<this.contents.length;e++)if(this.contents[e]==null)return this.contents[e]=t,!0;return!0}swap(t){if(!(t instanceof Qn))throw new TypeError("Invalid Fingerprint");const e=Ca(0,this.contents.length-1),r=this.contents[e];return this.contents[e]=t,r}remove(t){if(!(t instanceof Qn))throw new TypeError("Invalid Fingerprint");const e=this.contents.findIndex(r=>t.equals(r));return e>-1?(this.contents[e]=null,!0):!1}}const bu={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},e4={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},t4=new globalThis.TextEncoder;function _y(n,t){const e=bu[t];let r=e4[t];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(t,r*e);return r}function Sy(n,t,e){if(e.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=bu[t];let s=e4[t],i=n;for(;i.length>0;){const o=t4.encodeInto(i,e);i=i.slice(o.read);for(let a=0;a<o.written;a++)s^=BigInt(e[a]),s=BigInt.asUintN(t,s*r)}return s}function Iy(n,{size:t=32,utf8Buffer:e}={}){if(!bu[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(e)return Sy(n,t,e);n=t4.encode(n)}return _y(n,t)}const Eu={hash:n=>Number(Iy(n,{size:32})),hashV:(n,t)=>Ry(Eu.hash(n,t))};function Ry(n){let t=n.toString(16);return t.length%2===1&&(t=`0${t}`),Y(t,"base16")}const Ay=500;class Fh{constructor(t){h(this,"bucketSize");h(this,"filterSize");h(this,"fingerprintSize");h(this,"buckets");h(this,"count");h(this,"hash");h(this,"seed");this.filterSize=t.filterSize,this.bucketSize=t.bucketSize??4,this.fingerprintSize=t.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=t.hash??Eu,this.seed=t.seed??Ca(0,Math.pow(2,10))}add(t){typeof t=="string"&&(t=Y(t));const e=new Qn(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=(r^e.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new qo(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new qo(this.bucketSize)),this.buckets[r].add(e)||this.buckets[s].add(e))return this.count++,!0;const i=[r,s];let o=i[Ca(0,i.length-1)];this.buckets[o]==null&&(this.buckets[o]=new qo(this.bucketSize));for(let a=0;a<Ay;a++){const c=this.buckets[o].swap(e);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new qo(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(t){var o,a;typeof t=="string"&&(t=Y(t));const e=new Qn(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=((o=this.buckets[r])==null?void 0:o.has(e))??!1;if(s)return s;const i=(r^e.hash())%this.filterSize;return((a=this.buckets[i])==null?void 0:a.has(e))??!1}remove(t){var a,c;typeof t=="string"&&(t=Y(t));const e=new Qn(t,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(t,this.seed)%this.filterSize,s=((a=this.buckets[r])==null?void 0:a.remove(e))??!1;if(s)return this.count--,s;const i=(r^e.hash())%this.filterSize,o=((c=this.buckets[i])==null?void 0:c.remove(e))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=95}}const Ty={1:.5,2:.84,4:.95,8:.98};function Dy(n=.001){return n>.002?2:n>1e-5?4:8}function xy(n,t=.001){const e=Dy(t),r=Ty[e],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log(s/e))+2,j3);return{filterSize:s,bucketSize:e,fingerprintSize:i}}class Cy{constructor(t){h(this,"filterSize");h(this,"bucketSize");h(this,"fingerprintSize");h(this,"scale");h(this,"filterSeries");h(this,"hash");h(this,"seed");this.bucketSize=t.bucketSize??4,this.filterSize=t.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=t.fingerprintSize??2,this.scale=t.scale??2,this.hash=t.hash??Eu,this.seed=t.seed??Ca(0,Math.pow(2,10)),this.filterSeries=[new Fh({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(t){if(typeof t=="string"&&(t=Y(t)),this.has(t))return!0;let e=this.filterSeries.find(r=>r.reliable);if(e==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);e=new Fh({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(e)}return e.add(t)}has(t){typeof t=="string"&&(t=Y(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].has(t))return!0;return!1}remove(t){typeof t=="string"&&(t=Y(t));for(let e=0;e<this.filterSeries.length;e++)if(this.filterSeries[e].remove(t))return!0;return!1}get count(){return this.filterSeries.reduce((t,e)=>t+e.count,0)}}function r4(n,t=.001,e){return new Cy({...xy(n,t)})}class Py{constructor(t,e){h(this,"filter");this.filter=r4(t,e)}has(t){return this.filter.has(t.toBytes())}add(t){this.filter.add(t.toBytes())}remove(t){var e,r;(r=(e=this.filter).remove)==null||r.call(e,t.toBytes())}}function ky(n,t=.001){return new Py(n,t)}const Ny=async()=>{const n=await Dp("Ed25519"),t=await My(n);if(t.type==="Ed25519")return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};async function My(n){return Cr(cu(n.public),xp(n))}const Oy={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var Pa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.payloadType!=null&&e.payloadType.byteLength>0&&(r.uint32(18),r.bytes(e.payloadType)),e.payload!=null&&e.payload.byteLength>0&&(r.uint32(26),r.bytes(e.payload)),e.signature!=null&&e.signature.byteLength>0&&(r.uint32(42),r.bytes(e.signature)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.publicKey=e.bytes();break;case 2:s.payloadType=e.bytes();break;case 3:s.payload=e.bytes();break;case 5:s.signature=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Pa||(Pa={}));const fn=class fn{constructor(t){h(this,"peerId");h(this,"payloadType");h(this,"payload");h(this,"signature");h(this,"marshaled");const{peerId:e,payloadType:r,payload:s,signature:i}=t;this.peerId=e,this.payloadType=r,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=Pa.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(t){return ke(this.marshal(),t.marshal())}async validate(t){const e=Vh(t,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return ls(this.peerId.publicKey).verify(e.subarray(),this.signature)}};h(fn,"createFromProtobuf",async t=>{const e=Pa.decode(t),r=await Cr(e.publicKey);return new fn({peerId:r,payloadType:e.payloadType,payload:e.payload,signature:e.signature})}),h(fn,"seal",async(t,e)=>{if(e.privateKey==null)throw new Error("Missing private key");const r=t.domain,s=t.codec,i=t.marshal(),o=Vh(r,s,i),c=await(await Ji(e.privateKey)).sign(o.subarray());return new fn({peerId:e,payloadType:s,payload:i,signature:c})}),h(fn,"openAndCertify",async(t,e)=>{const r=await fn.createFromProtobuf(t);if(!await r.validate(e))throw new v("envelope signature is not valid for the given domain",Oy.ERR_SIGNATURE_NOT_VALID);return r});let Mn=fn;const Vh=(n,t,e)=>{const r=Y(n),s=ur(r.byteLength),i=ur(t.length),o=ur(e.length);return new Oe(s,r,i,t,o,e)};function Ly(n,t){const e=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==t.length?!1:(t.sort(e),n.sort(e).every((r,s)=>t[s].equals(r)))}const By="libp2p-peer-record",Uy=Uint8Array.from([3,1]);var ka;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={multiaddr:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.multiaddr=s.bytes();break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())})(n.AddressInfo||(n.AddressInfo={}));let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.peerId!=null&&e.peerId.byteLength>0&&(r.uint32(10),r.bytes(e.peerId)),e.seq!=null&&e.seq!==0n&&(r.uint32(16),r.uint64(e.seq)),e.addresses!=null)for(const i of e.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.peerId=e.bytes();break;case 2:s.seq=e.uint64();break;case 3:s.addresses.push(n.AddressInfo.codec().decode(e,e.uint32()));break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(ka||(ka={}));const $r=class $r{constructor(t){h(this,"peerId");h(this,"multiaddrs");h(this,"seqNumber");h(this,"domain",$r.DOMAIN);h(this,"codec",$r.CODEC);h(this,"marshaled");const{peerId:e,multiaddrs:r,seqNumber:s}=t;this.peerId=e,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=ka.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(t=>({multiaddr:t.bytes}))})),this.marshaled}equals(t){return!(!(t instanceof $r)||!this.peerId.equals(t.peerId)||this.seqNumber!==t.seqNumber||!Ly(this.multiaddrs,t.multiaddrs))}};h($r,"createFromProtobuf",t=>{const e=ka.decode(t),r=tr(e.peerId),s=(e.addresses??[]).map(o=>G(o.multiaddr)),i=e.seq;return new $r({peerId:r,multiaddrs:s,seqNumber:i})}),h($r,"DOMAIN",By),h($r,"CODEC",Uy);let Tr=$r;function Fy(n){return n[Symbol.asyncIterator]!=null}function Ul(n){if(Fy(n))return(async()=>{const e=[];for await(const r of n)e.push(r);return e})();const t=[];for(const e of n)t.push(e);return t}const xn={},us=n=>{n.addEventListener("message",t=>{us.dispatchEvent("message",n,t)}),n.port!=null&&n.port.addEventListener("message",t=>{us.dispatchEvent("message",n,t)})};us.addEventListener=(n,t)=>{xn[n]==null&&(xn[n]=[]),xn[n].push(t)};us.removeEventListener=(n,t)=>{xn[n]!=null&&(xn[n]=xn[n].filter(e=>e===t))};us.dispatchEvent=function(n,t,e){xn[n]!=null&&xn[n].forEach(r=>r(t,e))};const $h="lock:worker:request-read",Kh="lock:worker:release-read",Hh="lock:master:grant-read",zh="lock:worker:request-write",Wh="lock:worker:release-write",qh="lock:master:grant-write",Vy=(n=21)=>Math.random().toString().substring(2),Gh=(n,t,e,r,s)=>(i,o)=>{if(o.data.type!==e)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};n.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>{i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const l=u=>{if(u==null||u.data==null)return;const d={type:u.data.type,name:u.data.name,identifier:u.data.identifier};d.type===r&&d.identifier===a.identifier&&(i.removeEventListener("message",l),c())};i.addEventListener("message",l)})}}}))},Yh=(n,t,e,r)=>async()=>{const s=Vy();return globalThis.postMessage({type:t,identifier:s,name:n}),new Promise(i=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===e&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:r,identifier:s,name:n})}))};globalThis.addEventListener("message",o)})},$y={singleProcess:!1},Ky=n=>{if(n=Object.assign({},$y,n),!!globalThis.document||n.singleProcess){const e=new EventTarget;return us.addEventListener("message",Gh(e,"requestReadLock",$h,Kh,Hh)),us.addEventListener("message",Gh(e,"requestWriteLock",zh,Wh,qh)),e}return{isWorker:!0,readLock:e=>Yh(e,$h,Hh,Kh),writeLock:e=>Yh(e,zh,qh,Wh)}},$n={};let pn;async function Zc(n,t){let e;const r=new Promise(s=>{e=s});return n.add(async()=>Ao((async()=>{await new Promise(s=>{e(()=>{s()})})})(),{milliseconds:t.timeout})),r}const Hy=(n,t)=>{if(pn.isWorker===!0)return{readLock:pn.readLock(n,t),writeLock:pn.writeLock(n,t)};const e=new to({concurrency:1});let r;return{async readLock(){if(r!=null)return Zc(r,t);r=new to({concurrency:t.concurrency,autoStart:!1});const s=r,i=Zc(r,t);return e.add(async()=>{s.start(),await s.onIdle().then(()=>{r===s&&(r=null)})}),i},async writeLock(){return r=null,Zc(e,t)}}},zy={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Wy(n){const t=Object.assign({},zy,n);return pn==null&&(pn=Ky(t),pn.isWorker!==!0&&(pn.addEventListener("requestReadLock",e=>{$n[e.data.name]!=null&&$n[e.data.name].readLock().then(async r=>e.data.handler().finally(()=>{r()}))}),pn.addEventListener("requestWriteLock",async e=>{$n[e.data.name]!=null&&$n[e.data.name].writeLock().then(async r=>e.data.handler().finally(()=>{r()}))}))),$n[t.name]==null&&($n[t.name]=Hy(t.name,t)),$n[t.name]}const Ft={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var Na;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={key:"",value:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.key=s.string();break;case 2:o.value=s.bytes();break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Oa.codec().encode(s.value,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={key:""},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.key=s.string();break;case 2:o.value=Oa.codec().decode(s,s.uint32());break;default:s.skipType(c&7);break}}return o})),r),e.encode=s=>he(s,e.codec()),e.decode=s=>ue(s,e.codec())}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.addresses!=null)for(const i of e.addresses)r.uint32(10),Ma.codec().encode(i,r);if(e.protocols!=null)for(const i of e.protocols)r.uint32(18),r.string(i);if(e.publicKey!=null&&(r.uint32(34),r.bytes(e.publicKey)),e.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(e.peerRecordEnvelope)),e.metadata!=null&&e.metadata.size!==0)for(const[i,o]of e.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:o},r);if(e.tags!=null&&e.tags.size!==0)for(const[i,o]of e.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:o},r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.addresses.push(Ma.codec().decode(e,e.uint32()));break;case 2:s.protocols.push(e.string());break;case 4:s.publicKey=e.bytes();break;case 5:s.peerRecordEnvelope=e.bytes();break;case 6:{const a=n.Peer$metadataEntry.codec().decode(e,e.uint32());s.metadata.set(a.key,a.value);break}case 7:{const a=n.Peer$tagsEntry.codec().decode(e,e.uint32());s.tags.set(a.key,a.value);break}default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Na||(Na={}));var Ma;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.multiaddr!=null&&e.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(e.multiaddr)),e.isCertified!=null&&(r.uint32(16),r.bool(e.isCertified)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={multiaddr:new Uint8Array(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.multiaddr=e.bytes();break;case 2:s.isCertified=e.bool();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Ma||(Ma={}));var Oa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.value!=null&&e.value!==0&&(r.uint32(8),r.uint32(e.value)),e.expiry!=null&&(r.uint32(16),r.uint64(e.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={value:0},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:s.value=e.uint32();break;case 2:s.expiry=e.uint64();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Oa||(Oa={}));function Ni(n,t){const e=Na.decode(t);e.publicKey!=null&&n.publicKey==null&&(n=lg({...n,publicKey:n.publicKey}));const r=new Map,s=BigInt(Date.now());for(const[i,o]of e.tags.entries())o.expiry!=null&&o.expiry<s||r.set(i,o);return{...e,id:n,addresses:e.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:G(i),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}const n4="/peers/";function Ti(n){if(!D1(n)||n.type==null)throw new v("Invalid PeerId",Ft.ERR_INVALID_PARAMETERS);const t=n.toCID().toString();return new Be(`${n4}${t}`)}async function qy(n,t,e){const r=new Map;for(const s of e){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=G(s.multiaddr)),!ic(s.multiaddr))throw new v("Multiaddr was invalid",Ft.ERR_INVALID_PARAMETERS);if(!await t(n,s.multiaddr))continue;const i=s.isCertified??!1,o=s.multiaddr.toString(),a=r.get(o);a!=null?s.isCertified=a.isCertified||i:r.set(o,{multiaddr:s.multiaddr,isCertified:i})}return[...r.values()].sort((s,i)=>s.multiaddr.toString().localeCompare(i.multiaddr.toString())).map(({isCertified:s,multiaddr:i})=>({isCertified:s,multiaddr:i.bytes}))}async function Jc(n,t,e,r){if(t==null)throw new v("Invalid PeerData",Ft.ERR_INVALID_PARAMETERS);if(t.publicKey!=null&&n.publicKey!=null&&!ke(t.publicKey,n.publicKey))throw new v("publicKey bytes do not match peer id publicKey bytes",Ft.ERR_INVALID_PARAMETERS);const s=r.existingPeer;if(s!=null&&!n.equals(s.id))throw new v("peer id did not match existing peer id",Ft.ERR_INVALID_PARAMETERS);let i=(s==null?void 0:s.addresses)??[],o=new Set((s==null?void 0:s.protocols)??[]),a=(s==null?void 0:s.metadata)??new Map,c=(s==null?void 0:s.tags)??new Map,l=s==null?void 0:s.peerRecordEnvelope;if(e==="patch"){if((t.multiaddrs!=null||t.addresses!=null)&&(i=[],t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses)),t.protocols!=null&&(o=new Set(t.protocols)),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);a=Go(d,{validate:Qh})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags);c=Go(d,{validate:Xh,map:Zh})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}if(e==="merge"){if(t.multiaddrs!=null&&i.push(...t.multiaddrs.map(d=>({isCertified:!1,multiaddr:d}))),t.addresses!=null&&i.push(...t.addresses),t.protocols!=null&&(o=new Set([...o,...t.protocols])),t.metadata!=null){const d=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[f,p]of d)p==null?a.delete(f):a.set(f,p);a=Go([...a.entries()],{validate:Qh})}if(t.tags!=null){const d=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),f=new Map(c);for(const[p,y]of d)y==null?f.delete(p):f.set(p,y);c=Go([...f.entries()],{validate:Xh,map:Zh})}t.peerRecordEnvelope!=null&&(l=t.peerRecordEnvelope)}const u={addresses:await qy(n,r.addressFilter??(async()=>!0),i),protocols:[...o.values()].sort((d,f)=>d.localeCompare(f)),metadata:a,tags:c,publicKey:(s==null?void 0:s.id.publicKey)??t.publicKey??n.publicKey,peerRecordEnvelope:l};return n.type!=="RSA"&&delete u.publicKey,u}function Go(n,t){var r;const e=new Map;for(const[s,i]of n)i!=null&&t.validate(s,i);for(const[s,i]of n.sort(([o],[a])=>o.localeCompare(a)))i!=null&&e.set(s,((r=t.map)==null?void 0:r.call(t,s,i))??i);return e}function Qh(n,t){if(typeof n!="string")throw new v("Metadata key must be a string",Ft.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new v("Metadata value must be a Uint8Array",Ft.ERR_INVALID_PARAMETERS)}function Xh(n,t){if(typeof n!="string")throw new v("Tag name must be a string",Ft.ERR_INVALID_PARAMETERS);if(t.value!=null){if(parseInt(`${t.value}`,10)!==t.value)throw new v("Tag value must be an integer",Ft.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new v("Tag value must be between 0-100",Ft.ERR_INVALID_PARAMETERS)}if(t.ttl!=null){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new v("Tag ttl must be an integer",Ft.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new v("Tag ttl must be between greater than 0",Ft.ERR_INVALID_PARAMETERS)}}function Zh(n,t){let e;return t.expiry!=null&&(e=t.expiry),t.ttl!=null&&(e=BigInt(Date.now()+Number(t.ttl))),{value:t.value??0,expiry:e}}function aa(n,t,e){const r=n.toString().split("/")[2],s=Qr.decode(r),i=tr(s),o=e.get(i);if(o!=null)return o;const a=Ni(i,t);return e.set(i,a),a}function Gy(n,t){return n==null?{}:{prefix:n4,filters:(n.filters??[]).map(e=>({key:r,value:s})=>e(aa(r,s,t))),orders:(n.orders??[]).map(e=>(r,s)=>e(aa(r.key,r.value,t),aa(s.key,s.value,t)))}}var xr,ca,la;class Yy{constructor(t,e={}){j(this,xr);h(this,"peerId");h(this,"datastore");h(this,"lock");h(this,"addressFilter");this.peerId=t.peerId,this.datastore=t.datastore,this.addressFilter=e.addressFilter,this.lock=Wy({name:"peer-store",singleProcess:!0})}async has(t){return this.datastore.has(Ti(t))}async delete(t){if(this.peerId.equals(t))throw new v("Cannot delete self peer",Ft.ERR_INVALID_PARAMETERS);await this.datastore.delete(Ti(t))}async load(t){const e=await this.datastore.get(Ti(t));return Ni(t,e)}async save(t,e){const{existingBuf:r,existingPeer:s}=await O(this,xr,ca).call(this,t),i=await Jc(t,e,"patch",{addressFilter:this.addressFilter});return O(this,xr,la).call(this,t,i,r,s)}async patch(t,e){const{existingBuf:r,existingPeer:s}=await O(this,xr,ca).call(this,t),i=await Jc(t,e,"patch",{addressFilter:this.addressFilter,existingPeer:s});return O(this,xr,la).call(this,t,i,r,s)}async merge(t,e){const{existingBuf:r,existingPeer:s}=await O(this,xr,ca).call(this,t),i=await Jc(t,e,"merge",{addressFilter:this.addressFilter,existingPeer:s});return O(this,xr,la).call(this,t,i,r,s)}async*all(t){const e=new Es;for await(const{key:r,value:s}of this.datastore.query(Gy(t??{},e))){const i=aa(r,s,e);i.id.equals(this.peerId)||(yield i)}}}xr=new WeakSet,ca=async function(t){try{const e=await this.datastore.get(Ti(t)),r=Ni(t,e);return{existingBuf:e,existingPeer:r}}catch(e){if(e.code!=="ERR_NOT_FOUND")throw e}return{}},la=async function(t,e,r,s){const i=Na.encode(e);return r!=null&&ke(i,r)?{peer:Ni(t,i),previous:s,updated:!1}:(await this.datastore.put(Ti(t),i),{peer:Ni(t,i),previous:s,updated:!0})};var g0,Vs,ua;g0=Symbol.toStringTag;class Qy{constructor(t,e={}){j(this,Vs);h(this,"store");h(this,"events");h(this,"peerId");h(this,"log");h(this,g0,"@libp2p/peer-store");this.log=t.logger.forComponent("libp2p:peer-store"),this.events=t.events,this.peerId=t.peerId,this.store=new Yy(t,e)}async forEach(t,e){this.log.trace("forEach await read lock");const r=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const s of this.store.all(e))t(s)}finally{this.log.trace("forEach release read lock"),r()}}async all(t){this.log.trace("all await read lock");const e=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await Ul(this.store.all(t))}finally{this.log.trace("all release read lock"),e()}}async delete(t){this.log.trace("delete await write lock");const e=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(t)}finally{this.log.trace("delete release write lock"),e()}}async has(t){this.log.trace("has await read lock");const e=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(t)}finally{this.log.trace("has release read lock"),e()}}async get(t){this.log.trace("get await read lock");const e=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(t)}finally{this.log.trace("get release read lock"),e()}}async save(t,e){this.log.trace("save await write lock");const r=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const s=await this.store.save(t,e);return O(this,Vs,ua).call(this,t,s),s.peer}finally{this.log.trace("save release write lock"),r()}}async patch(t,e){this.log.trace("patch await write lock");const r=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const s=await this.store.patch(t,e);return O(this,Vs,ua).call(this,t,s),s.peer}finally{this.log.trace("patch release write lock"),r()}}async merge(t,e){this.log.trace("merge await write lock");const r=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const s=await this.store.merge(t,e);return O(this,Vs,ua).call(this,t,s),s.peer}finally{this.log.trace("merge release write lock"),r()}}async consumePeerRecord(t,e){const r=await Mn.openAndCertify(t,Tr.DOMAIN);if((e==null?void 0:e.equals(r.peerId))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",e,r.peerId),!1;const s=Tr.createFromProtobuf(r.payload);let i;try{i=await this.get(r.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if((i==null?void 0:i.peerRecordEnvelope)!=null){const o=await Mn.createFromProtobuf(i.peerRecordEnvelope),a=Tr.createFromProtobuf(o.payload);if(a.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:t,addresses:s.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}}Vs=new WeakSet,ua=function(t,e){e.updated&&(this.peerId.equals(t)?this.events.safeDispatchEvent("self:peer:update",{detail:e}):this.events.safeDispatchEvent("peer:update",{detail:e}))};function Xy(n){return n[Symbol.asyncIterator]!=null}function ro(n){if(Xy(n))return(async()=>{for await(const t of n);})();for(const t of n);}function Zy(n){return n[Symbol.asyncIterator]!=null}function dn(n,t){let e=0;if(Zy(n))return async function*(){for await(const c of n)await t(c,e++)&&(yield c)}();const r=B1(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof o.then=="function")return async function*(){await o&&(yield s);for await(const c of r)await t(c,e++)&&(yield c)}();const a=t;return function*(){o===!0&&(yield s);for(const c of r)a(c,e++)&&(yield c)}()}function Jy(n){return n[Symbol.asyncIterator]!=null}function La(n,t){return Jy(n)?async function*(){yield*(await Ul(n)).sort(t)}():function*(){yield*Ul(n).sort(t)}()}function jy(n){return n[Symbol.asyncIterator]!=null}function Fl(n,t){return jy(n)?async function*(){let e=0;if(!(t<1)){for await(const r of n)if(yield r,e++,e===t)return}}():function*(){let e=0;if(!(t<1)){for(const r of n)if(yield r,e++,e===t)return}}()}class s4{put(t,e,r){return Promise.reject(new Error(".put is not implemented"))}get(t,e){return Promise.reject(new Error(".get is not implemented"))}has(t,e){return Promise.reject(new Error(".has is not implemented"))}delete(t,e){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(t,e={}){for await(const{key:r,value:s}of t)await this.put(r,s,e),yield r}async*getMany(t,e={}){for await(const r of t)yield{key:r,value:await this.get(r,e)}}async*deleteMany(t,e={}){for await(const r of t)await this.delete(r,e),yield r}batch(){let t=[],e=[];return{put(r,s){t.push({key:r,value:s})},delete(r){e.push(r)},commit:async r=>{await ro(this.putMany(t,r)),t=[],await ro(this.deleteMany(e,r)),e=[]}}}async*_all(t,e){throw new Error("._all is not implemented")}async*_allKeys(t,e){throw new Error("._allKeys is not implemented")}query(t,e){let r=this._all(t,e);if(t.prefix!=null){const s=t.prefix;r=dn(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>dn(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>La(s,i),r)),t.offset!=null){let s=0;const i=t.offset;r=dn(r,()=>s++>=i)}return t.limit!=null&&(r=Fl(r,t.limit)),r}queryKeys(t,e){let r=this._allKeys(t,e);if(t.prefix!=null){const s=t.prefix;r=dn(r,i=>i.toString().startsWith(s))}if(Array.isArray(t.filters)&&(r=t.filters.reduce((s,i)=>dn(s,i),r)),Array.isArray(t.orders)&&(r=t.orders.reduce((s,i)=>La(s,i),r)),t.offset!=null){const s=t.offset;let i=0;r=dn(r,()=>i++>=s)}return t.limit!=null&&(r=Fl(r,t.limit)),r}}function ew(n){return n=n??new Error("Cannot open database"),Ce(n,"ERR_DB_OPEN_FAILED")}function tw(n){return n=n??new Error("Delete failed"),Ce(n,"ERR_DB_DELETE_FAILED")}function rw(n){return n=n??new Error("Write failed"),Ce(n,"ERR_DB_WRITE_FAILED")}function Jh(n){return n=n??new Error("Read failed"),Ce(n,"ERR_DB_READ_FAILED")}function i4(n){return n=n??new Error("Not Found"),Ce(n,"ERR_NOT_FOUND")}class nw extends s4{constructor(){super();h(this,"data");this.data=new Map}put(e,r){return this.data.set(e.toString(),r),e}get(e){const r=this.data.get(e.toString());if(r==null)throw i4();return r}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,r]of this.data.entries())yield{key:new Be(e),value:r}}*_allKeys(){for(const e of this.data.keys())yield new Be(e)}}function sw(n,t){let e;return function(){const r=function(){e=void 0,n()};clearTimeout(e),e=setTimeout(r,t)}}const iw=n=>n;function jc(n,t){const e=n.getPeerId();return e!=null&&ye(e).equals(t)&&(n=n.decapsulate(G(`/p2p/${t.toString()}`))),n}var p0;p0=Symbol.toStringTag;class ow{constructor(t,e={}){h(this,"log");h(this,"components");h(this,"listen");h(this,"announce");h(this,"observed");h(this,"announceFilter");h(this,p0,"@libp2p/address-manager");const{listen:r=[],announce:s=[]}=e;this.components=t,this.log=t.logger.forComponent("libp2p:address-manager"),this.listen=r.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Map,this.announceFilter=e.announceFilter??iw,this._updatePeerStoreAddresses=sw(this._updatePeerStoreAddresses.bind(this),1e3),t.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),t.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const t=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([e,r])=>r.confident).map(([e])=>G(e))).map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:t}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(t=>G(t))}getAnnounceAddrs(){return Array.from(this.announce).map(t=>G(t))}getObservedAddrs(){return Array.from(this.observed).map(([t])=>G(t))}addObservedAddr(t){t=jc(t,this.components.peerId);const e=t.toString();this.observed.has(e)||this.observed.set(e,{confident:!1})}confirmObservedAddr(t){t=jc(t,this.components.peerId);const e=t.toString(),s=(this.observed.get(e)??{confident:!1}).confident;this.observed.set(e,{confident:!0}),s||this._updatePeerStoreAddresses()}removeObservedAddr(t){t=jc(t,this.components.peerId);const e=t.toString();this.observed.delete(e)}getAddresses(){let t=this.getAnnounceAddrs().map(r=>r.toString());t.length===0&&(t=this.components.transportManager.getAddrs().map(r=>r.toString())),t=t.concat(Array.from(this.observed).filter(([r,s])=>s.confident).map(([r])=>r));const e=new Set(t);return this.announceFilter(Array.from(e).map(r=>G(r))).map(r=>{var s;return((s=r.protos().pop())==null?void 0:s.path)===!0||r.getPeerId()===this.components.peerId.toString()?r:r.encapsulate(`/p2p/${this.components.peerId.toString()}`)})}}class aw{constructor(t={}){h(this,"components",{});h(this,"_started",!1);this.components={};for(const[e,r]of Object.entries(t))this.components[e]=r;this.components.logger==null&&(this.components.logger=V2())}isStarted(){return this._started}async _invokeStartableMethod(t){await Promise.all(Object.values(this.components).filter(e=>C1(e)).map(async e=>{var r;await((r=e[t])==null?void 0:r.call(e))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const cw=["metrics","connectionProtector","dns"],lw=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function uw(n={}){const t=new aw(n);return new Proxy(t,{get(r,s,i){if(typeof s=="string"&&!lw.includes(s)){const o=t.components[s];if(o==null&&!cw.includes(s))throw new v(`${s} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?t.components[s]=i:Reflect.set(r,s,i),!0}})}function hw(n){const t={};for(const e of Object.values(n.components))for(const r of dw(e))t[r]=!0;for(const e of Object.values(n.components))for(const r of fw(e))if(t[r]!==!0)throw new v(`Service "${gw(e)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`,"ERR_UNMET_SERVICE_DEPENDENCIES")}function dw(n){return Array.isArray(n==null?void 0:n[jt])?n[jt]:[]}function fw(n){return Array.isArray(n==null?void 0:n[rs])?n[rs]:[]}function gw(n){return(n==null?void 0:n[Symbol.toStringTag])??(n==null?void 0:n.toString())??"unknown"}var o4;(function(){var n,t,e,r,s,i,o,a;a=function(c){var l,u,d,f;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,d=(c&65280)>>>8,f=c&255,[l,u,d,f].join(".")},o=function(c){var l,u,d,f,p,y;for(l=[],d=f=0;f<=3&&c.length!==0;d=++f){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}y=t(c),p=y[0],u=y[1],c=c.substring(u),l.push(p)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},e=function(c){return c.charCodeAt(0)},r=e("0"),i=e("a"),s=e("A"),t=function(c){var l,u,d,f,p;for(f=0,l=10,u="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,l=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,l=8,u="7")),p=d;d<c.length;){if("0"<=c[d]&&c[d]<=u)f=f*l+(e(c[d])-r)>>>0;else if(l===16)if("a"<=c[d]&&c[d]<="f")f=f*l+(10+e(c[d])-i)>>>0;else if("A"<=c[d]&&c[d]<="F")f=f*l+(10+e(c[d])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");d++}if(d===p)throw new Error("empty octet");return[f,d]},n=function(){function c(l,u){var d,f,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(p=l.split("/",2),l=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch{throw new Error("Invalid mask: "+u)}for(d=f=32;f>=0;d=--f)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,d,f;for(f=o(this.first),d=o(this.last),u=0;f<=d;)l(a(f),f,u),u++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),o4=n}).call(F2);const pw=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],mw=pw.map(n=>new o4(n));function yw(n){for(const t of mw)if(t.contains(n))return!0;return!1}function ww(n){return/^::$/.test(n)||/^::1$/.test(n)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function To(n){return P1(n)?yw(n):k1(n)?ww(n):void 0}function bw(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async t=>{const e=t.stringTuples();return e[0][0]===4||e[0][0]===41?!!To(`${e[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const Ew=n=>n.toString().split("/").slice(1),Do=n=>({match:t=>t.length<1?!1:n(t[0])?t.slice(1):!1,pattern:"fn"}),ve=n=>({match:t=>Do(e=>e===n).match(t),pattern:n}),wc=()=>({match:n=>Do(t=>typeof t=="string").match(n),pattern:"{string}"}),bc=()=>({match:n=>Do(t=>!isNaN(parseInt(t))).match(n),pattern:"{number}"}),ot=()=>({match:n=>{if(n.length<2||n[0]!=="p2p"&&n[0]!=="ipfs")return!1;if(n[1].startsWith("Q")||n[1].startsWith("1"))try{gt.decode(`z${n[1]}`)}catch{return!1}else return!1;return n.slice(2)},pattern:"/p2p/{peerid}"}),Ba=()=>({match:n=>{if(n.length<2||n[0]!=="certhash")return!1;try{g2.decode(n[1])}catch{return!1}return n.slice(2)},pattern:"/certhash/{certhash}"}),Je=n=>({match:t=>{const e=n.match(t);return e===!1?t:e},pattern:`optional(${n.pattern})`}),er=(...n)=>({match:t=>{let e;for(const r of n){const s=r.match(t);s!==!1&&(e==null||s.length<e.length)&&(e=s)}return e??!1},pattern:`or(${n.map(t=>t.pattern).join(", ")})`}),Re=(...n)=>({match:t=>{for(const e of n){const r=e.match(t);if(r===!1)return!1;t=r}return t},pattern:`and(${n.map(t=>t.pattern).join(", ")})`});function wi(...n){function t(s){let i=Ew(s);for(const o of n){const a=o.match(i);if(a===!1)return!1;i=a}return i}function e(s){return t(s)!==!1}function r(s){const i=t(s);return i===!1?!1:i.length===0}return{matches:e,exactMatch:r}}const a4=Re(ve("dns4"),wc()),c4=Re(ve("dns6"),wc()),l4=Re(ve("dnsaddr"),wc()),u4=Re(ve("dns"),wc()),vw=wi(er(u4,l4,a4,c4)),_w=Re(ve("ip4"),Do(P1)),Sw=Re(ve("ip6"),Do(k1)),h4=er(_w,Sw),Dr=er(h4,u4,a4,c4,l4),Iw=wi(Dr),Rw=wi(h4),d4=Re(Dr,ve("tcp"),bc()),Ec=Re(Dr,ve("udp"),bc()),f4=Re(Ec,ve("quic")),vu=Re(Ec,ve("quic-v1")),Aw=er(f4,vu),Vl=er(Dr,d4,Ec,f4,vu),Tw=er(Re(Vl,ve("ws"),Je(ot()))),Dw=er(Re(Vl,ve("wss"),Je(ot())),Re(Vl,ve("tls"),ve("ws"),Je(ot()))),xw=Re(Ec,ve("webrtc-direct"),Je(Ba()),Je(Ba()),Je(ot())),g4=Re(vu,ve("webtransport"),Je(Ba()),Je(Ba()),Je(ot())),p4=wi(g4),$l=er(Tw,Dw,Re(d4,Je(ot())),Re(Aw,Je(ot())),Re(Dr,Je(ot())),xw,g4,ot()),Cw=Re($l,ve("p2p-circuit"),ot()),Ua=wi(Cw),Pw=er(Re($l,ve("p2p-circuit"),ve("webrtc"),Je(ot())),Re($l,ve("webrtc"),Je(ot())),ve("webrtc")),kw=wi(Pw);er(Re(Dr,ve("tcp"),bc(),ve("http"),Je(ot())),Re(Dr,ve("http"),Je(ot())));er(Re(Dr,ve("tcp"),er(Re(ve("443"),ve("http")),Re(bc(),ve("https"))),Je(ot())),Re(Dr,ve("tls"),ve("http"),Je(ot())),Re(Dr,ve("https"),Je(ot())));function jh(n){try{const{address:t}=n.nodeAddress();return!!To(t)}catch{return!0}}function Nw(n,t){const e=jh(n.multiaddr),r=jh(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function Mw(n,t){return n.isCertified&&!t.isCertified?-1:!n.isCertified&&t.isCertified?1:0}function Ow(n,t){const e=Ua.exactMatch(n.multiaddr),r=Ua.exactMatch(t.multiaddr);return e&&!r?1:!e&&r?-1:0}function _u(n,t){const e=Nw(n,t);if(e!==0)return e;const r=Ow(n,t);return r!==0?r:Mw(n,t)}class Fa extends Event{constructor(t,e){super(t),this.detail=e}}function m4(n){const t=[On.A];return n==null?t:Array.isArray(n)?n.length===0?t:n:[n]}const y4=60;function w4(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(t=>({name:t.name,type:On[t.type]})),Answer:(n.Answer??n.answers??[]).map(t=>({name:t.name,type:On[t.type],TTL:t.TTL??t.ttl??y4,data:t.data instanceof Uint8Array?X(t.data):t.data}))}}const Lw=4;function ed(n,t={}){const e=new to({concurrency:t.queryConcurrency??Lw});return async(r,s={})=>{var a;const i=new URLSearchParams;i.set("name",r),m4(s.types).forEach(c=>{i.append("type",On[c])}),(a=s.onProgress)==null||a.call(s,new Fa("dns:query",{detail:r}));const o=await e.add(async()=>{var u;const c=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s==null?void 0:s.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=w4(await c.json());return(u=s.onProgress)==null||u.call(s,new Fa("dns:response",{detail:l})),l},{signal:s.signal});if(o==null)throw new Error("No DNS response received");return o}}function Bw(){return[ed("https://cloudflare-dns.com/dns-query"),ed("https://dns.google/resolve")]}var Uw=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,e=Object.create(null),r=Object.create(null);function s(i,o){e[i]=o,t++,t>=n&&(t=0,r=e,e=Object.create(null))}return{has:function(i){return e[i]!==void 0||r[i]!==void 0},remove:function(i){e[i]!==void 0&&(e[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var o=e[i];if(o!==void 0)return o;if((o=r[i])!==void 0)return s(i,o),o},set:function(i,o){e[i]!==void 0?e[i]=o:s(i,o)},clear:function(){e=Object.create(null),r=Object.create(null)}}};const b4=tn(Uw);class Fw{constructor(t){h(this,"lru");this.lru=b4(t)}get(t,e){let r=!0;const s=[];for(const i of e){const o=this.getAnswers(t,i);if(o.length===0){r=!1;break}s.push(...o)}if(r)return w4({answers:s})}getAnswers(t,e){const r=`${t.toLowerCase()}-${e}`,s=this.lru.get(r);if(s!=null){const i=s.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:On[a.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(t,e){const r=`${t.toLowerCase()}-${e.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(e.TTL??y4)*1e3,value:e}),this.lru.set(r,s)}remove(t,e){const r=`${t.toLowerCase()}-${e}`;this.lru.remove(r)}clear(){this.lru.clear()}}function Vw(n){return new Fw(n)}const $w=1e3;let Kw=class{constructor(t){h(this,"resolvers");h(this,"cache");this.resolvers={},this.cache=Vw(t.cacheSize??$w),Object.entries(t.resolvers??{}).forEach(([e,r])=>{Array.isArray(r)||(r=[r]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=r}),this.resolvers["."]==null&&(this.resolvers["."]=Bw())}async query(t,e={}){var c,l,u;const r=m4(e.types),s=e.cached!==!1?this.cache.get(t,r):void 0;if(s!=null)return(c=e.onProgress)==null||c.call(e,new Fa("dns:cache",{detail:s})),s;const i=`${t.split(".").pop()}.`,o=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const d of o){if(((l=e.signal)==null?void 0:l.aborted)===!0)break;try{const f=await d(t,{...e,types:r});for(const p of f.Answer)this.cache.add(t,p);return f}catch(f){a.push(f),(u=e.onProgress)==null||u.call(e,new Fa("dns:error",{detail:f}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${t} ${r} failed`)}};var On;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(On||(On={}));function Hw(n={}){return new Kw(n)}const zw=32,{code:Ww}=ce("dnsaddr"),Su=async function(t,e={}){const r=e.maxRecursiveDepth??zw;if(r===0)throw new v("Max recursive depth reached","ERR_MAX_RECURSIVE_DEPTH_REACHED");const[,s]=t.stringTuples().find(([l])=>l===Ww)??[],o=await((e==null?void 0:e.dns)??Hw()).query(`_dnsaddr.${s}`,{signal:e==null?void 0:e.signal,types:[On.TXT]}),a=t.getPeerId(),c=[];for(const l of o.Answer){const u=l.data.replace(/["']/g,"").trim().split("=")[1];if(u==null||a!=null&&!u.includes(a))continue;const d=G(u);if(u.startsWith("/dnsaddr")){const f=await d.resolve({...e,maxRecursiveDepth:r-1});c.push(...f.map(p=>p.toString()))}else c.push(d.toString())}return c};var qw=n=>{if(Object.prototype.toString.call(n)!=="[object Object]")return!1;const t=Object.getPrototypeOf(n);return t===null||t===Object.prototype};const Va=qw,{hasOwnProperty:E4}=Object.prototype,{propertyIsEnumerable:Gw}=Object,ti=(n,t,e)=>Object.defineProperty(n,t,{value:e,writable:!0,enumerable:!0,configurable:!0}),Yw=F2,td={concatArrays:!1,ignoreUndefined:!1},vc=n=>{const t=[];for(const e in n)E4.call(n,e)&&t.push(e);if(Object.getOwnPropertySymbols){const e=Object.getOwnPropertySymbols(n);for(const r of e)Gw.call(n,r)&&t.push(r)}return t};function bi(n){return Array.isArray(n)?Qw(n):Va(n)?Xw(n):n}function Qw(n){const t=n.slice(0,0);return vc(n).forEach(e=>{ti(t,e,bi(n[e]))}),t}function Xw(n){const t=Object.getPrototypeOf(n)===null?Object.create(null):{};return vc(n).forEach(e=>{ti(t,e,bi(n[e]))}),t}const v4=(n,t,e,r)=>(e.forEach(s=>{typeof t[s]>"u"&&r.ignoreUndefined||(s in n&&n[s]!==Object.getPrototypeOf(n)?ti(n,s,Kl(n[s],t[s],r)):ti(n,s,bi(t[s])))}),n),Zw=(n,t,e)=>{let r=n.slice(0,0),s=0;return[n,t].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)E4.call(i,a)&&(o.push(String(a)),i===n?ti(r,s++,i[a]):ti(r,s++,bi(i[a])));r=v4(r,i,vc(i).filter(a=>!o.includes(a)),e)}),r};function Kl(n,t,e){return e.concatArrays&&Array.isArray(n)&&Array.isArray(t)?Zw(n,t,e):!Va(t)||!Va(n)?bi(t):v4(n,t,vc(t),e)}var Jw=function(...n){const t=Kl(bi(td),this!==Yw&&this||{},td);let e={_:{}};for(const r of n)if(r!==void 0){if(!Va(r))throw new TypeError("`"+r+"` is not an Option Object");e=Kl(e,{_:r},t)}return e._};const _4=tn(Jw);var ri;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",n.NOT_FOUND="Not found"})(ri||(ri={}));var Q;(function(n){n.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",n.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",n.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",n.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",n.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",n.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",n.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",n.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",n.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",n.ERR_DIALED_SELF="ERR_DIALED_SELF",n.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",n.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",n.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",n.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",n.ERR_INVALID_KEY="ERR_INVALID_KEY",n.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_INVALID_PEER="ERR_INVALID_PEER",n.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",n.ERR_NOT_FOUND="ERR_NOT_FOUND",n.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",n.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",n.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",n.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",n.ERR_FIND_SELF="ERR_FIND_SELF",n.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",n.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",n.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",n.ERR_INVALID_CMS="ERR_INVALID_CMS",n.ERR_MISSING_KEYS="ERR_MISSING_KEYS",n.ERR_NO_KEY="ERR_NO_KEY",n.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",n.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",n.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",n.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",n.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",n.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",n.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",n.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",n.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",n.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",n.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",n.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",n.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",n.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",n.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",n.ERR_INVALID_RECORD="ERR_INVALID_RECORD",n.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",n.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",n.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(Q||(Q={}));const jw={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:Su},addressSorter:_u},transportManager:{faultTolerance:Cs.FATAL_ALL}};async function eb(n){var e,r;const t=_4(jw,n);if(t.connectionProtector===null&&((r=(e=globalThis.process)==null?void 0:e.env)==null?void 0:r.LIBP2P_FORCE_PNET)!=null)throw new v(ri.ERR_PROTECTOR_REQUIRED,Q.ERR_PROTECTOR_REQUIRED);if(t.privateKey!=null&&!(await Cr(t.privateKey.public.bytes,t.privateKey.bytes)).equals(t.peerId))throw new v("Private key doesn't match peer id",Q.ERR_INVALID_KEY);return t}const rd=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},tb=new WeakMap;function rb({clearTimeout:n,setTimeout:t}={}){return(e,{value:r,signal:s}={})=>{if(s!=null&&s.aborted)return Promise.reject(rd());let i,o,a;const c=n??clearTimeout,l=()=>{c(i),a(rd())},u=()=>{s&&s.removeEventListener("abort",l)},d=new Promise((f,p)=>{o=()=>{u(),f(r)},a=p,i=(t??setTimeout)(o,e)});return s&&s.addEventListener("abort",l,{once:!0}),tb.set(d,()=>{c(i),i=null,o()}),d}}const S4=rb();class nb{constructor(t={}){h(this,"memoryStorage");h(this,"points");h(this,"duration");h(this,"blockDuration");h(this,"execEvenly");h(this,"execEvenlyMinDelayMs");h(this,"keyPrefix");this.points=t.points??4,this.duration=t.duration??1,this.blockDuration=t.blockDuration??0,this.execEvenly=t.execEvenly??!1,this.execEvenlyMinDelayMs=t.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=t.keyPrefix??"rlflx",this.memoryStorage=new sb}async consume(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r);let o=this.memoryStorage.incrby(s,e,i);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+e&&(o=this.memoryStorage.set(s,o.consumedPoints,this.blockDuration)),new v("Rate limit exceeded","ERR_RATE_LIMIT_EXCEEDED",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await S4(a)}return o}penalty(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(t,e=1,r={}){const s=this.getKey(t),i=this._getKeySecDuration(r),o=this.memoryStorage.incrby(s,-e,i);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(t,e){const r=e*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(t),s,e),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(t,e,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(t),e,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:e,isFirstInDuration:!1}}get(t){const e=this.memoryStorage.get(this.getKey(t));return e!=null&&(e.remainingPoints=Math.max(this.points-e.consumedPoints,0)),e}delete(t){this.memoryStorage.delete(this.getKey(t))}_getKeySecDuration(t){return(t==null?void 0:t.customDuration)!=null&&t.customDuration>=0?t.customDuration:this.duration}getKey(t){return this.keyPrefix.length>0?`${this.keyPrefix}:${t}`:t}parseKey(t){return t.substring(this.keyPrefix.length)}}class sb{constructor(){h(this,"storage");this.storage=new Map}incrby(t,e,r){const s=this.storage.get(t);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=e,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(t,e,r)}return this.set(t,e,r)}set(t,e,r){const s=r*1e3,i=this.storage.get(t);i!=null&&clearTimeout(i.timeoutId);const o={value:e,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(t,o),s>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(t)},s),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:o.value,isFirstInDuration:!0}}get(t){const e=this.storage.get(t);if(e!=null)return{remainingPoints:0,msBeforeNext:e.expiresAt!=null?e.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:e.value,isFirstInDuration:!1}}delete(t){const e=this.storage.get(t);return e!=null?(e.timeoutId!=null&&clearTimeout(e.timeoutId),this.storage.delete(t),!0):!1}}function I4(n){if(D1(n))return{peerId:n,multiaddrs:[]};Array.isArray(n)||(n=[n]);let t;if(n.length>0){const e=n[0].getPeerId();t=e==null?void 0:ye(e),n.forEach(r=>{if(!ic(r))throw new v("Invalid Multiaddr",Q.ERR_INVALID_MULTIADDR);const s=r.getPeerId();if(s==null){if(t!=null)throw new v("Multiaddrs must all have the same peer id or have no peer id",Q.ERR_INVALID_PARAMETERS)}else{const i=ye(s);if(t==null||!t.equals(i))throw new v("Multiaddrs must all have the same peer id or have no peer id",Q.ERR_INVALID_PARAMETERS)}})}return{peerId:t,multiaddrs:n}}class ib extends Error{constructor(e,r){super(e??"The operation was aborted");h(this,"type");h(this,"code");this.type="aborted",this.name="AbortError",this.code=r??"ABORT_ERR"}}async function ha(n,t,e,r){const s=new ib(r==null?void 0:r.errorMessage,r==null?void 0:r.errorCode);return(e==null?void 0:e.aborted)===!0?Promise.reject(s):new Promise((i,o)=>{function a(){e==null||e.removeEventListener("abort",u),n.removeEventListener(t,c),(r==null?void 0:r.errorEvent)!=null&&n.removeEventListener(r.errorEvent,l)}const c=d=>{var f;try{if(((f=r==null?void 0:r.filter)==null?void 0:f.call(r,d))===!1)return}catch(p){a(),o(p);return}a(),i(d)},l=d=>{a(),o(d.detail)},u=()=>{a(),o(s)};e==null||e.addEventListener("abort",u),n.addEventListener(t,c),(r==null?void 0:r.errorEvent)!=null&&n.addEventListener(r.errorEvent,l)})}class ob{constructor(t){h(this,"deferred");h(this,"signal");var e;this.signal=t,this.deferred=me(),this.onAbort=this.onAbort.bind(this),(e=this.signal)==null||e.addEventListener("abort",this.onAbort)}onAbort(){var t;this.deferred.reject(((t=this.signal)==null?void 0:t.reason)??new ts)}cleanup(){var t;(t=this.signal)==null||t.removeEventListener("abort",this.onAbort)}}function ab(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class cb{constructor(t,e){h(this,"id");h(this,"fn");h(this,"options");h(this,"recipients");h(this,"status");h(this,"timeline");h(this,"controller");this.id=ab(),this.status="queued",this.fn=t,this.options=e,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,ge(1/0,this.controller.signal),this.onAbort=this.onAbort.bind(this)}abort(t){this.controller.abort(t)}onAbort(){this.recipients.reduce((e,r)=>{var s;return e&&((s=r.signal)==null?void 0:s.aborted)===!0},!0)&&(this.controller.abort(new ts),this.cleanup())}async join(t={}){var r;const e=new ob(t.signal);return this.recipients.push(e),(r=t.signal)==null||r.addEventListener("abort",this.onAbort),e.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const t=await it(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(e=>{e.deferred.resolve(t)}),this.status="complete"}catch(t){this.recipients.forEach(e=>{e.deferred.reject(t)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(t=>{var e;t.cleanup(),(e=t.signal)==null||e.removeEventListener("abort",this.onAbort)})}}class Iu extends Et{constructor(e={}){var r;super();h(this,"concurrency");h(this,"queue");h(this,"pending");h(this,"sort");this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&((r=e.metrics)==null||r.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=e.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let e;for(const r of this.queue)if(r.status==="queued"){e=r;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let r=0;r<this.queue.length;r++)if(this.queue[r]===e){this.queue.splice(r,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,r){var i;(i=r==null?void 0:r.signal)==null||i.throwIfAborted();const s=new cb(e,r);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(r).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:s,result:o}}),o)).catch(o=>{if(s.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===s){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:s,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new ts)}),this.clear()}async onEmpty(e){this.size!==0&&await ha(this,"empty",e==null?void 0:e.signal)}async onSizeLessThan(e,r){this.size<e||await ha(this,"next",r==null?void 0:r.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await ha(this,"idle",e==null?void 0:e.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){var l,u,d;(l=e==null?void 0:e.signal)==null||l.throwIfAborted();const r=jr({objectMode:!0}),s=f=>{f!=null?this.abort():this.clear(),r.end(f)},i=f=>{f.detail!=null&&r.push(f.detail)},o=f=>{s(f.detail)},a=()=>{s()},c=()=>{s(new v("Queue aborted","ERR_QUEUE_ABORTED"))};this.addEventListener("completed",i),this.addEventListener("error",o),this.addEventListener("idle",a),(u=e==null?void 0:e.signal)==null||u.addEventListener("abort",c);try{yield*r}finally{this.removeEventListener("completed",i),this.removeEventListener("error",o),this.removeEventListener("idle",a),(d=e==null?void 0:e.signal)==null||d.removeEventListener("abort",c),s()}}}class _c extends Iu{has(t){return this.find(t)!=null}find(t){return this.queue.find(e=>t.equals(e.options.peerId))}}const R4=5e3,lb=2e3,A4=25,ub=5e3,T4=25,D4=0,x4=100,C4=10,hb=5,db=10,P4="last-dial-failure",k4=500,N4=5,M4=100,O4=50,L4=1e3*60*7,Kn={minConnections:N4,maxQueueLength:x4,autoDialConcurrency:T4,autoDialPriority:D4,autoDialInterval:ub,autoDialPeerRetryThreshold:L4,autoDialDiscoveredPeersDebounce:C4};class fb{constructor(t,e){h(this,"connectionManager");h(this,"peerStore");h(this,"queue");h(this,"minConnections");h(this,"autoDialPriority");h(this,"autoDialIntervalMs");h(this,"autoDialMaxQueueLength");h(this,"autoDialPeerRetryThresholdMs");h(this,"autoDialDiscoveredPeersDebounce");h(this,"autoDialInterval");h(this,"started");h(this,"running");h(this,"log");this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.minConnections=e.minConnections??Kn.minConnections,this.autoDialPriority=e.autoDialPriority??Kn.autoDialPriority,this.autoDialIntervalMs=e.autoDialInterval??Kn.autoDialInterval,this.autoDialMaxQueueLength=e.maxQueueLength??Kn.maxQueueLength,this.autoDialPeerRetryThresholdMs=e.autoDialPeerRetryThreshold??Kn.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=e.autoDialDiscoveredPeersDebounce??Kn.autoDialDiscoveredPeersDebounce,this.log=t.logger.forComponent("libp2p:connection-manager:auto-dial"),this.started=!1,this.running=!1,this.queue=new _c({concurrency:e.autoDialConcurrency??Kn.autoDialConcurrency,metricName:"libp2p_autodial_queue",metrics:t.metrics}),this.queue.addEventListener("error",s=>{this.log.error("error during auto-dial",s.detail)}),t.events.addEventListener("connection:close",()=>{this.autoDial().catch(s=>{this.log.error(s)})});let r;t.events.addEventListener("peer:discovery",()=>{clearTimeout(r),r=setTimeout(()=>{this.autoDial().catch(s=>{this.log.error(s)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.autoDial().catch(t=>{this.log.error("error while autodialing",t)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started||this.running)return;const t=this.connectionManager.getConnectionsMap(),e=t.size;if(e>=this.minConnections){this.minConnections>0&&this.log.trace("have enough connections %d/%d",e,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){this.log("not enough connections %d/%d but auto dial queue is full",e,this.minConnections),this.sheduleNextAutodial();return}this.running=!0,this.log("not enough connections %d/%d - will dial peers to increase the number of connections",e,this.minConnections);const r=new hr(this.connectionManager.getDialQueue().map(l=>l.peerId).filter(Boolean)),s=await this.peerStore.all({filters:[l=>l.addresses.length===0?(this.log.trace("not autodialing %p because they have no addresses",l.id),!1):t.has(l.id)?(this.log.trace("not autodialing %p because they are already connected",l.id),!1):r.has(l.id)?(this.log.trace("not autodialing %p because they are already being dialed",l.id),!1):this.queue.has(l.id)?(this.log.trace("not autodialing %p because they are already being autodialed",l.id),!1):!0]}),i=s.sort(()=>Math.random()>.5?1:-1),o=new Es;for(const l of i)o.has(l.id)||o.set(l.id,[...l.tags.values()].reduce((u,d)=>u+d.value,0));const c=i.sort((l,u)=>{const d=o.get(l.id)??0,f=o.get(u.id)??0;return d>f?-1:d<f?1:0}).filter(l=>{const u=l.metadata.get(P4);if(u==null)return!0;const d=parseInt(X(u));return isNaN(d)?!0:Date.now()-d>this.autoDialPeerRetryThresholdMs});this.log("selected %d/%d peers to dial",c.length,s.length);for(const l of c)this.queue.add(async()=>{const u=this.connectionManager.getConnectionsMap().size;if(u>=this.minConnections){this.log("got enough connections now %d/%d",u,this.minConnections),this.queue.clear();return}this.log("connecting to a peerStore stored peer %p",l.id),await this.connectionManager.openConnection(l.id,{priority:this.autoDialPriority})},{peerId:l.id}).catch(u=>{this.log.error("could not connect to peerStore stored peer",u)});this.running=!1,this.sheduleNextAutodial()}sheduleNextAutodial(){this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(t=>{this.log.error("error while autodialing",t)})},this.autoDialIntervalMs))}}const gb=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function pb(n,t){var s;const e=((s=n==null?void 0:n.streams)==null?void 0:s.map(i=>i.protocol))??[],r=(t==null?void 0:t.closableProtocols)??gb;if(!(e.filter(i=>i!=null&&!r.includes(i)).length>0))try{await(n==null?void 0:n.close(t))}catch(i){n==null||n.abort(i)}}const nd={maxConnections:M4,allow:[]};class mb{constructor(t,e={}){h(this,"maxConnections");h(this,"connectionManager");h(this,"peerStore");h(this,"allow");h(this,"events");h(this,"log");this.maxConnections=e.maxConnections??nd.maxConnections,this.allow=e.allow??nd.allow,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager:connection-pruner"),t.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(r=>{this.log.error(r)})})}async maybePruneConnections(){const t=this.connectionManager.getConnections(),e=t.length;if(this.log("checking max connections limit %d/%d",e,this.maxConnections),e<=this.maxConnections)return;const r=new Es;for(const a of t){const c=a.remotePeer;if(!r.has(c)){r.set(c,0);try{const l=await this.peerStore.get(c);r.set(c,[...l.tags.values()].reduce((u,d)=>u+d.value,0))}catch(l){l.code!=="ERR_NOT_FOUND"&&this.log.error("error loading peer tags",l)}}}const s=this.sortConnections(t,r),i=Math.max(e-this.maxConnections,0),o=[];for(const a of s)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>a.remoteAddr.toString().startsWith(l.toString()))||o.push(a),o.length===i)break;await Promise.all(o.map(async a=>{await pb(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(t,e){return t.sort((r,s)=>{const i=r.timeline.open,o=s.timeline.open;return i<o?1:i>o?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=e.get(r.remotePeer)??0,o=e.get(s.remotePeer)??0;return i>o?1:i<o?-1:0})}}class yb extends Iu{constructor(t={}){super({...t,sort:(e,r)=>e.options.priority>r.options.priority?-1:e.options.priority<r.options.priority?1:0})}}async function wb(n,t){let e=!1;for(const s of O1.keys())if(e=n.protoNames().includes(s),e)break;if(!e)return[n];const r=await n.resolve(t);return t.log("resolved %s to",n,r.map(s=>s.toString())),r}const Di={addressSorter:_u,maxParallelDials:O4,maxDialQueueLength:k4,maxPeerAddrsToDial:A4,dialTimeout:R4,resolvers:{dnsaddr:Su}};class bb{constructor(t,e={}){h(this,"queue");h(this,"components");h(this,"addressSorter");h(this,"maxPeerAddrsToDial");h(this,"maxDialQueueLength");h(this,"dialTimeout");h(this,"shutDownController");h(this,"connections");h(this,"log");this.addressSorter=e.addressSorter??Di.addressSorter,this.maxPeerAddrsToDial=e.maxPeerAddrsToDial??Di.maxPeerAddrsToDial,this.maxDialQueueLength=e.maxDialQueueLength??Di.maxDialQueueLength,this.dialTimeout=e.dialTimeout??Di.dialTimeout,this.connections=e.connections??new Es,this.log=t.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=t,this.shutDownController=new AbortController,ge(1/0,this.shutDownController.signal);for(const[r,s]of Object.entries(e.resolvers??{}))O1.set(r,s);this.queue=new yb({concurrency:e.maxParallelDials??Di.maxParallelDials,metricName:"libp2p_dial_queue",metrics:t.metrics}),this.queue.addEventListener("error",r=>{this.log.error("error in dial queue",r.detail)})}start(){this.shutDownController=new AbortController,ge(1/0,this.shutDownController.signal)}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(t,e={}){const{peerId:r,multiaddrs:s}=I4(t),i=Array.from(this.connections.values()).flat().find(a=>e.force===!0?!1:a.remotePeer.equals(r)?!0:s.find(c=>c.equals(a.remoteAddr)));if(i!=null)return this.log("already connected to %a",i.remoteAddr),i;const o=this.queue.queue.find(a=>{if((r==null?void 0:r.equals(a.options.peerId))===!0)return!0;const c=a.options.multiaddrs;if(c==null)return!1;for(const l of s)if(c.has(l.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",r);for(const a of s)o.options.multiaddrs.add(a.toString());return o.join(e)}if(this.queue.size>=this.maxDialQueueLength)throw new v("Dial queue is full","ERR_DIAL_QUEUE_FULL");return this.log("creating dial target for %p",r,s.map(a=>a.toString())),this.queue.add(async a=>{const c=this.createDialAbortController(a==null?void 0:a.signal);let l;try{l=await this.calculateMultiaddrs(r,a==null?void 0:a.multiaddrs,{...a,signal:c}),l.map(({multiaddr:u})=>u.toString()).forEach(u=>{a==null||a.multiaddrs.add(u)})}catch(u){throw c.clear(),u}try{let u=0;const d=[];for(const f of l){if(u===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",u,r),new v("Peer had more than maxPeerAddrsToDial",Q.ERR_TOO_MANY_ADDRESSES);u++;try{const p=await this.components.transportManager.dial(f.multiaddr,{...a,signal:c});return this.log("dial to %a succeeded",f.multiaddr),p}catch(p){if(this.log.error("dial failed to %a",f.multiaddr,p),r!=null)try{await this.components.peerStore.patch(r,{metadata:{[P4]:Y(Date.now().toString())}})}catch(y){this.log.error("could not update last dial failure key for %p",r,y)}if(c.aborted)throw new v(p.message,S2);d.push(p)}}throw d.length===1?d[0]:new m7(d,"All multiaddr dials failed",Q.ERR_TRANSPORT_DIAL_FAILED)}finally{c.clear()}},{peerId:r,priority:e.priority??B4,multiaddrs:new Set(s.map(a=>a.toString())),signal:e.signal})}createDialAbortController(t){const e=Xt([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,t]);return ge(1/0,e),e}async calculateMultiaddrs(t,e=new Set,r={}){var d,f;const s=[...e].map(p=>({multiaddr:G(p),isCertified:!1}));if(t!=null){if(this.components.peerId.equals(t))throw new v("Tried to dial self",Q.ERR_DIALED_SELF);if(await((f=(d=this.components.connectionGater).denyDialPeer)==null?void 0:f.call(d,t))===!0)throw new v("The dial request is blocked by gater.allowDialPeer",Q.ERR_PEER_DIAL_INTERCEPTED);if(s.length===0){this.log("loading multiaddrs for %p",t);try{const p=await this.components.peerStore.get(t);s.push(...p.addresses),this.log("loaded multiaddrs for %p",t,s.map(({multiaddr:y})=>y.toString()))}catch(p){if(p.code!==Q.ERR_NOT_FOUND)throw p}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",t);try{const p=await this.components.peerRouting.findPeer(t);this.log("found multiaddrs for %p in the peer routing",t,s.map(({multiaddr:y})=>y.toString())),s.push(...p.multiaddrs.map(y=>({multiaddr:y,isCertified:!1})))}catch(p){p.code!==Q.ERR_NO_ROUTERS_AVAILABLE&&this.log.error("looking up multiaddrs for %p in the peer routing failed",t,p)}}}let i=(await Promise.all(s.map(async p=>{const y=await wb(p.multiaddr,{dns:this.components.dns,...r,log:this.log});return y.length===1&&y[0].equals(p.multiaddr)?p:y.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(t!=null){const p=`/p2p/${t.toString()}`;i=i.map(y=>{const g=y.multiaddr.protos().pop();return(g==null?void 0:g.path)===!0?y:y.multiaddr.getPeerId()==null?{multiaddr:y.multiaddr.encapsulate(p),isCertified:y.isCertified}:y})}const o=i.filter(p=>{if(this.components.transportManager.dialTransportForMultiaddr(p.multiaddr)==null)return!1;const y=p.multiaddr.getPeerId();return t!=null&&y!=null?t.equals(y):!0}),a=new Map;for(const p of o){const y=p.multiaddr.toString(),g=a.get(y);if(g!=null){g.isCertified=g.isCertified||p.isCertified||!1;continue}a.set(y,p)}const c=[...a.values()];if(c.length===0)throw new v("The dial request has no valid addresses",Q.ERR_NO_VALID_ADDRESSES);const l=[];for(const p of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(p.multiaddr)||l.push(p);const u=l.sort(this.addressSorter);if(u.length===0)throw new v("The connection gater denied all addresses in the dial request",Q.ERR_NO_VALID_ADDRESSES);return this.log.trace("addresses for %p before filtering",t??"unknown peer",i.map(({multiaddr:p})=>p.toString())),this.log.trace("addresses for %p after filtering",t??"unknown peer",u.map(({multiaddr:p})=>p.toString())),u}async isDialable(t,e={}){Array.isArray(t)||(t=[t]);try{const r=await this.calculateMultiaddrs(void 0,new Set(t.map(s=>s.toString())),e);return e.runOnTransientConnection===!1?r.find(s=>!Ua.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}const B4=50,Lr={minConnections:N4,maxConnections:M4,inboundConnectionThreshold:hb,maxIncomingPendingConnections:db,autoDialConcurrency:T4,autoDialPriority:D4,autoDialMaxQueueLength:x4,autoDialPeerRetryThreshold:L4,autoDialDiscoveredPeersDebounce:C4};var m0;m0=Symbol.toStringTag;class Eb{constructor(t,e={}){h(this,"started");h(this,"connections");h(this,"allow");h(this,"deny");h(this,"maxIncomingPendingConnections");h(this,"incomingPendingConnections");h(this,"maxConnections");h(this,"dialQueue");h(this,"autoDial");h(this,"connectionPruner");h(this,"inboundConnectionRateLimiter");h(this,"peerStore");h(this,"metrics");h(this,"events");h(this,"log");h(this,m0,"@libp2p/connection-manager");this.maxConnections=e.maxConnections??Lr.maxConnections;const r=e.minConnections??Lr.minConnections;if(this.maxConnections<r)throw new v("Connection Manager maxConnections must be greater than minConnections",Q.ERR_INVALID_PARAMETERS);this.connections=new Es,this.started=!1,this.peerStore=t.peerStore,this.metrics=t.metrics,this.events=t.events,this.log=t.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(e.allow??[]).map(s=>G(s)),this.deny=(e.deny??[]).map(s=>G(s)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=e.maxIncomingPendingConnections??Lr.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new nb({points:e.inboundConnectionThreshold??Lr.inboundConnectionThreshold,duration:1}),this.autoDial=new fb({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{minConnections:r,autoDialConcurrency:e.autoDialConcurrency??Lr.autoDialConcurrency,autoDialPriority:e.autoDialPriority??Lr.autoDialPriority,autoDialPeerRetryThreshold:e.autoDialPeerRetryThreshold??Lr.autoDialPeerRetryThreshold,autoDialDiscoveredPeersDebounce:e.autoDialDiscoveredPeersDebounce??Lr.autoDialDiscoveredPeersDebounce,maxQueueLength:e.autoDialMaxQueueLength??Lr.autoDialMaxQueueLength}),this.connectionPruner=new mb({connectionManager:this,peerStore:t.peerStore,events:t.events,logger:t.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new bb(t,{addressSorter:e.addressSorter??_u,maxParallelDials:e.maxParallelDials??O4,maxDialQueueLength:e.maxDialQueueLength??k4,maxPeerAddrsToDial:e.maxPeerAddrsToDial??A4,dialTimeout:e.dialTimeout??R4,resolvers:e.resolvers??{dnsaddr:Su},connections:this.connections})}isStarted(){return this.started}async start(){var t,e,r;(t=this.metrics)==null||t.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const s={inbound:0,outbound:0};for(const i of this.connections.values())for(const o of i)o.direction==="inbound"?s.inbound++:s.outbound++;return s}}),(e=this.metrics)==null||e.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const s={};for(const i of this.connections.values())for(const o of i)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;s[c]=(s[c]??0)+1}return s}}),(r=this.metrics)==null||r.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const s={};for(const o of this.connections.values())for(const a of o){const c={};for(const l of a.streams){const u=`${l.direction} ${l.protocol??"unnegotiated"}`;c[u]=(c[u]??0)+1}for(const[l,u]of Object.entries(c))s[l]=s[l]??[],s[l].push(u)}const i={};for(let[o,a]of Object.entries(s)){a=a.sort((l,u)=>l-u);const c=Math.floor(a.length*.9);i[o]=a[c]}return i}}),this.dialQueue.start(),this.autoDial.start(),this.started=!0,this.log("started")}async afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[e=>e.tags.has(p7)]});await Promise.all(t.map(async e=>{await this.openConnection(e.id).catch(r=>{this.log.error(r)})}))}).catch(t=>{this.log.error(t)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const t=[];for(const e of this.connections.values())for(const r of e)t.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",t.length),await Promise.all(t),this.connections.clear(),this.log("stopped")}onConnect(t){this._onConnect(t).catch(e=>{this.log.error(e)})}async _onConnect(t){const{detail:e}=t;if(!this.started){await e.close();return}const r=e.remotePeer,s=this.connections.get(r);let i=!1;s!=null?s.push(e):(i=!0,this.connections.set(r,[e])),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:e.remotePeer})}onDisconnect(t){const{detail:e}=t;if(!this.started)return;const r=e.remotePeer;let s=this.connections.get(r);s!=null&&s.length>1?(s=s.filter(i=>i.id!==e.id),this.connections.set(r,s)):s!=null&&(this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:e.remotePeer}))}getConnections(t){if(t!=null)return this.connections.get(t)??[];let e=[];for(const r of this.connections.values())e=e.concat(r);return e}getConnectionsMap(){return this.connections}async openConnection(t,e={}){var a;if(!this.isStarted())throw new v("Not started",Q.ERR_NODE_NOT_STARTED);(a=e.signal)==null||a.throwIfAborted();const{peerId:r}=I4(t);if(r!=null&&e.force!==!0){this.log("dial %p",r);const c=this.getConnections(r).find(l=>!l.transient);if(c!=null)return this.log("had an existing non-transient connection to %p",r),c}const s=await this.dialQueue.dial(t,{...e,priority:e.priority??B4});let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(const c of i)c.id===s.id&&(o=!0);return o||i.push(s),s}async closeConnections(t,e={}){const r=this.connections.get(t)??[];await Promise.all(r.map(async s=>{try{await s.close(e)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(t){if(this.deny.some(s=>t.remoteAddr.toString().startsWith(s.toString())))return this.log("connection from %a refused - connection remote address was in deny list",t.remoteAddr),!1;if(this.allow.some(s=>t.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",t.remoteAddr),!1;if(t.remoteAddr.isThinWaistAddress()){const s=t.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",t.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",t.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const t={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(e=>({id:e.id,status:t[e.status],peerId:e.options.peerId,multiaddrs:[...e.options.multiaddrs].map(r=>G(r))}))}async isDialable(t,e={}){return this.dialQueue.isDialable(t,e)}}var y0;y0=Symbol.toStringTag;class vb{constructor(t,e){h(this,"routers");h(this,"started");h(this,"components");h(this,y0,"@libp2p/content-routing");this.routers=e.routers??[],this.started=!1,this.components=t}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(t,e={}){if(this.routers.length===0)throw new v("No content routers available",Q.ERR_NO_ROUTERS_AVAILABLE);const r=this,s=new hr;for await(const i of Wi(...r.routers.map(o=>o.findProviders(t,e))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(t,e={}){if(this.routers.length===0)throw new v("No content routers available",Q.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async r=>{await r.provide(t,e)}))}async put(t,e,r){if(!this.isStarted())throw new v(ri.NOT_STARTED_YET,Q.ERR_NODE_NOT_STARTED);await Promise.all(this.routers.map(async s=>{await s.put(t,e,r)}))}async get(t,e){if(!this.isStarted())throw new v(ri.NOT_STARTED_YET,Q.ERR_NODE_NOT_STARTED);return Promise.any(this.routers.map(async r=>r.get(t,e)))}}const Yo=globalThis.CustomEvent??Event;async function*Sc(n,t={}){let e=t.concurrency??1/0;e<1&&(e=1/0);const r=t.ordered==null?!1:t.ordered,s=new EventTarget,i=[];let o=me(),a=me(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const y of n){if(i.length===e&&(o=me(),await o.promise),u)break;const g={done:!1};i.push(g),y().then(m=>{g.done=!0,g.ok=!0,g.value=m,s.dispatchEvent(new Yo("task-complete"))},m=>{g.done=!0,g.err=m,s.dispatchEvent(new Yo("task-complete"))})}c=!0,s.dispatchEvent(new Yo("task-complete"))}catch(y){l=y,s.dispatchEvent(new Yo("task-complete"))}});function d(){var y;return r?(y=i[0])==null?void 0:y.done:!!i.find(g=>g.done)}function*f(){for(;i.length>0&&i[0].done;){const y=i[0];if(i.shift(),y.ok)yield y.value;else throw u=!0,o.resolve(),y.err;o.resolve()}}function*p(){for(;d();)for(let y=0;y<i.length;y++)if(i[y].done){const g=i[y];if(i.splice(y,1),y--,g.ok)yield g.value;else throw u=!0,o.resolve(),g.err;o.resolve()}}for(;;){if(d()||(a=me(),await a.promise),l!=null)throw l;if(r?yield*f():yield*p(),c&&i.length===0)break}}var w0;w0=Symbol.toStringTag;class _b{constructor(t,e={}){h(this,"log");h(this,"peerId");h(this,"peerStore");h(this,"routers");h(this,w0,"@libp2p/peer-routing");this.log=t.logger.forComponent("libp2p:peer-routing"),this.peerId=t.peerId,this.peerStore=t.peerStore,this.routers=e.routers??[]}async findPeer(t,e){if(this.routers.length===0)throw new v("No peer routers available",Q.ERR_NO_ROUTERS_AVAILABLE);if(t.toString()===this.peerId.toString())throw new v("Should not try to find self",Q.ERR_FIND_SELF);const r=this,s=Wi(...this.routers.map(i=>async function*(){try{yield await i.findPeer(t,e)}catch(o){r.log.error(o)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),i;throw new v(ri.NOT_FOUND,Q.ERR_NOT_FOUND)}async*getClosestPeers(t,e={}){if(this.routers.length===0)throw new v("No peer routers available",Q.ERR_NO_ROUTERS_AVAILABLE);const r=this,s=r4(1024);for await(const i of Sc(async function*(){const o=Wi(...r.routers.map(a=>a.getClosestPeers(t,e)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await r.findPeer(a.id,{...e,useCache:!1})}catch(c){r.log.error("could not find peer multiaddrs",c);return}return a}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs}),!s.has(i.id.toBytes())&&(s.add(i.id.toBytes()),yield i))}}var b0,E0;class Sb extends(E0=Et,b0=Symbol.toStringTag,E0){constructor(e){super();h(this,"peerRouting");h(this,"log");h(this,"walking");h(this,"walkers");h(this,"shutdownController");h(this,"walkController");h(this,"needNext");h(this,b0,"@libp2p/random-walk");this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,ge(1/0,this.shutdownController.signal)}start(){this.shutdownController=new AbortController,ge(1/0,this.shutdownController.signal)}stop(){this.shutdownController.abort()}async*walk(e){var s,i;this.walking||this.startWalk(),this.walkers++;const r=Xt([this.shutdownController.signal,e==null?void 0:e.signal]);ge(1/0,r);try{for(;;)(s=this.needNext)==null||s.resolve(),this.needNext=me(),yield(await ha(this,"walk:peer",r,{errorEvent:"walk:error"})).detail}finally{r.clear(),this.walkers--,this.walkers===0&&((i=this.walkController)==null||i.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,ge(1/0,this.walkController.signal);const e=Xt([this.walkController.signal,this.shutdownController.signal]);ge(1/0,e);const r=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const i=as(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(i,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await it(this.needNext.promise,e)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",i,this.walkers,s)}catch(i){this.log.error("randomwalk errored",i),this.safeDispatchEvent("walk:error",{detail:i})}this.log("no walkers left, ended walk")}).catch(i=>{this.log.error("randomwalk errored",i)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-r),this.walking=!1})}}const U4=32,F4=64;var v0;v0=Symbol.toStringTag;class Ib{constructor(t){h(this,"log");h(this,"topologies");h(this,"handlers");h(this,"components");h(this,v0,"@libp2p/registrar");this.log=t.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=t,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(t){const e=this.handlers.get(t);if(e==null)throw new v(`No handler registered for protocol ${t}`,Q.ERR_NO_HANDLER_FOR_PROTOCOL);return e}getTopologies(t){const e=this.topologies.get(t);return e==null?[]:[...e.values()]}async handle(t,e,r){if(this.handlers.has(t))throw new v(`Handler already registered for protocol ${t}`,Q.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=_4.bind({ignoreUndefined:!0})({maxInboundStreams:U4,maxOutboundStreams:F4},r);this.handlers.set(t,{handler:e,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[t]})}async unhandle(t){(Array.isArray(t)?t:[t]).forEach(r=>{this.handlers.delete(r)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(t,e){if(e==null)throw new v("invalid topology",Q.ERR_INVALID_PARAMETERS);const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(t);return s==null&&(s=new Map,this.topologies.set(t,s)),s.set(r,e),r}unregister(t){for(const[e,r]of this.topologies.entries())r.has(t)&&(r.delete(t),r.size===0&&this.topologies.delete(e))}_onDisconnect(t){const e=t.detail;this.components.peerStore.get(e).then(r=>{var s,i,o;for(const a of r.protocols){const c=this.topologies.get(a);if(c!=null)for(const l of c.values())((s=l.filter)==null?void 0:s.has(e))!==!1&&((i=l.filter)==null||i.remove(e),(o=l.onDisconnect)==null||o.call(l,e))}}).catch(r=>{r.code!==Q.ERR_NOT_FOUND&&this.log.error("could not inform topologies of disconnecting peer %p",e,r)})}_onPeerUpdate(t){var i,o,a;const{peer:e,previous:r}=t.detail,s=((r==null?void 0:r.protocols)??[]).filter(c=>!e.protocols.includes(c));for(const c of s){const l=this.topologies.get(c);if(l!=null)for(const u of l.values())((i=u.filter)==null?void 0:i.has(e.id))!==!1&&((o=u.filter)==null||o.remove(e.id),(a=u.onDisconnect)==null||a.call(u,e.id))}}_onPeerIdentify(t){var i,o,a;const e=t.detail.protocols,r=t.detail.connection,s=t.detail.peerId;for(const c of e){const l=this.topologies.get(c);if(l!=null)for(const u of l.values())r.transient&&u.notifyOnTransient!==!0||((i=u.filter)==null?void 0:i.has(s))!==!0&&((o=u.filter)==null||o.add(s),(a=u.onConnect)==null||a.call(u,s,r))}}}class Rb extends Map{constructor(e){super();h(this,"metric");const{name:r,metrics:s}=e;this.metric=s.registerMetric(r),this.updateComponentMetric()}set(e,r){return super.set(e,r),this.updateComponentMetric(),this}delete(e){const r=super.delete(e);return this.updateComponentMetric(),r}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Ab(n){const{name:t,metrics:e}=n;let r;return e!=null?r=new Rb({name:t,metrics:e}):r=new Map,r}var _0;_0=Symbol.toStringTag;class Tb{constructor(t,e={}){h(this,"log");h(this,"components");h(this,"transports");h(this,"listeners");h(this,"faultTolerance");h(this,"started");h(this,_0,"@libp2p/transport-manager");this.log=t.logger.forComponent("libp2p:transports"),this.components=t,this.started=!1,this.transports=new Map,this.listeners=Ab({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=e.faultTolerance??Cs.FATAL_ALL}add(t){const e=t[Symbol.toStringTag];if(e==null)throw new v("Transport must have a valid tag",Q.ERR_INVALID_KEY);if(this.transports.has(e))throw new v(`There is already a transport with the tag ${e}`,Q.ERR_DUPLICATE_TRANSPORT);this.log("adding transport %s",e),this.transports.set(e,t),this.listeners.has(e)||this.listeners.set(e,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const t=this.components.addressManager.getListenAddrs();await this.listen(t)}async stop(){const t=[];for(const[e,r]of this.listeners)for(this.log("closing listeners for %s",e);r.length>0;){const s=r.pop();s!=null&&t.push(s.close())}await Promise.all(t),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(t,e){const r=this.dialTransportForMultiaddr(t);if(r==null)throw new v(`No transport available for address ${String(t)}`,Q.ERR_TRANSPORT_UNAVAILABLE);try{return await r.dial(t,{...e,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=Q.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let t=[];for(const e of this.listeners.values())for(const r of e)t=[...t,...r.getAddrs()];return t}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(t){for(const e of this.transports.values())if(e.dialFilter([t]).length>0)return e}listenTransportForMultiaddr(t){for(const e of this.transports.values())if(e.listenFilter([t]).length>0)return e}async listen(t){if(!this.isStarted())throw new v("Not started",Q.ERR_NODE_NOT_STARTED);if(t==null||t.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const e=[];for(const[r,s]of this.transports.entries()){const i=s.listenFilter(t),o=[];for(const l of i){this.log("creating listener for %s on %a",r,l);const u=s.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(r)??[];d==null&&(d=[],this.listeners.set(r,d)),d.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{const f=d.findIndex(p=>p===u);d.splice(f,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),o.push(u.listen(l))}if(o.length===0){e.push(r);continue}if((await Promise.allSettled(o)).find(l=>l.status==="fulfilled")==null&&this.faultTolerance!==Cs.NO_FATAL)throw new v(`Transport (${r}) could not listen on any available address`,Q.ERR_NO_VALID_ADDRESSES)}if(e.length===this.transports.size){const r=`no valid addresses were provided for transports [${e.join(", ")}]`;if(this.faultTolerance===Cs.FATAL_ALL)throw new v(r,Q.ERR_NO_VALID_ADDRESSES);this.log(`libp2p in dial mode only: ${r}`)}}async remove(t){const e=this.listeners.get(t)??[];this.log.trace("removing transport %s",t);const r=[];for(this.log.trace("closing listeners for %s",t);e.length>0;){const s=e.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(t),this.listeners.delete(t)}async removeAll(){const t=[];for(const e of this.transports.keys())t.push(this.remove(e));await Promise.all(t)}}const Dt="/multistream/1.0.0",Ru=1024,Db=Y(`
`);async function Mi(n,t,e){await n.write(t,e)}async function xb(n,t,e){await n.writeV(t,e)}async function Cb(n,t){const e=await n.read(t);if(e.byteLength===0||e.get(e.byteLength-1)!==Db[0])throw t.log.error("Invalid mss message - missing newline",e),new v("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return e.sublist(0,-1)}async function ks(n,t){const e=await Cb(n,t);return X(e.subarray())}async function el(n,t,e){if(t=Array.isArray(t)?[...t]:[t],t.length===1&&e.negotiateFully===!1)return Pb(n,t[0],e);const r=Gs(n,{...e,maxDataLength:Ru}),s=t.shift();if(s==null)throw new Error("At least one protocol must be specified");e.log.trace('select: write ["%s", "%s"]',Dt,s);const i=Y(`${Dt}
`),o=Y(`${s}
`);await xb(r,[i,o],e),e.log.trace("select: reading multistream-select header");let a=await ks(r,e);if(e.log.trace('select: read "%s"',a),a===Dt&&(e.log.trace("select: reading protocol response"),a=await ks(r,e),e.log.trace('select: read "%s"',a)),a===s)return{stream:r.unwrap(),protocol:s};for(const c of t){e.log.trace('select: write "%s"',c),await Mi(r,Y(`${c}
`),e),e.log.trace("select: reading protocol response");const l=await ks(r,e);if(e.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:r.unwrap(),protocol:c}}throw new v("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function Pb(n,t,e){const r=n.sink.bind(n),s=n.source;let i=!1,o=!1;const a=me();let c=!1,l=!1;const u=me();let d=!1,f=!1;const p=me(),y=Gs({sink:r,source:s},{...e,maxDataLength:Ru});n.sink=async _=>{const{sink:b}=y.unwrap();await b(async function*(){let S=!1;for await(const I of _){if(l&&await u.promise,c)yield I;else{l=!0,e.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Dt,t,I.byteLength);const A=`${t}
`;yield new Oe(Uint8Array.from([19]),Y(`${Dt}
`),ur(A.length),Y(A),I).subarray(),e.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Dt,t,I.byteLength),c=!0,l=!1,u.resolve(),g().catch(P=>{e.log.error("could not finish optimistic protocol negotiation of %s",t,P)})}S=!0}S||await g()}())};async function g(){if(o){e.log.trace("optimistic: already negotiating %s stream",t),await a.promise;return}o=!0;try{c||(e.log.trace("optimistic: doing send protocol for %s stream",t),await m()),d||(e.log.trace("optimistic: doing read protocol for %s stream",t),await w())}finally{o=!1,i=!0,a.resolve()}}async function m(){if(l){await u.promise;return}l=!0;try{e.log.trace('optimistic: write ["%s", "%s", data] in source',Dt,t),await y.writeV([Y(`${Dt}
`),Y(`${t}
`)]),e.log.trace('optimistic: wrote ["%s", "%s", data] in source',Dt,t)}finally{c=!0,l=!1,u.resolve()}}async function w(){if(f){await p.promise;return}f=!0;try{e.log.trace("optimistic: reading multistream select header");let _=await ks(y,e);if(e.log.trace('optimistic: read multistream select header "%s"',_),_===Dt&&(_=await ks(y,e)),e.log.trace('optimistic: read protocol "%s", expecting "%s"',_,t),_!==t)throw new v("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{d=!0,f=!1,p.resolve()}}if(n.source=async function*(){await g(),e.log.trace('optimistic: reading data from "%s" stream',t),yield*y.unwrap().source}(),n.closeRead!=null){const _=n.closeRead.bind(n);n.closeRead=async b=>{i||await g().catch(S=>{e.log.error("could not negotiate protocol before close read",S)}),await _(b)}}if(n.closeWrite!=null){const _=n.closeWrite.bind(n);n.closeWrite=async b=>{i||await g().catch(S=>{e.log.error("could not negotiate protocol before close write",S)}),await _(b)}}if(n.close!=null){const _=n.close.bind(n);n.close=async b=>{const S=[];l&&S.push(u.promise),f&&S.push(p.promise),S.length>0?await it(Promise.all(S),b==null?void 0:b.signal):(i=!0,o=!1,a.resolve()),await _(b)}}return{stream:n,protocol:t}}async function tl(n,t,e){t=Array.isArray(t)?t:[t],e.log.trace("handle: available protocols %s",t);const r=Gs(n,{...e,maxDataLength:Ru,maxLengthLength:2});for(;;){e.log.trace("handle: reading incoming string");const s=await ks(r,e);if(e.log.trace('handle: read "%s"',s),s===Dt){e.log.trace('handle: respond with "%s" for "%s"',Dt,s),await Mi(r,Y(`${Dt}
`),e),e.log.trace('handle: responded with "%s" for "%s"',Dt,s);continue}if(t.includes(s))return e.log.trace('handle: respond with "%s" for "%s"',s,s),await Mi(r,Y(`${s}
`),e),e.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new Oe(...t.map(o=>en.single(Y(`${o}
`))),Y(`
`));e.log.trace('handle: respond with "%s" for %s',t,s),await Mi(r,i,e),e.log.trace('handle: responded with "%s" for %s',t,s);continue}e.log('handle: respond with "na" for "%s"',s),await Mi(r,Y(`na
`),e),e.log('handle: responded with "na" for "%s"',s)}}const kb=500;var S0,I0;I0=Symbol.toStringTag,S0=g7;class Nb{constructor(t){h(this,"id");h(this,"remoteAddr");h(this,"remotePeer");h(this,"direction");h(this,"timeline");h(this,"multiplexer");h(this,"encryption");h(this,"status");h(this,"transient");h(this,"log");h(this,"tags");h(this,"_newStream");h(this,"_close");h(this,"_abort");h(this,"_getStreams");h(this,I0,"Connection");h(this,S0,!0);const{remoteAddr:e,remotePeer:r,newStream:s,close:i,abort:o,getStreams:a}=t;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=e,this.remotePeer=r,this.direction=t.direction,this.status="open",this.timeline=t.timeline,this.multiplexer=t.multiplexer,this.encryption=t.encryption,this.transient=t.transient??!1,this.log=t.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(t,e){if(this.status==="closing")throw new v("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new v("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(t)||(t=[t]),this.transient&&(e==null?void 0:e.runOnTransientConnection)!==!0)throw new v("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const r=await this._newStream(t,e);return r.direction="outbound",r}async close(t={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",t.signal==null){const e=AbortSignal.timeout(kb);ge(1/0,e),t={...t,signal:e}}try{this.log.trace("closing all streams"),await Promise.all(this.streams.map(async e=>e.close(t))),this.log.trace("closing underlying transport"),await this._close(t),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(t){this.log.error("aborting connection to %a due to error",this.remoteAddr,t),this.status="closing",this.streams.forEach(e=>{e.abort(t)}),this.log.error("all streams aborted",this.streams.length),this._abort(t),this.timeline.close=Date.now(),this.status="closed"}}function Mb(n){return new Nb(n)}const Ob=3e4;function Lb(n,t){try{const{options:e}=t.getHandler(n);return e.maxInboundStreams}catch(e){if(e.code!==Q.ERR_NO_HANDLER_FOR_PROTOCOL)throw e}return U4}function Bb(n,t,e={}){try{const{options:r}=t.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.code!==Q.ERR_NO_HANDLER_FOR_PROTOCOL)throw r}return e.maxOutboundStreams??F4}function sd(n,t,e){let r=0;return e.streams.forEach(s=>{s.direction===t&&s.protocol===n&&r++}),r}var R0;R0=Symbol.toStringTag;class Ub{constructor(t,e){h(this,"components");h(this,"connectionEncryption");h(this,"muxers");h(this,"inboundUpgradeTimeout");h(this,"events");h(this,R0,"@libp2p/upgrader");this.components=t,this.connectionEncryption=new Map,e.connectionEncryption.forEach(r=>{this.connectionEncryption.set(r.protocol,r)}),this.muxers=new Map,e.muxers.forEach(r=>{this.muxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=e.inboundUpgradeTimeout??lb,this.events=t.events}async shouldBlockConnection(t,e,r){const s=this.components.connectionGater[r];if(s!==void 0&&await s(t,e))throw new v(`The multiaddr connection is blocked by gater.${r}`,Q.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(t,e){var d,f,p;if(!await this.components.connectionManager.acceptIncomingConnection(t))throw new v("connection denied",Q.ERR_CONNECTION_DENIED);let s,i,o,a,c;const l=AbortSignal.timeout(this.inboundUpgradeTimeout),u=()=>{t.abort(new v("inbound upgrade timeout",S2))};l.addEventListener("abort",u,{once:!0}),ge(1/0,l);try{if(await((f=(d=this.components.connectionGater).denyInboundConnection)==null?void 0:f.call(d,t))===!0)throw new v("The multiaddr connection is blocked by gater.acceptConnection",Q.ERR_CONNECTION_INTERCEPTED);(p=this.components.metrics)==null||p.trackMultiaddrConnection(t),t.log("starting the inbound connection upgrade");let y=t;if((e==null?void 0:e.skipProtection)!==!0){const g=this.components.connectionProtector;g!=null&&(t.log("protecting the inbound connection"),y=await g.protect(t))}try{if(s=y,(e==null?void 0:e.skipEncryption)!==!0){({conn:s,remotePeer:i,protocol:c}=await this._encryptInbound(y));const g={...y,...s};await this.shouldBlockConnection(i,g,"denyInboundEncryptedConnection")}else{const g=t.remoteAddr.getPeerId();if(g==null)throw new v("inbound connection that skipped encryption must have a peer id",Q.ERR_INVALID_MULTIADDR);const m=ye(g);c="native",i=m}if(o=s,(e==null?void 0:e.muxerFactory)!=null)a=e.muxerFactory;else if(this.muxers.size>0){const g=await this._multiplexInbound({...y,...s},this.muxers);a=g.muxerFactory,o=g.stream}}catch(g){throw t.log.error("failed to upgrade inbound connection",g),g}return await this.shouldBlockConnection(i,t,"denyInboundUpgradedConnection"),t.log("successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:t,upgradedConn:o,muxerFactory:a,remotePeer:i,transient:e==null?void 0:e.transient})}finally{l.removeEventListener("abort",u),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(t,e){var d;const r=t.remoteAddr.getPeerId();let s;r!=null&&(s=ye(r),await this.shouldBlockConnection(s,t,"denyOutboundConnection"));let i,o,a,c,l;(d=this.components.metrics)==null||d.trackMultiaddrConnection(t),t.log("starting the outbound connection upgrade");let u=t;if((e==null?void 0:e.skipProtection)!==!0){const f=this.components.connectionProtector;f!=null&&(u=await f.protect(t))}try{if(i=u,(e==null?void 0:e.skipEncryption)!==!0){({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(u,s));const f={...u,...i};await this.shouldBlockConnection(o,f,"denyOutboundEncryptedConnection")}else{if(s==null)throw new v("Encryption was skipped but no peer id was passed",Q.ERR_INVALID_PEER);c="native",o=s}if(a=i,(e==null?void 0:e.muxerFactory)!=null)l=e.muxerFactory;else if(this.muxers.size>0){const f=await this._multiplexOutbound({...u,...i},this.muxers);l=f.muxerFactory,a=f.stream}}catch(f){throw t.log.error("failed to upgrade outbound connection",f),await t.close(f),f}return await this.shouldBlockConnection(o,t,"denyOutboundUpgradedConnection"),t.log("successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:t,upgradedConn:a,muxerFactory:l,remotePeer:o,transient:e==null?void 0:e.transient})}_createConnection(t){const{cryptoProtocol:e,direction:r,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,transient:c}=t;let l,u,d;a!=null&&(l=a.createStreamMuxer({direction:r,onIncomingStream:y=>{d!=null&&Promise.resolve().then(async()=>{var S;const g=this.components.registrar.getProtocols(),{stream:m,protocol:w}=await tl(y,g,{log:y.log,yieldBytes:!1});if(d==null)return;d.log("incoming stream opened on %s",w);const _=Lb(w,this.components.registrar);if(sd(w,"inbound",d)===_){const I=new v(`Too many inbound protocol streams for protocol "${w}" - limit ${_}`,Q.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw y.abort(I),I}y.source=m.source,y.sink=m.sink,y.protocol=w,m.closeWrite!=null&&(y.closeWrite=m.closeWrite),m.closeRead!=null&&(y.closeRead=m.closeRead),m.close!=null&&(y.close=m.close),await this.components.peerStore.merge(o,{protocols:[w]}),(S=this.components.metrics)==null||S.trackProtocolStream(y,d),this._onStream({connection:d,stream:y,protocol:w})}).catch(async g=>{d.log.error("error handling incoming stream id %s",y.id,g.message,g.code,g.stack),y.timeline.close==null&&await y.close()})}}),u=async(y,g={})=>{var w;if(l==null)throw new v("Stream is not multiplexed",Q.ERR_MUXER_UNAVAILABLE);d.log("starting new stream for protocols %s",y);const m=await l.newStream();d.log.trace("started new stream %s for protocols %s",m.id,y);try{if(g.signal==null){m.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",y);const A=AbortSignal.timeout(Ob);ge(1/0,A),g={...g,signal:A}}m.log.trace("selecting protocol from protocols %s",y);const{stream:_,protocol:b}=await el(m,y,{...g,log:m.log,yieldBytes:!0});m.log("selected protocol %s",b);const S=Bb(b,this.components.registrar,g),I=sd(b,"outbound",d);if(I>=S){const A=new v(`Too many outbound protocol streams for protocol "${b}" - ${I}/${S}`,Q.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw m.abort(A),A}return await this.components.peerStore.merge(o,{protocols:[b]}),m.source=_.source,m.sink=_.sink,m.protocol=b,_.closeWrite!=null&&(m.closeWrite=_.closeWrite),_.closeRead!=null&&(m.closeRead=_.closeRead),_.close!=null&&(m.close=_.close),(w=this.components.metrics)==null||w.trackProtocolStream(m,d),m}catch(_){throw d.log.error("could not create new stream for protocols %s",y,_),m.timeline.close==null&&m.abort(_),_.code!=null?_:new v(String(_),Q.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(y=>{d.log.error("error piping data through muxer",y)}));const f=s.timeline;s.timeline=new Proxy(f,{set:(...y)=>(d!=null&&y[1]==="close"&&y[2]!=null&&f.close==null&&(async()=>{try{d.status==="open"&&await d.close()}catch(g){d.log.error("error closing connection after timeline close",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:d})}})().catch(g=>{d.log.error("error thrown while dispatching connection:close event",g)}),Reflect.set(...y))}),s.timeline.upgraded=Date.now();const p=()=>{throw new v("connection is not multiplexed",Q.ERR_CONNECTION_NOT_MULTIPLEXED)};return d=Mb({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:r,timeline:s.timeline,multiplexer:l==null?void 0:l.protocol,encryption:e,transient:c,logger:this.components.logger,newStream:u??p,getStreams:()=>l!=null?l.streams:[],close:async y=>{l!=null&&(d.log.trace("close muxer"),await l.close(y)),d.log.trace("close maconn"),await s.close(y),d.log.trace("closed maconn")},abort:y=>{s.abort(y),l!=null&&l.abort(y)}}),this.events.safeDispatchEvent("connection:open",{detail:d}),d}_onStream(t){const{connection:e,stream:r,protocol:s}=t,{handler:i,options:o}=this.components.registrar.getHandler(s);if(e.transient&&o.runOnTransientConnection!==!0)throw new v("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:e,stream:r})}async _encryptInbound(t){const e=Array.from(this.connectionEncryption.keys());t.log("handling inbound crypto protocol selection",e);try{const{stream:r,protocol:s}=await tl(t,e,{log:t.log}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return t.log("encrypting inbound connection using",s),{...await i.secureInbound(this.components.peerId,r),protocol:s}}catch(r){throw t.log.error("encrypting inbound connection failed",r),new v(r.message,Q.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(t,e){const r=Array.from(this.connectionEncryption.keys());t.log("selecting outbound crypto protocol",r);try{t.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await el(t,r,{log:t.log,yieldBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return t.log("encrypting outbound connection to %p using %s",e,o),{...await o.secureOutbound(this.components.peerId,s,e),protocol:i}}catch(s){throw t.log.error("encrypting outbound connection to %p failed",e,s),new v(s.message,Q.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(t,e){const r=Array.from(e.keys());t.log("outbound selecting muxer %s",r);try{t.log.trace("selecting stream muxer from %s",r);const{stream:s,protocol:i}=await el(t,r,{log:t.log,yieldBytes:!0});t.log("selected %s as muxer protocol",i);const o=e.get(i);return{stream:s,muxerFactory:o}}catch(s){throw t.log.error("error multiplexing outbound connection",s),new v(String(s),Q.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(t,e){const r=Array.from(e.keys());t.log("inbound handling muxers %s",r);try{const{stream:s,protocol:i}=await tl(t,r,{log:t.log}),o=e.get(i);return{stream:s,muxerFactory:o}}catch(s){throw t.log.error("error multiplexing inbound connection",s),new v(String(s),Q.ERR_MUXER_UNAVAILABLE)}}}const Fb="1.7.0",Vb="libp2p";var ho,Hl;class $b extends Et{constructor(e){var c,l,u,d;super();j(this,ho);h(this,"peerId");h(this,"peerStore");h(this,"contentRouting");h(this,"peerRouting");h(this,"metrics");h(this,"services");h(this,"logger");h(this,"status");h(this,"components");h(this,"log");this.status="stopped";const r=new Et,s=r.dispatchEvent.bind(r);r.dispatchEvent=f=>{const p=s(f),y=this.dispatchEvent(new pt(f.type,{detail:f.detail}));return p||y},ge(1/0,r),this.peerId=e.peerId,this.logger=e.logger??V2(),this.log=this.logger.forComponent("libp2p"),this.services={};const i=this.components=uw({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:e.nodeInfo??{name:Vb,version:Fb},logger:this.logger,events:r,datastore:e.datastore??new nw,connectionGater:bw(e.connectionGater),dns:e.dns});this.peerStore=this.configureComponent("peerStore",new Qy(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),i.events.addEventListener("peer:update",f=>{if(f.detail.previous==null){const p={id:f.detail.peer.id,multiaddrs:f.detail.peer.addresses.map(y=>y.multiaddr)};i.events.safeDispatchEvent("peer:discovery",{detail:p})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new Ub(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((f,p)=>this.configureComponent(`connection-encryption-${p}`,f(this.components))),muxers:(e.streamMuxers??[]).map((f,p)=>this.configureComponent(`stream-muxers-${p}`,f(this.components))),inboundUpgradeTimeout:(c=e.connectionManager)==null?void 0:c.inboundUpgradeTimeout}),this.configureComponent("transportManager",new Tb(this.components,e.transportManager)),this.configureComponent("connectionManager",new Eb(this.components,e.connectionManager)),this.configureComponent("registrar",new Ib(this.components)),this.configureComponent("addressManager",new ow(this.components,e.addresses));const o=(e.peerRouters??[]).map((f,p)=>this.configureComponent(`peer-router-${p}`,f(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new _b(this.components,{routers:o}));const a=(e.contentRouters??[]).map((f,p)=>this.configureComponent(`content-router-${p}`,f(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new vb(this.components,{routers:a})),this.configureComponent("randomWalk",new Sb(this.components)),(e.peerDiscovery??[]).forEach((f,p)=>{this.configureComponent(`peer-discovery-${p}`,f(this.components)).addEventListener("peer",g=>{O(this,ho,Hl).call(this,g)})}),(l=e.transports)==null||l.forEach((f,p)=>{this.components.transportManager.add(this.configureComponent(`transport-${p}`,f(this.components)))}),e.services!=null)for(const f of Object.keys(e.services)){const p=e.services[f],y=p(this.components);if(y==null){this.log.error("service factory %s returned null or undefined instance",f);continue}this.services[f]=y,this.configureComponent(f,y),y[Ea]!=null&&(this.log("registering service %s for content routing",f),a.push(y[Ea])),y[_a]!=null&&(this.log("registering service %s for peer routing",f),o.push(y[_a])),y[va]!=null&&(this.log("registering service %s for peer discovery",f),(d=(u=y[va]).addEventListener)==null||d.call(u,"peer",g=>{O(this,ho,Hl).call(this,g)}))}hw(i)}configureComponent(e,r){return r==null&&this.log.error("component %s was null or undefined",e),this.components[e]=r,r}async start(){var e,r,s,i;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((r=(e=this.components).beforeStart)==null?void 0:r.call(e)),await this.components.start(),await((i=(s=this.components).afterStart)==null?void 0:i.call(s)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var e,r,s,i;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((r=(e=this.components).beforeStop)==null?void 0:r.call(e)),await this.components.stop(),await((i=(s=this.components).afterStop)==null?void 0:i.call(s)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new hr;for(const r of this.components.connectionManager.getConnections())e.add(r.remotePeer);return Array.from(e)}async dial(e,r={}){return this.components.connectionManager.openConnection(e,{priority:75,...r})}async dialProtocol(e,r,s={}){if(r==null)throw new v("no protocols were provided to open a stream",Q.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(r=Array.isArray(r)?r:[r],r.length===0)throw new v("no protocols were provided to open a stream",Q.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,s)).newStream(r,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,r={}){ic(e)&&(e=ye(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,r)}async getPublicKey(e,r={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const o=await this.peerStore.get(e);if(o.id.publicKey!=null)return o.id.publicKey}catch(o){if(o.code!==Q.ERR_NOT_FOUND)throw o}const s=at([Y("/pk/"),e.multihash.digest]),i=await this.contentRouting.get(s,r);return ls(i),await this.peerStore.patch(e,{publicKey:i}),i}async handle(e,r,s){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async i=>{await this.components.registrar.handle(i,r,s)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r)}))}async register(e,r){return this.components.registrar.register(e,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,r={}){return this.components.connectionManager.isDialable(e,r)}}ho=new WeakSet,Hl=function(e){const{detail:r}=e;if(r.id.toString()===this.peerId.toString()){this.log.error(new Error(Q.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(r.id,{multiaddrs:r.multiaddrs}).catch(s=>{this.log.error(s)})};async function Kb(n={}){const t=n.peerId??(n.peerId=await Ny());if(t.privateKey==null)throw new v("peer id was missing private key","ERR_MISSING_PRIVATE_KEY");return n.privateKey??(n.privateKey=await Ji(t.privateKey)),new $b(await eb(n))}async function Hb(n={}){const t=await Kb(n);return n.start!==!1&&await t.start(),t}const zb="SHARDING";new Be(zb);di("datastore:core:tiered");const zl=(n,t)=>t.some(e=>n instanceof e);let id,od;function Wb(){return id||(id=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function qb(){return od||(od=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Wl=new WeakMap,rl=new WeakMap,Ic=new WeakMap;function Gb(n){const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("success",i),n.removeEventListener("error",o)},i=()=>{e(Cn(n.result)),s()},o=()=>{r(n.error),s()};n.addEventListener("success",i),n.addEventListener("error",o)});return Ic.set(t,n),t}function Yb(n){if(Wl.has(n))return;const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("complete",i),n.removeEventListener("error",o),n.removeEventListener("abort",o)},i=()=>{e(),s()},o=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",i),n.addEventListener("error",o),n.addEventListener("abort",o)});Wl.set(n,t)}let ql={get(n,t,e){if(n instanceof IDBTransaction){if(t==="done")return Wl.get(n);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Cn(n[t])},set(n,t,e){return n[t]=e,!0},has(n,t){return n instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in n}};function V4(n){ql=n(ql)}function Qb(n){return qb().includes(n)?function(...t){return n.apply(Gl(this),t),Cn(this.request)}:function(...t){return Cn(n.apply(Gl(this),t))}}function Xb(n){return typeof n=="function"?Qb(n):(n instanceof IDBTransaction&&Yb(n),zl(n,Wb())?new Proxy(n,ql):n)}function Cn(n){if(n instanceof IDBRequest)return Gb(n);if(rl.has(n))return rl.get(n);const t=Xb(n);return t!==n&&(rl.set(n,t),Ic.set(t,n)),t}const Gl=n=>Ic.get(n);function Zb(n,t,{blocked:e,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(n,t),a=Cn(o);return r&&o.addEventListener("upgradeneeded",c=>{r(Cn(o.result),c.oldVersion,c.newVersion,Cn(o.transaction),c)}),e&&o.addEventListener("blocked",c=>e(c.oldVersion,c.newVersion,c)),a.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),a}function Jb(n,{blocked:t}={}){const e=indexedDB.deleteDatabase(n);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),Cn(e).then(()=>{})}const jb=["get","getKey","getAll","getAllKeys","count"],eE=["put","add","delete","clear"],nl=new Map;function ad(n,t){if(!(n instanceof IDBDatabase&&!(t in n)&&typeof t=="string"))return;if(nl.get(t))return nl.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,s=eE.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(s||jb.includes(e)))return;const i=async function(o,...a){const c=this.transaction(o,s?"readwrite":"readonly");let l=c.store;return r&&(l=l.index(a.shift())),(await Promise.all([l[e](...a),s&&c.done]))[0]};return nl.set(t,i),i}V4(n=>({...n,get:(t,e,r)=>ad(t,e)||n.get(t,e,r),has:(t,e)=>!!ad(t,e)||n.has(t,e)}));const tE=["continue","continuePrimaryKey","advance"],cd={},Yl=new WeakMap,$4=new WeakMap,rE={get(n,t){if(!tE.includes(t))return n[t];let e=cd[t];return e||(e=cd[t]=function(...r){Yl.set(this,$4.get(this)[t](...r))}),e}};async function*nE(...n){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...n)),!t)return;t=t;const e=new Proxy(t,rE);for($4.set(e,t),Ic.set(e,Gl(t));t;)yield e,t=await(Yl.get(e)||t.continue()),Yl.delete(e)}function ld(n,t){return t===Symbol.asyncIterator&&zl(n,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&zl(n,[IDBIndex,IDBObjectStore])}V4(n=>({...n,get(t,e,r){return ld(t,e)?nE:n.get(t,e,r)},has(t,e){return ld(t,e)||n.has(t,e)}}));var fo,Ql;class sE extends s4{constructor(e,r={}){super();j(this,fo);h(this,"location");h(this,"version");h(this,"db");this.location=`${r.prefix??""}${e}`,this.version=r.version??1}async open(){try{const e=this.location;this.db=await Zb(e,this.version,{upgrade(r){r.createObjectStore(e)}})}catch(e){throw ew(e)}}async close(){var e;(e=this.db)==null||e.close()}async put(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return await this.db.put(this.location,r,e.toString()),e}catch(s){throw rw(s)}}async get(e){if(this.db==null)throw new Error("Datastore needs to be opened.");let r;try{r=await this.db.get(this.location,e.toString())}catch(s){throw Jh(s)}if(r===void 0)throw i4();return r}async has(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{return!!await this.db.getKey(this.location,e.toString())}catch(r){throw Jh(r)}}async delete(e){if(this.db==null)throw new Error("Datastore needs to be opened.");try{await this.db.delete(this.location,e.toString())}catch(r){throw tw(r)}}batch(){const e=[],r=[];return{put(s,i){e.push({key:s,value:i})},delete(s){r.push(s)},commit:async()=>{if(this.db==null)throw new Error("Datastore needs to be opened.");const s=this.db.transaction(this.location,"readwrite");try{const i=e.filter(({key:o})=>r.find(a=>a.toString()===o.toString())==null).map(o=>async()=>{await s.store.put(o.value,o.key.toString())}).concat(r.map(o=>async()=>{await s.store.delete(o.toString())})).concat(async()=>{await s.done});await Promise.all(i.map(async o=>{await o()}))}catch{s.abort()}}}}async*query(e){let r=O(this,fo,Ql).call(this,e,(s,i)=>({key:s,value:i}));Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>dn(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>La(s,i),r)),yield*r}async*queryKeys(e){let r=O(this,fo,Ql).call(this,e,s=>s);Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>dn(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>La(s,i),r)),yield*r}async destroy(){await Jb(this.location)}}fo=new WeakSet,Ql=async function*(e,r){if(this.db==null)throw new Error("Datastore needs to be opened.");let s=0,i=-1;for(const o of await this.db.getAllKeys(this.location)){if(e.prefix!=null&&!o.toString().startsWith(e.prefix))continue;if(e.limit!=null&&s===e.limit)return;if(i++,e.offset!=null&&i<e.offset)continue;const a=new Be(o.toString());let c;try{c=await this.get(a)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;continue}c!=null&&(yield r(a,c),s++)}};function ud(){const n=me();let t=!1;return{sink:async e=>{if(t)throw new Error("already piped");t=!0,n.resolve(e)},source:async function*(){yield*await n.promise}()}}function iE(){const n=ud(),t=ud();return[{source:n.source,sink:t.sink},{source:t.source,sink:n.sink}]}const no=65535,hd=no-16;var A0,T0;const xo=!!((T0=(A0=globalThis.process)==null?void 0:A0.env)!=null&&T0.DUMP_SESSION_KEYS);function sl(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function dd(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function K4(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function Rr(n,...t){if(!K4(n))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(n.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${n.length}`)}function fd(n,t=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(t&&n.finished)throw new Error("Hash#digest() has already been called")}function oE(n,t){Rr(n);const e=t.outputLen;if(n.length<e)throw new Error(`digestInto() expects output buffer of length at least ${e}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const Pn=n=>new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4)),aE=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),cE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!cE)throw new Error("Non little-endian hardware is not supported");function lE(n){if(typeof n!="string")throw new Error(`string expected, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function Xl(n){if(typeof n=="string")n=lE(n);else if(K4(n))n=n.slice();else throw new Error(`Uint8Array expected, got ${typeof n}`);return n}function uE(n,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(n,t)}function hE(n,t){if(n.length!==t.length)return!1;let e=0;for(let r=0;r<n.length;r++)e|=n[r]^t[r];return e===0}const dE=(n,t)=>(Object.assign(t,n),t);function gd(n,t,e,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(t,e,r);const s=BigInt(32),i=BigInt(4294967295),o=Number(e>>s&i),a=Number(e&i),c=4,l=0;n.setUint32(t+c,o,r),n.setUint32(t+l,a,r)}const rt=(n,t)=>n[t++]&255|(n[t++]&255)<<8;class fE{constructor(t){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,t=Xl(t),Rr(t,32);const e=rt(t,0),r=rt(t,2),s=rt(t,4),i=rt(t,6),o=rt(t,8),a=rt(t,10),c=rt(t,12),l=rt(t,14);this.r[0]=e&8191,this.r[1]=(e>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=rt(t,16+2*u)}process(t,e,r=!1){const s=r?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],d=o[4],f=o[5],p=o[6],y=o[7],g=o[8],m=o[9],w=rt(t,e+0),_=rt(t,e+2),b=rt(t,e+4),S=rt(t,e+6),I=rt(t,e+8),A=rt(t,e+10),P=rt(t,e+12),T=rt(t,e+14);let R=i[0]+(w&8191),C=i[1]+((w>>>13|_<<3)&8191),k=i[2]+((_>>>10|b<<6)&8191),B=i[3]+((b>>>7|S<<9)&8191),L=i[4]+((S>>>4|I<<12)&8191),z=i[5]+(I>>>1&8191),x=i[6]+((I>>>14|A<<2)&8191),N=i[7]+((A>>>11|P<<5)&8191),$=i[8]+((P>>>8|T<<8)&8191),M=i[9]+(T>>>5|s),D=0,V=D+R*a+C*(5*m)+k*(5*g)+B*(5*y)+L*(5*p);D=V>>>13,V&=8191,V+=z*(5*f)+x*(5*d)+N*(5*u)+$*(5*l)+M*(5*c),D+=V>>>13,V&=8191;let K=D+R*c+C*a+k*(5*m)+B*(5*g)+L*(5*y);D=K>>>13,K&=8191,K+=z*(5*p)+x*(5*f)+N*(5*d)+$*(5*u)+M*(5*l),D+=K>>>13,K&=8191;let W=D+R*l+C*c+k*a+B*(5*m)+L*(5*g);D=W>>>13,W&=8191,W+=z*(5*y)+x*(5*p)+N*(5*f)+$*(5*d)+M*(5*u),D+=W>>>13,W&=8191;let te=D+R*u+C*l+k*c+B*a+L*(5*m);D=te>>>13,te&=8191,te+=z*(5*g)+x*(5*y)+N*(5*p)+$*(5*f)+M*(5*d),D+=te>>>13,te&=8191;let re=D+R*d+C*u+k*l+B*c+L*a;D=re>>>13,re&=8191,re+=z*(5*m)+x*(5*g)+N*(5*y)+$*(5*p)+M*(5*f),D+=re>>>13,re&=8191;let ie=D+R*f+C*d+k*u+B*l+L*c;D=ie>>>13,ie&=8191,ie+=z*a+x*(5*m)+N*(5*g)+$*(5*y)+M*(5*p),D+=ie>>>13,ie&=8191;let ne=D+R*p+C*f+k*d+B*u+L*l;D=ne>>>13,ne&=8191,ne+=z*c+x*a+N*(5*m)+$*(5*g)+M*(5*y),D+=ne>>>13,ne&=8191;let se=D+R*y+C*p+k*f+B*d+L*u;D=se>>>13,se&=8191,se+=z*l+x*c+N*a+$*(5*m)+M*(5*g),D+=se>>>13,se&=8191;let Ae=D+R*g+C*y+k*p+B*f+L*d;D=Ae>>>13,Ae&=8191,Ae+=z*u+x*l+N*c+$*a+M*(5*m),D+=Ae>>>13,Ae&=8191;let Ie=D+R*m+C*g+k*y+B*p+L*f;D=Ie>>>13,Ie&=8191,Ie+=z*d+x*u+N*l+$*c+M*a,D+=Ie>>>13,Ie&=8191,D=(D<<2)+D|0,D=D+V|0,V=D&8191,D=D>>>13,K+=D,i[0]=V,i[1]=K,i[2]=W,i[3]=te,i[4]=re,i[5]=ie,i[6]=ne,i[7]=se,i[8]=Ae,i[9]=Ie}finalize(){const{h:t,pad:e}=this,r=new Uint16Array(10);let s=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=s,s=t[a]>>>13,t[a]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,r[0]=t[0]+5,s=r[0]>>>13,r[0]&=8191;for(let a=1;a<10;a++)r[a]=t[a]+s,s=r[a]>>>13,r[a]&=8191;r[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)r[a]&=i;i=~i;for(let a=0;a<10;a++)t[a]=t[a]&i|r[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let o=t[0]+e[0];t[0]=o&65535;for(let a=1;a<8;a++)o=(t[a]+e[a]|0)+(o>>>16)|0,t[a]=o&65535}update(t){fd(this);const{buffer:e,blockLen:r}=this;t=Xl(t);const s=t.length;for(let i=0;i<s;){const o=Math.min(r-this.pos,s-i);if(o===r){for(;r<=s-i;i+=r)this.process(t,i);continue}e.set(t.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===r&&(this.process(e,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(t){fd(this),oE(t,this),this.finished=!0;const{buffer:e,h:r}=this;let{pos:s}=this;if(s){for(e[s++]=1;s<16;s++)e[s]=0;this.process(e,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)t[i++]=r[o]>>>0,t[i++]=r[o]>>>8;return t}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const r=t.slice(0,e);return this.destroy(),r}}function gE(n){const t=(r,s)=>n(s).update(Xl(r)).digest(),e=n(new Uint8Array(32));return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=r=>n(r),t}const pE=gE(n=>new fE(n)),H4=n=>Uint8Array.from(n.split("").map(t=>t.charCodeAt(0))),mE=H4("expand 16-byte k"),yE=H4("expand 32-byte k"),wE=Pn(mE),z4=Pn(yE);z4.slice();function we(n,t){return n<<t|n>>>32-t}function Zl(n){return n.byteOffset%4===0}const Qo=64,bE=16,W4=2**32-1,pd=new Uint32Array;function EE(n,t,e,r,s,i,o,a){const c=s.length,l=new Uint8Array(Qo),u=Pn(l),d=Zl(s)&&Zl(i),f=d?Pn(s):pd,p=d?Pn(i):pd;for(let y=0;y<c;o++){if(n(t,e,r,u,o,a),o>=W4)throw new Error("arx: counter overflow");const g=Math.min(Qo,c-y);if(d&&g===Qo){const m=y/4;if(y%4!==0)throw new Error("arx: invalid block position");for(let w=0,_;w<bE;w++)_=m+w,p[_]=f[_]^u[w];y+=Qo;continue}for(let m=0,w;m<g;m++)w=y+m,i[w]=s[w]^l[m];y+=g}}function vE(n,t){const{allowShortKeys:e,extendNonceFn:r,counterLength:s,counterRight:i,rounds:o}=uE({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof n!="function")throw new Error("core must be a function");return sl(s),sl(o),dd(i),dd(e),(a,c,l,u,d=0)=>{Rr(a),Rr(c),Rr(l);const f=l.length;if(u||(u=new Uint8Array(f)),Rr(u),sl(d),d<0||d>=W4)throw new Error("arx: counter overflow");if(u.length<f)throw new Error(`arx: output (${u.length}) is shorter than data (${f})`);const p=[];let y=a.length,g,m;if(y===32)g=a.slice(),p.push(g),m=z4;else if(y===16&&e)g=new Uint8Array(32),g.set(a),g.set(a,16),m=wE,p.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${y}`);Zl(c)||(c=c.slice(),p.push(c));const w=Pn(g);if(r){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(m,w,Pn(c.subarray(0,16)),w),c=c.subarray(16)}const _=16-s;if(_!==c.length)throw new Error(`arx: nonce must be ${_} or 16 bytes`);if(_!==12){const S=new Uint8Array(12);S.set(c,i?0:12-c.length),c=S,p.push(c)}const b=Pn(c);for(EE(n,m,w,b,l,u,d,o);p.length>0;)p.pop().fill(0);return u}}function _E(n,t,e,r,s,i=20){let o=n[0],a=n[1],c=n[2],l=n[3],u=t[0],d=t[1],f=t[2],p=t[3],y=t[4],g=t[5],m=t[6],w=t[7],_=s,b=e[0],S=e[1],I=e[2],A=o,P=a,T=c,R=l,C=u,k=d,B=f,L=p,z=y,x=g,N=m,$=w,M=_,D=b,V=S,K=I;for(let te=0;te<i;te+=2)A=A+C|0,M=we(M^A,16),z=z+M|0,C=we(C^z,12),A=A+C|0,M=we(M^A,8),z=z+M|0,C=we(C^z,7),P=P+k|0,D=we(D^P,16),x=x+D|0,k=we(k^x,12),P=P+k|0,D=we(D^P,8),x=x+D|0,k=we(k^x,7),T=T+B|0,V=we(V^T,16),N=N+V|0,B=we(B^N,12),T=T+B|0,V=we(V^T,8),N=N+V|0,B=we(B^N,7),R=R+L|0,K=we(K^R,16),$=$+K|0,L=we(L^$,12),R=R+L|0,K=we(K^R,8),$=$+K|0,L=we(L^$,7),A=A+k|0,K=we(K^A,16),N=N+K|0,k=we(k^N,12),A=A+k|0,K=we(K^A,8),N=N+K|0,k=we(k^N,7),P=P+B|0,M=we(M^P,16),$=$+M|0,B=we(B^$,12),P=P+B|0,M=we(M^P,8),$=$+M|0,B=we(B^$,7),T=T+L|0,D=we(D^T,16),z=z+D|0,L=we(L^z,12),T=T+L|0,D=we(D^T,8),z=z+D|0,L=we(L^z,7),R=R+C|0,V=we(V^R,16),x=x+V|0,C=we(C^x,12),R=R+C|0,V=we(V^R,8),x=x+V|0,C=we(C^x,7);let W=0;r[W++]=o+A|0,r[W++]=a+P|0,r[W++]=c+T|0,r[W++]=l+R|0,r[W++]=u+C|0,r[W++]=d+k|0,r[W++]=f+B|0,r[W++]=p+L|0,r[W++]=y+z|0,r[W++]=g+x|0,r[W++]=m+N|0,r[W++]=w+$|0,r[W++]=_+M|0,r[W++]=b+D|0,r[W++]=S+V|0,r[W++]=I+K|0}const SE=vE(_E,{counterRight:!1,counterLength:4,allowShortKeys:!1}),IE=new Uint8Array(16),md=(n,t)=>{n.update(t);const e=t.length%16;e&&n.update(IE.subarray(e))},RE=new Uint8Array(32);function yd(n,t,e,r,s){const i=n(t,e,RE),o=pE.create(i);s&&md(o,s),md(o,r);const a=new Uint8Array(16),c=aE(a);gd(c,0,BigInt(s?s.length:0),!0),gd(c,8,BigInt(r.length),!0),o.update(a);const l=o.digest();return i.fill(0),l}const AE=n=>(t,e,r)=>(Rr(t,32),Rr(e),{encrypt:(i,o)=>{const a=i.length,c=a+16;o?Rr(o,c):o=new Uint8Array(c),n(t,e,i,o,1);const l=yd(n,t,e,o.subarray(0,-16),r);return o.set(l,a),o},decrypt:(i,o)=>{const a=i.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Rr(o,c):o=new Uint8Array(c);const l=i.subarray(0,-16),u=i.subarray(-16),d=yd(n,t,e,l,r);if(!hE(u,d))throw new Error("invalid tag");return n(t,e,l,o,1),o}}),wd=dE({blockSize:64,nonceLength:12,tagLength:16},AE(SE));function TE(n,t,e){return cc(n),e===void 0&&(e=new Uint8Array(n.outputLen)),_o(n,ns(e),ns(t))}const il=new Uint8Array([0]),bd=new Uint8Array;function DE(n,t,e,r=32){if(cc(n),Ps(r),r>255*n.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/n.outputLen);e===void 0&&(e=bd);const i=new Uint8Array(s*n.outputLen),o=_o.create(n,t),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let l=0;l<s;l++)il[0]=l+1,a.update(l===0?bd:c).update(e).update(il).digestInto(c),i.set(c,n.outputLen*l),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),il.fill(0),i.slice(0,r)}const xE={hashSHA256(n){return na(n.subarray())},getHKDF(n,t){const e=TE(na,t,n),s=DE(na,e,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const n=Ho.utils.randomPrivateKey();return{publicKey:Ho.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:Ho.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,t){return Ho.getSharedSecret(n.subarray(),t.subarray())},chaCha20Poly1305Encrypt(n,t,e,r){return wd(r,t,e).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,t,e,r,s){return wd(r,t,e).decrypt(n.subarray(),s)}},CE=xE;function PE(n){return{generateKeypair:n.generateX25519KeyPair,dh:(t,e)=>n.generateX25519SharedKey(t.privateKey,e).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const $a=n=>{const t=fr(2);return t[0]=n>>8,t[1]=n,t};$a.bytes=2;const da=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let t=0;return t+=n[0]<<8,t+=n[1],t}return n.getUint16(0)};da.bytes=2;function kE(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function q4(n,t){!t.enabled||!xo||(n?(t(`LOCAL_STATIC_PUBLIC_KEY ${X(n.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${X(n.privateKey,"hex")}`)):t("Missing local static keys."))}function G4(n,t){!t.enabled||!xo||(n?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${X(n.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${X(n.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function NE(n,t){!t.enabled||!xo||t(n?`REMOTE_STATIC_PUBLIC_KEY ${X(n.subarray(),"hex")}`:"Missing remote static public key.")}function Y4(n,t){!t.enabled||!xo||t(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${X(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Q4(n,t,e){!e.enabled||!xo||(e(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&X(n.k,"hex")}`),e(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&X(t.k,"hex")}`))}function ni(n,t){if(n.length!==t.length)throw new Error("Inputs should have the same length");const e=fr(n.length);for(let r=0;r<n.length;r++)e[r]=n[r]^t[r];return e}const ja=class ja extends Error{constructor(e="Unexpected Peer"){super(e);h(this,"code");this.code=ja.code}};h(ja,"code","ERR_UNEXPECTED_PEER");let Jl=ja;const ec=class ec extends Error{constructor(e="Invalid crypto exchange"){super(e);h(this,"code");this.code=ec.code}};h(ec,"code","ERR_INVALID_CRYPTO_EXCHANGE");let Bi=ec;const ME=0,OE=4294967295,LE="Cipherstate has reached maximum n, a new handshake must be performed";class BE{constructor(t=ME){h(this,"n");h(this,"bytes");h(this,"view");this.n=t,this.bytes=Ue(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>OE)throw new Error(LE)}}const Ns=Ue(0);class Xo{constructor(t,e=void 0,r=0){h(this,"k");h(this,"n");h(this,"crypto");this.crypto=t,this.k=e,this.n=new BE(r)}hasKey(){return!!this.k}encryptWithAd(t,e){if(!this.hasKey())return e;this.n.assertValue();const r=this.crypto.encrypt(e,this.n.getBytes(),t,this.k);return this.n.increment(),r}decryptWithAd(t,e,r){if(!this.hasKey())return e;this.n.assertValue();const s=this.crypto.decrypt(e,this.n.getBytes(),t,this.k,r);return this.n.increment(),s}}class UE{constructor(t,e){h(this,"cs");h(this,"ck");h(this,"h");h(this,"crypto");this.crypto=t;const r=Y(e,"utf-8");this.h=VE(t,r),this.ck=this.h,this.cs=new Xo(t)}mixKey(t){const[e,r]=this.crypto.hkdf(this.ck,t);this.ck=e,this.cs=new Xo(this.crypto,r)}mixHash(t){this.h=this.crypto.hash(new Oe(this.h,t))}encryptAndHash(t){const e=this.cs.encryptWithAd(this.h,t);return this.mixHash(e),e}decryptAndHash(t){const e=this.cs.decryptWithAd(this.h,t);return this.mixHash(t),e}split(){const[t,e]=this.crypto.hkdf(this.ck,Ns);return[new Xo(this.crypto,t),new Xo(this.crypto,e)]}}class FE{constructor(t){h(this,"ss");h(this,"s");h(this,"e");h(this,"rs");h(this,"re");h(this,"initiator");h(this,"crypto");const{crypto:e,protocolName:r,prologue:s,initiator:i,s:o,e:a,rs:c,re:l}=t;this.crypto=e,this.ss=new UE(e,r),this.ss.mixHash(s),this.initiator=i,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const t=this.crypto.generateKeypair();return this.ss.mixHash(t.publicKey),this.e=t,t.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(t,e=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(t.byteLength<e+32)throw new Error("message is not long enough");this.re=t.sublist(e,e+32),this.ss.mixHash(this.re)}readS(t,e=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(t.byteLength<e+r)throw new Error("message is not long enough");const s=t.sublist(e,e+r);return this.rs=this.ss.decryptAndHash(s),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class X4 extends FE{writeMessageA(t){return new Oe(this.writeE(),this.ss.encryptAndHash(t))}writeMessageB(t){const e=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Oe(e,r,this.ss.encryptAndHash(t))}writeMessageC(t){const e=this.writeS();return this.writeSE(),new Oe(e,this.ss.encryptAndHash(t))}readMessageA(t){try{return this.readE(t),this.ss.decryptAndHash(t.sublist(32))}catch(e){throw new Bi(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(t){try{this.readE(t),this.readEE();const e=this.readS(t,32);return this.readES(),this.ss.decryptAndHash(t.sublist(32+e))}catch(e){throw new Bi(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(t){try{const e=this.readS(t);return this.readSE(),this.ss.decryptAndHash(t.sublist(e))}catch(e){throw new Bi(`handshake stage 2 validation fail: ${e.message}`)}}}function VE(n,t){if(t.length<=32){const e=Ue(32);return e.set(t),e}else return n.hash(t)}var Ka;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.webtransportCerthashes!=null)for(const i of e.webtransportCerthashes)r.uint32(10),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={webtransportCerthashes:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.webtransportCerthashes.push(e.bytes());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Ka||(Ka={}));var Ha;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.identityKey!=null&&e.identityKey.byteLength>0&&(r.uint32(10),r.bytes(e.identityKey)),e.identitySig!=null&&e.identitySig.byteLength>0&&(r.uint32(18),r.bytes(e.identitySig)),e.extensions!=null&&(r.uint32(34),Ka.codec().encode(e.extensions,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={identityKey:Ue(0),identitySig:Ue(0)},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.identityKey=e.bytes();break}case 2:{s.identitySig=e.bytes();break}case 4:{s.extensions=Ka.codec().decode(e,e.uint32());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Ha||(Ha={}));async function Z4(n,t,e){const r=await n.sign(j4(t));return Ha.encode({identityKey:n.public.bytes,identitySig:r,extensions:e})}async function J4(n,t,e){try{const r=Ha.decode(n);if(e){const o=e.subarray();if(!ke(o,r.identityKey))throw new Error(`Payload identity key ${X(r.identityKey,"hex")} does not match expected remote identity key ${X(o,"hex")}`)}if(!t)throw new Error("Remote static does not exist");const s=j4(t);if(!await ls(r.identityKey).verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new Jl(r.message)}}function j4(n){const t=Y("noise-libp2p-static-key:");return n instanceof Uint8Array?at([t,n],t.length+n.length):(n.prepend(t),n)}async function $E(n){const{log:t,connection:e,crypto:r,privateKey:s,prologue:i,s:o,remoteIdentityKey:a,extensions:c}=n,l=await Z4(s,o.publicKey,c),u=new X4({crypto:r,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:i,s:o});q4(u.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await e.write(u.writeMessageA(Ns)),t.trace("Stage 0 - Initiator finished sending first message."),G4(u.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=u.readMessageB(await e.read());t.trace("Stage 1 - Initiator received the message."),Y4(u.re,t),NE(u.rs,t),t.trace("Initiator going to check remote's signature...");const f=await J4(d,u.rs,a);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await e.write(u.writeMessageC(l)),t.trace("Stage 2 - Initiator sent message with signed payload.");const[p,y]=u.ss.split();return Q4(p,y,t),{payload:f,encrypt:g=>p.encryptWithAd(Ns,g),decrypt:(g,m)=>y.decryptWithAd(Ns,g,m)}}async function KE(n){const{log:t,connection:e,crypto:r,privateKey:s,prologue:i,s:o,remoteIdentityKey:a,extensions:c}=n,l=await Z4(s,o.publicKey,c),u=new X4({crypto:r,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:i,s:o});q4(u.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),u.readMessageA(await e.read()),t.trace("Stage 0 - Responder received first message."),Y4(u.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await e.write(u.writeMessageB(l)),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),G4(u.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const d=u.readMessageC(await e.read());t.trace("Stage 2 - Responder received the message, finished handshake.");const f=await J4(d,u.rs,a),[p,y]=u.ss.split();return Q4(p,y,t),{payload:f,encrypt:g=>y.encryptWithAd(Ns,g),decrypt:(g,m)=>p.decryptWithAd(Ns,g,m)}}const Ed=16;function HE(n,t){return async function*(e){for await(const r of e)for(let s=0;s<r.length;s+=hd){let i=s+hd;i>r.length&&(i=r.length);let o;r instanceof Uint8Array?o=n.encrypt(r.subarray(s,i)):o=n.encrypt(r.sublist(s,i)),t==null||t.encryptedPackets.increment(),yield new Oe($a(o.byteLength),o)}}}function zE(n,t){return async function*(e){for await(const r of e)for(let s=0;s<r.length;s+=no){let i=s+no;if(i>r.length&&(i=r.length),i-Ed<s)throw new Error("Invalid chunk");const o=r.sublist(s,i),a=r.subarray(s,i-Ed);try{const c=n.decrypt(o,a);t==null||t.decryptedPackets.increment(),yield c}catch(c){throw t==null||t.decryptErrors.increment(),c}}}}var D0,x0;x0=Symbol.toStringTag,D0=jt;class WE{constructor(t,e={}){h(this,"protocol","/noise");h(this,"crypto");h(this,"prologue");h(this,"staticKey");h(this,"extensions");h(this,"metrics");h(this,"components");h(this,x0,"@chainsafe/libp2p-noise");h(this,D0,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:r,extensions:s,crypto:i,prologueBytes:o}=e,{metrics:a}=t;this.components=t;const c=i??CE;this.crypto=PE(c),this.extensions=s,this.metrics=a?kE(a):void 0,r?this.staticKey=c.generateX25519KeyPairFromSeed(r):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Ue(0)}async secureOutbound(t,e,r){const s=Gs(e,{lengthEncoder:$a,lengthDecoder:da,maxDataLength:no});if(!t.privateKey)throw new v("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const i=await Ji(t.privateKey),o=r==null?void 0:r.publicKey,a=await this.performHandshakeInitiator(s,i,o),c=await this.createSecureConnection(s,a);return e.source=c.source,e.sink=c.sink,{conn:e,remoteExtensions:a.payload.extensions,remotePeer:await Cr(a.payload.identityKey)}}async secureInbound(t,e,r){const s=Gs(e,{lengthEncoder:$a,lengthDecoder:da,maxDataLength:no});if(!t.privateKey)throw new v("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const i=await Ji(t.privateKey),o=r==null?void 0:r.publicKey,a=await this.performHandshakeResponder(s,i,o),c=await this.createSecureConnection(s,a);return e.source=c.source,e.sink=c.sink,{conn:e,remoteExtensions:a.payload.extensions,remotePeer:await Cr(a.payload.identityKey)}}async performHandshakeInitiator(t,e,r){var i,o;let s;try{s=await $E({connection:t,privateKey:e,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions}),(i=this.metrics)==null||i.xxHandshakeSuccesses.increment()}catch(a){throw(o=this.metrics)==null||o.xxHandshakeErrors.increment(),a}return s}async performHandshakeResponder(t,e,r){var i,o;let s;try{s=await KE({connection:t,privateKey:e,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions}),(i=this.metrics)==null||i.xxHandshakeSuccesses.increment()}catch(a){throw(o=this.metrics)==null||o.xxHandshakeErrors.increment(),a}return s}async createSecureConnection(t,e){const[r,s]=iE(),i=t.unwrap();return await Zt(r,HE(e,this.metrics),i,o=>kn(o,{lengthDecoder:da}),zE(e,this.metrics),r),s}}function e6(n={}){return t=>new WE(t,n)}function qE(n){throw new Error("Not implemented")}function t6(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}function GE(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function YE(n,t){var r,s;const e=(s=(r=t6(n)).return)==null?void 0:s.call(r);GE(e)&&e.catch(i=>{t.error("could not cause iterator to return",i)})}const QE="ERR_STREAM_RESET",XE="ERR_SINK_INVALID_STATE",ZE=5e3;function ol(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class Au{constructor(t){h(this,"id");h(this,"direction");h(this,"timeline");h(this,"protocol");h(this,"metadata");h(this,"source");h(this,"status");h(this,"readStatus");h(this,"writeStatus");h(this,"log");h(this,"sinkController");h(this,"sinkEnd");h(this,"closed");h(this,"endErr");h(this,"streamSource");h(this,"onEnd");h(this,"onCloseRead");h(this,"onCloseWrite");h(this,"onReset");h(this,"onAbort");h(this,"sendCloseWriteTimeout");h(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=me(),this.closed=me(),this.log=t.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=t.id,this.metadata=t.metadata??{},this.direction=t.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=t.sendCloseWriteTimeout??ZE,this.onEnd=t.onEnd,this.onCloseRead=t==null?void 0:t.onCloseRead,this.onCloseWrite=t==null?void 0:t.onCloseWrite,this.onReset=t==null?void 0:t.onReset,this.onAbort=t==null?void 0:t.onAbort,this.source=this.streamSource=jr({onEnd:e=>{e!=null?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(t){if(this.writeStatus!=="ready")throw new v(`writable end state is "${this.writeStatus}" not "ready"`,XE);try{this.writeStatus="writing";const e={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(e);ol(s)&&await s}const r=()=>{YE(t,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let s of t){s=s instanceof Uint8Array?new Oe(s):s;const i=this.sendData(s,e);ol(i)&&(this.sendingData=me(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(t){var e;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),(e=this.onCloseRead)==null||e.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(t){var e;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",t!=null&&this.endErr==null&&(this.endErr=t),(e=this.onCloseWrite)==null||e.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(t){this.log.trace("closing gracefully"),this.status="closing",await it(Promise.all([this.closeWrite(t),this.closeRead(t),this.closed.promise]),t==null?void 0:t.signal),this.status="closed",this.log.trace("closed gracefully")}async closeRead(t={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const e=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(t)),e==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(t={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await it(this.sink([]),t.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await it(this.sendingData.promise,t.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await it(this.sinkEnd.promise,t.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(t){var r;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",t),this.log("try to send reset to remote");const e=this.sendReset();ol(e)&&e.catch(s=>{this.log.error("error sending reset message",s)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(t),(r=this.onAbort)==null||r.call(this,t)}reset(){var e;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const t=new v("stream reset",QE);this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(t),(e=this.onReset)==null||e.call(this)}_closeSinkAndSource(t){this._closeSink(t),this._closeSource(t)}_closeSink(t){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(t)}_closeSource(t){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(t))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(t){this.streamSource.push(t)}sourceReadableLength(){return this.streamSource.readableLength}}class JE extends Au{constructor(e){super(e);h(this,"writer");h(this,"reader");this.writer=e.bidiStream.writable.getWriter(),this.reader=e.bidiStream.readable.getReader(),Promise.resolve().then(async()=>{for(;;){const r=await this.reader.read();if(r.done){e.log("remote closed write");return}r.value!=null&&this.sourcePush(new Oe(r.value))}}).catch(r=>{e.log.error("error reading from stream",r),this.abort(r)}).finally(()=>{this.remoteCloseWrite()}),this.writer.closed.then(()=>{e.log("writer closed")}).catch(r=>{e.log("writer close promise rejected",r)}).finally(()=>{this.remoteCloseRead()})}sendNewStream(e){}async sendData(e,r){for await(const s of e)this.log("sendData waiting for writer to be ready"),await it(this.writer.ready,r==null?void 0:r.signal),this.writer.write(s).catch(i=>{this.log.error("error sending stream data",i)})}async sendReset(e){this.log("sendReset aborting writer"),await it(this.writer.abort(),e==null?void 0:e.signal),this.log("sendReset aborted writer")}async sendCloseWrite(e){this.log("sendCloseWrite closing writer"),await it(this.writer.close(),e==null?void 0:e.signal),this.log("sendCloseWrite closed writer")}async sendCloseRead(e){this.log("sendCloseRead cancelling reader"),await it(this.reader.cancel(),e==null?void 0:e.signal),this.log("sendCloseRead cancelled reader")}}async function vd(n,t,e,r,s,i){const o=i.forComponent(`libp2p:webtransport:stream:${e}:${t}`),a=new JE({bidiStream:n,id:t,direction:e,log:o,onEnd:()=>{const c=r.findIndex(l=>l===a);c!==-1&&r.splice(c,1),s==null||s(a)}});return a}function r6(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async n=>new Promise(()=>{})}}function jE(n,t,e,r){let s=0;const i=e.forComponent("libp2p:webtransport:muxer");return{protocol:"webtransport",createStreamMuxer:o=>{typeof o=="function"&&(o={onIncomingStream:o});const a=[];Promise.resolve().then(async()=>{//! TODO unclear how to add backpressure here?
var l;for(;;){const{done:u,value:d}=await t.read();if(u)break;if(a.length>=r.maxInboundStreams)i(`too many inbound streams open - ${a.length}/${r.maxInboundStreams}, closing new incoming stream`),d.writable.close().catch(f=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)}),d.readable.cancel().catch(f=>{i.error(`failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)});else{const f=await vd(d,String(s++),"inbound",a,o==null?void 0:o.onStreamEnd,e);a.push(f),(l=o==null?void 0:o.onIncomingStream)==null||l.call(o,f)}}}).catch(l=>{i.error("could not create a new stream",l)});const c={protocol:"webtransport",streams:a,newStream:async l=>{i("new outgoing stream",l);const u=await n.createBidirectionalStream(),d=await vd(u,String(s++),(o==null?void 0:o.direction)??"outbound",a,o==null?void 0:o.onStreamEnd,e);return a.push(d),d},close:async()=>{i("closing webtransport muxer gracefully");try{n.close()}catch(l){c.abort(l)}},abort:l=>{i("closing webtransport muxer with err:",l);try{n.close()}catch(u){i.error("webtransport session threw error during close",u)}},...r6()};return c}}}function ev(n,t){return t.filter(r=>!!n.find(s=>ke(r,s))).length===t.length}const tv=Object.values(Ws).map(n=>n.decoder).reduce((n,t)=>n.or(t));function rv(n){return yo(tv.decode(n))}function _d(n){if(!p4.matches(n))throw new v("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");const t=n.stringTuples(),e=t.filter(([o,a])=>o===ce("certhash").code).map(([o,a])=>rv(a??"")),r=t.filter(([o,a])=>o===ce("p2p").code).map(([o,a])=>ye(a??""))[0],s=n.toOptions();let i=s.host;return s.family===6&&(i!=null&&i.includes(":"))&&(i=`[${i}]`),{url:`https://${i}:${s.port}`,certhashes:e,remotePeer:r}}const nv=WebTransport;var C0,P0,k0;k0=Symbol.toStringTag,P0=sc,C0=jt;class sv{constructor(t,e={}){h(this,"log");h(this,"components");h(this,"config");h(this,"metrics");h(this,k0,"@libp2p/webtransport");h(this,P0,!0);h(this,C0,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:webtransport"),this.components=t,this.config={...e,maxInboundStreams:e.maxInboundStreams??1e3,certificates:e.certificates??[]},t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webtransport_dialer_events_total",{label:"event",help:"Total count of WebTransport dialer events by type"})})}async dial(t,e){var p,y,g,m,w,_;if(((p=e==null?void 0:e.signal)==null?void 0:p.aborted)===!0)throw new ts;this.log("dialing %s",t);const r=this.components.peerId;if(r===void 0)throw new v("Need a local peerid","ERR_INVALID_PARAMETERS");e=e??{};const{url:s,certhashes:i,remotePeer:o}=_d(t);let a,c,l=()=>{},u=!1,d=!1,f=!1;try{(y=this.metrics)==null||y.dialerEvents.increment({pending:!0});const b=new nv(`${s}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:i.map(S=>({algorithm:"sha-256",value:S.digest}))});if(l=S=>{var I;if(!u)try{(I=this.metrics)==null||I.dialerEvents.increment({[S]:!0}),b.close()}catch(A){this.log.error("error closing wt session",A)}finally{c!=null&&(c.timeline.close=Date.now()),u=!0}},a=()=>{l(d?"noise_timeout":"ready_timeout")},(g=e.signal)==null||g.addEventListener("abort",a,{once:!0}),this.log("wait for session to be ready"),await Promise.race([b.closed,b.ready]),this.log("session became ready"),d=!0,(m=this.metrics)==null||m.dialerEvents.increment({ready:!0}),b.closed.catch(S=>{this.log.error("error on remote wt session close",S)}).finally(()=>{l("remote_close")}),f=await it(this.authenticateWebTransport(b,r,o,i),e.signal),!f)throw new v("Failed to authenticate webtransport","ERR_AUTHENTICATION_FAILED");return(w=this.metrics)==null||w.dialerEvents.increment({open:!0}),c={close:async()=>{this.log("closing webtransport"),l("close")},abort:S=>{this.log("aborting webtransport due to passed err",S),l("abort")},remoteAddr:t,timeline:{open:Date.now()},log:this.components.logger.forComponent("libp2p:webtransport:maconn"),...r6()},await e.upgrader.upgradeOutbound(c,{skipEncryption:!0,muxerFactory:jE(b,b.incomingBidirectionalStreams.getReader(),this.components.logger,this.config),skipProtection:!0})}catch(b){throw this.log.error("caught wt session err",b),l(f?"upgrade_error":d?"noise_error":"ready_error"),b}finally{a!=null&&((_=e.signal)==null||_.removeEventListener("abort",a))}}async authenticateWebTransport(t,e,r,s=[],i){if((i==null?void 0:i.aborted)===!0)throw new ts;const o=await t.createBidirectionalStream(),a=o.writable.getWriter(),c=o.readable.getReader(),l={source:async function*(){for(;;){const f=await c.read();if(f.value!=null&&(yield f.value),f.done)break}}(),sink:async f=>{for await(const p of f){await it(a.ready,i);const y=p instanceof Uint8Array?p:p.subarray();a.write(y).catch(g=>{this.log.error("could not write chunk during authentication of WebTransport stream",g)})}}},u=e6()(this.components),{remoteExtensions:d}=await u.secureOutbound(e,l,r);if(a.close().catch(f=>{this.log.error(`Failed to close authentication stream writer: ${f.message}`)}),c.cancel().catch(f=>{this.log.error(`Failed to close authentication stream reader: ${f.message}`)}),!ev((d==null?void 0:d.webtransportCerthashes)??[],s.map(f=>f.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}createListener(t){return qE(this.components,{...t,certificates:this.config.certificates,maxInboundStreams:this.config.maxInboundStreams})}listenFilter(){return[]}dialFilter(t){return t.filter(e=>{if(!p4.exactMatch(e))return!1;const{url:r,certhashes:s}=_d(e);return r!=null&&s.length>0})}}function iv(n={}){return t=>new sv(t,n)}const ov=[ce("tcp").code,ce("dns").code,ce("dnsaddr").code,ce("dns4").code,ce("dns6").code];function Sd(n){let t;try{t=ce("sni").code}catch{return null}for(const[e,r]of n)if(e===t&&r!==void 0)return r;return null}function Id(n){return n.some(([t,e])=>t===ce("tls").code)}function St(n,t,e){const r=n6[ce(n).name];if(r===void 0)throw new Error(`Can't interpret protocol ${ce(n).name}`);const s=r(t,e);return n===ce("ip6").code?`[${s}]`:s}const n6={ip4:(n,t)=>n,ip6:(n,t)=>t.length===0?n:`[${n}]`,tcp:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${St(e[0],e[1]??"",t)}:${n}`},udp:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${St(e[0],e[1]??"",t)}:${n}`},dnsaddr:(n,t)=>n,dns4:(n,t)=>n,dns6:(n,t)=>n,dns:(n,t)=>n,ipfs:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${St(e[0],e[1]??"",t)}/ipfs/${n}`},p2p:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${St(e[0],e[1]??"",t)}/p2p/${n}`},http:(n,t)=>{const e=Id(t),r=Sd(t);if(e&&r!==null)return`https://${r}`;const s=e?"https://":"http://",i=t.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=St(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},"http-path":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");const r=St(e[0],e[1]??"",t),s=decodeURIComponent(n);return`${r}/${s}`},tls:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return St(e[0],e[1]??"",t)},sni:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return St(e[0],e[1]??"",t)},https:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");let r=St(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`https://${r}`},ws:(n,t)=>{const e=Id(t),r=Sd(t);if(e&&r!==null)return`wss://${r}`;const s=e?"wss://":"ws://",i=t.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=St(i[0],i[1]??"",t);return o=o.replace("tcp://",""),`${s}${o}`},wss:(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");let r=St(e[0],e[1]??"",t);return r=r.replace("tcp://",""),`wss://${r}`},"p2p-websocket-star":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${St(e[0],e[1]??"",t)}/p2p-websocket-star`},"p2p-webrtc-star":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${St(e[0],e[1]??"",t)}/p2p-webrtc-star`},"p2p-webrtc-direct":(n,t)=>{const e=t.pop();if(e===void 0)throw new Error("Unexpected end of multiaddr");return`${St(e[0],e[1]??"",t)}/p2p-webrtc-direct`}};function av(n,t){const r=G(n).stringTuples(),s=r.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");const i=ce(s[0]),o=n6[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",r);return ov.includes(s[0])&&(a=a.replace(/^.*:\/\//,""),s[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}const cv=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((t,e)=>{function r(){n.removeEventListener("open",s),n.removeEventListener("error",i)}function s(){r(),t()}function i(o){r(),e(o.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",s),n.addEventListener("error",i)})},lv=(n,t)=>(t=t??{},t.closeOnEnd=t.closeOnEnd!==!1,async r=>{for await(const s of r){try{await cv(n)}catch(i){if(i.message==="socket closed")break;throw i}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(s)}t.closeOnEnd!=null&&n.readyState<=1&&await new Promise((s,i)=>{n.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{n.close()})})});var Rc={},Ac={};Object.defineProperty(Ac,"__esModule",{value:!0});class uv{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(t){if(this.isStopped)return;const e={value:t,done:!1};if(this.pullQueue.length){const r=this.pullQueue.shift();r&&r.resolve(e)}else this.pushQueue.push(Promise.resolve(e)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const t of this.pullQueue)t.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(t){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const e of this.pullQueue)e.reject(t);this.pullQueue.length=0}else{const e=Promise.reject(t);e.catch(()=>{}),this.pushQueue.push(e)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:t=>{const e=this.pushQueue.shift();return e?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),e):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((r,s)=>{this.pullQueue.push({resolve:r,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let s6=class{constructor(t,{highWaterMark:e=100,lowWaterMark:r=1}={}){const s=new uv;s.highWaterMark=e,s.lowWaterMark=r,s.removeCallback=t({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};Ac.EventIterator=s6;Ac.default=s6;Object.defineProperty(Rc,"__esModule",{value:!0});const Tu=Ac;var hv=Rc.EventIterator=Tu.EventIterator;function dv(n,t,e){return new Tu.EventIterator(({push:r})=>(this.addEventListener(n,r,t),()=>this.removeEventListener(n,r,t)),e)}Rc.subscribe=dv;Rc.default=Tu.EventIterator;function Rd(n){var t;return n instanceof ArrayBuffer||((t=n==null?void 0:n.constructor)==null?void 0:t.name)==="ArrayBuffer"&&typeof(n==null?void 0:n.byteLength)=="number"}const fv=n=>{n.binaryType="arraybuffer";const t=async()=>{await new Promise((i,o)=>{if(r){i();return}if(s!=null){o(s);return}const a=u=>{n.removeEventListener("open",c),n.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",c),n.addEventListener("error",l)})},e=async function*(){const i=new hv(({push:o,stop:a,fail:c})=>{const l=d=>{let f=null;typeof d.data=="string"&&(f=Y(d.data)),Rd(d.data)&&(f=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(f=d.data),f!=null&&o(f)},u=d=>{c(d.error??new Error("Socket error"))};return n.addEventListener("message",l),n.addEventListener("error",u),n.addEventListener("close",a),()=>{n.removeEventListener("message",l),n.removeEventListener("error",u),n.removeEventListener("close",a)}},{highWaterMark:1/0});await t();for await(const o of i)yield Rd(o)?new Uint8Array(o):o}();let r=n.readyState===1,s;return n.addEventListener("open",()=>{r=!0,s=null}),n.addEventListener("close",()=>{r=!1,s=null}),n.addEventListener("error",i=>{r||(s=i.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(e,{connected:t})},gv=(n,t)=>{t=t??{};const e=fv(n);let r=t.remoteAddress,s=t.remotePort;if(n.url!=null)try{const o=new URL(n.url);r=o.hostname,s=parseInt(o.port,10)}catch{}if(r==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:lv(n,t),source:e,connected:async()=>{await e.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(o=>{n.addEventListener("close",()=>{o()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:s,socket:n}},pv=WebSocket,mv={"http:":"ws:","https:":"wss:"},Ad="ws:",yv=(n,t)=>{if(n.startsWith("//")&&(n=`${(t==null?void 0:t.protocol)??Ad}${n}`),n.startsWith("/")&&t!=null){const r=t.protocol??Ad,s=t.host,i=t.port!=null&&(s==null?void 0:s.endsWith(`:${t.port}`))!==!0?`:${t.port}`:"";n=`${r}//${s}${i}${n}`}const e=new URL(n);for(const[r,s]of Object.entries(mv))e.protocol===r&&(e.protocol=s);return e};function wv(n,t){const e=typeof window>"u"?void 0:window.location;t=t??{};const r=yv(n,e),s=new pv(r.toString(),t.websocket);return gv(s,t)}function bv(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}var Ev=bv;const vv=tn(Ev),Du=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,Tc=vv(),i6=Du&&!Tc,_v=Tc&&!Du,Sv=Tc&&Du,Iv=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!Tc,o6=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,Rv=typeof navigator<"u"&&navigator.product==="ReactNative",Av=Z("dns4"),Tv=Z("dns6"),Dv=Z("dnsaddr"),hs=lt(Z("dns"),Dv,Av,Tv),Dc=lt(Z("ip4"),Z("ip6")),si=lt(le(Dc,Z("tcp")),le(hs,Z("tcp"))),xc=le(Dc,Z("udp")),xv=le(xc,Z("utp")),Cv=le(xc,Z("quic")),Pv=le(xc,Z("quic-v1")),jl=lt(le(si,Z("ws")),le(hs,Z("ws"))),e1=lt(le(jl,Z("p2p")),jl),t1=lt(le(si,Z("wss")),le(hs,Z("wss")),le(si,Z("tls"),Z("ws")),le(hs,Z("tls"),Z("ws"))),za=lt(le(t1,Z("p2p")),t1),r1=lt(le(si,Z("http")),le(Dc,Z("http")),le(hs,Z("http"))),n1=lt(le(si,Z("https")),le(Dc,Z("https")),le(hs,Z("https"))),Td=le(xc,Z("webrtc-direct"),Z("certhash")),a6=lt(le(Td,Z("p2p")),Td),Dd=le(Pv,Z("webtransport"),Z("certhash"),Z("certhash")),c6=lt(le(Dd,Z("p2p")),Dd),l6=lt(le(e1,Z("p2p-webrtc-star"),Z("p2p")),le(za,Z("p2p-webrtc-star"),Z("p2p")),le(e1,Z("p2p-webrtc-star")),le(za,Z("p2p-webrtc-star"))),u6=lt(le(r1,Z("p2p-webrtc-direct"),Z("p2p")),le(n1,Z("p2p-webrtc-direct"),Z("p2p")),le(r1,Z("p2p-webrtc-direct")),le(n1,Z("p2p-webrtc-direct"))),s1=lt(jl,t1,r1,n1,l6,u6,si,xv,Cv,hs,a6,c6),Zo=lt(le(s1,Z("p2p")),l6,u6,a6,c6,Z("p2p")),xd=lt(le(Zo,Z("p2p-circuit"),Zo),le(Zo,Z("p2p-circuit")),le(Z("p2p-circuit"),Zo),le(s1,Z("p2p-circuit")),le(Z("p2p-circuit"),s1),Z("p2p-circuit")),h6=()=>lt(le(xd,h6),xd),d6=h6();function f6(n){function t(e){let r;try{r=G(e)}catch{return!1}const s=n(r.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return t}function le(...n){function t(e){if(e.length<n.length)return null;let r=e;return n.some(s=>(r=typeof s=="function"?s().partialMatch(e):s.partialMatch(e),Array.isArray(r)&&(e=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:f6(t),partialMatch:t}}function lt(...n){function t(r){let s=null;return n.some(i=>{const o=typeof i=="function"?i().partialMatch(r):i.partialMatch(r);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:f6(t),partialMatch:t}}function Z(n){const t=n;function e(s){let i;try{i=G(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===t}function r(s){return s.length===0?null:s[0]===t?s.slice(1):null}return{toString:function(){return t},matches:e,partialMatch:r}}const g6=421,p6=290,kv=500;function Nv(n){return n.filter(t=>{if(t.protoCodes().includes(p6))return!1;const e=t.decapsulateCode(g6);return e1.matches(e)||za.matches(e)})}function Mv(n){return n.filter(t=>{if(t.protoCodes().includes(p6))return!1;const e=t.decapsulateCode(g6);return za.matches(e)})}function Ov(){throw new Error("WebSocket Servers can not be created in the browser!")}function Lv(n,t,e){const r=e.logger.forComponent("libp2p:websockets:maconn"),s={log:r,async sink(i){try{await n.sink(async function*(){for await(const o of i)o instanceof Uint8Array?yield o:yield o.subarray()}())}catch(o){o.type!=="aborted"&&r.error(o)}},source:n.source,remoteAddr:t,timeline:{open:Date.now()},async close(i={}){var c,l;const o=Date.now();if(i.signal==null){const u=AbortSignal.timeout(kv);i={...i,signal:u}}const a=()=>{const{host:u,port:d}=s.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",u,d,Date.now()-o),this.abort(new v("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};(c=i.signal)==null||c.addEventListener("abort",a);try{await n.close()}catch(u){r.error("error closing WebSocket gracefully",u),this.abort(u)}finally{(l=i.signal)==null||l.removeEventListener("abort",a),s.timeline.close=Date.now()}},abort(i){const{host:o,port:a}=s.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",o,a,i),n.destroy(),s.timeline.close=Date.now()}};return n.socket.addEventListener("close",()=>{s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}var N0,M0,O0;O0=sc,M0=Symbol.toStringTag,N0=jt;class Bv{constructor(t,e){h(this,"log");h(this,"init");h(this,"logger");h(this,O0,!0);h(this,M0,"@libp2p/websockets");h(this,N0,["@libp2p/transport"]);this.log=t.logger.forComponent("libp2p:websockets"),this.logger=t.logger,this.init=e}async dial(t,e){this.log("dialing %s",t),e=e??{};const r=await this._connect(t,e),s=Lv(r,t,{logger:this.logger});this.log("new outbound connection %s",s.remoteAddr);const i=await e.upgrader.upgradeOutbound(s);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(t,e){var c,l;if(((c=e==null?void 0:e.signal)==null?void 0:c.aborted)===!0)throw new ts;const r=t.toOptions();this.log("dialing %s:%s",r.host,r.port);const s=me(),i=wv(av(t),this.init);if(i.socket.addEventListener("error",()=>{const u=new v(`Could not connect to ${t.toString()}`,"ERR_CONNECTION_FAILED");this.log.error("connection error:",u),s.reject(u)}),e.signal==null)return await Promise.race([i.connected(),s.promise]),this.log("connected %s",t),i;let o;const a=new Promise((u,d)=>{var f,p;if(o=()=>{d(new ts),i.close().catch(y=>{this.log.error("error closing raw socket",y)})},((f=e==null?void 0:e.signal)==null?void 0:f.aborted)===!0){o();return}(p=e==null?void 0:e.signal)==null||p.addEventListener("abort",o)});try{await Promise.race([a,s.promise,i.connected()])}finally{o!=null&&((l=e==null?void 0:e.signal)==null||l.removeEventListener("abort",o))}return this.log("connected %s",t),i}createListener(t){return Ov({logger:this.logger},{...this.init,...t})}listenFilter(t){var e,r;return t=Array.isArray(t)?t:[t],((e=this.init)==null?void 0:e.filter)!=null?(r=this.init)==null?void 0:r.filter(t):i6||o6?Mv(t):Nv(t)}dialFilter(t){return this.listenFilter(t)}}function Uv(n={}){return t=>new Bv(t,n)}var As;(function(n){n.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",n.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",n.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",n.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",n.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",n.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",n.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",n.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",n.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",n.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(As||(As={}));var Cd=function(n,t,e){if(e||arguments.length===2)for(var r=0,s=t.length,i;r<s;r++)(i||!(r in t))&&(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return n.concat(i||Array.prototype.slice.call(t))},Fv=function(){function n(t,e,r){this.name=t,this.version=e,this.os=r,this.type="browser"}return n}(),Vv=function(){function n(t){this.version=t,this.type="node",this.name="node",this.os=process.platform}return n}(),$v=function(){function n(t,e,r,s){this.name=t,this.version=e,this.os=r,this.bot=s,this.type="bot-device"}return n}(),Kv=function(){function n(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return n}(),Hv=function(){function n(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return n}(),zv=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,Wv=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,Pd=3,qv=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",zv]],kd=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function Gv(n){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new Hv:typeof navigator<"u"?Qv(navigator.userAgent):Zv()}function Yv(n){return n!==""&&qv.reduce(function(t,e){var r=e[0],s=e[1];if(t)return t;var i=s.exec(n);return!!i&&[r,i]},!1)}function Qv(n){var t=Yv(n);if(!t)return null;var e=t[0],r=t[1];if(e==="searchbot")return new Kv;var s=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);s?s.length<Pd&&(s=Cd(Cd([],s,!0),Jv(Pd-s.length),!0)):s=[];var i=s.join("."),o=Xv(n),a=Wv.exec(n);return a&&a[1]?new $v(e,i,o,a[1]):new Fv(e,i,o)}function Xv(n){for(var t=0,e=kd.length;t<e;t++){var r=kd[t],s=r[0],i=r[1],o=i.exec(n);if(o)return s}return null}function Zv(){var n=typeof process<"u"&&process.version;return n?new Vv(process.version.slice(1)):null}function Jv(n){for(var t=[],e=0;e<n;e++)t.push("0");return t}const Nd=Gv(),m6=Nd!=null&&Nd.name==="firefox",y6=async function*(){},w6=async n=>{},jv=30*1e3;function e_(n,t,e=jv,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,n.bufferedAmount);const s=me();let i=!1;n.bufferedAmountLowThreshold=0;const o=()=>{i||(r.log("%s drain channel closed before drain",t),s.resolve())};n.addEventListener("close",o,{once:!0}),n.addEventListener("bufferedamountlow",()=>{i=!0,n.removeEventListener("close",o),s.resolve()}),await Ao(s.promise,{milliseconds:e})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(s=>{r.log.error("error closing outbound stream",s)})}class Md{constructor(t,e){h(this,"log");h(this,"peerConnection");h(this,"remoteAddr");h(this,"timeline");h(this,"metrics");h(this,"source",y6());h(this,"sink",w6);this.log=t.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=e.remoteAddr,this.timeline=e.timeline,this.peerConnection=e.peerConnection;const r=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",r),(this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed"||this.peerConnection.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(t){var e;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(e=this.metrics)==null||e.increment({close:!0})}abort(t){var e;this.log.error("closing connection due to error",t),this.peerConnection.close(),this.timeline.close=Date.now(),(e=this.metrics)==null||e.increment({abort:!0})}}const t_=n=>{const t=n.addEventListener||n.on||n.addListener,e=n.removeEventListener||n.off||n.removeListener;if(!t||!e)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(n),removeListener:e.bind(n)}};function r_(n,t,e){let r;const s=new Promise((i,o)=>{var p;if(e={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...e},!(e.count>=0&&(e.count===Number.POSITIVE_INFINITY||Number.isInteger(e.count))))throw new TypeError("The `count` option should be at least 0 or more");(p=e.signal)==null||p.throwIfAborted();const a=[t].flat(),c=[],{addListener:l,removeListener:u}=t_(n),d=(...y)=>{const g=e.multiArgs?y:y[0];e.filter&&!e.filter(g)||(c.push(g),e.count===c.length&&(r(),i(c)))},f=y=>{r(),o(y)};r=()=>{for(const y of a)u(y,d);for(const y of e.rejectionEvents)u(y,f)};for(const y of a)l(y,d);for(const y of e.rejectionEvents)l(y,f);e.signal&&e.signal.addEventListener("abort",()=>{f(e.signal.reason)},{once:!0}),e.resolveImmediately&&i(c)});if(s.cancel=r,typeof e.timeout=="number"){const i=Ao(s,{milliseconds:e.timeout});return i.cancel=r,i}return s}function i1(n,t,e){typeof e=="function"&&(e={filter:e}),e={...e,count:1,resolveImmediately:!1};const r=r_(n,t,e),s=r.then(i=>i[0]);return s.cancel=r.cancel,s}var Mt;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let t;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.Flag||(n.Flag={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.flag!=null&&(s.uint32(8),n.Flag.codec().encode(r.flag,s)),r.message!=null&&(s.uint32(18),s.bytes(r.message)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.flag=n.Flag.codec().decode(r);break;case 2:i.message=r.bytes();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(Mt||(Mt={}));const n_=16*1024*1024,s_=30*1e3,i_=5,o_=2,a_=16*1024,c_=5e3,l_=5e3;class u_ extends Au{constructor(e){const r=e.onEnd;e.onEnd=i=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Ao(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),r==null||r(i)}).catch(o=>{this.log.error("error ending stream",o)})};super(e);h(this,"channel");h(this,"incomingData");h(this,"maxBufferedAmount");h(this,"bufferedAmountLowEventTimeout");h(this,"maxMessageSize");h(this,"receiveFinAck");h(this,"finAckTimeout");h(this,"openTimeout");switch(this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=jr(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??s_,this.maxBufferedAmount=e.maxBufferedAmount??n_,this.maxMessageSize=(e.maxMessageSize??a_)-i_-o_,this.receiveFinAck=me(),this.finAckTimeout=e.closeTimeout??c_,this.openTimeout=e.openTimeout??l_,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new v("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=i=>{this.timeline.open=new Date().getTime()},this.channel.onclose=i=>{this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=i=>{const o=i.error;this.abort(o)},this.channel.onmessage=async i=>{const{data:o}=i;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const s=this;Promise.resolve().then(async()=>{for await(const i of kn(this.incomingData)){const o=s.processIncomingProtobuf(i);o!=null&&s.sourcePush(new Oe(o))}}).catch(i=>{this.log.error("error processing incoming data channel messages",i)})}sendNewStream(){}async _sendMessage(e,r=!0){if(r&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await i1(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(s){throw s instanceof wu?new v(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`,"ERR_BUFFER_CLEAR_TIMEOUT"):s}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new v(`Invalid datachannel state - ${this.channel.readyState}`,"ERR_INVALID_STATE");this.channel.readyState!=="open"&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await i1(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const r=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,r),i=Mt.encode({message:s}),o=en.single(i);await this._sendMessage(o),e.consume(r)}}async sendReset(){await this._sendFlag(Mt.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(Mt.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await it(this.receiveFinAck.promise,e==null?void 0:e.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(s){this.log.error("failed to await FIN_ACK",s)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(Mt.Flag.STOP_SENDING)}processIncomingProtobuf(e){const r=Mt.decode(e);if(r.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',r.flag,this.writeStatus,this.readStatus),r.flag===Mt.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Mt.Flag.FIN_ACK).catch(s=>{this.log.error("error sending FIN_ACK immediately",s)})),r.flag===Mt.Flag.RESET&&this.reset(),r.flag===Mt.Flag.STOP_SENDING&&this.remoteCloseRead(),r.flag===Mt.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return r.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const r=Mt.encode({flag:e}),s=en.single(r);try{return await this._sendMessage(s,!1),!0}catch(i){this.log.error("could not send flag %s",e.toString(),i)}return!1}}function o1(n){const{channel:t,direction:e}=n;return new u_({id:e==="inbound"?`i${t.id}`:`r${t.id}`,log:n.logger.forComponent(`libp2p:webrtc:stream:${e}:${t.id}`),...n})}const b6="/webrtc";class E6{constructor(t,e){h(this,"protocol");h(this,"peerConnection");h(this,"bufferedStreams",[]);h(this,"metrics");h(this,"dataChannelOptions");h(this,"components");h(this,"log");this.components=t,this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??b6,this.dataChannelOptions=e.dataChannelOptions??{},this.log=t.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const s={},i=o1({channel:r,direction:"inbound",onEnd:o=>{s.onEnd(o)},logger:t.logger,...this.dataChannelOptions});s.stream=i,s.channel=r,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(t){return new h_(this.components,{...t,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var $s,fa;class h_{constructor(t,e){j(this,$s);h(this,"init");h(this,"streams");h(this,"protocol");h(this,"log");h(this,"peerConnection");h(this,"dataChannelOptions");h(this,"metrics");h(this,"logger");h(this,"source",y6());h(this,"sink",w6);this.init=e,this.log=t.logger.forComponent("libp2p:webrtc:muxer"),this.logger=t.logger,this.streams=e.streams.map(r=>r.stream),this.peerConnection=e.peerConnection,this.protocol=e.protocol??b6,this.metrics=e.metrics,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:r})=>{var i,o;if(this.log.trace("incoming datachannel with channel id %d",r.id),r.label==="init"){this.log.trace("closing init channel"),r.close();return}const s=o1({channel:r,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",r.id,r.readyState),O(this,$s,fa).call(this,s,r)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),(i=this.metrics)==null||i.increment({incoming_stream:!0}),(o=e==null?void 0:e.onIncomingStream)==null||o.call(e,s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(r=>{var s,i,o;r.onEnd=()=>{this.log("incoming early channel %s ended with state %s",r.channel.id,r.channel.readyState),O(this,$s,fa).call(this,r.stream,r.channel)},(s=this.metrics)==null||s.increment({incoming_stream:!0}),(o=(i=this.init)==null?void 0:i.onIncomingStream)==null||o.call(i,r.stream)})})}async close(t){try{await Promise.all(this.streams.map(async e=>e.close(t)))}catch(e){this.abort(e)}}abort(t){for(const e of this.streams)e.abort(t)}newStream(){var r;const t=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",t.id);const e=o1({channel:t,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",t.id,t.readyState),O(this,$s,fa).call(this,e,t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(e),(r=this.metrics)==null||r.increment({outgoing_stream:!0}),e}}$s=new WeakSet,fa=function(t,e){var r,s,i;this.log.trace("stream %s %s %s onEnd",t.direction,t.id,t.protocol),e_(e,`${t.direction} ${t.id} ${t.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==t.id),(r=this.metrics)==null||r.increment({stream_end:!0}),(i=(s=this.init)==null?void 0:s.onStreamEnd)==null||i.call(s,t)};const v6=globalThis.RTCPeerConnection,_6=globalThis.RTCSessionDescription,d_=globalThis.RTCIceCandidate;function Ct(n,t){const e=Gs(n,t),r={read:async(s,i)=>{const o=await e.read(i);return s.decode(o)},write:async(s,i,o)=>{await e.write(i.encode(s),o)},writeV:async(s,i,o)=>{await e.writeV(s.map(a=>i.encode(a)),o)},pb:s=>({read:async i=>r.read(s,i),write:async(i,o)=>r.write(i,s,o),writeV:async(i,o)=>r.writeV(i,s,o),unwrap:()=>r}),unwrap:()=>e.unwrap()};return r}var lr;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let t;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.data!=null&&(s.uint32(18),s.string(r.data)),i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.type=n.Type.codec().decode(r);break;case 2:i.data=r.string();break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(lr||(lr={}));const S6=async(n,t,e)=>{var r,s;try{const i=me();for(g_(n,i);;){const o=await Promise.race([i.promise,t.read({signal:e.signal}).catch(()=>{})]);if(o==null){(r=e.signal)==null||r.throwIfAborted();break}if(o.type!==lr.Type.ICE_CANDIDATE)throw new v("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const a=JSON.parse(o.data??"null");if(a===""||a===null){e.log.trace("end-of-candidates received");continue}const c=new d_(a);e.log.trace("%s received new ICE candidate %o",e.direction,a);try{await n.addIceCandidate(c)}catch(l){e.log.error("%s bad candidate received",e.direction,a,l)}}}catch(i){if(e.log.error("%s error parsing ICE candidate",e.direction,i),((s=e.signal)==null?void 0:s.aborted)===!0)throw i}};function f_(n){return m6?n.iceConnectionState:n.connectionState}function g_(n,t){n[m6?"oniceconnectionstatechange":"onconnectionstatechange"]=e=>{switch(f_(n)){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new v("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"));break}}}async function p_({rtcConfiguration:n,dataChannel:t,signal:e,metrics:r,multiaddr:s,connectionManager:i,transportManager:o,log:a,logger:c}){const{baseAddr:l}=__(s);r==null||r.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",l);const u=l.getPeerId();if(u==null)throw new v("Relay peer was missing","ERR_INVALID_ADDRESS");const d=i.getConnections(ye(u));let f,p=!1;d.length===0?(f=await o.dial(l,{signal:e}),p=!0):f=d[0];try{const y=await f.newStream(a1,{signal:e,runOnTransientConnection:!0}),g=Ct(y).pb(lr),m=new v6(n),w=new E6({logger:c},{peerConnection:m,dataChannelOptions:t});try{const _=m.createDataChannel("init");m.onicecandidate=({candidate:A})=>{const P=JSON.stringify((A==null?void 0:A.toJSON())??null);a.trace("initiator sending ICE candidate %o",A),g.write({type:lr.Type.ICE_CANDIDATE,data:P},{signal:e}).catch(T=>{a.error("error sending ICE candidate",T)})},m.onicecandidateerror=A=>{a.error("initiator ICE candidate error",A)};const b=await m.createOffer().catch(A=>{throw a.error("could not execute createOffer",A),new v("Failed to set createOffer","ERR_SDP_HANDSHAKE_FAILED")});a.trace("initiator send SDP offer %s",b.sdp),await g.write({type:lr.Type.SDP_OFFER,data:b.sdp},{signal:e}),await m.setLocalDescription(b).catch(A=>{throw a.error("could not execute setLocalDescription",A),new v("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")});const S=await g.read({signal:e});if(S.type!==lr.Type.SDP_ANSWER)throw new v("Remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",S.data);const I=new _6({type:"answer",sdp:S.data});return await m.setRemoteDescription(I).catch(A=>{throw a.error("could not execute setRemoteDescription",A),new v("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}),a.trace("initiator read candidates until connected"),await S6(m,g,{direction:"initiator",signal:e,log:a}),a.trace("initiator connected, closing init channel"),_.close(),a.trace("closing signalling channel"),await y.close({signal:e}),a.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:m,muxerFactory:w}}catch(_){throw a.error("outgoing signalling error",_),m.close(),y.abort(_),_}finally{m.onicecandidate=null,m.onicecandidateerror=null}}finally{if(p)try{await f.close({signal:e})}catch(y){f.abort(y)}}}class m_ extends Et{constructor(e,r){super();h(this,"peerId");h(this,"transportManager");h(this,"shutdownController");this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=r.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(r=>d6.matches(r)).map(r=>r.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}async function y_({peerConnection:n,stream:t,signal:e,connection:r,log:s}){s.trace("new inbound signaling stream");const i=Ct(t).pb(lr);try{n.onicecandidate=({candidate:u})=>{const d=JSON.stringify((u==null?void 0:u.toJSON())??null);s.trace("recipient sending ICE candidate %s",d),i.write({type:lr.Type.ICE_CANDIDATE,data:d},{signal:e}).catch(f=>{s.error("error sending ICE candidate",f)})};const a=await i.read({signal:e});if(a.type!==lr.Type.SDP_OFFER)throw new v(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `,"ERR_SDP_HANDSHAKE_FAILED");s.trace("recipient receive SDP offer %s",a.data);const c=new _6({type:"offer",sdp:a.data});await n.setRemoteDescription(c).catch(u=>{throw s.error("could not execute setRemoteDescription",u),new v("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")});const l=await n.createAnswer().catch(u=>{throw s.error("could not execute createAnswer",u),new v("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")});s.trace("recipient send SDP answer %s",l.sdp),await i.write({type:lr.Type.SDP_ANSWER,data:l.sdp},{signal:e}),await n.setLocalDescription(l).catch(u=>{throw s.error("could not execute setLocalDescription",u),new v("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}),s.trace("recipient read candidates until connected"),await S6(n,i,{direction:"recipient",signal:e,log:s})}catch(a){if(n.connectionState!=="connected")throw s.error("error while handling signaling stream from peer %a",r.remoteAddr,a),n.close(),a;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,a)}const o=G(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",o),{remoteAddress:o}}const w_="/webrtc",b_="/p2p-circuit",a1="/webrtc-signaling/0.0.1",E_=30*1e3;var L0,B0,U0,F0;F0=sc,U0=Symbol.toStringTag,B0=jt,L0=rs;class v_{constructor(t,e={}){h(this,"components");h(this,"init");h(this,"log");h(this,"_started",!1);h(this,"metrics");h(this,"shutdownController");h(this,F0,!0);h(this,U0,"@libp2p/webrtc");h(this,B0,["@libp2p/transport"]);h(this,L0,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=t,this.init=e,this.log=t.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,ge(1/0,this.shutdownController.signal),t.metrics!=null&&(this.metrics={dialerEvents:t.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:t.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(a1,t=>{this._onProtocol(t).catch(e=>{this.log.error("failed to handle incoming connect from %p",t.connection.remotePeer,e)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(a1),this._started=!1}createListener(t){return new m_(this.components,{shutdownController:this.shutdownController})}listenFilter(t){return t.filter(kw.exactMatch)}dialFilter(t){return this.listenFilter(t)}async dial(t,e){var c;this.log.trace("dialing address: %a",t);const{remoteAddress:r,peerConnection:s,muxerFactory:i}=await p_({rtcConfiguration:typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration,dataChannel:this.init.dataChannel,multiaddr:t,dataChannelOptions:this.init.dataChannel,signal:e.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger}),o=new Md(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:r,metrics:(c=this.metrics)==null?void 0:c.dialerEvents}),a=await e.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:i});return this._closeOnShutdown(s,o),a}async _onProtocol({connection:t,stream:e}){var o;const r=AbortSignal.timeout(this.init.inboundConnectionTimeout??E_),s=new v6(typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration),i=new E6(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await y_({peerConnection:s,connection:t,stream:e,signal:r,log:this.log});await e.close({signal:r});const c=new Md(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:i}),this._closeOnShutdown(s,c)}catch(a){throw this.log.error("incoming signalling error",a),s.close(),e.abort(a),a}}_closeOnShutdown(t,e){const r=()=>{e.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",r),t.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function __(n){const t=n.toString().split(w_+"/");if(t.length!==2)throw new v("webrtc protocol was not present in multiaddr",As.ERR_INVALID_MULTIADDR);if(!t[0].includes(b_))throw new v("p2p-circuit protocol was not present in multiaddr",As.ERR_INVALID_MULTIADDR);let e=G(t[0]);const s=G("/"+t[1]).getPeerId();if(s==null)throw new v("destination peer id was missing",As.ERR_INVALID_MULTIADDR);const i=e.protos().pop();if(i===void 0)throw new v("invalid multiaddr",As.ERR_INVALID_MULTIADDR);return i.name!=="p2p"&&(e=e.encapsulate(`/p2p/${s}`)),{baseAddr:e,peerId:ye(s)}}function S_(n){return t=>new v_(t,n)}var Er;(function(n){(function(r){r.UNUSED="UNUSED",r.CONNECT="CONNECT",r.SYNC="SYNC"})(n.Type||(n.Type={}));let t;(function(r){r[r.UNUSED=0]="UNUSED",r[r.CONNECT=100]="CONNECT",r[r.SYNC=300]="SYNC"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.observedAddresses!=null)for(const o of r.observedAddresses)s.uint32(18),s.bytes(o);i.lengthDelimited!==!1&&s.ldelim()},(r,s)=>{const i={observedAddresses:[]},o=s==null?r.len:r.pos+s;for(;r.pos<o;){const a=r.uint32();switch(a>>>3){case 1:i.type=n.Type.codec().decode(r);break;case 2:i.observedAddresses.push(r.bytes());break;default:r.skipType(a&7);break}}return i})),e),n.encode=r=>he(r,n.codec()),n.decode=r=>ue(r,n.codec())})(Er||(Er={}));function Od(n,t){return Ua.matches(n)||t.dialTransportForMultiaddr(n)==null?!1:vw.matches(n)?!0:Rw.matches(n)?To(n.toOptions().host)===!1:!1}const Ld=1024*4,Bd=100,Jo={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};var V0,$0;$0=Symbol.toStringTag,V0=rs;class I_{constructor(t,e){h(this,"started");h(this,"timeout");h(this,"retries");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"peerStore");h(this,"registrar");h(this,"connectionManager");h(this,"addressManager");h(this,"transportManager");h(this,"topologyId");h(this,"log");h(this,$0,"@libp2p/dcutr");h(this,V0,["@libp2p/identify"]);this.log=t.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.timeout=e.timeout??Jo.timeout,this.retries=e.retries??Jo.retries,this.maxInboundStreams=e.maxInboundStreams??Jo.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??Jo.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(jo,{notifyOnTransient:!0,onConnect:(t,e)=>{e.transient&&e.direction==="inbound"&&this.upgradeInbound(e).catch(r=>{this.log.error("error during outgoing DCUtR attempt",r)})}}),await this.registrar.handle(jo,t=>{this.handleIncomingUpgrade(t.stream,t.connection).catch(e=>{this.log.error("error during incoming DCUtR attempt",e),t.stream.abort(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(jo),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(t){if(await this.attemptUnilateralConnectionUpgrade(t))return;let e;for(let r=0;r<this.retries;r++){const s={signal:AbortSignal.timeout(this.timeout)};try{e=await t.newStream([jo],{signal:s.signal,runOnTransientConnection:!0});const i=Ct(e,{maxDataLength:Ld}).pb(Er);this.log("B sending connect to %p",t.remotePeer);const o=Date.now();await i.write({type:Er.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(d=>d.bytes)},s),this.log("B receiving connect from %p",t.remotePeer);const a=await i.read(s);if(a.type!==Er.Type.CONNECT)throw this.log("A sent wrong message type"),new v("DCUtR message type was incorrect",vs);const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new v("DCUtR connect message had no multiaddrs",vs);const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await i.write({type:Er.Type.SYNC,observedAddresses:[]},s),this.log("A waiting for half RTT"),await S4(l/2),this.log("B dialing",c);const u=await this.connectionManager.openConnection(c,{signal:s.signal,priority:Bd});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",t.remotePeer,u.remoteAddr),await t.close(s);break}catch(i){if(this.log.error("error while attempting DCUtR on attempt %d of %d",r+1,this.retries,i),e==null||e.abort(i),r===this.retries)throw i}finally{e!=null&&await e.close(s)}}}async attemptUnilateralConnectionUpgrade(t){const r=(await this.peerStore.get(t.remotePeer)).addresses.map(s=>{const i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${t.remotePeer}`):i}).filter(s=>Od(s,this.transportManager));if(r.length>0){const s=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",r);const i=await this.connectionManager.openConnection(r,{signal:s,force:!0});if(i.transient)throw new Error("Could not open a new, non-transient, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",t.remotePeer,i.remoteAddr),await t.close({signal:s}),!0}catch(i){this.log.error("unilateral connection upgrade to %p on addresses %a failed",t.remotePeer,r,i)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",t.remotePeer);return!1}async handleIncomingUpgrade(t,e){const r={signal:AbortSignal.timeout(this.timeout)};try{const s=Ct(t,{maxDataLength:Ld}).pb(Er);this.log("A receiving connect");const i=await s.read(r);if(i.type!==Er.Type.CONNECT)throw this.log("B sent wrong message type"),new v("DCUtR message type was incorrect",vs);if(i.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new v("DCUtR connect message had no multiaddrs",vs);const o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new v("DCUtR connect message had no dialable multiaddrs",vs);if(this.log("A sending connect"),await s.write({type:Er.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await s.read(r)).type!==Er.Type.SYNC)throw new v("DCUtR message type was incorrect",vs);this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:r.signal,priority:Bd,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",e.remotePeer,c.remoteAddr),await e.close(r)}catch(s){this.log.error("incoming DCUtR from %p failed",e.remotePeer,s),t.abort(s)}finally{await t.close(r)}}getDialableMultiaddrs(t){const e=[];for(const r of t)if(!(r==null||r.length===0))try{const s=G(r);if(!Od(s,this.transportManager))continue;e.push(s)}catch{}return e}}const jo="/libp2p/dcutr";function R_(n={}){return t=>new I_(t,n)}const Oi="ERR_INVALID_FRAME",I6="ERR_UNREQUESTED_PING",R6="ERR_NOT_MATCHING_PING",A6="ERR_STREAM_ALREADY_EXISTS",T6="ERR_DECODE_INVALID_VERSION",D6="ERR_BOTH_CLIENTS",x6="ERR_RECV_WINDOW_EXCEEDED",A_=new Set([Oi,I6,R6,A6,T6,D6,x6]),Hn="ERR_INVALID_CONFIG",al="ERR_MUXER_LOCAL_CLOSED",Ud="ERR_MUXER_REMOTE_CLOSED",T_="ERR_STREAM_ABORT",D_="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",x_="ERR_DECODE_IN_PROGRESS",xu=256*1024,C_=16*1024*1024,P_={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:xu,maxStreamWindowSize:C_,maxMessageSize:64*1024};function k_(n){if(n.keepAliveInterval<=0)throw new v("keep-alive interval must be positive",Hn);if(n.maxInboundStreams<0)throw new v("max inbound streams must be larger or equal 0",Hn);if(n.maxOutboundStreams<0)throw new v("max outbound streams must be larger or equal 0",Hn);if(n.initialStreamWindowSize<xu)throw new v("InitialStreamWindowSize must be larger or equal 256 kB",Hn);if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new v("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Hn);if(n.maxStreamWindowSize>2**32-1)throw new v("MaxStreamWindowSize must be less than equal MAX_UINT32",Hn);if(n.maxMessageSize<1024)throw new v("MaxMessageSize must be greater than a kilobyte",Hn)}var Ze;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(Ze||(Ze={}));var Ke;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(Ke||(Ke={}));Object.values(Ke).filter(n=>typeof n!="string");const N_=0;var vr;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(vr||(vr={}));const Ui=12,Fd=2**24;function M_(n){if(n[0]!==N_)throw new v("Invalid frame version",T6);return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*Fd+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*Fd+(n[9]<<16)+(n[10]<<8)+n[11]}}class O_{constructor(t){h(this,"source");h(this,"buffer");h(this,"frameInProgress");this.source=L_(t),this.buffer=new Oe,this.frameInProgress=!1}async*emitFrames(){for await(const t of this.source)for(this.buffer.append(t);;){const e=this.readHeader();if(e===void 0)break;const{type:r,length:s}=e;r===Ze.Data?(this.frameInProgress=!0,yield{header:e,readData:this.readBytes.bind(this,s)}):yield{header:e}}}readHeader(){if(this.frameInProgress)throw new v("decoding frame already in progress",x_);if(this.buffer.length<Ui)return;const t=M_(this.buffer.subarray(0,Ui));return this.buffer.consume(Ui),t}async readBytes(t){if(this.buffer.length<t){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=t)break}const e=this.buffer.sublist(0,t);return this.buffer.consume(t),this.frameInProgress=!1,e}}function L_(n){if(n[Symbol.iterator]!==void 0){const t=n[Symbol.iterator]();return t.return=void 0,{[Symbol.iterator](){return t}}}else if(n[Symbol.asyncIterator]!==void 0){const t=n[Symbol.asyncIterator]();return t.return=void 0,{[Symbol.asyncIterator](){return t}}}else throw new Error("a source must be either an iterable or an async iterable")}function Vd(n){const t=new Uint8Array(Ui);return t[1]=n.type,t[2]=n.flag>>>8,t[3]=n.flag,t[4]=n.streamID>>>24,t[5]=n.streamID>>>16,t[6]=n.streamID>>>8,t[7]=n.streamID,t[8]=n.length>>>24,t[9]=n.length>>>16,t[10]=n.length>>>8,t[11]=n.length,t}function B_(n){return n[Symbol.asyncIterator]!=null}function $d(n){return(n==null?void 0:n.then)!=null}function c1(n,t){let e=0;if(B_(n))return async function*(){for await(const c of n){const l=t(c,e++);$d(l)&&await l,yield c}}();const r=B1(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const o=t(s,e++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield s;for await(const c of r){const l=t(c,e++);$d(l)&&await l,yield c}}();const a=t;return function*(){yield s;for(const c of r)a(c,e++),yield c}()}var cr;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(cr||(cr={}));class U_ extends Au{constructor(e){super({...e,onEnd:r=>{var s;this.state=cr.Finished,(s=e.onEnd)==null||s.call(e,r)}});h(this,"name");h(this,"state");h(this,"config");h(this,"_id");h(this,"sendWindowCapacity");h(this,"sendWindowCapacityUpdate");h(this,"recvWindow");h(this,"recvWindowCapacity");h(this,"epochStart");h(this,"getRTT");h(this,"sendFrame");this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=xu,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=c1(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,r={}){var s,i;for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&((s=this.log)==null||s.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(r),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(i=this.log)==null||i.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-Ui,e.length),a=this.getSendFlags();this.sendFrame({type:Ze.Data,flag:a,streamID:this._id,length:o},e.sublist(0,o)),this.sendWindowCapacity-=o,e.consume(o)}}async sendReset(){this.sendFrame({type:Ze.WindowUpdate,flag:Ke.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|Ke.FIN;this.sendFrame({type:Ze.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){var o,a;if(this.sendWindowCapacity>0)return;let r,s;const i=()=>{this.status==="open"||this.status==="closing"?s(new v("stream aborted",T_)):r()};(o=e.signal)==null||o.addEventListener("abort",i);try{await new Promise((c,l)=>{this.sendWindowCapacityUpdate=()=>{c()},s=l,r=c})}finally{(a=e.signal)==null||a.removeEventListener("abort",i)}}handleWindowUpdate(e){var s,i;(s=this.log)==null||s.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const r=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,r===0&&e.length>0&&((i=this.sendWindowCapacityUpdate)==null||i.call(this))}async handleData(e,r){var i;if((i=this.log)==null||i.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new v("receive window exceeded",x6,{available:this.recvWindowCapacity,recv:e.length});const s=await r();this.recvWindowCapacity-=e.length,this.sourcePush(s)}processFlags(e){(e&Ke.ACK)===Ke.ACK&&this.state===cr.SYNSent&&(this.state=cr.Established),(e&Ke.FIN)===Ke.FIN&&this.remoteCloseWrite(),(e&Ke.RST)===Ke.RST&&this.reset()}getSendFlags(){switch(this.state){case cr.Init:return this.state=cr.SYNSent,Ke.SYN;case cr.SYNReceived:return this.state=cr.Established,Ke.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),r=Date.now(),s=this.getRTT();if(e===0&&s>-1&&r-this.epochStart<s*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const i=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=r,this.sendFrame({type:Ze.WindowUpdate,flag:e,streamID:this._id,length:i})}}const C6="/yamux/1.0.0",F_=500;class V_{constructor(t,e={}){h(this,"protocol",C6);h(this,"_components");h(this,"_init");this._components=t,this._init=e}createStreamMuxer(t){return new $_(this._components,{...this._init,...t})}}class $_{constructor(t,e){h(this,"protocol",C6);h(this,"source");h(this,"sink");h(this,"config");h(this,"log");h(this,"logger");h(this,"closeController");h(this,"nextStreamID");h(this,"_streams");h(this,"nextPingID");h(this,"activePing");h(this,"rtt");h(this,"client");h(this,"localGoAway");h(this,"remoteGoAway");h(this,"numInboundStreams");h(this,"numOutboundStreams");h(this,"onIncomingStream");h(this,"onStreamEnd");var r;this.client=e.direction==="outbound",this.config={...P_,...e},this.logger=t.logger,this.log=this.logger.forComponent("libp2p:yamux"),k_(this.config),this.closeController=new AbortController,ge(1/0,this.closeController.signal),this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=jr({onEnd:()=>{var s;(s=this.log)==null||s.trace("muxer source ended"),this._streams.forEach(i=>{i.destroy()})}}),this.sink=async s=>{var c,l,u;const i=()=>{const d=t6(s);if(d.return!=null){const f=d.return();K_(f)&&f.catch(p=>{var y;(y=this.log)==null||y.call(this,"could not cause sink source to return",p)})}};let o,a;try{const d=new O_(s);try{this.closeController.signal.addEventListener("abort",i);for await(const f of d.emitFrames())await this.handleFrame(f.header,f.readData)}finally{this.closeController.signal.removeEventListener("abort",i)}o=vr.NormalTermination}catch(d){const f=d.code;A_.has(f)?((c=this.log)==null||c.error("protocol error in sink",d),o=vr.ProtocolError):((l=this.log)==null||l.error("internal error in sink",d),o=vr.InternalError),a=d}(u=this.log)==null||u.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(r=this.log)==null||r.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("keepalive error: %s",s)}),this.ping().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("ping error: %s",s)})}get streams(){return Array.from(this._streams.values())}newStream(t){var s;if(this.remoteGoAway!==void 0)throw new v("muxer closed remotely",Ud);if(this.localGoAway!==void 0)throw new v("muxer closed locally",al);const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new v("max outbound streams exceeded",D_);(s=this.log)==null||s.trace("new outgoing stream id=%s",e);const r=this._newStream(e,t,cr.Init,"outbound");return this._streams.set(e,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new v("muxer closed remotely",Ud);if(this.localGoAway!==void 0)throw new v("muxer closed locally",al);if(this.activePing===void 0){let t=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const o=()=>{i(new v("muxer closed locally",al))};this.closeController.signal.addEventListener("abort",o,{once:!0}),t=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:t};const e=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-e}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(t={}){var r;if(this.closeController.signal.aborted)return;const e=(t==null?void 0:t.reason)??vr.NormalTermination;if((r=this.log)==null||r.trace("muxer close reason=%s",e),t.signal==null){const s=AbortSignal.timeout(F_);ge(1/0,s),t={...t,signal:s}}try{await Promise.all([...this._streams.values()].map(async s=>s.close(t))),this.sendGoAway(e),this._closeMuxer()}catch(s){this.abort(s)}}abort(t,e){var r;if(!this.closeController.signal.aborted){e=e??vr.InternalError,(r=this.log)==null||r.error("muxer abort reason=%s error=%s",e,t);for(const s of this._streams.values())s.abort(t);this.sendGoAway(e),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(t,e,r,s){if(this._streams.get(t)!=null)throw new v("Stream already exists",A6,{id:t});const i=new U_({id:t.toString(),name:e,state:r,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(t),(o=this.onStreamEnd)==null||o.call(this,i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${t}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(t){this.client===(t%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(t)}async keepAliveLoop(){var e;const t=new Promise((r,s)=>{this.closeController.signal.addEventListener("abort",s,{once:!0})});for((e=this.log)==null||e.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let r;try{await Promise.race([t,new Promise(s=>{r=setTimeout(s,this.config.keepAliveInterval)})]),this.ping().catch(s=>{var i;return(i=this.log)==null?void 0:i.error("ping error: %s",s)})}catch{clearInterval(r);return}}}async handleFrame(t,e){var o;const{streamID:r,type:s,length:i}=t;if((o=this.log)==null||o.trace("received frame %o",t),r===0)switch(s){case Ze.Ping:{this.handlePing(t);return}case Ze.GoAway:{this.handleGoAway(i);return}default:throw new v("Invalid frame type",Oi,{header:t})}else switch(t.type){case Ze.Data:case Ze.WindowUpdate:{await this.handleStreamMessage(t,e);return}default:throw new v("Invalid frame type",Oi,{header:t})}}handlePing(t){var e,r;if(t.flag===Ke.SYN)(e=this.log)==null||e.trace("received ping request pingId=%s",t.length),this.sendPing(t.length,Ke.ACK);else if(t.flag===Ke.ACK)(r=this.log)==null||r.trace("received ping response pingId=%s",t.length),this.handlePingResponse(t.length);else throw new v("Invalid frame flag",Oi,{header:t})}handlePingResponse(t){if(this.activePing===void 0)throw new v("ping not requested",I6);if(this.activePing.id!==t)throw new v("ping doesn't match our id",R6);this.activePing.resolve()}handleGoAway(t){var e;(e=this.log)==null||e.trace("received GoAway reason=%s",vr[t]??"unknown"),this.remoteGoAway=t;for(const r of this._streams.values())r.reset();this._closeMuxer()}async handleStreamMessage(t,e){var a,c;const{streamID:r,flag:s,type:i}=t;(s&Ke.SYN)===Ke.SYN&&this.incomingStream(r);const o=this._streams.get(r);if(o===void 0){if(i===Ze.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",r),e===void 0)throw new Error("unreachable");await e()}else(c=this.log)==null||c.call(this,"frame for missing stream id=%s",r);return}switch(i){case Ze.WindowUpdate:{o.handleWindowUpdate(t);return}case Ze.Data:{if(e===void 0)throw new Error("unreachable");await o.handleData(t,e);return}default:throw new Error("unreachable")}}incomingStream(t){var r,s,i;if(this.client!==(t%2===0))throw new v("both endpoints are clients",D6);if(this._streams.has(t))return;if((r=this.log)==null||r.trace("new incoming stream id=%s",t),this.localGoAway!==void 0){this.sendFrame({type:Ze.WindowUpdate,flag:Ke.RST,streamID:t,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(s=this.log)==null||s.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:Ze.WindowUpdate,flag:Ke.RST,streamID:t,length:0});return}const e=this._newStream(t,void 0,cr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(t,e),(i=this.onIncomingStream)==null||i.call(this,e)}sendFrame(t,e){var r;if((r=this.log)==null||r.trace("sending frame %o",t),t.type===Ze.Data){if(e===void 0)throw new v("invalid frame",Oi);this.source.push(new Oe(Vd(t),e))}else this.source.push(Vd(t))}sendPing(t,e=Ke.SYN){var r,s;e===Ke.SYN?(r=this.log)==null||r.trace("sending ping request pingId=%s",t):(s=this.log)==null||s.trace("sending ping response pingId=%s",t),this.sendFrame({type:Ze.Ping,flag:e,streamID:0,length:t})}sendGoAway(t=vr.NormalTermination){var e;(e=this.log)==null||e.call(this,"sending GoAway reason=%s",vr[t]),this.localGoAway=t,this.sendFrame({type:Ze.GoAway,flag:0,streamID:0,length:t})}}function K_(n){return n!=null&&typeof n.then=="function"}function H_(n={}){return t=>new V_(t,n)}function z_(n){return globalThis.Buffer!=null?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):n}function W_(n=0){var t;return((t=globalThis.Buffer)==null?void 0:t.alloc)!=null?z_(globalThis.Buffer.alloc(n)):new Uint8Array(n)}var Wa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.publicKey!=null&&e.publicKey.byteLength>0&&(r.uint32(10),r.bytes(e.publicKey)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={publicKey:W_(0),addrs:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.publicKey=e.bytes();break}case 2:{s.addrs.push(e.bytes());break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Wa||(Wa={}));const q_="_peer-discovery._p2p._pubsub";var K0,H0,z0;class G_ extends(z0=Et,H0=va,K0=Symbol.toStringTag,z0){constructor(e,r={}){super();h(this,H0,!0);h(this,K0,"@libp2p/pubsub-peer-discovery");h(this,"interval");h(this,"listenOnly");h(this,"topics");h(this,"intervalId");h(this,"components");h(this,"log");const{interval:s,topics:i,listenOnly:o}=r;this.components=e,this.interval=s??1e4,this.listenOnly=o??!1,this.log=e.logger.forComponent("libp2p:discovery:pubsub"),Array.isArray(i)&&i.length>0?this.topics=i:this.topics=[q_],this._onMessage=this._onMessage.bind(this)}isStarted(){return this.intervalId!=null}start(){}afterStart(){if(this.intervalId!=null)return;const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.subscribe(r),e.addEventListener("message",this._onMessage);this.listenOnly||(this._broadcast(),this.intervalId=setInterval(()=>{this._broadcast()},this.interval))}beforeStop(){const e=this.components.pubsub;if(e==null)throw new Error("PubSub not configured");for(const r of this.topics)e.unsubscribe(r),e.removeEventListener("message",this._onMessage)}stop(){this.intervalId!=null&&(clearInterval(this.intervalId),this.intervalId=void 0)}_broadcast(){const e=this.components.peerId;if(e.publicKey==null)throw new Error("PeerId was missing public key");const r={publicKey:e.publicKey,addrs:this.components.addressManager.getAddresses().map(o=>o.bytes)},s=Wa.encode(r),i=this.components.pubsub;if(i==null)throw new Error("PubSub not configured");for(const o of this.topics){if(i.getSubscribers(o).length===0){this.log("skipping broadcasting our peer data on topic %s because there are no peers present",o);continue}this.log("broadcasting our peer data on topic %s",o),i.publish(o,s)}}_onMessage(e){if(!this.isStarted())return;const r=e.detail;if(!this.topics.includes(r.topic))return;const s=Wa.decode(r.data);Cr(s.publicKey).then(i=>{i.equals(this.components.peerId)||(this.log("discovered peer %p on %s",i,r.topic),this.safeDispatchEvent("peer",{detail:{id:i,multiaddrs:s.addrs.map(o=>G(o))}}))}).catch(i=>{this.log.error(i)})}}function Y_(n={}){return t=>new G_(t,n)}const Q_=290,X_=1,Z_=1e3,J_=100,j_="circuit-relay-relay";BigInt(1<<17);const qa="/libp2p/circuit/relay/0.2.0/hop",Kd="/libp2p/circuit/relay/0.2.0/stop",Hd=300,zd="ERR_RELAYED_DIAL",eS="ERR_HOP_REQUEST_FAILED",tS=4096,rS=.001;var ii;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),oi.codec().encode(r.peer,s)),r.reservation!=null&&(s.uint32(26),Ga.codec().encode(r.reservation,s)),r.limit!=null&&(s.uint32(34),ai.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(40),bt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{var c,l,u;const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const d=r.uint32();switch(d>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=oi.codec().decode(r,r.uint32(),{limits:(c=i.limits)==null?void 0:c.peer});break}case 3:{o.reservation=Ga.codec().decode(r,r.uint32(),{limits:(l=i.limits)==null?void 0:l.reservation});break}case 4:{o.limit=ai.codec().decode(r,r.uint32(),{limits:(u=i.limits)==null?void 0:u.limit});break}case 5:{o.status=bt.codec().decode(r);break}default:{r.skipType(d&7);break}}}return o})),e),n.encode=r=>he(r,n.codec()),n.decode=(r,s)=>ue(r,n.codec(),s)})(ii||(ii={}));var Vr;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let t;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(t||(t={})),function(r){r.codec=()=>kr(t)}(n.Type||(n.Type={}));let e;n.codec=()=>(e==null&&(e=de((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),oi.codec().encode(r.peer,s)),r.limit!=null&&(s.uint32(26),ai.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(32),bt.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{var c,l;const o={},a=s==null?r.len:r.pos+s;for(;r.pos<a;){const u=r.uint32();switch(u>>>3){case 1:{o.type=n.Type.codec().decode(r);break}case 2:{o.peer=oi.codec().decode(r,r.uint32(),{limits:(c=i.limits)==null?void 0:c.peer});break}case 3:{o.limit=ai.codec().decode(r,r.uint32(),{limits:(l=i.limits)==null?void 0:l.limit});break}case 4:{o.status=bt.codec().decode(r);break}default:{r.skipType(u&7);break}}}return o})),e),n.encode=r=>he(r,n.codec()),n.decode=(r,s)=>ue(r,n.codec(),s)})(Vr||(Vr={}));var oi;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a;const i={id:Ue(0),addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const c=e.uint32();switch(c>>>3){case 1:{i.id=e.bytes();break}case 2:{if(((a=s.limits)==null?void 0:a.addrs)!=null&&i.addrs.length===s.limits.addrs)throw new Bt('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");i.addrs.push(e.bytes());break}default:{e.skipType(c&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(oi||(oi={}));var Ga;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.expire!=null&&e.expire!==0n&&(r.uint32(8),r.uint64(e.expire)),e.addrs!=null)for(const i of e.addrs)r.uint32(18),r.bytes(i);e.voucher!=null&&(r.uint32(26),r.bytes(e.voucher)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a;const i={expire:0n,addrs:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const c=e.uint32();switch(c>>>3){case 1:{i.expire=e.uint64();break}case 2:{if(((a=s.limits)==null?void 0:a.addrs)!=null&&i.addrs.length===s.limits.addrs)throw new Bt('decode error - map field "addrs" had too many elements',"ERR_MAX_LENGTH");i.addrs.push(e.bytes());break}case 3:{i.voucher=e.bytes();break}default:{e.skipType(c&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(Ga||(Ga={}));var ai;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.duration!=null&&(r.uint32(8),r.uint32(e.duration)),e.data!=null&&(r.uint32(16),r.uint64(e.data)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.duration=e.uint32();break}case 2:{i.data=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(ai||(ai={}));var bt;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(bt||(bt={}));var l1;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(l1||(l1={}));(function(n){n.codec=()=>kr(l1)})(bt||(bt={}));var Wd;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.relay!=null&&e.relay.byteLength>0&&(r.uint32(10),r.bytes(e.relay)),e.peer!=null&&e.peer.byteLength>0&&(r.uint32(18),r.bytes(e.peer)),e.expiration!=null&&e.expiration!==0n&&(r.uint32(24),r.uint64(e.expiration)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={relay:Ue(0),peer:Ue(0),expiration:0n},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.relay=e.bytes();break}case 2:{i.peer=e.bytes();break}case 3:{i.expiration=e.uint64();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(Wd||(Wd={}));function qd(n){const t=n*BigInt(1e3),e=new Date().getTime();return Number(t-BigInt(e))}function Gd(n){const{stream:t,remoteAddr:e,logger:r}=n,s=r.forComponent("libp2p:stream:converter");let i=!1,o=!1;const a=t.close.bind(t);t.close=async f=>{await a(f),d(!0)};const c=t.abort.bind(t);t.abort=f=>{c(f),d(!0)};const l=t.sink.bind(t);t.sink=async f=>{try{await l(f)}catch(p){p.type!=="aborted"&&s.error("%s error in sink",e,p)}finally{o=!0,d()}};const u={log:s,sink:t.sink,source:async function*(){try{for await(const f of t.source)f instanceof Uint8Array?yield f:yield*f}finally{i=!0,d()}}(),remoteAddr:e,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function d(f){f===!0&&(i=!0,o=!0),i&&o&&u.timeline.close==null&&(u.timeline.close=Date.now())}return u}class nS extends Et{constructor(e,r={}){super();h(this,"peerStore");h(this,"registrar");h(this,"connectionManager");h(this,"randomWalk");h(this,"started");h(this,"running");h(this,"topologyId");h(this,"log");h(this,"discoveryController");h(this,"filter");this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.connectionManager=e.connectionManager,this.randomWalk=e.randomWalk,this.filter=r.filter,this.discoveryController=new AbortController,ge(1/0,this.discoveryController.signal)}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(qa,{filter:this.filter,onConnect:e=>{this.log("discovered relay %p",e),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){var e;this.topologyId!=null&&this.registrar.unregister(this.topologyId),(e=this.discoveryController)==null||e.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,ge(1/0,this.discoveryController.signal),Promise.resolve().then(async()=>{var s;this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[i=>i.protocols.includes(qa)],orders:[()=>Math.random()<.5?1:-1]});for(const i of e)this.log.trace("found relay peer %p in peer store",i.id),this.safeDispatchEvent("relay:discover",{detail:i.id});this.log("found %d relay peers in peer store",e.length);const r=new _c({concurrency:5});this.log("start random walk");for await(const i of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",i.id),r.has(i.id)){this.log.trace("random peer %p was already in queue",i.id);continue}if(((s=this.connectionManager.getConnections(i.id))==null?void 0:s.length)>0){this.log.trace("random peer %p was already connected",i.id);continue}if(!await this.connectionManager.isDialable(i.multiaddrs)){this.log.trace("random peer %p was not dialable",i.id,i.multiaddrs.map(o=>o.toString()));continue}this.log.trace("wait for space in queue for %p",i.id),await it(r.onSizeLessThan(10),this.discoveryController.signal),this.log("adding random peer %p to dial queue (length: %d)",i.id,r.size),r.add(async()=>{const o=Xt([this.discoveryController.signal,AbortSignal.timeout(5e3)]);ge(1/0,o);try{await this.connectionManager.openConnection(i.id,{signal:o})}finally{o.clear()}},{peerId:i.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",i.id,o)})}await r.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){var e;this.log("stop discovery"),this.running=!1,(e=this.discoveryController)==null||e.abort()}}var tc,P6;class sS extends Et{constructor(e){super();j(this,tc);h(this,"connectionManager");h(this,"relayStore");h(this,"listeningAddrs");h(this,"log");h(this,"_onRemoveRelayPeer",e=>{O(this,tc,P6).call(this,e.detail)});this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Es,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(e){this.log("listen on %a",e);const r=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(r);if(!this.relayStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer),await this.relayStore.addRelay(s.remotePeer,"configured");return}const i=this.relayStore.getReservation(s.remotePeer);if(i==null)throw new v("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(s.remotePeer)){this.log("already listening on relay %p",s.remotePeer);return}this.listeningAddrs.set(s.remotePeer,i.addrs.map(o=>G(o).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}}tc=new WeakSet,P6=function(e){const r=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,r),this.listeningAddrs.delete(e),r&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))};function iS(n){return new sS(n)}const oS=60*1e3*10,aS=60*1e3*5,cS=30*1e3;var hi,k6,N6;class lS extends Et{constructor(e,r){super();j(this,hi);h(this,"peerId");h(this,"connectionManager");h(this,"transportManager");h(this,"peerStore");h(this,"events");h(this,"reserveQueue");h(this,"reservations");h(this,"maxDiscoveredRelays");h(this,"maxReservationQueueLength");h(this,"reservationCompletionTimeout");h(this,"started");h(this,"log");h(this,"relayFilter");this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Es,this.maxDiscoveredRelays=(r==null?void 0:r.discoverRelays)??0,this.maxReservationQueueLength=(r==null?void 0:r.maxReservationQueueLength)??J_,this.reservationCompletionTimeout=(r==null?void 0:r.reservationCompletionTimeout)??Z_,this.started=!1,this.relayFilter=by(100),this.reserveQueue=new _c({concurrency:(r==null?void 0:r.reservationConcurrency)??X_,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("peer:disconnect",s=>{O(this,hi,N6).call(this,s.detail)})}isStarted(){return this.started}start(){this.started=!0}afterStart(){this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{}))}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,r){if(this.peerId.equals(e)){this.log("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){this.log("not adding potential relay peer %p as the queue is full",e);return}if(this.reserveQueue.has(e)){this.log("potential relay peer %p is already in the reservation queue",e);return}if(this.relayFilter.has(e.toBytes())){this.log("potential relay peer %p has failed previously, not trying again",e);return}this.log("try to reserve relay slot with %p",e),await this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){if(qd(i.reservation.expire)>oS){this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(i.timeout),this.reservations.delete(e)}if(r==="discovered"&&[...this.reservations.values()].reduce((f,p)=>(p.type==="discovered"&&f++,f),0)>=this.maxDiscoveredRelays){this.log("already have enough discovered relays");return}const o=AbortSignal.timeout(this.reservationCompletionTimeout);ge(1/0,o);const a=await this.connectionManager.openConnection(e,{signal:o});if(a.remoteAddr.protoNames().includes("p2p-circuit")){this.log("not creating reservation over relayed connection");return}const c=await O(this,hi,k6).call(this,a,{signal:o});this.log("created reservation on relay peer %p",e);const l=qd(c.expire),u=Math.min(Math.max(l-aS,cS),Math.pow(2,31)-1),d=setTimeout(()=>{this.addRelay(e,r).catch(f=>{this.log.error("could not refresh reservation to relay %p",e,f)})},u);this.reservations.set(e,{timeout:d,reservation:c,type:r}),await this.peerStore.merge(e,{tags:{[j_]:{value:1,ttl:l}}}),await this.transportManager.listen([G(`/p2p/${e.toString()}/p2p-circuit`)]),this.safeDispatchEvent("relay:created-reservation",{detail:e})}catch(i){this.log.error("could not reserve slot on %p after %dms",e,Date.now()-s,i);const o=this.reservations.get(e);o!=null&&clearTimeout(o.timeout),this.reservations.delete(e),this.relayFilter.add(e.toBytes())}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){var r;return(r=this.reservations.get(e))==null?void 0:r.reservation}reservationCount(){return this.reservations.size}}hi=new WeakSet,k6=async function(e,r){var l;(l=r.signal)==null||l.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const s=await e.newStream(qa,r),o=Ct(s).pb(ii);await o.write({type:ii.Type.RESERVE},r);let a;try{a=await o.read(r)}catch(u){throw s.abort(u),u}finally{s.status!=="closed"&&await s.close(r)}if(a.status===bt.OK&&a.reservation!=null){let u=!1;const d=e.remoteAddr.bytes;for(const f of a.reservation.addrs)if(ke(d,f)){u=!0;break}return u||a.reservation.addrs.push(d),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},N6=function(e){const r=this.reservations.get(e);r!=null&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(r.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))};const uS=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(G)}catch{return!1}return!0},cl={maxInboundStopStreams:Hd,maxOutboundStopStreams:Hd,stopTimeout:3e4};var W0,q0,G0,Y0;class hS{constructor(t,e){h(this,"discovery");h(this,"registrar");h(this,"peerStore");h(this,"connectionManager");h(this,"transportManager");h(this,"peerId");h(this,"upgrader");h(this,"addressManager");h(this,"connectionGater");h(this,"reservationStore");h(this,"logger");h(this,"maxInboundStopStreams");h(this,"maxOutboundStopStreams");h(this,"stopTimeout");h(this,"started");h(this,"log");h(this,Y0,"@libp2p/circuit-relay-v2-transport");h(this,G0,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);h(this,W0,!0);this.log=t.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=t.registrar,this.peerStore=t.peerStore,this.connectionManager=t.connectionManager,this.transportManager=t.transportManager,this.logger=t.logger,this.peerId=t.peerId,this.upgrader=t.upgrader,this.addressManager=t.addressManager,this.connectionGater=t.connectionGater,this.maxInboundStopStreams=e.maxInboundStopStreams??cl.maxInboundStopStreams,this.maxOutboundStopStreams=e.maxOutboundStopStreams??cl.maxOutboundStopStreams,this.stopTimeout=e.stopTimeout??cl.stopTimeout;const r=e.discoverRelays??0;r>0&&(this.discovery=new nS(t,{filter:e.discoveryFilter??ky(tS,rS)}),this.discovery.addEventListener("relay:discover",s=>{this.reservationStore.addRelay(s.detail,"discovered").catch(i=>{this.log.error("could not add discovered relay %p",s.detail,i)})})),this.reservationStore=new lS(t,e),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var s;(s=this.discovery)==null||s.startDiscovery()}),this.reservationStore.addEventListener("relay:created-reservation",()=>{var s;this.reservationStore.reservationCount()>=r&&((s=this.discovery)==null||s.stopDiscovery())}),this.started=!1}get[(Y0=Symbol.toStringTag,G0=jt,q0=rs,W0=sc,q0)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){await this.registrar.handle(Kd,t=>{this.onStop(t).catch(e=>{this.log.error("error while handling STOP protocol",e),t.stream.abort(e)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),await I2(this.discovery,this.reservationStore),this.started=!0}async stop(){await R2(this.discovery,this.reservationStore),await this.registrar.unhandle(Kd),this.started=!1}async dial(t,e={}){if(t.protoCodes().filter(y=>y===Q_).length!==1){const y="Invalid circuit relay address";throw this.log.error(y,t),new v(y,zd)}const r=t.toString().split("/p2p-circuit"),s=G(r[0]),i=G(r[r.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const y=`Circuit relay dial to ${t.toString()} failed as address did not have peer ids`;throw this.log.error(y),new v(y,zd)}const c=ye(o),l=ye(a);let u=!1,f=this.connectionManager.getConnections(c)[0];f==null&&(await this.peerStore.merge(c,{multiaddrs:[s]}),f=await this.connectionManager.openConnection(c,e),u=!0);let p;try{return p=await f.newStream(qa),await this.connectV2({stream:p,connection:f,destinationPeer:l,destinationAddr:i,relayAddr:s,ma:t,disconnectOnFailure:u})}catch(y){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,y),p!=null&&p.abort(y),u&&await f.close(),y}}async connectV2({stream:t,connection:e,destinationPeer:r,destinationAddr:s,relayAddr:i,ma:o,disconnectOnFailure:a}){var c;try{const l=Ct(t),u=l.pb(ii);await u.write({type:ii.Type.CONNECT,peer:{id:r.toBytes(),addrs:[G(s).bytes]}});const d=await u.read();if(d.status!==bt.OK)throw new v(`failed to connect via relay with status ${((c=d==null?void 0:d.status)==null?void 0:c.toString())??"undefined"}`,eS);const f=Gd({stream:l.unwrap(),remoteAddr:o,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger});return this.log("new outbound relayed connection %a",f.remoteAddr),await this.upgrader.upgradeOutbound(f,{transient:d.limit!=null})}catch(l){throw this.log.error(`Circuit relay dial to destination ${r.toString()} via relay ${e.remotePeer.toString()} failed`,l),a&&await e.close(),l}}createListener(t){return iS({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}listenFilter(t){return t=Array.isArray(t)?t:[t],t.filter(e=>d6.matches(e))}dialFilter(t){return this.listenFilter(t)}async onStop({connection:t,stream:e}){var u,d;if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}const r=AbortSignal.timeout(this.stopTimeout),s=Ct(e).pb(Vr),i=await s.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,i.type),(i==null?void 0:i.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await s.write({type:Vr.Type.STATUS,status:bt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}if(i.type!==Vr.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Vr.Type.STATUS,status:bt.UNEXPECTED_MESSAGE},{signal:r}),await e.close();return}if(!uS(i)){this.log.error("invalid stop connect request via peer %p",t.remotePeer),await s.write({type:Vr.Type.STATUS,status:bt.MALFORMED_MESSAGE},{signal:r}),await e.close();return}const o=tr(i.peer.id);if(await((d=(u=this.connectionGater).denyInboundRelayedConnection)==null?void 0:d.call(u,t.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await s.write({type:Vr.Type.STATUS,status:bt.PERMISSION_DENIED},{signal:r}),await e.close();return}this.log.trace("sending success response to %p",t.remotePeer),await s.write({type:Vr.Type.STATUS,status:bt.OK},{signal:r});const a=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),c=this.addressManager.getAddresses()[0],l=Gd({stream:s.unwrap().unwrap(),remoteAddr:a,localAddr:c,logger:this.logger});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:i.limit!=null}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function dS(n={}){return t=>new hS(t,n)}const Ei=1e3,Cu=60*Ei,Yd="/floodsub/1.0.0",Qd="/meshsub/1.0.0",Xd="/meshsub/1.1.0",fS=6,gS=4,pS=12,mS=4,yS=2,wS=5,bS=3,ES=6,vS=.25,_S=3,Zd=100,SS=Ei,IS=Cu,RS=16,AS=Cu,TS=10*Ei,DS=15,xS=300,CS=Ei,PS=60,kS=2,NS=10*Ei,Ss=5e3,MS=10,OS=3*Ei,LS=2*Cu,BS=120*1e3,US="ERR_TOPIC_VALIDATOR_REJECT",FS="ERR_TOPIC_VALIDATOR_IGNORE",VS=0,$S=128,KS=1e3,HS=1e3,zS=1,WS={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var es;(function(n){(function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.subscribe!=null&&(i.uint32(8),i.bool(s.subscribe)),s.topic!=null&&(i.uint32(18),i.string(s.topic)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.subscribe=s.bool();break}case 2:{a.topic=s.string();break}default:{s.skipType(l&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)})(n.SubOpts||(n.SubOpts={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.from!=null&&(i.uint32(10),i.bytes(s.from)),s.data!=null&&(i.uint32(18),i.bytes(s.data)),s.seqno!=null&&(i.uint32(26),i.bytes(s.seqno)),s.topic!=null&&s.topic!==""&&(i.uint32(34),i.string(s.topic)),s.signature!=null&&(i.uint32(42),i.bytes(s.signature)),s.key!=null&&(i.uint32(50),i.bytes(s.key)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={topic:""},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.from=s.bytes();break}case 2:{a.data=s.bytes();break}case 3:{a.seqno=s.bytes();break}case 4:{a.topic=s.string();break}case 5:{a.signature=s.bytes();break}case 6:{a.key=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.Message||(n.Message={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.ihave!=null)for(const a of s.ihave)i.uint32(10),n.ControlIHave.codec().encode(a,i);if(s.iwant!=null)for(const a of s.iwant)i.uint32(18),n.ControlIWant.codec().encode(a,i);if(s.graft!=null)for(const a of s.graft)i.uint32(26),n.ControlGraft.codec().encode(a,i);if(s.prune!=null)for(const a of s.prune)i.uint32(34),n.ControlPrune.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{var l,u,d,f;const a={ihave:[],iwant:[],graft:[],prune:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const p=s.uint32();switch(p>>>3){case 1:{if(((l=o.limits)==null?void 0:l.ihave)!=null&&a.ihave.length===o.limits.ihave)throw new Bt('decode error - map field "ihave" had too many elements',"ERR_MAX_LENGTH");a.ihave.push(n.ControlIHave.codec().decode(s,s.uint32()));break}case 2:{if(((u=o.limits)==null?void 0:u.iwant)!=null&&a.iwant.length===o.limits.iwant)throw new Bt('decode error - map field "iwant" had too many elements',"ERR_MAX_LENGTH");a.iwant.push(n.ControlIWant.codec().decode(s,s.uint32()));break}case 3:{if(((d=o.limits)==null?void 0:d.graft)!=null&&a.graft.length===o.limits.graft)throw new Bt('decode error - map field "graft" had too many elements',"ERR_MAX_LENGTH");a.graft.push(n.ControlGraft.codec().decode(s,s.uint32()));break}case 4:{if(((f=o.limits)==null?void 0:f.prune)!=null&&a.prune.length===o.limits.prune)throw new Bt('decode error - map field "prune" had too many elements',"ERR_MAX_LENGTH");a.prune.push(n.ControlPrune.codec().decode(s,s.uint32()));break}default:{s.skipType(p&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.ControlMessage||(n.ControlMessage={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{var l;const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new Bt('decode error - map field "messageIDs" had too many elements',"ERR_MAX_LENGTH");a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.ControlIHave||(n.ControlIHave={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.messageIDs!=null)for(const a of s.messageIDs)i.uint32(10),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{var l;const a={messageIDs:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new Bt('decode error - map field "messageIDs" had too many elements',"ERR_MAX_LENGTH");a.messageIDs.push(s.bytes());break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.ControlIWant||(n.ControlIWant={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.topicID=s.string();break}default:{s.skipType(l&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.ControlGraft||(n.ControlGraft={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.topicID!=null&&(i.uint32(10),i.string(s.topicID)),s.peers!=null)for(const a of s.peers)i.uint32(18),n.PeerInfo.codec().encode(a,i);s.backoff!=null&&(i.uint32(24),i.uint64Number(s.backoff)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{var l;const a={peers:[]},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const u=s.uint32();switch(u>>>3){case 1:{a.topicID=s.string();break}case 2:{if(((l=o.limits)==null?void 0:l.peers)!=null&&a.peers.length===o.limits.peers)throw new Bt('decode error - map field "peers" had too many elements',"ERR_MAX_LENGTH");a.peers.push(n.PeerInfo.codec().decode(s,s.uint32()));break}case 3:{a.backoff=s.uint64Number();break}default:{s.skipType(u&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.ControlPrune||(n.ControlPrune={})),function(e){let r;e.codec=()=>(r==null&&(r=de((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.peerID!=null&&(i.uint32(10),i.bytes(s.peerID)),s.signedPeerRecord!=null&&(i.uint32(18),i.bytes(s.signedPeerRecord)),o.lengthDelimited!==!1&&i.ldelim()},(s,i,o={})=>{const a={},c=i==null?s.len:s.pos+i;for(;s.pos<c;){const l=s.uint32();switch(l>>>3){case 1:{a.peerID=s.bytes();break}case 2:{a.signedPeerRecord=s.bytes();break}default:{s.skipType(l&7);break}}}return a})),r),e.encode=s=>he(s,e.codec()),e.decode=(s,i)=>ue(s,e.codec(),i)}(n.PeerInfo||(n.PeerInfo={}));let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.subscriptions!=null)for(const i of e.subscriptions)r.uint32(10),n.SubOpts.codec().encode(i,r);if(e.messages!=null)for(const i of e.messages)r.uint32(18),n.Message.codec().encode(i,r);e.control!=null&&(r.uint32(26),n.ControlMessage.codec().encode(e.control,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{var a,c;const i={subscriptions:[],messages:[]},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const l=e.uint32();switch(l>>>3){case 1:{if(((a=s.limits)==null?void 0:a.subscriptions)!=null&&i.subscriptions.length===s.limits.subscriptions)throw new Bt('decode error - map field "subscriptions" had too many elements',"ERR_MAX_LENGTH");i.subscriptions.push(n.SubOpts.codec().decode(e,e.uint32()));break}case 2:{if(((c=s.limits)==null?void 0:c.messages)!=null&&i.messages.length===s.limits.messages)throw new Bt('decode error - map field "messages" had too many elements',"ERR_MAX_LENGTH");i.messages.push(n.Message.codec().decode(e,e.uint32()));break}case 3:{i.control=n.ControlMessage.codec().decode(e,e.uint32());break}default:{e.skipType(l&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(es||(es={}));class qS{constructor(t,e,r){h(this,"gossip");h(this,"msgs",new Map);h(this,"msgIdToStrFn");h(this,"history",[]);h(this,"notValidatedCount",0);this.gossip=t,this.msgIdToStrFn=r;for(let s=0;s<e;s++)this.history[s]=[]}get size(){return this.msgs.size}put(t,e,r=!1){const{msgIdStr:s}=t;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:e,validated:r,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...t,topic:e.topic}),r||this.notValidatedCount++,!0)}observeDuplicate(t,e){const r=this.msgs.get(t);r!=null&&!r.validated&&r.originatingPeers.add(e)}get(t){var e;return(e=this.msgs.get(this.msgIdToStrFn(t)))==null?void 0:e.message}getWithIWantCount(t,e){const r=this.msgs.get(t);if(r==null)return null;const s=(r.iwantCounts.get(e)??0)+1;return r.iwantCounts.set(e,s),{msg:r.message,count:s}}getGossipIDs(t){const e=new Map;for(let r=0;r<this.gossip;r++)this.history[r].forEach(s=>{const i=this.msgs.get(s.msgIdStr);if(((i==null?void 0:i.validated)??!1)&&t.has(s.topic)){let o=e.get(s.topic);o==null&&(o=[],e.set(s.topic,o)),o.push(s.msgId)}});return e}validate(t){const e=this.msgs.get(t);if(e==null)return null;e.validated||this.notValidatedCount--;const{message:r,originatingPeers:s}=e;return e.validated=!0,e.originatingPeers=new Set,{message:r,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(e=>{const r=this.msgs.get(e.msgIdStr);r!=null&&(this.msgs.delete(e.msgIdStr),r.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(t){const e=this.msgs.get(t);return e==null?null:(this.msgs.delete(t),e)}}var Jd;(function(n){n.StrictSign="StrictSign",n.StrictNoSign="StrictNoSign"})(Jd||(Jd={}));var ci;(function(n){n[n.Signing=0]="Signing",n[n.Anonymous=1]="Anonymous"})(ci||(ci={}));var dr;(function(n){n.Error="error",n.Ignore="ignore",n.Reject="reject",n.Blacklisted="blacklisted"})(dr||(dr={}));var It;(function(n){n.InvalidSignature="invalid_signature",n.InvalidSeqno="invalid_seqno",n.InvalidPeerId="invalid_peerid",n.SignaturePresent="signature_present",n.SeqnoPresent="seqno_present",n.FromPresent="from_present",n.TransformFailed="transform_failed"})(It||(It={}));var Tt;(function(n){n.duplicate="duplicate",n.invalid="invalid",n.valid="valid"})(Tt||(Tt={}));function jd(n){switch(n){case Yt.Ignore:return dr.Ignore;case Yt.Reject:return dr.Reject;default:throw new Error("Unreachable")}}var e0;(function(n){n.forward="forward",n.publish="publish"})(e0||(e0={}));var xt;(function(n){n.Fanout="fanout",n.Random="random",n.Subscribed="subscribed",n.Outbound="outbound",n.NotEnough="not_enough",n.Opportunistic="opportunistic"})(xt||(xt={}));var Ar;(function(n){n.Dc="disconnected",n.BadScore="bad_score",n.Prune="prune",n.Excess="excess"})(Ar||(Ar={}));var Fi;(function(n){n.GraftBackoff="graft_backoff",n.BrokenPromise="broken_promise",n.MessageDeficit="message_deficit",n.IPColocation="IP_colocation"})(Fi||(Fi={}));var Vi;(function(n){n.LowScore="low_score",n.MaxIhave="max_ihave",n.MaxIasked="max_iasked"})(Vi||(Vi={}));var Ts;(function(n){n.graylist="graylist",n.publish="publish",n.gossip="gossip",n.mesh="mesh"})(Ts||(Ts={}));function GS(n,t,e){return{protocolsEnabled:n.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:n.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:n.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:n.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:n.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:n.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:n.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:n.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:n.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:n.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:n.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:n.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:n.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:n.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:n.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:n.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:n.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:n.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:n.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:n.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:n.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:n.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:n.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:n.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:n.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:n.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:n.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:n.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:n.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:n.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:n.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:n.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:n.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:n.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:n.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:n.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:n.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:n.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:n.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:n.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:n.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:n.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:n.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:n.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:n.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:n.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:n.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:n.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:n.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:n.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:n.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:n.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:n.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:n.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:n.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:n.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:n.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:n.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:n.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:n.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:n.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*e.maxMeshMessageDeliveriesWindowSec,.5*e.maxMeshMessageDeliveriesWindowSec,Number(e.maxMeshMessageDeliveriesWindowSec),2*e.maxMeshMessageDeliveriesWindowSec,4*e.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:n.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:n.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:n.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:n.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:n.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:n.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:n.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:n.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:n.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:n.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:n.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*e.behaviourPenaltyThreshold,.5*e.behaviourPenaltyThreshold,Number(e.behaviourPenaltyThreshold),2*e.behaviourPenaltyThreshold,4*e.behaviourPenaltyThreshold]}),ihaveRcvIgnored:n.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:n.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:n.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:n.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:n.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:n.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:n.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:n.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:n.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:n.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:n.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:n.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*e.gossipPromiseExpireSec,Number(e.gossipPromiseExpireSec),2*e.gossipPromiseExpireSec,4*e.gossipPromiseExpireSec]}),iwantPromiseUntracked:n.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:n.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:n.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:n.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:n.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:n.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:n.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(r){return this.topicStrToLabel.get(r)??r},onJoin(r){this.topicSubscriptionStatus.set({topicStr:r},1),this.meshPeerCounts.set({topicStr:r},0)},onLeave(r){this.topicSubscriptionStatus.set({topicStr:r},0),this.meshPeerCounts.set({topicStr:r},0)},onAddToMesh(r,s,i){const o=this.toTopic(r);switch(s){case xt.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case xt.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case xt.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case xt.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case xt.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case xt.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(r,s,i){const o=this.toTopic(r);switch(s){case Ar.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Ar.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Ar.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Ar.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(r,s,i){if(this.asyncValidationMcacheHit.inc({hit:r!=null?"hit":"miss"}),r!=null){const o=this.toTopic(r.message.topic);switch(s){case Yt.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Yt.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Yt.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(r){this.scoringPenalties.inc({penalty:r},1)},onIhaveRcv(r,s,i){const o=this.toTopic(r);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(r,s){for(const[i,o]of r){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(r,s){const i=this.toTopic(r);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(r,s,i,o,a){const c=this.toTopic(r);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},i*o),this.msgPublishPeersByTopic.inc({topic:c},i),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(r){const s=this.toTopic(r);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(r){const s=this.toTopic(r);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(r,s){const i=this.toTopic(r);switch(s){case Tt.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case Tt.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case Tt.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(r,s){const i=this.toTopic(r),o=s.reason===dr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(r,s,i){const o=this.toTopic(r);this.duplicateMsgDeliveryDelay.observe({topic:o},s/1e3),i&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(r){const s=this.toTopic(r);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(r,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),r.subscriptions!=null&&this.rpcRecvSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcRecvMessage.inc(r.messages.length),r.control!=null&&(this.rpcRecvControl.inc(1),r.control.ihave!=null&&this.rpcRecvIHave.inc(r.control.ihave.length),r.control.iwant!=null&&this.rpcRecvIWant.inc(r.control.iwant.length),r.control.graft!=null&&this.rpcRecvGraft.inc(r.control.graft.length),r.control.prune!=null&&this.rpcRecvPrune.inc(r.control.prune.length))},onRpcSent(r,s){var i,o,a,c;if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),r.subscriptions!=null&&this.rpcSentSubscription.inc(r.subscriptions.length),r.messages!=null&&this.rpcSentMessage.inc(r.messages.length),r.control!=null){const l=((i=r.control.ihave)==null?void 0:i.length)??0,u=((o=r.control.iwant)==null?void 0:o.length)??0,d=((a=r.control.graft)==null?void 0:a.length)??0,f=((c=r.control.prune)==null?void 0:c.length)??0;l>0&&this.rpcSentIHave.inc(l),u>0&&this.rpcSentIWant.inc(u),d>0&&this.rpcSentGraft.inc(d),f>0&&this.rpcSentPrune.inc(f),(l>0||u>0||d>0||f>0)&&this.rpcSentControl.inc(1)}},registerScores(r,s){let i=0,o=0,a=0,c=0;for(const l of r)l>=s.graylistThreshold&&i++,l>=s.publishThreshold&&o++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:Ts.graylist},i),this.peersByScoreThreshold.set({threshold:Ts.publish},o),this.peersByScoreThreshold.set({threshold:Ts.gossip},a),this.peersByScoreThreshold.set({threshold:Ts.mesh},c),this.score.set(r)},registerScoreWeights(r){for(const[s,i]of r.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},r.p5w),this.scoreWeights.set({p:"p6"},r.p6w),this.scoreWeights.set({p:"p7"},r.p7w)},registerScorePerMesh(r,s){const i=new Map;r.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=i.get(c);l==null&&(l=new Set,i.set(c,l)),o.forEach(u=>l==null?void 0:l.add(u))});for(const[o,a]of i){const c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}const Te="ERR_INVALID_PEER_SCORE_PARAMS",YS={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},QS={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function XS(n={}){return{...YS,...n,topics:n.topics!=null?Object.entries(n.topics).reduce((t,[e,r])=>(t[e]=ZS(r),t),{}):{}}}function ZS(n={}){return{...QS,...n}}function JS(n){for(const[t,e]of Object.entries(n.topics))try{jS(e)}catch(r){throw new v(`invalid score parameters for topic ${t}: ${r.message}`,Te)}if(n.topicScoreCap<0)throw new v("invalid topic score cap; must be positive (or 0 for no cap)",Te);if(n.appSpecificScore===null||n.appSpecificScore===void 0)throw new v("missing application specific score function",Te);if(n.IPColocationFactorWeight>0)throw new v("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Te);if(n.IPColocationFactorWeight!==0&&n.IPColocationFactorThreshold<1)throw new v("invalid IPColocationFactorThreshold; must be at least 1",Te);if(n.behaviourPenaltyWeight>0)throw new v("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Te);if(n.behaviourPenaltyWeight!==0&&(n.behaviourPenaltyDecay<=0||n.behaviourPenaltyDecay>=1))throw new v("invalid BehaviourPenaltyDecay; must be between 0 and 1",Te);if(n.decayInterval<1e3)throw new v("invalid DecayInterval; must be at least 1s",Te);if(n.decayToZero<=0||n.decayToZero>=1)throw new v("invalid DecayToZero; must be between 0 and 1",Te)}function jS(n){if(n.topicWeight<0)throw new v("invalid topic weight; must be >= 0",Te);if(n.timeInMeshQuantum===0)throw new v("invalid TimeInMeshQuantum; must be non zero",Te);if(n.timeInMeshWeight<0)throw new v("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Te);if(n.timeInMeshWeight!==0&&n.timeInMeshQuantum<=0)throw new v("invalid TimeInMeshQuantum; must be positive",Te);if(n.timeInMeshWeight!==0&&n.timeInMeshCap<=0)throw new v("invalid TimeInMeshCap; must be positive",Te);if(n.firstMessageDeliveriesWeight<0)throw new v("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Te);if(n.firstMessageDeliveriesWeight!==0&&(n.firstMessageDeliveriesDecay<=0||n.firstMessageDeliveriesDecay>=1))throw new v("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Te);if(n.firstMessageDeliveriesWeight!==0&&n.firstMessageDeliveriesCap<=0)throw new v("invalid FirstMessageDeliveriesCap; must be positive",Te);if(n.meshMessageDeliveriesWeight>0)throw new v("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Te);if(n.meshMessageDeliveriesWeight!==0&&(n.meshMessageDeliveriesDecay<=0||n.meshMessageDeliveriesDecay>=1))throw new v("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Te);if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesCap<=0)throw new v("invalid MeshMessageDeliveriesCap; must be positive",Te);if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesThreshold<=0)throw new v("invalid MeshMessageDeliveriesThreshold; must be positive",Te);if(n.meshMessageDeliveriesWindow<0)throw new v("invalid MeshMessageDeliveriesWindow; must be non-negative",Te);if(n.meshMessageDeliveriesWeight!==0&&n.meshMessageDeliveriesActivation<1e3)throw new v("invalid MeshMessageDeliveriesActivation; must be at least 1s",Te);if(n.meshFailurePenaltyWeight>0)throw new v("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Te);if(n.meshFailurePenaltyWeight!==0&&(n.meshFailurePenaltyDecay<=0||n.meshFailurePenaltyDecay>=1))throw new v("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Te);if(n.invalidMessageDeliveriesWeight>0)throw new v("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Te);if(n.invalidMessageDeliveriesDecay<=0||n.invalidMessageDeliveriesDecay>=1)throw new v("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Te)}const eI={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function tI(n={}){return{...eI,...n}}function u1(n,t,e=()=>!0){const r=new Set;if(t<=0)return r;for(const s of n){if(r.size>=t)break;e(s)&&(r.add(s),n.delete(s))}return r}function rI(n,t){return u1(n,t,()=>!0)}class nI extends Map{constructor(e){super();h(this,"getDefault");this.getDefault=e}getOrDefault(e){let r=super.get(e);return r===void 0&&(r=this.getDefault(),this.set(e,r)),r}}function sI(n,t,e,r){let s=0;Object.entries(t.topics).forEach(([o,a])=>{const c=e.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let p=a.meshTime/c.timeInMeshQuantum;p>c.timeInMeshCap&&(p=c.timeInMeshCap),l+=p*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const p=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,y=p*p;l+=y*c.meshMessageDeliveriesWeight}const d=a.meshFailurePenalty;l+=d*c.meshFailurePenaltyWeight;const f=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=f*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),e.topicScoreCap>0&&s>e.topicScoreCap&&(s=e.topicScoreCap);const i=e.appSpecificScore(n);if(s+=i*e.appSpecificWeight,t.knownIPs.forEach(o=>{if(e.IPColocationFactorWhitelist.has(o))return;const a=r.get(o),c=a!=null?a.size:0;if(c>e.IPColocationFactorThreshold){const l=c-e.IPColocationFactorThreshold,u=l*l;s+=u*e.IPColocationFactorWeight}}),t.behaviourPenalty>e.behaviourPenaltyThreshold){const o=t.behaviourPenalty-e.behaviourPenaltyThreshold,a=o*o;s+=a*e.behaviourPenaltyWeight}return s}function Ve(n,e){var e=e||{};this._capacity=e.capacity,this._head=0,this._tail=0,Array.isArray(n)?this._fromArray(n):(this._capacityMask=3,this._list=new Array(4))}Ve.prototype.peekAt=function(t){var e=t;if(e===(e|0)){var r=this.size();if(!(e>=r||e<-r))return e<0&&(e+=r),e=this._head+e&this._capacityMask,this._list[e]}};Ve.prototype.get=function(t){return this.peekAt(t)};Ve.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Ve.prototype.peekFront=function(){return this.peek()};Ve.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Ve.prototype,"length",{get:function(){return this.size()}});Ve.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.unshift=function(t){if(arguments.length===0)return this.size();var e=this._list.length;return this._head=this._head-1+e&this._capacityMask,this._list[this._head]=t,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.shift=function(){var t=this._head;if(t!==this._tail){var e=this._list[t];return this._list[t]=void 0,this._head=t+1&this._capacityMask,t<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),e}};Ve.prototype.push=function(t){if(arguments.length===0)return this.size();var e=this._tail;return this._list[e]=t,this._tail=e+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Ve.prototype.pop=function(){var t=this._tail;if(t!==this._head){var e=this._list.length;this._tail=t-1+e&this._capacityMask;var r=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&t>1e4&&t<=e>>>2&&this._shrinkArray(),r}};Ve.prototype.removeOne=function(t){var e=t;if(e===(e|0)&&this._head!==this._tail){var r=this.size(),s=this._list.length;if(!(e>=r||e<-r)){e<0&&(e+=r),e=this._head+e&this._capacityMask;var i=this._list[e],o;if(t<r/2){for(o=t;o>0;o--)this._list[e]=this._list[e=e-1+s&this._capacityMask];this._list[e]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=r-1-t;o>0;o--)this._list[e]=this._list[e=e+1+s&this._capacityMask];this._list[e]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};Ve.prototype.remove=function(t,e){var r=t,s,i=e;if(r===(r|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(r>=o||r<-o||e<1)){if(r<0&&(r+=o),e===1||!e)return s=new Array(1),s[0]=this.removeOne(r),s;if(r===0&&r+e>=o)return s=this.toArray(),this.clear(),s;r+e>o&&(e=o-r);var c;for(s=new Array(e),c=0;c<e;c++)s[c]=this._list[this._head+r+c&this._capacityMask];if(r=this._head+r&this._capacityMask,t+e===o){for(this._tail=this._tail-e+a&this._capacityMask,c=e;c>0;c--)this._list[r=r+1+a&this._capacityMask]=void 0;return s}if(t===0){for(this._head=this._head+e+a&this._capacityMask,c=e-1;c>0;c--)this._list[r=r+1+a&this._capacityMask]=void 0;return s}if(r<o/2){for(this._head=this._head+t+e+a&this._capacityMask,c=t;c>0;c--)this.unshift(this._list[r=r-1+a&this._capacityMask]);for(r=this._head-1+a&this._capacityMask;i>0;)this._list[r=r-1+a&this._capacityMask]=void 0,i--;t<0&&(this._tail=r)}else{for(this._tail=r,r=r+e+a&this._capacityMask,c=o-(e+t);c>0;c--)this.push(this._list[r++]);for(r=this._tail;i>0;)this._list[r=r+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Ve.prototype.splice=function(t,e){var r=t;if(r===(r|0)){var s=this.size();if(r<0&&(r+=s),!(r>s))if(arguments.length>2){var i,o,a,c=arguments.length,l=this._list.length,u=2;if(!s||r<s/2){for(o=new Array(r),i=0;i<r;i++)o[i]=this._list[this._head+i&this._capacityMask];for(e===0?(a=[],r>0&&(this._head=this._head+r+l&this._capacityMask)):(a=this.remove(r,e),this._head=this._head+r+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(i=r;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(r+e));var d=o.length;for(i=0;i<d;i++)o[i]=this._list[this._head+r+e+i&this._capacityMask];for(e===0?(a=[],r!=s&&(this._tail=this._head+r+l&this._capacityMask)):(a=this.remove(r,e),this._tail=this._tail-d+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(i=0;i<d;i++)this.push(o[i])}return a}else return this.remove(r,e)}};Ve.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};Ve.prototype.isEmpty=function(){return this._head===this._tail};Ve.prototype.toArray=function(){return this._copyArray(!1)};Ve.prototype._fromArray=function(t){var e=t.length,r=this._nextPowerOf2(e);this._list=new Array(r),this._capacityMask=r-1,this._tail=e;for(var s=0;s<e;s++)this._list[s]=t[s]};Ve.prototype._copyArray=function(t,e){var r=this._list,s=r.length,i=this.length;if(e=e|i,e==i&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(e),a=0,c;if(t||this._head>this._tail){for(c=this._head;c<s;c++)o[a++]=r[c];for(c=0;c<this._tail;c++)o[a++]=r[c]}else for(c=this._head;c<this._tail;c++)o[a++]=r[c];return o};Ve.prototype._growArray=function(){if(this._head!=0){var t=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=t}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};Ve.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};Ve.prototype._nextPowerOf2=function(t){var e=Math.log(t)/Math.log(2),r=1<<e+1;return Math.max(r,4)};var iI=Ve;const oI=tn(iI);var Rt;(function(n){n[n.unknown=0]="unknown",n[n.valid=1]="valid",n[n.invalid=2]="invalid",n[n.ignored=3]="ignored"})(Rt||(Rt={}));class aI{constructor(){h(this,"records");h(this,"queue");this.records=new Map,this.queue=new oI}getRecord(t){return this.records.get(t)}ensureRecord(t){let e=this.records.get(t);if(e!=null)return e;e={status:Rt.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(t,e);const r={msgId:t,expire:Date.now()+BS};return this.queue.push(r),e}gc(){const t=Date.now();let e=this.queue.peekFront();for(;e!=null&&e.expire<t;)this.records.delete(e.msgId),this.queue.shift(),e=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class cI{constructor(t,e,r,s){h(this,"params");h(this,"metrics");h(this,"peerStats",new Map);h(this,"peerIPs",new nI(()=>new Set));h(this,"scoreCache",new Map);h(this,"deliveryRecords",new aI);h(this,"_backgroundInterval");h(this,"scoreCacheValidityMs");h(this,"computeScore");h(this,"log");this.params=t,this.metrics=e,JS(t),this.scoreCacheValidityMs=s.scoreCacheValidityMs,this.computeScore=s.computeScore??sI,this.log=r.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([t,e])=>[t,e]))}messageFirstSeenTimestampMs(t){const e=this.deliveryRecords.getRecord(t);return e!=null?e.firstSeenTsMs:null}refreshScores(){const t=Date.now(),e=this.params.decayToZero;this.peerStats.forEach((r,s)=>{if(!r.connected){t>r.expire&&(this.removeIPsForPeer(s,r.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(r.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<e&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<e&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<e&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<e&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=t-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),r.behaviourPenalty*=this.params.behaviourPenaltyDecay,r.behaviourPenalty<e&&(r.behaviourPenalty=0)})}score(t){var a,c,l;(a=this.metrics)==null||a.scoreFnCalls.inc();const e=this.peerStats.get(t);if(e==null)return 0;const r=Date.now(),s=this.scoreCache.get(t);if(s!=null&&s.cacheUntil>r)return s.score;(c=this.metrics)==null||c.scoreFnRuns.inc();const i=this.computeScore(t,e,this.params,this.peerIPs),o=r+this.scoreCacheValidityMs;return s!=null?((l=this.metrics)==null||l.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(t,{score:i,cacheUntil:o}),i}addPenalty(t,e,r){var i;const s=this.peerStats.get(t);s!=null&&(s.behaviourPenalty+=e,(i=this.metrics)==null||i.onScorePenalty(r))}addPeer(t){const e={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(t,e)}addIP(t,e){const r=this.peerStats.get(t);r!=null&&r.knownIPs.add(e),this.peerIPs.getOrDefault(e).add(t)}removeIP(t,e){const r=this.peerStats.get(t);r!=null&&r.knownIPs.delete(e);const s=this.peerIPs.get(e);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(e))}removePeer(t){const e=this.peerStats.get(t);if(e!=null){if(this.score(t)>0){this.removeIPsForPeer(t,e.knownIPs),this.peerStats.delete(t);return}Object.entries(e.topics).forEach(([r,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[r].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),e.connected=!1,e.expire=Date.now()+this.params.retainScore}}graft(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){const i=this.params.topics[e].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(t){this.deliveryRecords.ensureRecord(t)}deliverMessage(t,e,r){this.markFirstMessageDelivery(t,r);const s=this.deliveryRecords.ensureRecord(e),i=Date.now();if(s.status!==Rt.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",t,i-s.firstSeenTsMs,Rt[s.status]);return}s.status=Rt.valid,s.validated=i,s.peers.forEach(o=>{o!==t.toString()&&this.markDuplicateMessageDelivery(o,r)})}rejectInvalidMessage(t,e){this.markInvalidMessageDelivery(t,e)}rejectMessage(t,e,r,s){switch(s){case dr.Error:this.markInvalidMessageDelivery(t,r);return;case dr.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(e);if(i.status!==Rt.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",t,Date.now()-i.firstSeenTsMs,Rt[i.status]);return}if(s===dr.Ignore){i.status=Rt.ignored,i.peers.clear();return}i.status=Rt.invalid,this.markInvalidMessageDelivery(t,r),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,r)}),i.peers.clear()}duplicateMessage(t,e,r){const s=this.deliveryRecords.ensureRecord(e);if(!s.peers.has(t))switch(s.status){case Rt.unknown:s.peers.add(t);break;case Rt.valid:s.peers.add(t),this.markDuplicateMessageDelivery(t,r,s.validated);break;case Rt.invalid:this.markInvalidMessageDelivery(t,r);break;case Rt.ignored:break}}markInvalidMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);s!=null&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(t,e){const r=this.peerStats.get(t);if(r!=null){const s=this.getPtopicStats(r,e);if(s!=null){let i=this.params.topics[e].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[e].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(t,e,r){var i;const s=this.peerStats.get(t);if(s!=null){const o=r!==void 0?Date.now():0,a=this.getPtopicStats(s,e);if(a!=null&&a.inMesh){const c=this.params.topics[e];if(r!==void 0){const u=o-r,d=u>c.meshMessageDeliveriesWindow;if((i=this.metrics)==null||i.onDuplicateMsgDelivery(e,u,d),d)return}const l=c.meshMessageDeliveriesCap;a.meshMessageDeliveries=Math.min(l,a.meshMessageDeliveries+1)}}}removeIPsForPeer(t,e){for(const r of e){const s=this.peerIPs.get(r);s!=null&&(s.delete(t),s.size===0&&this.peerIPs.delete(r))}}getPtopicStats(t,e){let r=t.topics[e];return r!==void 0?r:this.params.topics[e]!==void 0?(r={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},t.topics[e]=r,r):null}}function lI(n,t,e,r,s){let i=0;const o=new Map;if(Object.entries(t.topics).forEach(([f,p])=>{const y=s.get(f)??"unknown",g=e.topics[f];if(g===void 0)return;let m=o.get(y);m==null&&(m={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(y,m));let w=0,_=0,b=0,S=0,I=0;if(p.inMesh){const R=Math.max(p.meshTime/g.timeInMeshQuantum,g.timeInMeshCap);w+=R*g.timeInMeshWeight}let A=p.firstMessageDeliveries;if(A>g.firstMessageDeliveriesCap&&(A=g.firstMessageDeliveriesCap),_+=A*g.firstMessageDeliveriesWeight,p.meshMessageDeliveriesActive&&p.meshMessageDeliveries<g.meshMessageDeliveriesThreshold){const R=g.meshMessageDeliveriesThreshold-p.meshMessageDeliveries,C=R*R;b+=C*g.meshMessageDeliveriesWeight}const P=p.meshFailurePenalty;S+=P*g.meshFailurePenaltyWeight;const T=p.invalidMessageDeliveries*p.invalidMessageDeliveries;I+=T*g.invalidMessageDeliveriesWeight,i+=(w+_+b+S+I)*g.topicWeight,m.p1w+=w,m.p2w+=_,m.p3w+=b,m.p3bw+=S,m.p4w+=I}),e.topicScoreCap>0&&i>e.topicScoreCap){i=e.topicScoreCap;const f=e.topicScoreCap/i;for(const p of o.values())p.p1w*=f,p.p2w*=f,p.p3w*=f,p.p3bw*=f,p.p4w*=f}let a=0,c=0,l=0;const u=e.appSpecificScore(n);a+=u*e.appSpecificWeight,t.knownIPs.forEach(f=>{if(e.IPColocationFactorWhitelist.has(f))return;const p=r.get(f),y=p!=null?p.size:0;if(y>e.IPColocationFactorThreshold){const g=y-e.IPColocationFactorThreshold,m=g*g;c+=m*e.IPColocationFactorWeight}});const d=t.behaviourPenalty*t.behaviourPenalty;return l+=d*e.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function uI(n,t,e,r,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of n){const a=t.get(o);if(a!=null){const c=lI(o,a,e,r,s);for(const[l,u]of c.byTopic){let d=i.byTopic.get(l);d==null&&(d={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(l,d)),d.p1w.push(u.p1w),d.p2w.push(u.p2w),d.p3w.push(u.p3w),d.p3bw.push(u.p3bw),d.p4w.push(u.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}class hI{constructor(t,e,r){h(this,"rawStream");h(this,"pushable");h(this,"closeController");h(this,"maxBufferSize");this.rawStream=t,this.pushable=jr(),this.closeController=new AbortController,this.maxBufferSize=r.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(s=>{t.abort(s)})}),Zt(this.pushable,this.rawStream).catch(e)}get protocol(){return this.rawStream.protocol}push(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(en.single(t))}pushPrefixed(t){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(t)}async close(){this.closeController.abort(),await this.pushable.return()}}class dI{constructor(t,e={}){h(this,"source");h(this,"rawStream");h(this,"closeController");this.rawStream=t,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{t.close().catch(r=>{t.abort(r)})}),this.source=Zt(this.rawStream,r=>kn(r,e))}async close(){this.closeController.abort()}}class fI{constructor(t,e,r){h(this,"gossipsubIWantFollowupMs");h(this,"msgIdToStrFn");h(this,"metrics");h(this,"promises",new Map);h(this,"requestMsByMsg",new Map);h(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=t,this.msgIdToStrFn=e,this.metrics=r,this.requestMsByMsgExpire=10*t}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(t,e){const r=Math.floor(Math.random()*e.length),s=e[r],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o==null&&(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(t)||(o.set(t,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){var s;const t=Date.now(),e=new Map;let r=0;return this.promises.forEach((i,o)=>{i.forEach((a,c)=>{a<t&&(e.set(c,(e.get(c)??0)+1),i.delete(c),r++)}),i.size===0&&this.promises.delete(o)}),(s=this.metrics)==null||s.iwantPromiseBroken.inc(r),e}deliverMessage(t,e=!1){this.trackMessage(t);const r=this.promises.get(t);r!=null&&(this.promises.delete(t),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),e&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(r.size)))}rejectMessage(t,e){switch(this.trackMessage(t),e){case dr.Error:return}this.promises.delete(t)}clear(){this.promises.clear()}prune(){var r;const t=Date.now()-this.requestMsByMsgExpire;let e=0;for(const[s,i]of this.requestMsByMsg.entries())if(i<t)this.requestMsByMsg.delete(s),e++;else break;(r=this.metrics)==null||r.iwantMessagePruned.inc(e)}trackMessage(t){if(this.metrics!=null){const e=this.requestMsByMsg.get(t);e!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-e)/1e3),this.requestMsByMsg.delete(t))}}}const M6=Y("libp2p-pubsub:");async function gI(n,t,e,r){switch(n.type){case ci.Signing:{const s={from:n.author.toBytes(),data:r,seqno:as(8),topic:t,signature:void 0,key:void 0},i=at([M6,es.Message.encode(s)]);s.signature=await n.privateKey.sign(i),s.key=n.key;const o={type:"signed",from:n.author,data:e,sequenceNumber:BigInt(`0x${X(s.seqno,"base16")}`),topic:t,signature:s.signature,key:s.key};return{raw:s,msg:o}}case ci.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:e,topic:t}};default:throw new Error("Unreachable")}}async function pI(n,t){switch(n){case x1:return t.signature!=null?{valid:!1,error:It.SignaturePresent}:t.seqno!=null?{valid:!1,error:It.SeqnoPresent}:t.key!=null?{valid:!1,error:It.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case Sa:{if(t.seqno==null)return{valid:!1,error:It.InvalidSeqno};if(t.seqno.length!==8)return{valid:!1,error:It.InvalidSeqno};if(t.signature==null)return{valid:!1,error:It.InvalidSignature};if(t.from==null)return{valid:!1,error:It.InvalidPeerId};let e;try{e=tr(t.from)}catch{return{valid:!1,error:It.InvalidPeerId}}let r;if(t.key!=null){if(r=ls(t.key),e.publicKey!==void 0&&!ke(r.bytes,e.publicKey))return{valid:!1,error:It.InvalidPeerId}}else{if(e.publicKey==null)return{valid:!1,error:It.InvalidPeerId};r=ls(e.publicKey)}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},i=at([M6,es.Message.encode(s)]);return await r.verify(i,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${X(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:t.key??cu(r)}}:{valid:!1,error:It.InvalidSignature}}default:throw new Error("Unreachable")}}function Br(n=[],t){return{subscriptions:[],messages:n,control:t!==void 0?{graft:t.graft??[],prune:t.prune??[],ihave:t.ihave??[],iwant:t.iwant??[]}:void 0}}function t0(n){return n.control===void 0&&(n.control={graft:[],prune:[],ihave:[],iwant:[]}),n}function Ur(n){if(n.length<=1)return n;const t=()=>Math.floor(Math.random()*Math.floor(n.length));for(let e=0;e<n.length;e++){const r=t(),s=n[e];n[e]=n[r],n[r]=s}return n}function mI(n){return X(n,"base64")}async function yI(n,t){switch(n){case Sa:{if(t==null)throw Error("Must provide PeerId");if(t.privateKey==null)throw Error("Cannot sign message, no private key present");if(t.publicKey==null)throw Error("Cannot sign message, no public key present");const e=await Ji(t.privateKey);return{type:ci.Signing,author:t,key:t.publicKey,privateKey:e}}case x1:return{type:ci.Anonymous};default:throw new Error(`Unknown signature policy "${n}"`)}}const wI=(n,t)=>{const e=Y(t.toString(16).padStart(16,"0"),"base16"),r=new Uint8Array(n.length+e.length);return r.set(n,0),r.set(e,n.length),r};function bI(n){if(n.type!=="signed")throw new Error("expected signed message type");if(n.sequenceNumber==null)throw Error("missing seqno field");return wI(n.from.toBytes(),n.sequenceNumber)}async function EI(n){return mt.encode(n.data)}var Ya;(function(n){n[n.ip4=4]="ip4",n[n.ip6=41]="ip6"})(Ya||(Ya={}));function vI(n){for(const t of n.tuples())switch(t[0]){case Ya.ip4:case Ya.ip6:return N1(t[0],t[1])}return null}class ll{constructor(t){h(this,"entries",new Map);h(this,"validityMs");this.validityMs=t.validityMs}get size(){return this.entries.size}put(t,e){return this.entries.has(t)?!0:(this.entries.set(t,{value:e,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const t=Date.now();for(const[e,r]of this.entries.entries())if(r.validUntilMs<t)this.entries.delete(e);else break}has(t){return this.entries.has(t)}get(t){const e=this.entries.get(t);return e!=null&&e.validUntilMs>=Date.now()?e.value:void 0}clear(){this.entries.clear()}}var Ot;(function(n){n[n.started=0]="started",n[n.stopped=1]="stopped"})(Ot||(Ot={}));var Q0,X0,Z0,J0;class O6 extends(J0=Et,Z0=Symbol.toStringTag,X0=jt,Q0=rs,J0){constructor(e,r={}){super();h(this,"globalSignaturePolicy");h(this,"multicodecs",[Xd,Qd]);h(this,"publishConfig");h(this,"dataTransform");h(this,"peers",new Set);h(this,"streamsInbound",new Map);h(this,"streamsOutbound",new Map);h(this,"outboundInflightQueue",jr({objectMode:!0}));h(this,"direct",new Set);h(this,"floodsubPeers",new Set);h(this,"seenCache");h(this,"acceptFromWhitelist",new Map);h(this,"topics",new Map);h(this,"subscriptions",new Set);h(this,"mesh",new Map);h(this,"fanout",new Map);h(this,"fanoutLastpub",new Map);h(this,"gossip",new Map);h(this,"control",new Map);h(this,"peerhave",new Map);h(this,"iasked",new Map);h(this,"backoff",new Map);h(this,"outbound",new Map);h(this,"msgIdFn");h(this,"fastMsgIdFn");h(this,"msgIdToStrFn");h(this,"fastMsgIdCache");h(this,"publishedMessageIds");h(this,"mcache");h(this,"score");h(this,"topicValidators",new Map);h(this,"log");h(this,"heartbeatTicks",0);h(this,"gossipTracer");h(this,"components");h(this,"directPeerInitial",null);h(this,"opts");h(this,"decodeRpcLimits");h(this,"metrics");h(this,"status",{code:Ot.stopped});h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"runOnTransientConnection");h(this,"allowedTopics");h(this,"heartbeatTimer",null);h(this,Z0,"@chainsafe/libp2p-gossipsub");h(this,X0,["@libp2p/pubsub"]);h(this,Q0,["@libp2p/identify"]);h(this,"runHeartbeat",()=>{var r;const e=(r=this.metrics)==null?void 0:r.heartbeatDuration.startTimer();this.heartbeat().catch(s=>{this.log("Error running heartbeat",s)}).finally(()=>{var s;if(e!=null&&e(),this.status.code===Ot.started){clearTimeout(this.status.heartbeatTimeout);let i=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;i<this.opts.heartbeatInterval*.25&&(i+=this.opts.heartbeatInterval,(s=this.metrics)==null||s.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,i)}})});h(this,"tagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(ye(r),{tags:{[s]:{value:100}}}).catch(i=>{this.log.error("Error tagging peer %s with topic %s",r,s,i)})});h(this,"untagMeshPeer",e=>{const{peerId:r,topic:s}=e.detail;this.components.peerStore.merge(ye(r),{tags:{[s]:void 0}}).catch(i=>{this.log.error("Error untagging peer %s with topic %s",r,s,i)})});const s={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:fS,Dlo:gS,Dhi:pS,Dscore:mS,Dout:yS,Dlazy:ES,heartbeatInterval:SS,fanoutTTL:IS,mcacheLength:wS,mcacheGossip:bS,seenTTL:LS,gossipsubIWantFollowupMs:OS,prunePeers:RS,pruneBackoff:AS,unsubcribeBackoff:TS,graftFloodThreshold:NS,opportunisticGraftPeers:kS,opportunisticGraftTicks:PS,directConnectTicks:xS,...r,scoreParams:XS(r.scoreParams),scoreThresholds:tI(r.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=s.decodeRpcLimits??WS,this.globalSignaturePolicy=s.globalSignaturePolicy??Sa,s.fallbackToFloodsub&&this.multicodecs.push(Yd),this.log=e.logger.forComponent(s.debugName??"libp2p:gossipsub"),this.opts=s,this.direct=new Set(s.directPeers.map(i=>i.id.toString())),this.seenCache=new ll({validityMs:s.seenTTL}),this.publishedMessageIds=new ll({validityMs:s.seenTTL}),r.msgIdFn!=null)this.msgIdFn=r.msgIdFn;else switch(this.globalSignaturePolicy){case Sa:this.msgIdFn=bI;break;case x1:this.msgIdFn=EI;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(r.fastMsgIdFn!=null&&(this.fastMsgIdFn=r.fastMsgIdFn,this.fastMsgIdCache=new ll({validityMs:s.seenTTL})),this.msgIdToStrFn=r.msgIdToStrFn??mI,this.mcache=r.messageCache??new qS(s.mcacheGossip,s.mcacheLength,this.msgIdToStrFn),r.dataTransform!=null&&(this.dataTransform=r.dataTransform),r.metricsRegister!=null){if(r.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const i=Math.max(...Object.values(s.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),HS),o=GS(r.metricsRegister,r.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:s.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:i/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(const a of this.multicodecs)o.protocolsEnabled.set({protocol:a},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new fI(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new cI(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:s.heartbeatInterval}),this.maxInboundStreams=r.maxInboundStreams,this.maxOutboundStreams=r.maxOutboundStreams,this.runOnTransientConnection=r.runOnTransientConnection,this.allowedTopics=s.allowedTopics!=null?new Set(s.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>ye(e))}isStarted(){return this.status.code===Ot.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await yI(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=jr({objectMode:!0}),Zt(this.outboundInflightQueue,async o=>{for await(const{peerId:a,connection:c}of o)await this.createOutboundStream(a,c)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>e.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection})));const r={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnTransient:this.runOnTransientConnection},s=await Promise.all(this.multicodecs.map(async o=>e.register(o,r))),i=setTimeout(this.runHeartbeat,Zd);this.status={code:Ot.started,registrarTopologyIds:s,heartbeatTimeout:i,hearbeatStartMs:Date.now()+Zd},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},CS),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Ot.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:Ot.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const r=this.components.registrar;await Promise.all(this.multicodecs.map(async i=>r.unhandle(i))),e.forEach(i=>{r.unregister(i)}),this.outboundInflightQueue.end();const s=[];for(const i of this.streamsOutbound.values())s.push(i.close());this.streamsOutbound.clear();for(const i of this.streamsInbound.values())s.push(i.close());this.streamsInbound.clear(),await Promise.all(s),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:r}){if(!this.isStarted())return;const s=r.remotePeer;this.addPeer(s,r.direction,r.remoteAddr),this.createInboundStream(s,e),this.outboundInflightQueue.push({peerId:s,connection:r})}onPeerConnected(e,r){var s;(s=this.metrics)==null||s.newConnectionCount.inc({status:r.status}),!(!this.isStarted()||r.status!=="open")&&(this.addPeer(e,r.direction,r.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:r}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,r){var i;if(!this.isStarted())return;const s=e.toString();if(this.peers.has(s)&&!this.streamsOutbound.has(s))try{const o=new hI(await r.newStream(this.multicodecs,{runOnTransientConnection:this.runOnTransientConnection}),c=>{this.log.error("outbound pipe error",c)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(s,o);const a=o.protocol;a===Yd&&this.floodsubPeers.add(s),(i=this.metrics)==null||i.peersPerProtocol.inc({protocol:a},1),this.subscriptions.size>0&&(this.log("send subscriptions to",s),this.sendSubscriptions(s,Array.from(this.subscriptions),!0))}catch(o){this.log.error("createOutboundStream error",o)}}createInboundStream(e,r){if(!this.isStarted())return;const s=e.toString();if(!this.peers.has(s))return;const i=this.streamsInbound.get(s);i!==void 0&&(this.log("replacing existing inbound steam %s",s),i.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",s);const o=new dI(r,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(s,o),this.pipePeerReadStream(e,o.source).catch(a=>{this.log(a)})}addPeer(e,r,s){const i=e.toString();if(!this.peers.has(i)){this.log("new peer %p",e),this.peers.add(i),this.score.addPeer(i);const o=vI(s);o!==null?this.score.addIP(i,o):this.log("Added peer has no IP in current address %s %s",i,s.toString()),this.outbound.has(i)||this.outbound.set(i,r==="outbound")}}removePeer(e){var o,a;const r=e.toString();if(!this.peers.has(r))return;this.log("delete peer %p",e),this.peers.delete(r);const s=this.streamsOutbound.get(r),i=this.streamsInbound.get(r);s!=null&&((o=this.metrics)==null||o.peersPerProtocol.inc({protocol:s.protocol},-1)),s==null||s.close().catch(c=>{this.log.error(c)}),i==null||i.close().catch(c=>{this.log.error(c)}),this.streamsOutbound.delete(r),this.streamsInbound.delete(r);for(const c of this.topics.values())c.delete(r);for(const[c,l]of this.mesh)l.delete(r)&&((a=this.metrics)==null||a.onRemoveFromMesh(c,Ar.Dc,1));for(const c of this.fanout.values())c.delete(r);this.floodsubPeers.delete(r),this.gossip.delete(r),this.control.delete(r),this.outbound.delete(r),this.score.removePeer(r),this.acceptFromWhitelist.delete(r)}get started(){return this.status.code===Ot.started}getMeshPeers(e){const r=this.mesh.get(e);return r!=null?Array.from(r):[]}getSubscribers(e){const r=this.topics.get(e);return(r!=null?Array.from(r):[]).map(s=>ye(s))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,r){var s;try{await Zt(r,async i=>{var o,a,c;for await(const l of i)try{const u=l.subarray(),d=es.decode(u,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos}}}});if((o=this.metrics)==null||o.onRpcRecv(d,u.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,d)}catch(f){(a=this.metrics)==null||a.onRpcRecvError(),this.log(f)}else this.handleReceivedRpc(e,d).catch(f=>{var p;(p=this.metrics)==null||p.onRpcRecvError(),this.log(f)})}catch(u){(c=this.metrics)==null||c.onRpcDataError(),this.log(u)}})}catch(i){(s=this.metrics)==null||s.onPeerReadStreamError(),this.handlePeerReadStreamError(i,e)}}handlePeerReadStreamError(e,r){this.log.error(e),this.onPeerDisconnected(r)}async handleReceivedRpc(e,r){var u;if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),(u=this.metrics)==null||u.rpcRecvNotAccepted.inc();return}const s=r.subscriptions!=null?r.subscriptions.length:0,i=r.messages!=null?r.messages.length:0;let o=0,a=0,c=0,l=0;if(r.control!=null&&(r.control.ihave!=null&&(o=r.control.ihave.length),r.control.iwant!=null&&(a=r.control.iwant.length),r.control.graft!=null&&(c=r.control.graft.length),r.control.prune!=null&&(l=r.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${s} messages ${i} ihave ${o} iwant ${a} graft ${c} prune ${l}`),r.subscriptions!=null&&r.subscriptions.length>0){const d=[];r.subscriptions.forEach(f=>{const p=f.topic,y=f.subscribe===!0;if(p!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(p))return;this.handleReceivedSubscription(e,p,y),d.push({topic:p,subscribe:y})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:d}})}for(const d of r.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(d.topic))continue;const f=this.handleReceivedMessage(e,d).catch(p=>{var y;(y=this.metrics)==null||y.onMsgRecvError(d.topic),this.log(p)});this.opts.awaitRpcMessageHandler&&await f}r.control!=null&&await this.handleControlMessage(e.toString(),r.control)}handleReceivedSubscription(e,r,s){this.log("subscription update from %p topic %s",e,r);let i=this.topics.get(r);i==null&&(i=new Set,this.topics.set(r,i)),s?i.add(e.toString()):i.delete(e.toString())}async handleReceivedMessage(e,r){var o,a,c;(o=this.metrics)==null||o.onMsgRecvPreValidation(r.topic);const s=await this.validateReceivedMessage(e,r);(a=this.metrics)==null||a.onPrevalidationResult(r.topic,s.code);const i=s.code;switch(i){case Tt.duplicate:this.score.duplicateMessage(e.toString(),s.msgIdStr,r.topic),this.gossipTracer.deliverMessage(s.msgIdStr,!0),this.mcache.observeDuplicate(s.msgIdStr,e.toString());return;case Tt.invalid:if(s.msgIdStr!=null){const l=s.msgIdStr;this.score.rejectMessage(e.toString(),l,r.topic,s.reason),this.gossipTracer.rejectMessage(l,s.reason)}else this.score.rejectInvalidMessage(e.toString(),r.topic);(c=this.metrics)==null||c.onMsgRecvInvalid(r.topic,s);return;case Tt.valid:this.score.validateMessage(s.messageId.msgIdStr),this.gossipTracer.deliverMessage(s.messageId.msgIdStr),this.mcache.put(s.messageId,r,!this.opts.asyncValidation),this.subscriptions.has(r.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new pt("gossipsub:message",{detail:{propagationSource:e,msgId:s.messageId.msgIdStr,msg:s.msg}})),super.dispatchEvent(new pt("message",{detail:s.msg}))),this.opts.asyncValidation||this.forwardMessage(s.messageId.msgIdStr,r,e.toString());break;default:throw new Error(`Invalid validation result: ${i}`)}}async validateReceivedMessage(e,r){var f,p,y;const s=(f=this.fastMsgIdFn)==null?void 0:f.call(this,r),i=s!==void 0?(p=this.fastMsgIdCache)==null?void 0:p.get(s):void 0;if(i!=null)return{code:Tt.duplicate,msgIdStr:i};const o=await pI(this.globalSignaturePolicy,r);if(!o.valid)return{code:Tt.invalid,reason:dr.Error,error:o.error};const a=o.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(r.topic,a.data))}catch(g){return this.log("Invalid message, transform failed",g),{code:Tt.invalid,reason:dr.Error,error:It.TransformFailed}}const c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u={msgId:c,msgIdStr:l};if(s!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(s,l)&&((y=this.metrics)==null||y.fastMsgIdCacheCollision.inc()),this.seenCache.has(l))return{code:Tt.duplicate,msgIdStr:l};this.seenCache.put(l);const d=this.topicValidators.get(r.topic);if(d!=null){let g;try{g=await d(e,a)}catch(m){const w=m.code;w===FS&&(g=Yt.Ignore),w===US?g=Yt.Reject:g=Yt.Ignore}if(g!==Yt.Accept)return{code:Tt.invalid,reason:jd(g),msgIdStr:l}}return{code:Tt.valid,messageId:u,msg:a}}getScore(e){return this.score.score(e)}sendSubscriptions(e,r,s){this.sendRpc(e,{subscriptions:r.map(i=>({topic:i,subscribe:s})),messages:[]})}async handleControlMessage(e,r){var l,u;if(r===void 0)return;const s=r.ihave!=null?this.handleIHave(e,r.ihave):[],i=r.iwant!=null?this.handleIWant(e,r.iwant):[],o=r.graft!=null?await this.handleGraft(e,r.graft):[];if(r.prune!=null&&await this.handlePrune(e,r.prune),s.length===0&&i.length===0&&o.length===0)return;const a=this.sendRpc(e,Br(i,{iwant:s,prune:o})),c=(l=s[0])==null?void 0:l.messageIDs;c!=null&&(a?this.gossipTracer.addPromise(e,c):(u=this.metrics)==null||u.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const r=Date.now(),s=this.acceptFromWhitelist.get(e);if(s!=null&&s.messagesAccepted<$S&&s.acceptUntil>=r)return s.messagesAccepted+=1,!0;const i=this.score.score(e);return i>=VS?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:r+KS}):this.acceptFromWhitelist.delete(e),i>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,r){var u,d,f;if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,s),(u=this.metrics)==null||u.ihaveRcvIgnored.inc({reason:Vi.LowScore}),[];const i=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,i),i>MS)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,i),(d=this.metrics)==null||d.ihaveRcvIgnored.inc({reason:Vi.MaxIhave}),[];const o=this.iasked.get(e)??0;if(o>=Ss)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,o),(f=this.metrics)==null||f.ihaveRcvIgnored.inc({reason:Vi.MaxIasked}),[];const a=new Map;if(r.forEach(({topicID:p,messageIDs:y})=>{var m;if(p==null||y==null||!this.mesh.has(p))return;let g=0;y.forEach(w=>{const _=this.msgIdToStrFn(w);this.seenCache.has(_)||(a.set(_,w),g++)}),(m=this.metrics)==null||m.onIhaveRcv(p,y.length,g)}),a.size===0)return[];let c=a.size;c+o>Ss&&(c=Ss-o),this.log("IHAVE: Asking for %d out of %d messages from %s",c,a.size,e);let l=Array.from(a.values());return Ur(l),l=l.slice(0,c),this.iasked.set(e,o+c),[{messageIDs:l}]}handleIWant(e,r){var c;if(r.length===0)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,s),[];const i=new Map,o=new Map;let a=0;return r.forEach(({messageIDs:l})=>{l==null||l.forEach(u=>{const d=this.msgIdToStrFn(u),f=this.mcache.getWithIWantCount(d,e);if(f==null){a++;return}if(o.set(f.msg.topic,1+(o.get(f.msg.topic)??0)),f.count>_S){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,u);return}i.set(d,f.msg)})}),(c=this.metrics)==null||c.onIwantRcv(o,a),i.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values()))}async handleGraft(e,r){const s=[],i=this.score.score(e),o=Date.now();let a=this.opts.doPX;if(r.forEach(({topicID:l})=>{var f,p;if(l==null)return;const u=this.mesh.get(l);if(u==null){a=!1;return}if(u.has(e))return;const d=(f=this.backoff.get(l))==null?void 0:f.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),s.push(l),a=!1;else if(typeof d=="number"&&o<d){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Fi.GraftBackoff),a=!1;const y=d+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<y&&this.score.addPenalty(e,1,Fi.GraftBackoff),this.addBackoff(e,l),s.push(l)}else i<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,i,l),s.push(l),a=!1,this.addBackoff(e,l)):u.size>=this.opts.Dhi&&!(this.outbound.get(e)??!1)?(s.push(l),this.addBackoff(e,l)):(this.log("GRAFT: Add mesh link from %s in %s",e,l),this.score.graft(e,l),u.add(e),(p=this.metrics)==null||p.onAddToMesh(l,xt.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:l,direction:"inbound"}})}),s.length===0)return[];const c=!1;return Promise.all(s.map(async l=>this.makePrune(e,l,a,c)))}async handlePrune(e,r){var i;const s=this.score.score(e);for(const{topicID:o,backoff:a,peers:c}of r){if(o==null)continue;const l=this.mesh.get(o);if(l==null)return;this.log("PRUNE: Remove mesh link to %s in %s",e,o),this.score.prune(e,o),l.has(e)&&(l.delete(e),(i=this.metrics)==null||i.onRemoveFromMesh(o,Ar.Prune,1)),typeof a=="number"&&a>0?this.doAddBackoff(e,o,a*1e3):this.addBackoff(e,o),c!=null&&c.length>0&&(s<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,s,o):await this.pxConnect(c)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:o,direction:"inbound"}})}}addBackoff(e,r){this.doAddBackoff(e,r,this.opts.pruneBackoff)}doAddBackoff(e,r,s){let i=this.backoff.get(r);i==null&&(i=new Map,this.backoff.set(r,i));const o=Date.now()+s;(i.get(e)??0)<o&&i.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,r)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",r,e),this.score.addPenalty(r,e,Fi.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%DS!==0)return;const e=Date.now();this.backoff.forEach((r,s)=>{r.forEach((i,o)=>{i+zS*this.opts.heartbeatInterval<e&&r.delete(o)}),r.size===0&&this.backoff.delete(s)})}async directConnect(){const e=[];this.direct.forEach(r=>{this.streamsOutbound.has(r)||e.push(r)}),await Promise.all(e.map(async r=>this.connect(r)))}async pxConnect(e){e.length>this.opts.prunePeers&&(Ur(e),e=e.slice(0,this.opts.prunePeers));const r=[];await Promise.all(e.map(async s=>{if(s.peerID==null)return;const i=tr(s.peerID),o=i.toString();if(!this.peers.has(o)){if(s.signedPeerRecord==null){r.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(s.signedPeerRecord,i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}r.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),r.length!==0&&await Promise.all(r.map(async s=>this.connect(s)))}async connect(e){var i;this.log("Initiating connection with %s",e);const r=ye(e),s=await this.components.connectionManager.openConnection(r);for(const o of this.multicodecs)for(const a of this.components.registrar.getTopologies(o))(i=a.onConnect)==null||i.call(a,r,s)}subscribe(e){if(this.status.code!==Ot.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const r of this.peers.keys())this.sendSubscriptions(r,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==Ot.started)throw new Error("Pubsub is not started");const r=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,r),r)for(const s of this.peers.keys())this.sendSubscriptions(s,[e],!1);this.leave(e)}join(e){var o,a,c;if(this.status.code!==Ot.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),(o=this.metrics)==null||o.onJoin(e);const r=new Set,s=this.backoff.get(e),i=this.fanout.get(e);if(i!=null&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach(l=>{!this.direct.has(l)&&this.score.score(l)>=0&&(s==null||!s.has(l))&&r.add(l)}),(a=this.metrics)==null||a.onAddToMesh(e,xt.Fanout,r.size)),r.size<this.opts.D){const l=r.size;this.getRandomGossipPeers(e,this.opts.D,d=>!r.has(d)&&!this.direct.has(d)&&this.score.score(d)>=0&&(s==null||!s.has(d))).forEach(d=>{r.add(d)}),(c=this.metrics)==null||c.onAddToMesh(e,xt.Random,r.size-l)}this.mesh.set(e,r),r.forEach(l=>{this.log("JOIN: Add mesh link to %s in %s",l,e),this.sendGraft(l,e)})}leave(e){var s;if(this.status.code!==Ot.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),(s=this.metrics)==null||s.onLeave(e);const r=this.mesh.get(e);r!=null&&(Promise.all(Array.from(r).map(async i=>{this.log("LEAVE: Remove mesh link to %s in %s",i,e),await this.sendPrune(i,e)})).catch(i=>{this.log("Error sending prunes to mesh peers",i)}),this.mesh.delete(e))}selectPeersToForward(e,r,s){const i=new Set,o=this.topics.get(e);o!=null&&(this.direct.forEach(c=>{o.has(c)&&r!==c&&!((s==null?void 0:s.has(c))??!1)&&i.add(c)}),this.floodsubPeers.forEach(c=>{o.has(c)&&r!==c&&!((s==null?void 0:s.has(c))??!1)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold&&i.add(c)}));const a=this.mesh.get(e);return a!=null&&a.size>0&&a.forEach(c=>{r!==c&&!((s==null?void 0:s.has(c))??!1)&&i.add(c)}),i}selectPeersToPublish(e){const r=new Set,s={direct:0,floodsub:0,mesh:0,fanout:0},i=this.topics.get(e);if(i!=null)if(this.opts.floodPublish)i.forEach(o=>{this.direct.has(o)?(r.add(o),s.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(r.add(o),s.floodsub++)});else{this.direct.forEach(a=>{i.has(a)&&(r.add(a),s.direct++)}),this.floodsubPeers.forEach(a=>{i.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(r.add(a),s.floodsub++)});const o=this.mesh.get(e);if(o!=null&&o.size>0)o.forEach(a=>{r.add(a),s.mesh++}),o.size<this.opts.D&&this.getRandomGossipPeers(e,this.opts.D-o.size,c=>!o.has(c)&&!this.direct.has(c)&&!this.floodsubPeers.has(c)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold).forEach(c=>{r.add(c),s.mesh++});else{const a=this.fanout.get(e);if(a!=null&&a.size>0)a.forEach(c=>{r.add(c),s.fanout++});else{const c=this.getRandomGossipPeers(e,this.opts.D,l=>this.score.score(l)>=this.opts.scoreThresholds.publishThreshold);c.size>0&&(this.fanout.set(e,c),c.forEach(l=>{r.add(l),s.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:r,tosendCount:s}}forwardMessage(e,r,s,i){var a;s!=null&&this.score.deliverMessage(s,e,r.topic);const o=this.selectPeersToForward(r.topic,s,i);o.forEach(c=>{this.sendRpc(c,Br([r]))}),(a=this.metrics)==null||a.onForwardMsg(r.topic,o.size)}async publish(e,r,s){var b,S;const i=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(e,r):r;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:a,msg:c}=await gI(this.publishConfig,e,r,o),l=await this.msgIdFn(c),u=this.msgIdToStrFn(l),d=(s==null?void 0:s.ignoreDuplicatePublishError)??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(u)){if(d)return(b=this.metrics)==null||b.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:f,tosendCount:p}=this.selectPeersToPublish(e),y=this.opts.emitSelf&&this.subscriptions.has(e),g=(s==null?void 0:s.allowPublishToZeroTopicPeers)??this.opts.allowPublishToZeroTopicPeers;if(f.size===0&&!g&&!y)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(u),this.mcache.put({msgId:l,msgIdStr:u},a,!0),this.publishedMessageIds.put(u);const m=(s==null?void 0:s.batchPublish)??this.opts.batchPublish,w=Br([a]);if(m)this.sendRpcInBatch(f,w);else for(const I of f)this.sendRpc(I,w)||f.delete(I);const _=Date.now()-i;return(S=this.metrics)==null||S.onPublishMsg(e,p,f.size,a.data!=null?a.data.length:0,_),y&&(f.add(this.components.peerId.toString()),super.dispatchEvent(new pt("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:u,msg:c}})),super.dispatchEvent(new pt("message",{detail:c}))),{recipients:Array.from(f.values()).map(I=>ye(I))}}sendRpcInBatch(e,r){var o;const s=es.encode(r),i=en.single(s);for(const a of e){const c=this.streamsOutbound.get(a);if(c==null){this.log(`Cannot send RPC to ${a} as there is no open stream to it available`),e.delete(a);continue}try{c.pushPrefixed(i)}catch(l){e.delete(a),this.log.error(`Cannot send rpc to ${a}`,l)}(o=this.metrics)==null||o.onRpcSent(r,s.length)}}reportMessageValidationResult(e,r,s){var a;let i;if(s===Yt.Accept){if(i=this.mcache.validate(e),i!=null){const{message:c,originatingPeers:l}=i;this.score.deliverMessage(r,e,c.topic),this.forwardMessage(e,i.message,r,l)}}else if(i=this.mcache.remove(e),i!=null){const c=jd(s),{message:l,originatingPeers:u}=i;this.score.rejectMessage(r,e,l.topic,c);for(const d of u)this.score.rejectMessage(d,e,l.topic,c)}const o=this.score.messageFirstSeenTimestampMs(e);(a=this.metrics)==null||a.onReportValidation(i,s,o)}sendGraft(e,r){const i=Br([],{graft:[{topicID:r}]});this.sendRpc(e,i)}async sendPrune(e,r){const i=[await this.makePrune(e,r,this.opts.doPX,!0)],o=Br([],{prune:i});this.sendRpc(e,o)}sendRpc(e,r){var c,l,u,d,f;const s=this.streamsOutbound.get(e);if(s==null)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const i=this.control.get(e);i!=null&&(this.piggybackControl(e,r,i),this.control.delete(e));const o=this.gossip.get(e);o!=null&&(this.piggybackGossip(e,r,o),this.gossip.delete(e));const a=es.encode(r);try{s.push(a)}catch(p){return this.log.error(`Cannot send rpc to ${e}`,p),i!=null&&this.control.set(e,i),o!=null&&this.gossip.set(e,o),!1}if((c=this.metrics)==null||c.onRpcSent(r,a.length),((l=r.control)==null?void 0:l.graft)!=null)for(const p of(u=r.control)==null?void 0:u.graft)p.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:p.topicID,direction:"outbound"}});if(((d=r.control)==null?void 0:d.prune)!=null)for(const p of(f=r.control)==null?void 0:f.prune)p.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:p.topicID,direction:"outbound"}});return!0}piggybackControl(e,r,s){var o,a;const i=t0(r);for(const c of s.graft)c.topicID!=null&&(((o=this.mesh.get(c.topicID))==null?void 0:o.has(e))??!1)&&i.control.graft.push(c);for(const c of s.prune)c.topicID!=null&&!(((a=this.mesh.get(c.topicID))==null?void 0:a.has(e))??!1)&&i.control.prune.push(c)}piggybackGossip(e,r,s){const i=t0(r);i.control.ihave=s}async sendGraftPrune(e,r,s){const i=this.opts.doPX,o=!1;for(const[a,c]of e){const l=c.map(f=>({topicID:f}));let u=[];const d=r.get(a);d!=null&&(u=await Promise.all(d.map(async f=>this.makePrune(a,f,i&&!(s.get(a)??!1),o))),r.delete(a)),this.sendRpc(a,Br([],{graft:l,prune:u}))}for(const[a,c]of r){const l=await Promise.all(c.map(async u=>this.makePrune(a,u,i&&!(s.get(a)??!1),o)));this.sendRpc(a,Br([],{prune:l}))}}emitGossip(e){const r=this.mcache.getGossipIDs(new Set(e.keys()));for(const[s,i]of e)this.doEmitGossip(s,i,r.get(s)??[])}doEmitGossip(e,r,s){if(s.length===0||(Ur(s),s.length>Ss&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",s.length),r.size===0))return;let i=this.opts.Dlazy;const o=vS*r.size;let a=r;o>i&&(i=o),i>a.size?i=a.size:a=Ur(Array.from(a)).slice(0,i),a.forEach(c=>{let l=s;s.length>Ss&&(l=Ur(l.slice()).slice(0,Ss)),this.pushGossip(c,{topicID:e,messageIDs:l})})}flush(){for(const[e,r]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,Br([],{ihave:r}));for(const[e,r]of this.control.entries()){this.control.delete(e);const s=Br([],{graft:r.graft,prune:r.prune});this.sendRpc(e,s)}}pushGossip(e,r){this.log("Add gossip to %s",e);const s=this.gossip.get(e)??[];this.gossip.set(e,s.concat(r))}async makePrune(e,r,s,i){var u;if(this.score.prune(e,r),((u=this.streamsOutbound.get(e))==null?void 0:u.protocol)===Qd)return{topicID:r,peers:[]};const o=i?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=o/1e3;if(this.doAddBackoff(e,r,o),!s)return{topicID:r,peers:[],backoff:a};const c=this.getRandomGossipPeers(r,this.opts.prunePeers,d=>d!==e&&this.score.score(d)>=0),l=await Promise.all(Array.from(c).map(async d=>{const f=ye(d);let p;try{p=await this.components.peerStore.get(f)}catch(y){if(y.code!=="ERR_NOT_FOUND")throw y}return{peerID:f.toBytes(),signedPeerRecord:p==null?void 0:p.peerRecordEnvelope}}));return{topicID:r,peers:l,backoff:a}}async heartbeat(){var g,m;const{D:e,Dlo:r,Dhi:s,Dscore:i,Dout:o,fanoutTTL:a}=this.opts;this.heartbeatTicks++;const c=new Map,l=w=>{let _=c.get(w);return _===void 0&&(_=this.score.score(w),c.set(w,_)),_},u=new Map,d=new Map,f=new Map;this.clearBackoff(),this.peerhave.clear(),(g=this.metrics)==null||g.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),(m=this.fastMsgIdCache)==null||m.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const p=new Map;this.mesh.forEach((w,_)=>{const b=this.topics.get(_),S=new Set,I=new Set;if(p.set(_,I),b!=null){const T=Ur(Array.from(b)),R=this.backoff.get(_);for(const C of T){const k=this.streamsOutbound.get(C);if(k!=null&&this.multicodecs.includes(k.protocol)&&!w.has(C)&&!this.direct.has(C)){const B=l(C);(R==null||!R.has(C))&&B>=0&&S.add(C),B>=this.opts.scoreThresholds.gossipThreshold&&I.add(C)}}}const A=(T,R)=>{var k;this.log("HEARTBEAT: Remove mesh link to %s in %s",T,_),this.addBackoff(T,_),w.delete(T),l(T)>=this.opts.scoreThresholds.gossipThreshold&&I.add(T),(k=this.metrics)==null||k.onRemoveFromMesh(_,R,1);const C=d.get(T);C==null?d.set(T,[_]):C.push(_)},P=(T,R)=>{var k;this.log("HEARTBEAT: Add mesh link to %s in %s",T,_),this.score.graft(T,_),w.add(T),I.delete(T),(k=this.metrics)==null||k.onAddToMesh(_,R,1);const C=u.get(T);C==null?u.set(T,[_]):C.push(_)};if(w.forEach(T=>{const R=l(T);R<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",T,R,_),A(T,Ar.BadScore),f.set(T,!0))}),w.size<r){const T=e-w.size;rI(S,T).forEach(C=>{P(C,xt.NotEnough)})}if(w.size>s){let T=Array.from(w);T.sort((C,k)=>l(k)-l(C)),T=T.slice(0,i).concat(Ur(T.slice(i)));let R=0;if(T.slice(0,e).forEach(C=>{(this.outbound.get(C)??!1)&&R++}),R<o){const C=B=>{const L=T[B];for(let z=B;z>0;z--)T[z]=T[z-1];T[0]=L};if(R>0){let B=R;for(let L=1;L<e&&B>0;L++)(this.outbound.get(T[L])??!1)&&(C(L),B--)}let k=e-R;for(let B=e;B<T.length&&k>0;B++)(this.outbound.get(T[B])??!1)&&(C(B),k--)}T.slice(e).forEach(C=>{A(C,Ar.Excess)})}if(w.size>=r){let T=0;if(w.forEach(R=>{(this.outbound.get(R)??!1)&&T++}),T<o){const R=o-T;u1(S,R,k=>this.outbound.get(k)===!0).forEach(k=>{P(k,xt.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&w.size>1){const T=Array.from(w).sort((k,B)=>l(k)-l(B)),R=Math.floor(w.size/2),C=l(T[R]);if(C<this.opts.scoreThresholds.opportunisticGraftThreshold){const k=this.opts.opportunisticGraftPeers,B=u1(S,k,L=>l(L)>C);for(const L of B)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",L,_),P(L,xt.Opportunistic)}}});const y=Date.now();this.fanoutLastpub.forEach((w,_)=>{w+a<y&&(this.fanout.delete(_),this.fanoutLastpub.delete(_))}),this.fanout.forEach((w,_)=>{const b=this.topics.get(_);w.forEach(P=>{(!((b==null?void 0:b.has(P))??!1)||l(P)<this.opts.scoreThresholds.publishThreshold)&&w.delete(P)});const S=this.topics.get(_),I=[],A=new Set;if(p.set(_,A),S!=null){const P=Ur(Array.from(S));for(const T of P){const R=this.streamsOutbound.get(T);if(R!=null&&this.multicodecs.includes(R.protocol)&&!w.has(T)&&!this.direct.has(T)){const C=l(T);C>=this.opts.scoreThresholds.publishThreshold&&I.push(T),C>=this.opts.scoreThresholds.gossipThreshold&&A.add(T)}}}if(w.size<e){const P=e-w.size;I.slice(0,P).forEach(T=>{w.add(T),A==null||A.delete(T)})}}),this.emitGossip(p),await this.sendGraftPrune(u,d,f),this.flush(),this.mcache.shift(),this.dispatchEvent(new pt("gossipsub:heartbeat"))}getRandomGossipPeers(e,r,s=()=>!0){const i=this.topics.get(e);if(i==null)return new Set;let o=[];return i.forEach(a=>{const c=this.streamsOutbound.get(a);c!=null&&this.multicodecs.includes(c.protocol)&&s(a)&&o.push(a)}),o=Ur(o),r>0&&o.length>r&&(o=o.slice(0,r)),new Set(o)}onScrapeMetrics(e){var c,l;e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},((c=this.fastMsgIdCache)==null?void 0:c.size)??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let r=0;const s=Date.now();e.connectedPeersBackoffSec.reset();for(const u of this.backoff.values()){r+=u.size;for(const[d,f]of u.entries())this.peers.has(d)&&e.connectedPeersBackoffSec.observe(Math.max(0,f-s)/1e3)}e.cacheSize.set({cache:"backoff"},r);for(const[u,d]of this.topics)e.topicPeersCount.set({topicStr:u},d.size);for(const[u,d]of this.mesh)e.meshPeerCounts.set({topicStr:u},d.size);const i=[],o=new Map;e.behaviourPenalty.reset();for(const u of this.peers.keys()){const d=this.score.score(u);i.push(d),o.set(u,d),e.behaviourPenalty.observe(((l=this.score.peerStats.get(u))==null?void 0:l.behaviourPenalty)??0)}e.registerScores(i,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,o);const a=uI(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(a)}}h(O6,"multicodec",Xd);function _I(n={}){return t=>new O6(t,n)}const SI="0.1.0",II="id",RI="id/push",AI="1.0.0",TI="1.0.0",DI=1024*8,xI=32;var li;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.protocolVersion!=null&&(r.uint32(42),r.string(e.protocolVersion)),e.agentVersion!=null&&(r.uint32(50),r.string(e.agentVersion)),e.publicKey!=null&&(r.uint32(10),r.bytes(e.publicKey)),e.listenAddrs!=null)for(const i of e.listenAddrs)r.uint32(18),r.bytes(i);if(e.observedAddr!=null&&(r.uint32(34),r.bytes(e.observedAddr)),e.protocols!=null)for(const i of e.protocols)r.uint32(26),r.string(i);e.signedPeerRecord!=null&&(r.uint32(66),r.bytes(e.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={listenAddrs:[],protocols:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 5:s.protocolVersion=e.string();break;case 6:s.agentVersion=e.string();break;case 1:s.publicKey=e.bytes();break;case 2:s.listenAddrs.push(e.bytes());break;case 4:s.observedAddr=e.bytes();break;case 3:s.protocols.push(e.string());break;case 8:s.signedPeerRecord=e.bytes();break;default:e.skipType(o&7);break}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(li||(li={}));const Gt={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:DI,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnTransientConnection:!0,concurrency:xI};function CI(n){if(n!=null&&n.length>0)try{return G(n)}catch{}}function PI(n,t){return t!=null||(t=`${n.name}/${n.version}`,Iv||_v?t+=` UserAgent=${globalThis.process.version}`:(i6||o6||Sv||Rv)&&(t+=` UserAgent=${globalThis.navigator.userAgent}`)),t}async function L6(n,t,e,r,s){if(e("received identify from %p",r.remotePeer),s==null)throw new v("message was null or undefined","ERR_INVALID_MESSAGE");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(c=>({isCertified:!1,multiaddr:G(c)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null&&(i.publicKey=s.publicKey,!(await Cr(s.publicKey)).equals(r.remotePeer)))throw new v("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY");let o;if(s.signedPeerRecord!=null){e("received signedPeerRecord from %p",r.remotePeer);let c=s.signedPeerRecord;const l=await Mn.openAndCertify(c,Tr.DOMAIN);let u=Tr.createFromProtobuf(l.payload);if(!u.peerId.equals(l.peerId))throw new v("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!r.remotePeer.equals(u.peerId))throw new v("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");let d;try{d=await n.get(u.peerId)}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f}if(d!=null&&(i.metadata=d.metadata,d.peerRecordEnvelope!=null)){const f=await Mn.createFromProtobuf(d.peerRecordEnvelope),p=Tr.createFromProtobuf(f.payload);p.seqNumber>=u.seqNumber&&(e("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,u.seqNumber),u=p,c=d.peerRecordEnvelope)}i.peerRecordEnvelope=c,i.addresses=u.multiaddrs.map(f=>({isCertified:!0,multiaddr:f})),o={seq:u.seqNumber,addresses:u.multiaddrs}}else e("%p did not send a signed peer record",r.remotePeer);if(e("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const c={};s.agentVersion!=null&&(c.AgentVersion=Y(s.agentVersion)),s.protocolVersion!=null&&(c.ProtocolVersion=Y(s.protocolVersion)),e("merging %p metadata",r.remotePeer,c),await n.merge(r.remotePeer,{metadata:c})}const a={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(c=>G(c)),observedAddr:s.observedAddr==null?void 0:G(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class B6{constructor(t,e){h(this,"host");h(this,"protocol");h(this,"started");h(this,"timeout");h(this,"peerId");h(this,"peerStore");h(this,"registrar");h(this,"addressManager");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"maxMessageSize");h(this,"maxObservedAddresses");h(this,"events");h(this,"runOnTransientConnection");h(this,"log");this.protocol=e.protocol,this.started=!1,this.peerId=t.peerId,this.peerStore=t.peerStore,this.registrar=t.registrar,this.addressManager=t.addressManager,this.events=t.events,this.log=e.log,this.timeout=e.timeout??Gt.timeout,this.maxInboundStreams=e.maxInboundStreams??Gt.maxInboundStreams,this.maxOutboundStreams=e.maxOutboundStreams??Gt.maxOutboundStreams,this.maxMessageSize=e.maxMessageSize??Gt.maxMessageSize,this.maxObservedAddresses=e.maxObservedAddresses??Gt.maxObservedAddresses,this.runOnTransientConnection=e.runOnTransientConnection??Gt.runOnTransientConnection,this.host={protocolVersion:`${e.protocolPrefix??Gt.protocolPrefix}/${SI}`,agentVersion:PI(t.nodeInfo,e.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Y(this.host.agentVersion),ProtocolVersion:Y(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,t=>{this.handleProtocol(t).catch(e=>{this.log.error(e)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var j0,e2;class kI extends(e2=B6,j0=jt,e2){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??Gt.protocolPrefix}/${RI}/${TI}`,log:e.logger.forComponent("libp2p:identify-push")});h(this,"connectionManager");h(this,"concurrency");h(this,j0,["@libp2p/identify-push"]);this.connectionManager=e.connectionManager,this.concurrency=r.concurrency??Gt.concurrency,(r.runOnSelfUpdate??Gt.runOnSelfUpdate)&&e.events.addEventListener("self:peer:update",s=>{this.push().catch(i=>{this.log.error(i)})})}async push(){if(!this.isStarted())return;const e=this.addressManager.getAddresses().map(d=>d.decapsulateCode(ce("p2p").code)),r=new Tr({peerId:this.peerId,multiaddrs:e}),s=await Mn.seal(r,this.peerId),i=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=X(o.metadata.get("AgentVersion")??Y(this.host.agentVersion)),c=X(o.metadata.get("ProtocolVersion")??Y(this.host.protocolVersion)),l=this;async function*u(){for(const d of l.connectionManager.getConnections())(await l.peerStore.get(d.remotePeer)).protocols.includes(l.protocol)&&(yield async()=>{let p;const y=AbortSignal.timeout(l.timeout);ge(1/0,y);try{p=await d.newStream(l.protocol,{signal:y,runOnTransientConnection:l.runOnTransientConnection}),await Ct(p,{maxDataLength:l.maxMessageSize}).pb(li).write({listenAddrs:e.map(m=>m.bytes),signedPeerRecord:s.marshal(),protocols:i,agentVersion:a,protocolVersion:c},{signal:y}),await p.close({signal:y})}catch(g){l.log.error("could not push identify update to peer",g),p==null||p.abort(g)}})}await ro(Sc(u(),{concurrency:this.concurrency}))}async handleProtocol(e){const{connection:r,stream:s}=e;try{if(this.peerId.equals(r.remotePeer))throw new Error("received push from ourselves?");const i={signal:AbortSignal.timeout(this.timeout)},a=await Ct(s,{maxDataLength:this.maxMessageSize}).pb(li).read(i);await s.close(i),await L6(this.peerStore,this.events,this.log,r,a)}catch(i){this.log.error("received invalid message",i),s.abort(i);return}this.log("handled push from %p",r.remotePeer)}}var t2,r2;class NI extends(r2=B6,t2=jt,r2){constructor(e,r={}){super(e,{...r,protocol:`/${r.protocolPrefix??Gt.protocolPrefix}/${II}/${AI}`,log:e.logger.forComponent("libp2p:identify")});h(this,t2,["@libp2p/identify"]);(r.runOnConnectionOpen??Gt.runOnConnectionOpen)&&e.events.addEventListener("connection:open",s=>{const i=s.detail;this.identify(i).catch(o=>{this.log.error("error during identify trigged by connection:open",o)})})}async _identify(e,r={}){let s;if(r.signal==null){const i=AbortSignal.timeout(this.timeout);ge(1/0,i),r={...r,signal:i}}try{s=await e.newStream(this.protocol,{...r,runOnTransientConnection:this.runOnTransientConnection});const o=await Ct(s,{maxDataLength:this.maxMessageSize}).pb(li).read(r);return await s.close(r),o}catch(i){throw this.log.error("error while reading identify message",i),s==null||s.abort(i),i}}async identify(e,r={}){const s=await this._identify(e,r),{publicKey:i,protocols:o,observedAddr:a}=s;if(i==null)throw new v("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const c=await Cr(i);if(!e.remotePeer.equals(c))throw new v("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(c))throw new v("identified peer is our own peer id?","ERR_INVALID_PEER");const l=CI(a);return this.log("identify completed for peer %p and protocols %o",c,o),this.log("our observed address is %a",l),l!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(this.log("storing our observed address %a",l),this.addressManager.addObservedAddr(l)),L6(this.peerStore,this.events,this.log,e,s)}async handleProtocol(e){const{connection:r,stream:s}=e,i=AbortSignal.timeout(this.timeout);ge(1/0,i);try{const o=this.peerId.publicKey??new Uint8Array(0),a=await this.peerStore.get(this.peerId),c=this.addressManager.getAddresses().map(f=>f.decapsulateCode(ce("p2p").code));let l=a.peerRecordEnvelope;if(c.length>0&&l==null){const f=new Tr({peerId:this.peerId,multiaddrs:c});l=(await Mn.seal(f,this.peerId)).marshal().subarray()}let u=r.remoteAddr.bytes;Iw.matches(r.remoteAddr)||(u=void 0),await Ct(s).pb(li).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:o,listenAddrs:c.map(f=>f.bytes),signedPeerRecord:l,observedAddr:u,protocols:a.protocols},{signal:i}),await s.close({signal:i})}catch(o){this.log.error("could not respond to identify request",o),s.abort(o)}}}function MI(n={}){return t=>new NI(t,n)}function OI(n={}){return t=>new kI(t,n)}const Co=1e3,Pu=60*Co,ku=60*Pu,LI=36*ku,BI="/ipfs/kad/1.0.0",UI="/dht/record",U6="/dht/provider",FI=256,VI=24*ku,$I=ku,h1=20,Qa=3,KI=5*Pu,HI=Co,zI=5*Co,WI=5*Pu,qI=30*Co,GI=180*Co;var Xa;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.key!=null&&e.key.byteLength>0&&(r.uint32(10),r.bytes(e.key)),e.value!=null&&e.value.byteLength>0&&(r.uint32(18),r.bytes(e.value)),e.timeReceived!=null&&e.timeReceived!==""&&(r.uint32(42),r.string(e.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(e,r,s={})=>{const i={key:Ue(0),value:Ue(0),timeReceived:""},o=r==null?e.len:e.pos+r;for(;e.pos<o;){const a=e.uint32();switch(a>>>3){case 1:{i.key=e.bytes();break}case 2:{i.value=e.bytes();break}case 5:{i.timeReceived=e.string();break}default:{e.skipType(a&7);break}}}return i})),t),n.encode=e=>he(e,n.codec()),n.decode=(e,r)=>ue(e,n.codec(),r)})(Xa||(Xa={}));function YI(n){const t=n.getUTCFullYear(),e=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),s=String(n.getUTCHours()).padStart(2,"0"),i=String(n.getUTCMinutes()).padStart(2,"0"),o=String(n.getUTCSeconds()).padStart(2,"0"),a=n.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${t}-${e}-${r}T${s}:${i}:${o}.${c}Z`}function QI(n){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),e=String(n).trim().match(t);if(e==null)throw new Error("Invalid format");const r=parseInt(e[1],10),s=parseInt(e[2],10)-1,i=parseInt(e[3],10),o=parseInt(e[4],10),a=parseInt(e[5],10),c=parseInt(e[6],10),l=parseInt(e[7].slice(0,-6),10);return new Date(Date.UTC(r,s,i,o,a,c,l))}class Jt{constructor(t,e,r){h(this,"key");h(this,"value");h(this,"timeReceived");if(!(t instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(e instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=t,this.value=e,this.timeReceived=r}serialize(){return Xa.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:YI(this.timeReceived)}}static deserialize(t){const e=Xa.decode(t);return new Jt(e.key,e.value,new Date(e.timeReceived))}static fromDeserialized(t){const e=QI(t.timeReceived);if(t.key==null)throw new Error("key missing from deserialized object");if(t.value==null)throw new Error("value missing from deserialized object");return new Jt(t.key,t.value,e)}}var r0;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),e.key!=null&&(r.uint32(10),r.bytes(e.key)),e.value!=null&&(r.uint32(18),r.bytes(e.value)),e.author!=null&&(r.uint32(26),r.bytes(e.author)),e.signature!=null&&(r.uint32(34),r.bytes(e.signature)),e.timeReceived!=null&&(r.uint32(42),r.string(e.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.key=e.bytes();break}case 2:{s.value=e.bytes();break}case 3:{s.author=e.bytes();break}case 4:{s.signature=e.bytes();break}case 5:{s.timeReceived=e.string();break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(r0||(r0={}));var Pe;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(Pe||(Pe={}));var Za;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(Za||(Za={}));(function(n){n.codec=()=>kr(Za)})(Pe||(Pe={}));var ui;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(ui||(ui={}));var d1;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(d1||(d1={}));(function(n){n.codec=()=>kr(d1)})(ui||(ui={}));var Ds;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.id!=null&&e.id.byteLength>0&&(r.uint32(10),r.bytes(e.id)),e.multiaddrs!=null)for(const i of e.multiaddrs)r.uint32(18),r.bytes(i);e.connection!=null&&(r.uint32(24),ui.codec().encode(e.connection,r)),s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={id:Ue(0),multiaddrs:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.id=e.bytes();break}case 2:{s.multiaddrs.push(e.bytes());break}case 3:{s.connection=ui.codec().decode(e);break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Ds||(Ds={}));var Jr;(function(n){let t;n.codec=()=>(t==null&&(t=de((e,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),e.type!=null&&Za[e.type]!==0&&(r.uint32(8),Pe.codec().encode(e.type,r)),e.clusterLevel!=null&&(r.uint32(80),r.int32(e.clusterLevel)),e.key!=null&&(r.uint32(18),r.bytes(e.key)),e.record!=null&&(r.uint32(26),r.bytes(e.record)),e.closer!=null)for(const i of e.closer)r.uint32(66),Ds.codec().encode(i,r);if(e.providers!=null)for(const i of e.providers)r.uint32(74),Ds.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(e,r)=>{const s={type:Pe.PUT_VALUE,closer:[],providers:[]},i=r==null?e.len:e.pos+r;for(;e.pos<i;){const o=e.uint32();switch(o>>>3){case 1:{s.type=Pe.codec().decode(e);break}case 10:{s.clusterLevel=e.int32();break}case 2:{s.key=e.bytes();break}case 3:{s.record=e.bytes();break}case 8:{s.closer.push(Ds.codec().decode(e,e.uint32()));break}case 9:{s.providers.push(Ds.codec().decode(e,e.uint32()));break}default:{e.skipType(o&7);break}}}return s})),t),n.encode=e=>he(e,n.codec()),n.decode=e=>ue(e,n.codec())})(Jr||(Jr={}));function n0(n,t={}){var r;const e={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:send-query",{detail:e})),e}function f1(n,t={}){var r;const e={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer!=null?n.closer:[],providers:n.providers!=null?n.providers:[]};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:peer-response",{detail:e})),e}function ul(n,t={}){var r;const e={...n,name:"FINAL_PEER",type:2};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:final-peer",{detail:e})),e}function Ln(n,t={}){var r;const e={...n,name:"QUERY_ERROR",type:3};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:query-error",{detail:e})),e}function s0(n,t={}){var r;const e={...n,name:"PROVIDER",type:4};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:provider",{detail:e})),e}function g1(n,t={}){var r;const e={...n,name:"VALUE",type:5};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:value",{detail:e})),e}function i0(n,t={}){var r;const e={...n,name:"DIAL_PEER",type:7};return(r=t.onProgress)==null||r.call(t,new pt("kad-dht:query:dial-peer",{detail:e})),e}function XI(n,t,e){if(e.length===0){const o="No records given";throw new v(o,"ERR_NO_RECORDS_RECEIVED")}const s=X(t).split("/");if(s.length<3){const o="Record key does not have a selector function";throw new v(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=n[s[1].toString()];if(i==null){const o=`No selector function configured for key type "${s[1]}"`;throw new v(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return e.length===1?0:i(t,e)}function ZI(n,t){return 0}const JI={pk:ZI};async function Nu(n,t){const e=t.key,s=X(e).split("/");if(s.length<3)return;const i=n[s[1].toString()];if(i==null){const o=`No validator available for key type "${s[1]}"`;throw new v(o,"ERR_INVALID_RECORD_KEY_TYPE")}await i(e,t.value)}const jI=async(n,t)=>{if(!(n instanceof Uint8Array))throw new v('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(n.byteLength<5)throw new v("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(X(n.subarray(0,4))!=="/pk/")throw new v("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");const r=n.slice(4),s=await mt.digest(t);if(!ke(r,s.bytes))throw new v("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},eR={pk:jI},tR=Y("/pk/");function F6(n){return{...n,multiaddrs:n.multiaddrs.filter(t=>{const[[e,r]]=t.stringTuples();if(e===53||e===54||e===55)return r!=="localhost";if(e!==4&&e!==6||r==null)return!1;const s=To(r);return s==null?!0:!s})}}async function so(n){return(await mt.digest(n)).digest}async function Gr(n){return so(n.toBytes())}function $i(n){return new Be(`${UI}/${X(n,"base32")}`,!1)}function rR(n){return at([tR,n.toBytes()])}function nR(n){return X(n.subarray(0,4))==="/pk/"}function sR(n){return tr(n.subarray(4))}function o0(n,t){const e=new Date;return new Jt(n,t,e).serialize()}function iR(n,t=100){let e;return()=>{clearTimeout(e),e=setTimeout(()=>{n()},t)}}const oR=290,aR=54,cR=55,lR=56,uR=4,hR=41;function dR(n){const t=n.stringTuples();for(const e of t)if(e[0]===oR)return!1;if(t[0][0]===aR||t[0][0]===cR||t[0][0]===lR)return!0;if(t[0][0]===uR||t[0][0]===hR){const e=To(`${t[0][1]}`);return e==null||!e}return!1}class fR{constructor(t,e){h(this,"log");h(this,"components");h(this,"validators");h(this,"selectors");h(this,"peerRouting");h(this,"queryManager");h(this,"network");const{validators:r,selectors:s,peerRouting:i,queryManager:o,network:a,logPrefix:c}=e;this.components=t,this.log=t.logger.forComponent(`${c}:content-fetching`),this.validators=r,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a}async getLocal(t){this.log("getLocal %b",t);const e=$i(t);this.log("fetching record for key %k",e);const r=await this.components.datastore.get(e);this.log("found %k in local datastore",e);const s=Jt.deserialize(r);return await Nu(this.validators,s),s}async*sendCorrectionRecord(t,e,r,s={}){this.log("sendCorrection for %b",t);const i=o0(t,r);for(const{value:o,from:a}of e){if(ke(o,r)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const u=$i(t);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1;const l={type:Pe.PUT_VALUE,key:t,record:i};for await(const u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&ke(u.record.value,Jt.deserialize(i).value)&&(c=!0),yield u;c||(yield Ln({from:a,error:new v("value not put correctly","ERR_PUT_VALUE_INVALID")},s)),this.log.error("Failed error correcting entry")}}async*put(t,e,r={}){this.log("put key %b value %b",t,e);const s=o0(t,e),i=$i(t);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*Zt(this.peerRouting.getClosestPeers(t,{signal:r.signal}),o=>In(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:Pe.PUT_VALUE,key:t,record:s};this.log("send put to %p",a.peer.id);for await(const u of this.network.sendRequest(a.peer.id,l,r))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&ke(u.record.value,Jt.deserialize(s).value)||c.push(Ln({from:a.peer.id,error:new v("value not put correctly","ERR_PUT_VALUE_INVALID")},r)));return c}),o=>Sc(o,{ordered:!1,concurrency:Qa}),async function*(o){for await(const a of o)yield*a})}async*get(t,e={}){this.log("get %b",t);const r=[];for await(const a of this.getMany(t,e))a.name==="VALUE"&&r.push(a),yield a;if(r.length===0)return;const s=r.map(a=>a.value);let i=0;try{i=XI(this.selectors,t,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=s[i];if(this.log("GetValue %b %b",t,o),o==null)throw new v("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(t,r,o,e),yield r[i]}async*getMany(t,e={}){this.log("getMany values for %b",t);try{const i=await this.getLocal(t);yield g1({value:i.value,from:this.components.peerId},e)}catch(i){this.log("error getting local value for %b",t,i)}const r=this,s=async function*({peer:i,signal:o}){for await(const a of r.peerRouting.getValueOrPeers(i,t,{signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield g1({from:i,value:a.record.value},e))};yield*this.queryManager.run(t,s,e)}}function gR(n,t){return{id:n.id.toBytes(),multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:t}}function ea(n){if(n.id==null)throw new Error("Invalid peer in message");return{id:tr(n.id),multiaddrs:(n.multiaddrs??[]).map(t=>G(t))}}class pR{constructor(t,e){h(this,"log");h(this,"components");h(this,"network");h(this,"peerRouting");h(this,"queryManager");h(this,"routingTable");h(this,"providers");const{network:r,peerRouting:s,queryManager:i,routingTable:o,providers:a,logPrefix:c}=e;this.components=t,this.log=t.logger.forComponent(`${c}:content-routing`),this.network=r,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(t,e,r={}){this.log("provide %s",t);const s=t.multihash.bytes;await this.providers.addProvider(t,this.components.peerId);const i={type:Pe.ADD_PROVIDER,key:s,providers:[gR({id:this.components.peerId,multiaddrs:e})]};let o=0;const a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const l=[];this.log("putProvider %s to %p",t,c.peer.id);try{this.log("sending provider record for %s to %p",t,c.peer.id);for await(const u of this.network.sendMessage(c.peer.id,i,r))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",t,c.peer.id),o++),l.push(u)}catch(u){this.log.error("error sending provide record to peer %p",c.peer.id,u),l.push(Ln({from:c.peer.id,error:u},r))}return l};yield*Zt(this.peerRouting.getClosestPeers(s,r),c=>In(c,l=>a(l)),c=>Sc(c,{ordered:!1,concurrency:Qa}),async function*(c){for await(const l of c)yield*l}),this.log("sent provider records to %d peers",o)}async*findProviders(t,e){const r=this.routingTable.kBucketSize;let s=0;const i=t.multihash.bytes,o=this;this.log("findProviders %c",t);const a=await this.providers.getProviders(t);if(a.length>0){const u=[];for(const d of a.slice(0,r))try{const f=await this.components.peerStore.get(d);u.push({id:d,multiaddrs:f.addresses.map(({multiaddr:p})=>p)})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",d)}if(yield f1({from:this.components.peerId,messageType:Pe.GET_PROVIDERS,providers:u},e),yield s0({from:this.components.peerId,providers:u},e),s+=u.length,s>=r)return}const c=async function*({peer:u,signal:d}){const f={type:Pe.GET_PROVIDERS,key:i};yield*o.network.sendRequest(u,f,{...e,signal:d})},l=new hr(a);for await(const u of this.queryManager.run(i,c,e))if(yield u,u.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",u.providers.length,t,u.closer.length);const d=[];for(const f of u.providers)l.has(f.id)||(l.add(f.id),d.push(f));if(d.length>0&&(yield s0({from:u.from,providers:d},e),s+=d.length,s>=r))return}}}class hl{constructor(t){h(this,"movingAverage");h(this,"variance");h(this,"deviation");h(this,"forecast");h(this,"timespan");h(this,"previousTime");this.timespan=t,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(t,e){return 1-Math.exp(-(t-e)/this.timespan)}push(t,e=Date.now()){if(this.previousTime!=null){const r=this.alpha(e,this.previousTime),s=t-this.movingAverage,i=r*s;this.movingAverage=r*t+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=t;this.previousTime=e}}const mR=1.2,yR=2,wR=2e3;class bR{constructor(t={}){h(this,"success");h(this,"failure");h(this,"next");h(this,"metric");h(this,"timeoutMultiplier");h(this,"failureMultiplier");h(this,"minTimeout");var e;this.success=new hl(t.interval??5e3),this.failure=new hl(t.interval??5e3),this.next=new hl(t.interval??5e3),this.failureMultiplier=t.failureMultiplier??yR,this.timeoutMultiplier=t.timeoutMultiplier??mR,this.minTimeout=t.minTimeout??wR,t.metricName!=null&&(this.metric=(e=t.metrics)==null?void 0:e.registerMetricGroup(t.metricName))}getTimeoutSignal(t={}){const e=Math.max(Math.round(this.next.movingAverage*(t.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),r=AbortSignal.timeout(e),s=Xt([t.signal,r]);return ge(1/0,s,r),s.start=Date.now(),s.timeout=e,s}cleanUp(t){var r,s;const e=Date.now()-t.start;t.aborted?(this.failure.push(e),this.next.push(e*this.failureMultiplier),(r=this.metric)==null||r.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:e})):(this.success.push(e),this.next.push(e),(s=this.metric)==null||s.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:e}))}}class ER extends Et{constructor(e,r){super();h(this,"log");h(this,"protocol");h(this,"running");h(this,"components");h(this,"timeout");const{protocol:s}=r;this.components=e,this.log=e.logger.forComponent(`${r.logPrefix}:network`),this.running=!1,this.protocol=s,this.timeout=new bR({...r.timeout??{},metrics:e.metrics,metricName:`${r.logPrefix.replaceAll(":","_")}_network_message_send_times_milliseconds`})}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,r,s={}){if(!this.running)return;const i=r.type;if(i==null)throw new Bt("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,e),yield i0({peer:e},s),yield n0({to:e,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{o=await(await this.components.connectionManager.openConnection(e,s)).newStream(this.protocol,s);const l=await this._writeReadMessage(o,r,s);o.close(s).catch(u=>{this.log.error("error closing stream to %p",e,u),o==null||o.abort(u)}),yield f1({from:e,messageType:l.type,closer:l.closer.map(ea),providers:l.providers.map(ea),record:l.record==null?void 0:Jt.deserialize(l.record)},s)}catch(c){o==null||o.abort(c),this.log.error("could not send %s to %p",r.type,e,c),yield Ln({from:e,error:c},s)}finally{this.timeout.cleanUp(a)}}async*sendMessage(e,r,s={}){if(!this.running)return;const i=r.type;if(i==null)throw new Bt("Message type was missing","ERR_INVALID_PARAMETERS");this.log("sending %s to %p",r.type,e),yield i0({peer:e},s),yield n0({to:e,type:i},s);let o;const a=this.timeout.getTimeoutSignal(s);s={...s,signal:a};try{o=await(await this.components.connectionManager.openConnection(e,s)).newStream(this.protocol,s),await this._writeMessage(o,r,s),o.close(s).catch(l=>{this.log.error("error closing stream to %p",e,l),o==null||o.abort(l)}),yield f1({from:e,messageType:i},s)}catch(c){o==null||o.abort(c),yield Ln({from:e,error:c},s)}finally{this.timeout.cleanUp(a)}}async _writeMessage(e,r,s){const i=Ct(e);await i.write(r,Jr,s),await i.unwrap().close(s)}async _writeReadMessage(e,r,s){const i=Ct(e);await i.write(r,Jr,s);const o=await i.read(Jr,s);return await i.unwrap().close(s),o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:ea(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:ea(a)})}),o}}function Ja(n,t){if(n.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let e=0;e<n.byteLength;e++)if(n[e]!==t[e])return n[e]<t[e]?-1:1;return 0}class V6{constructor(t,e){h(this,"originDhtKey");h(this,"capacity");h(this,"peerDistances");this.originDhtKey=t,this.capacity=e,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(t=>t.peer)}async add(t){const e=await Gr(t.id);this.addWitKadId(t,e)}addWitKadId(t,e){if(this.peerDistances.find(s=>s.peer.id.equals(t.id))!=null)return;const r={peer:t,distance:ni(this.originDhtKey,e)};this.peerDistances.push(r),this.peerDistances.sort((s,i)=>Ja(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(t){if(this.length===0)return!0;const e=await Gr(t),r=ni(e,this.originDhtKey),s=this.peerDistances[this.peerDistances.length-1].distance;return Ja(r,s)===-1}async anyCloser(t){return t.length===0?!1:Promise.any(t.map(async e=>this.isCloser(e)))}}class vR{constructor(t,e){h(this,"log");h(this,"routingTable");h(this,"network");h(this,"validators");h(this,"queryManager");h(this,"peerStore");h(this,"peerId");const{routingTable:r,network:s,validators:i,queryManager:o,logPrefix:a}=e;this.routingTable=r,this.network=s,this.validators=i,this.queryManager=o,this.peerStore=t.peerStore,this.peerId=t.peerId,this.log=t.logger.forComponent(`${a}:peer-routing`)}async findPeerLocal(t){let e;const r=await this.routingTable.find(t);if(r!=null){this.log("findPeerLocal found %p in routing table",t);try{e=await this.peerStore.get(r)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(e==null)try{e=await this.peerStore.get(t)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(e!=null)return this.log("findPeerLocal found %p in peer store",t),{id:e.id,multiaddrs:e.addresses.map(s=>s.multiaddr)}}async*_getValueSingle(t,e,r={}){const s={type:Pe.GET_VALUE,key:e};yield*this.network.sendRequest(t,s,r)}async*getPublicKeyFromNode(t,e={}){const r=rR(t);for await(const s of this._getValueSingle(t,r,e))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=await Cr(cu({bytes:s.record.value}));if(!i.equals(t))throw new v("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw new v("public key missing","ERR_PUBLIC_KEY_MISSING");yield g1({from:t,value:i.publicKey},e)}throw new v(`Node not responding with its public key: ${t.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(t,e={}){if(this.log("findPeer %p",t),e.useCache!==!1){const s=await this.findPeerLocal(t);if(s!=null){this.log("found local"),yield ul({from:this.peerId,peer:s},e);return}}let r=!1;if(e.useNetwork!==!1){const s=this,i=async function*({peer:o,signal:a}){const c={type:Pe.FIND_NODE,key:t.toBytes()};for await(const l of s.network.sendRequest(o,c,{...e,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){const u=l.closer.find(d=>d.id.equals(t));u!=null&&(yield ul({from:l.from,peer:u},e))}};for await(const o of this.queryManager.run(t.toBytes(),i,e))o.name==="FINAL_PEER"&&(r=!0),yield o}r||(yield Ln({from:this.peerId,error:new v("Not found","ERR_NOT_FOUND")},e))}async*getClosestPeers(t,e={}){this.log("getClosestPeers to %b",t);const r=await so(t),s=this.routingTable.closestPeers(r),i=this,o=new V6(r,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await o.add({id:c,multiaddrs:[]})}));const a=async function*({peer:c,signal:l}){i.log("closerPeersSingle %s from %p",X(t,"base32"),c);const u={type:Pe.FIND_NODE,key:t};yield*i.network.sendRequest(c,u,{...e,signal:l})};for await(const c of this.queryManager.run(t,a,e))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l)})),yield c;this.log("found %d peers close to %b",o.length,t);for(const c of o.peers)yield ul({from:this.peerId,peer:c},e)}async*getValueOrPeers(t,e,r={}){for await(const s of this._getValueSingle(t,e,r)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield Ln({from:s.from,error:new v(o,"ERR_INVALID_RECORD")},r);continue}yield s}}async _verifyRecordOnline(t){if(t.timeReceived==null)throw new v("invalid record received","ERR_INVALID_RECORD");await Nu(this.validators,new Jt(t.key,t.value,t.timeReceived))}async getCloserPeersOffline(t,e){const r=await so(t),s=this.routingTable.closestPeers(r),i=[];for(const o of s)if(!o.equals(e))try{const a=await this.peerStore.get(o);i.push({id:o,multiaddrs:a.addresses.map(({multiaddr:c})=>c)})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,t,e):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",t,e,this.routingTable.size),i}}class _R{constructor(t,e={}){h(this,"log");h(this,"datastore");h(this,"cache");h(this,"cleanupInterval");h(this,"provideValidity");h(this,"syncQueue");h(this,"started");h(this,"cleaner");const{cacheSize:r,cleanupInterval:s,provideValidity:i}=e;this.log=t.logger.forComponent("libp2p:kad-dht:providers"),this.datastore=t.datastore,this.cleanupInterval=s??$I,this.provideValidity=i??VI,this.cache=b4(r??FI),this.syncQueue=new to({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(t=>{this.log.error(t)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{const t=Date.now();let e=0,r=0;const s=new Map,i=this.datastore.batch(),o=this.datastore.query({prefix:U6});for await(const a of o)try{const{cid:c,peerId:l}=$6(a.key),u=K6(a.value).getTime(),d=Date.now(),f=d-u,p=f>this.provideValidity;if(this.log("comparing: %d - %d = %d > %d %s",d,u,f,this.provideValidity,p?"(expired)":""),p){r++,i.delete(a.key);const y=s.get(c)??new Set;y.add(l),s.set(c,y)}e++}catch(c){this.log.error(c.message)}s.size>0?(this.log("deleting %d / %d entries",r,e),await i.commit()):this.log("nothing to delete");for(const[a,c]of s){const l=Ki(a),u=this.cache.get(l);if(u!=null){for(const d of c)u.delete(d);u.size===0?this.cache.remove(l):this.cache.set(l,u)}}this.log("Cleanup successful (%dms)",Date.now()-t)})}async _getProvidersMap(t){const e=Ki(t);let r=this.cache.get(e);return r==null&&(r=await IR(this.datastore,t),this.cache.set(e,r)),r}async addProvider(t,e){await this.syncQueue.add(async()=>{this.log("%p provides %s",e,t);const r=await this._getProvidersMap(t);this.log("loaded %s provs",r.size);const s=new Date;r.set(e.toString(),s);const i=Ki(t);this.cache.set(i,r),await SR(this.datastore,t,e,s)})}async getProviders(t){return this.syncQueue.add(async()=>(this.log("get providers for %s",t),[...(await this._getProvidersMap(t)).keys()].map(r=>ye(r))),{throwOnTimeout:!0})}}function Ki(n){const t=typeof n=="string"?n:X(n.multihash.bytes,"base32");return`${U6}/${t}`}async function SR(n,t,e,r){const s=[Ki(t),"/",e.toString()].join(""),i=new Be(s),o=ur(r.getTime());await n.put(i,o)}function $6(n){const t=n.toString().split("/");if(t.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:t[3],peerId:t[4]}}async function IR(n,t){const e=new Map,r=n.query({prefix:Ki(t)});for await(const s of r){const{peerId:i}=$6(s.key);e.set(i,K6(s.value))}return e}function K6(n){return new Date(Bn(n))}async function*RR(n){const{key:t,startingPeer:e,ourPeerId:r,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:u,peersSeen:d,connectionManager:f}=n,p=new Iu({concurrency:o,sort:(m,w)=>Ja(m.options.distance,w.options.distance)}),y=await so(t);function g(m,w){if(m==null)return;d.add(m);const _=ni(w,y);p.add(async()=>{const b=[s];l!=null&&b.push(AbortSignal.timeout(l));const S=Xt(b);ge(1/0,S);try{for await(const I of i({key:t,peer:m,signal:S,pathIndex:a,numPaths:c})){if(S.aborted)return;if(I.name==="PEER_RESPONSE")for(const A of I.closer){if(d.has(A.id)){u("already seen %p in query",A.id);continue}if(r.equals(A.id)){u("not querying ourselves");continue}if(!await f.isDialable(A.multiaddrs)){u("not querying undialable peer");continue}const P=await Gr(A.id),T=ni(P,y);if(Ja(T,_)!==-1){u("skipping %p as they are not closer to %b than %p",A.id,t,m);continue}u("querying closer peer %p",A.id),g(A.id,P)}p.safeDispatchEvent("completed",{detail:I})}}catch(I){if(!s.aborted)return Ln({from:m,error:I},n)}finally{S.clear()}},{distance:_}).catch(b=>{u.error(b)})}g(e,await Gr(e));try{for await(const m of p.toGenerator({signal:s}))m!=null&&(yield m)}catch(m){throw s.aborted?new v("Query aborted","ERR_QUERY_ABORTED"):m}}class AR{constructor(t,e){h(this,"disjointPaths");h(this,"alpha");h(this,"shutDownController");h(this,"running");h(this,"queries");h(this,"logger");h(this,"peerId");h(this,"connectionManager");h(this,"routingTable");h(this,"initialQuerySelfHasRun");h(this,"logPrefix");h(this,"metrics");const{disjointPaths:r=h1,alpha:s=Qa,logPrefix:i}=e;this.logPrefix=i,this.disjointPaths=r??h1,this.running=!1,this.alpha=s??Qa,this.queries=0,this.initialQuerySelfHasRun=e.initialQuerySelfHasRun,this.routingTable=e.routingTable,this.logger=t.logger,this.peerId=t.peerId,this.connectionManager=t.connectionManager,t.metrics!=null&&(this.metrics={runningQueries:t.metrics.registerMetric(`${i.replaceAll(":","_")}_running_queries`),queryTime:t.metrics.registerMetric(`${i.replaceAll(":","_")}_query_time_seconds`)}),this.shutDownController=new AbortController,ge(1/0,this.shutDownController.signal)}isStarted(){return this.running}async start(){this.running=!0,this.shutDownController=new AbortController,ge(1/0,this.shutDownController.signal)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(t,e,r={}){var u,d,f;if(!this.running)throw new Error("QueryManager not started");const s=(u=this.metrics)==null?void 0:u.queryTime.timer();if(r.signal==null){const p=AbortSignal.timeout(GI);ge(1/0,p),r={...r,signal:p}}const i=new AbortController,o=Xt([this.shutDownController.signal,i.signal,r.signal]);ge(1/0,o,i.signal);const a=this.logger.forComponent(`${this.logPrefix}:query:`+X(t,"base58btc")),c=Date.now();let l=!1;try{r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial query-self query before continuing"),await it(this.initialQuerySelfHasRun.promise,o),this.initialQuerySelfHasRun=void 0),a("query:start"),this.queries++,(d=this.metrics)==null||d.runningQueries.update(this.queries);const p=await so(t),y=this.routingTable.closestPeers(p),g=y.slice(0,Math.min(this.disjointPaths,y.length));if(y.length===0){a.error("Running query with no peers");return}const m=new hr,w=g.map((_,b)=>RR({key:t,startingPeer:_,ourPeerId:this.peerId,signal:o,query:e,pathIndex:b,numPaths:g.length,alpha:this.alpha,queryFuncTimeout:r.queryFuncTimeout,log:a,peersSeen:m,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const _ of Wi(...w)){if(_.name==="QUERY_ERROR"&&a.error("query error",_.error),_.name==="PEER_RESPONSE")for(const b of[..._.closer,..._.providers])await this.connectionManager.isDialable(b.multiaddrs)&&await this.routingTable.add(b.id);yield _}l=!0}catch(p){if(!(!this.running&&p.code==="ERR_QUERY_ABORTED"))throw p}finally{l||(a("query exited early"),i.abort()),o.clear(),this.queries--,(f=this.metrics)==null||f.runningQueries.update(this.queries),s!=null&&s(),a("query:done in %dms",Date.now()-c)}}}function TR(n){return n[Symbol.asyncIterator]!=null}function H6(n){if(TR(n))return(async()=>{let t=0;for await(const e of n)t++;return t})();{let t=0;for(const e of n)t++;return t}}class DR{constructor(t,e){h(this,"log");h(this,"peerId");h(this,"peerRouting");h(this,"routingTable");h(this,"count");h(this,"interval");h(this,"initialInterval");h(this,"queryTimeout");h(this,"started");h(this,"timeoutId");h(this,"controller");h(this,"initialQuerySelfHasRun");h(this,"querySelfPromise");const{peerRouting:r,logPrefix:s,count:i,interval:o,queryTimeout:a,routingTable:c}=e;this.peerId=t.peerId,this.log=t.logger.forComponent(`${s}:query-self`),this.started=!1,this.peerRouting=r,this.routingTable=c,this.count=i??h1,this.interval=o??KI,this.initialInterval=e.initialInterval??HI,this.queryTimeout=a??zI,this.initialQuerySelfHasRun=e.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(t=>{this.log.error("error running self-query",t)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=me(),this.started){this.controller=new AbortController;const t=AbortSignal.timeout(this.queryTimeout),e=Xt([this.controller.signal,t]);ge(1/0,e,this.controller.signal,t);try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await i1(this.routingTable,"peer:add",{signal:e})),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),s=await Zt(this.peerRouting.getClosestPeers(this.peerId.toBytes(),{signal:e,isSelfQuery:!0}),i=>Fl(i,this.count),async i=>H6(i));this.log("self-query found %d peers in %dms",s,Date.now()-r)}catch(r){this.log.error("self-query error",r)}finally{e.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(t=>{this.log.error("error running self-query",t)})},this.interval))}}function xR(n,t){if(n===t)return!0;if(n.length!==t.length)return!1;for(let e=0,r=n.length;e<r;++e)if(n[e]!==t[e])return!1;return!0}function a0(n,t){if(!(t instanceof Uint8Array))throw new TypeError(n+" is not a Uint8Array");if(t.byteLength!==32)throw new TypeError(n+" had incorrect length")}function ga(n){return Array.isArray(n==null?void 0:n.peers)}class CR extends Et{constructor(e){super();h(this,"root");h(this,"localPeer");h(this,"prefixLength");h(this,"splitThreshold");h(this,"kBucketSize");h(this,"numberOfNodesToPing");this.localPeer=e.localPeer,this.prefixLength=e.prefixLength,this.kBucketSize=e.kBucketSize??pa,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfNodesToPing??3,a0("options.localPeer.kadId",e.localPeer.kadId),this.root={prefix:"",depth:0,peers:[]}}add(e){a0("peer.kadId",e==null?void 0:e.kadId);const r=this._determineBucket(e.kadId);if(!(this._indexOf(r,e.kadId)>-1)){if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){this._split(r),this.add(e);return}if(r.peers.length<this.kBucketSize){r.peers.push(e),this.safeDispatchEvent("added",{detail:e});return}this.safeDispatchEvent("ping",{detail:{oldContacts:r.peers.slice(0,this.numberOfNodesToPing),newContact:e}})}}*closest(e,r=this.kBucketSize){const s=new V6(e,r);for(const i of this.toIterable())s.addWitKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*In(s.peers,i=>i.id)}count(){function e(r){if(ga(r))return r.peers.length;let s=0;return r.left!=null&&(s+=e(r.left)),r.right!=null&&(s+=e(r.right)),s}return e(this.root)}get(e){const r=this._determineBucket(e),s=this._indexOf(r,e);return r.peers[s]}remove(e){const r=this._determineBucket(e),s=this._indexOf(r,e);if(s>-1){const i=r.peers.splice(s,1)[0];this.safeDispatchEvent("removed",{detail:i})}}*toIterable(){function*e(r){if(ga(r)){yield*r.peers;return}yield*e(r.left),yield*e(r.right)}yield*e(this.root)}distance(e,r){return BigInt("0x"+X(ni(e,r),"base16"))}_determineBucket(e){const s=X(e,"base2").substring(0,this.prefixLength);function i(o,a=0){return ga(o)?o:s[a]==="0"?i(o.left,a+1):i(o.right,a+1)}return i(this.root)}_indexOf(e,r){return e.peers.findIndex(s=>xR(s.kadId,r))}_split(e){const r=e.depth+1,s={prefix:"0",depth:r,peers:[]},i={prefix:"1",depth:r,peers:[]};for(const o of e.peers)X(o.kadId,"base2")[r]==="0"?s.peers.push(o):i.peers.push(o);delete e.peers,e.left=s,e.right=i}}const PR="kad-close",kR=50,pa=20,NR=32,MR=1e4,OR=10;class LR extends Et{constructor(e,r){super();h(this,"kBucketSize");h(this,"kb");h(this,"pingQueue");h(this,"log");h(this,"components");h(this,"prefixLength");h(this,"splitThreshold");h(this,"pingTimeout");h(this,"pingConcurrency");h(this,"running");h(this,"protocol");h(this,"tagName");h(this,"tagValue");h(this,"metrics");this.components=e,this.log=e.logger.forComponent(`${r.logPrefix}:routing-table`),this.kBucketSize=r.kBucketSize??pa,this.pingTimeout=r.pingTimeout??MR,this.pingConcurrency=r.pingConcurrency??OR,this.running=!1,this.protocol=r.protocol,this.tagName=r.tagName??PR,this.tagValue=r.tagValue??kR,this.prefixLength=r.prefixLength??NR,this.splitThreshold=r.splitThreshold??pa,this.pingQueue=new _c({concurrency:this.pingConcurrency,metricName:`${r.logPrefix.replaceAll(":","_")}_ping_queue`,metrics:this.components.metrics}),this.pingQueue.addEventListener("error",s=>{this.log.error("error pinging peer",s.detail)}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${r.logPrefix.replaceAll(":","_")}_routing_table_kad_bucket_max_depth`)})}isStarted(){return this.running}async start(){this.running=!0;const e=new CR({localPeer:{kadId:await Gr(this.components.peerId),peerId:this.components.peerId},kBucketSize:this.kBucketSize,prefixLength:this.prefixLength,splitThreshold:this.splitThreshold,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",s=>{this._onPing(s).catch(i=>{this.log.error("could not process k-bucket ping event",i)})});let r=0;for(const s of await this.components.peerStore.all())if(s.protocols.includes(this.protocol)){const i=await Gr(s.id);this.kb.add({kadId:i,peerId:s.id}),r++}this.log("added %d peer store peers to the routing table",r),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let r=new hr;const s=iR(()=>{const i=new hr(e.closest(e.localPeer.kadId,pa)),o=i.difference(r),a=r.difference(i);Promise.resolve().then(async()=>{for(const c of o)await this.components.peerStore.merge(c,{tags:{[this.tagName]:{value:this.tagValue}}});for(const c of a)await this.components.peerStore.merge(c,{tags:{[this.tagName]:void 0}})}).catch(c=>{this.log.error("Could not update peer tags",c)}),r=i});e.addEventListener("added",i=>{s(),this.safeDispatchEvent("peer:add",{detail:i.detail.peerId})}),e.addEventListener("removed",i=>{s(),this.safeDispatchEvent("peer:remove",{detail:i.detail.peerId})})}async _onPing(e){if(!this.running)return;const{oldContacts:r,newContact:s}=e.detail,o=(await Promise.all(r.map(async a=>{const c=this.pingQueue.find(a.peerId);return c!=null?c.join():this.pingQueue.add(async()=>{var u;let l;try{const d={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",a.peerId),l=await(await this.components.connectionManager.openConnection(a.peerId,d)).newStream(this.protocol,d);const p=Ct(l);await p.write({type:Pe.PING},Jr,d);const y=await p.read(Jr,d);if(await p.unwrap().close(),y.type!==Pe.PING)throw new v(`Incorrect message type received, expected PING got ${y.type}`,"ERR_BAD_PING_RESPONSE");return!0}catch(d){return this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",a.peerId,d),this.log("evicting old contact after ping failed %p",a.peerId),this.kb.remove(a.kadId)),l==null||l.abort(d),!1}finally{(u=this.metrics)==null||u.routingTableSize.update(this.size)}},{peerId:a.peerId})}))).filter(a=>a).length;this.running&&o<r.length&&this.kb!=null&&(this.log("adding new contact %p",s.peerId),this.kb.add(s))}get size(){return this.kb==null?0:this.kb.count()}async find(e){var s,i;const r=await Gr(e);return(i=(s=this.kb)==null?void 0:s.get(r))==null?void 0:i.peerId}closestPeer(e){const r=this.closestPeers(e,1);if(r.length>0)return r[0]}closestPeers(e,r=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(e,r)]}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await Gr(e);this.kb.add({kadId:r,peerId:e}),this.log("added %p with kad id %b",e,r),this.updateMetrics()}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await Gr(e);this.kb.remove(r),this.updateMetrics()}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,r=0,s=0;function i(o){if(ga(o)){o.depth>s&&(s=o.depth),r++,e+=o.peers.length;return}i(o.left),i(o.right)}i(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(r),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/r)),this.metrics.routingTableKadBucketMaxDepth.update(s)}}const BR=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],ta=15;class UR{constructor(t,e){h(this,"log");h(this,"peerRouting");h(this,"routingTable");h(this,"refreshInterval");h(this,"refreshQueryTimeout");h(this,"commonPrefixLengthRefreshedAt");h(this,"refreshTimeoutId");const{peerRouting:r,routingTable:s,refreshInterval:i,refreshQueryTimeout:o,logPrefix:a}=e;this.log=t.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=r,this.routingTable=s,this.refreshInterval=i??WI,this.refreshQueryTimeout=o??qI,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(t=!1){this.log("refreshing routing table");const e=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(e);this.log(`max common prefix length ${e}`),this.log(`tracked CPLs [ ${r.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(r.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,t),this._numPeersForCpl(e)===0){const o=Math.min(2*(i+1),r.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,t)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(t,e,r){if(!r&&e.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",t);return}const s=await this._generateRandomPeerId(t);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",t,s,this.routingTable.size);const i=AbortSignal.timeout(this.refreshQueryTimeout);ge(1/0,i);const o=await H6(this.peerRouting.getClosestPeers(s.toBytes(),{signal:i}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",t,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(t){t>ta&&(t=ta);const e=[];for(let r=0;r<=t;r++)e[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return e}async _generateRandomPeerId(t){if(this.routingTable.kb==null)throw new Error("Routing table not started");const e=as(2),r=(e[1]<<8)+e[0],s=await this._makePeerId(this.routingTable.kb.localPeer.kadId,r,t);return tr(s)}async _makePeerId(t,e,r){if(r>ta)throw new Error(`Cannot generate peer ID for common prefix length greater than ${ta}`);const o=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0,!1)^32768>>r,a=65535<<16-(r+1),c=o&a|e&~a,l=BR[c],u=new ArrayBuffer(34),d=new DataView(u,0,u.byteLength);return d.setUint8(0,mt.code),d.setUint8(1,32),d.setUint32(2,l,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let t=0;for(const e of this._prefixLengths())e>t&&(t=e);return t}_numPeersForCpl(t){let e=0;for(const r of this._prefixLengths())r===t&&e++;return e}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const e=ni(this.routingTable.kb.localPeer.kadId,t);let r=0;for(const s of e)if(s===0)r++;else break;yield r}}}class FR{constructor(t,e){h(this,"providers");h(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:add-provider`),this.providers=e.providers}async handle(t,e){if(this.log("start"),e.key==null||e.key.length===0)throw new v("Missing key","ERR_MISSING_KEY");let r;try{r=Me.decode(e.key)}catch{throw new v("Invalid CID","ERR_INVALID_CID")}(e.providers==null||e.providers.length===0)&&this.log.error("no providers found in message"),await Promise.all(e.providers.map(async s=>{if(!t.equals(s.id)){this.log("invalid provider peer %p from %p",s.id,t);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",t);return}this.log("received provider %p for %s (addrs %s)",t,r,s.multiaddrs.map(i=>G(i).toString())),await this.providers.addProvider(r,tr(s.id))}))}}class VR{constructor(t,e){h(this,"peerRouting");h(this,"peerInfoMapper");h(this,"peerId");h(this,"addressManager");h(this,"log");const{peerRouting:r,logPrefix:s}=e;this.log=t.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=t.peerId,this.addressManager=t.addressManager,this.peerRouting=r,this.peerInfoMapper=e.peerInfoMapper}async handle(t,e){if(this.log("incoming request from %p for peers closer to %b",t,e.key),e.key==null)throw new v("Invalid FIND_NODE message received - key was missing","ERR_INVALID_MESSAGE");const r=await this.peerRouting.getCloserPeersOffline(e.key,t);ke(this.peerId.toBytes(),e.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(ce("p2p").code))});const s={type:Pe.FIND_NODE,clusterLevel:e.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toBytes(),multiaddrs:i.multiaddrs.map(o=>o.bytes)})),providers:[]};return s.closer.length===0&&this.log("could not find any peers closer to %b than %p",e.key,t),s}}class $R{constructor(t,e){h(this,"peerRouting");h(this,"providers");h(this,"peerStore");h(this,"peerInfoMapper");h(this,"log");const{peerRouting:r,providers:s,logPrefix:i}=e;this.log=t.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerStore=t.peerStore,this.peerRouting=r,this.providers=s,this.peerInfoMapper=e.peerInfoMapper}async handle(t,e){if(e.key==null)throw new v("Invalid GET_PROVIDERS message received - key was missing","ERR_INVALID_MESSAGE");let r;try{r=Me.decode(e.key)}catch{throw new v("Invalid CID","ERR_INVALID_CID")}this.log("%p asking for providers for %s",t,r);const[s,i]=await Promise.all([this.providers.getProviders(r),this.peerRouting.getCloserPeersOffline(e.key,t)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:l})=>l)),c={type:Pe.GET_PROVIDERS,key:e.key,clusterLevel:e.clusterLevel,closer:a.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(u=>u.bytes)})),providers:o.map(this.peerInfoMapper).filter(({multiaddrs:l})=>l.length).map(l=>({id:l.id.toBytes(),multiaddrs:l.multiaddrs.map(u=>u.bytes)}))};return this.log("got %s providers %s closerPeers",c.providers.length,c.closer.length),c}async _getAddresses(t){return[]}async _getPeers(t){const e=[];for(const r of t)try{const s=await this.peerStore.get(r),i=this.peerInfoMapper({id:r,multiaddrs:s.addresses.map(({multiaddr:o})=>o)});i.multiaddrs.length>0&&e.push(i)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}return e}}class KR{constructor(t,e){h(this,"peerStore");h(this,"datastore");h(this,"peerRouting");h(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:get-value`),this.peerStore=t.peerStore,this.datastore=t.datastore,this.peerRouting=e.peerRouting}async handle(t,e){const r=e.key;if(this.log("%p asked for key %b",t,r),r==null||r.length===0)throw new v("Invalid key","ERR_INVALID_KEY");const s={type:Pe.GET_VALUE,key:r,clusterLevel:e.clusterLevel,closer:[],providers:[]};if(nR(r)){this.log("is public key");const a=sR(r);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new v("No public key found in key book","ERR_NOT_FOUND");c=l.id.publicKey}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null)return this.log("returning found public key"),s.record=new Jt(r,c,new Date).serialize(),s}const[i,o]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getCloserPeersOffline(r,t)]);return i!=null&&(this.log("had record for %b in local datastore",r),s.record=i.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),s.closer=o.map(a=>({id:a.id.toBytes(),multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),s}async _checkLocalDatastore(t){this.log("checkLocalDatastore looking for %b",t);const e=$i(t);let r;try{r=await this.datastore.get(e)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}const s=Jt.deserialize(r);if(s==null)throw new v("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>LI){await this.datastore.delete(e);return}return s}}class HR{constructor(t,e){h(this,"log");this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:ping`)}async handle(t,e){return this.log("ping from %p",t),e}}class zR{constructor(t,e){h(this,"components");h(this,"validators");h(this,"log");const{validators:r}=e;this.components=t,this.log=t.logger.forComponent(`${e.logPrefix}:rpc:handlers:put-value`),this.validators=r}async handle(t,e){const r=e.key;if(this.log("%p asked us to store value for key %b",t,r),e.record==null){const s=`Empty record from: ${t.toString()}`;throw this.log.error(s),new v(s,"ERR_EMPTY_RECORD")}try{const s=Jt.deserialize(e.record);await Nu(this.validators,s),s.timeReceived=new Date;const i=$i(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,i)}catch(s){this.log("did not put record for key %b into datastore %o",r,s)}return e}}class WR{constructor(t,e){h(this,"handlers");h(this,"routingTable");h(this,"log");const{providers:r,peerRouting:s,validators:i,logPrefix:o,peerInfoMapper:a}=e;this.log=t.logger.forComponent(`${o}:rpc`),this.routingTable=e.routingTable,this.handlers={[Pe.GET_VALUE.toString()]:new KR(t,{peerRouting:s,logPrefix:o}),[Pe.PUT_VALUE.toString()]:new zR(t,{validators:i,logPrefix:o}),[Pe.FIND_NODE.toString()]:new VR(t,{peerRouting:s,logPrefix:o,peerInfoMapper:a}),[Pe.ADD_PROVIDER.toString()]:new FR(t,{providers:r,logPrefix:o}),[Pe.GET_PROVIDERS.toString()]:new $R(t,{peerRouting:s,providers:r,logPrefix:o,peerInfoMapper:a}),[Pe.PING.toString()]:new HR(t,{logPrefix:o})}}async handleMessage(t,e){try{await this.routingTable.add(t)}catch(s){this.log.error("Failed to update the kbucket store",s)}const r=this.handlers[e.type];if(r==null){this.log.error(`no handler found for message type: ${e.type}`);return}return r.handle(t,e)}onIncomingStream(t){Promise.resolve().then(async()=>{const{stream:e,connection:r}=t,s=r.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}const i=this;await Zt(e,o=>kn(o),async function*(o){for await(const a of o){const c=Jr.decode(a);i.log("incoming %s from %p",c.type,s);const l=await i.handleMessage(s,c);l!=null&&(yield Jr.encode(l))}},o=>en(o),e)}).catch(e=>{this.log.error(e)})}}class qR extends Et{constructor(e,r){super();h(this,"log");h(this,"components");h(this,"protocol");h(this,"running");h(this,"registrarId");const{protocol:s,logPrefix:i}=r;this.components=e,this.log=e.logger.forComponent(`${i}:topology-listener`),this.running=!1,this.protocol=s}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new pt("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class GR{constructor(t){h(this,"dht");this.dht=t}async provide(t,e={}){await ro(this.dht.provide(t,e))}async*findProviders(t,e={}){for await(const r of this.dht.findProviders(t,e))r.name==="PROVIDER"&&(yield*r.providers)}async put(t,e,r){await ro(this.dht.put(t,e,r))}async get(t,e){for await(const r of this.dht.get(t,e))if(r.name==="VALUE")return r.value;throw new v("Not found","ERR_NOT_FOUND")}}class YR{constructor(t){h(this,"dht");this.dht=t}async findPeer(t,e={}){for await(const r of this.dht.findPeer(t,e))if(r.name==="FINAL_PEER")return r.peer;throw new v("Not found","ERR_NOT_FOUND")}async*getClosestPeers(t,e={}){for await(const r of this.dht.getClosestPeers(t,e))r.name==="FINAL_PEER"&&(yield r.peer)}}const QR=32,XR=64;var n2,s2,i2;class ZR extends Et{constructor(e,r){super();h(this,"protocol");h(this,"routingTable");h(this,"providers");h(this,"network");h(this,"peerRouting");h(this,"components");h(this,"log");h(this,"running");h(this,"kBucketSize");h(this,"clientMode");h(this,"validators");h(this,"selectors");h(this,"queryManager");h(this,"contentFetching");h(this,"contentRouting");h(this,"routingTableRefresh");h(this,"rpc");h(this,"topologyListener");h(this,"querySelf");h(this,"maxInboundStreams");h(this,"maxOutboundStreams");h(this,"dhtContentRouting");h(this,"dhtPeerRouting");h(this,"peerInfoMapper");h(this,i2,"@libp2p/kad-dht");h(this,s2,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);h(this,n2,["@libp2p/identify"]);const{kBucketSize:s,clientMode:i,validators:o,selectors:a,querySelfInterval:c,protocol:l,logPrefix:u,pingTimeout:d,pingConcurrency:f,maxInboundStreams:p,maxOutboundStreams:y,providers:g}=r,m=u??"libp2p:kad-dht";this.running=!1,this.components=e,this.log=e.logger.forComponent(m),this.protocol=l??BI,this.kBucketSize=s??20,this.clientMode=i??!0,this.maxInboundStreams=p??QR,this.maxOutboundStreams=y??XR,this.peerInfoMapper=r.peerInfoMapper??F6,this.routingTable=new LR(e,{kBucketSize:s,pingTimeout:d,pingConcurrency:f,protocol:this.protocol,logPrefix:m}),this.providers=new _R(e,g??{}),this.validators={...eR,...o},this.selectors={...JI,...a},this.network=new ER(e,{protocol:this.protocol,logPrefix:m});const w=me();r.allowQueryWithZeroPeers===!0&&w.resolve(),this.queryManager=new AR(e,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:m,initialQuerySelfHasRun:w,routingTable:this.routingTable}),this.peerRouting=new vR(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:m}),this.contentFetching=new fR(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:m}),this.contentRouting=new pR(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:m}),this.routingTableRefresh=new UR(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:m}),this.rpc=new WR(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:m,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new qR(e,{protocol:this.protocol,logPrefix:m}),this.querySelf=new DR(e,{peerRouting:this.peerRouting,interval:c,initialInterval:r.initialQuerySelfInterval,logPrefix:m,initialQuerySelfHasRun:w,routingTable:this.routingTable}),this.network.addEventListener("peer",_=>{const b=_.detail;this.onPeerConnect(b).catch(S=>{this.log.error("could not add %p to routing table",b.id,S)}),this.dispatchEvent(new pt("peer",{detail:b}))}),this.topologyListener.addEventListener("peer",_=>{const b=_.detail;Promise.resolve().then(async()=>{const S=await this.components.peerStore.get(b),I={id:b,multiaddrs:S.addresses.map(({multiaddr:A})=>A),protocols:S.protocols};await this.onPeerConnect(I)}).catch(S=>{this.log.error("could not add %p to routing table",b,S)})}),this.dhtPeerRouting=new YR(this),this.dhtContentRouting=new GR(this),r.clientMode==null&&e.events.addEventListener("self:peer:update",_=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const b=_.detail.peer.addresses.some(({multiaddr:I})=>dR(I)),S=this.getMode();b&&S==="client"?await this.setMode("server"):S==="server"&&!b&&await this.setMode("client")}).catch(b=>{this.log.error("error setting dht server mode",b)})})}get[(i2=Symbol.toStringTag,s2=jt,n2=rs,Ea)](){return this.dhtContentRouting}get[_a](){return this.dhtPeerRouting}get[va](){return this}async onPeerConnect(e){if(this.log("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(r=>r.toString()));return}try{await this.routingTable.add(e.id)}catch(r){this.log.error("could not add %p to routing table",e.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await I2(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.topologyListener,this.routingTableRefresh)}async stop(){this.running=!1,await R2(this.querySelf,this.providers,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener)}async*put(e,r,s={}){yield*this.contentFetching.put(e,r,s)}async*get(e,r={}){yield*this.contentFetching.get(e,r)}async*provide(e,r={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),r)}async*findProviders(e,r={}){yield*this.contentRouting.findProviders(e,r)}async*findPeer(e,r={}){yield*this.peerRouting.findPeer(e,r)}async*getClosestPeers(e,r={}){yield*this.peerRouting.getClosestPeers(e,r)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var c0;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER"})(c0||(c0={}));function JR(n){return t=>new ZR(t,n)}const jR=di("libp2p:simple-metrics");class dl{constructor(){h(this,"value",0)}update(t){this.value=t}increment(t=1){this.value+=t}decrement(t=1){this.value-=t}reset(){this.value=0}timer(){const t=Date.now();return()=>{this.value=Date.now()-t}}}class fl{constructor(){h(this,"values",{})}update(t){Object.entries(t).forEach(([e,r])=>{this.values[e]=r})}increment(t){Object.entries(t).forEach(([e,r])=>{this.values[e]=this.values[e]??0;const s=typeof r=="number"?r:1;this.values[e]+=Number(s)})}decrement(t){Object.entries(t).forEach(([e,r])=>{this.values[e]=this.values[e]??0;const s=typeof r=="number"?r:1;this.values[e]-=Number(s)})}reset(){this.values={}}timer(t){const e=Date.now();return()=>{this.values[t]=Date.now()-e}}}var o2,a2;a2=Symbol.toStringTag,o2=jt;class eA{constructor(t,e){h(this,"metrics",new Map);h(this,"transferStats");h(this,"started");h(this,"interval");h(this,"intervalMs");h(this,"onMetrics");h(this,a2,"@libp2p/metrics-simple");h(this,o2,["@libp2p/metrics"]);this.started=!1,this._emitMetrics=this._emitMetrics.bind(this),this.intervalMs=e.intervalMs??1e3,this.onMetrics=e.onMetrics,this.transferStats=new Map}isStarted(){return this.started}start(){this.started=!0,this.interval=setInterval(this._emitMetrics,this.intervalMs)}stop(){this.started=!1,clearInterval(this.interval)}_emitMetrics(){Promise.resolve().then(async()=>{const t={};for(const[e,r]of this.metrics.entries())r instanceof dl?t[e]=r.value:r instanceof fl?t[e]=r.values:t[e]=await r();this.onMetrics(structuredClone(t))}).catch(t=>{jR.error("could not invoke onMetrics callback",t)})}_incrementValue(t,e){const r=this.transferStats.get(t)??0;this.transferStats.set(t,r+e)}_track(t,e){const r=this,s=t.sink;t.sink=async function(a){await s(c1(a,c=>{r._incrementValue(`${e} sent`,c.byteLength)}))};const i=t.source;t.source=c1(i,o=>{r._incrementValue(`${e} received`,o.byteLength)})}trackMultiaddrConnection(t){this._track(t,"global")}trackProtocolStream(t,e){t.protocol!=null&&this._track(t,t.protocol)}registerMetric(t,e={}){if(t==null||t.trim()==="")throw new Error("Metric name is required");if((e==null?void 0:e.calculate)!=null){this.metrics.set(t,e.calculate);return}const r=new dl;return this.metrics.set(t,r),r}registerMetricGroup(t,e={}){if(t==null||t.trim()==="")throw new Error("Metric name is required");if((e==null?void 0:e.calculate)!=null){this.metrics.set(t,e.calculate);return}const r=new fl;return this.metrics.set(t,r),r}registerCounter(t,e={}){if(t==null||t.trim()==="")throw new Error("Metric name is required");if((e==null?void 0:e.calculate)!=null){this.metrics.set(t,e.calculate);return}const r=new dl;return this.metrics.set(t,r),r}registerCounterGroup(t,e={}){if(t==null||t.trim()==="")throw new Error("Metric name is required");if((e==null?void 0:e.calculate)!=null){this.metrics.set(t,e.calculate);return}const r=new fl;return this.metrics.set(t,r),r}}function tA(n){return t=>new eA(t,n)}//! WebpeerJS -- https://github.com/nuzulul/webpeerjs
var oe,wn,nt,Ks,Hr,$e,Ir,bn,Xe,fe,_e,Zn,zr,qe,En,vn,Lt,Hs,_n,Wr,go,U,zn,z6,W6,Is,q6,ut,Ne,m1,y1,Li,G6,Y6,Q6,w1,X6,Z6,J6,j6,e5,t5,r5,n5,b1;const Mu=class Mu{constructor(t,e,r){j(this,U);j(this,oe);j(this,wn);j(this,nt);j(this,Ks);j(this,Hr);j(this,$e);j(this,Ir);j(this,bn);j(this,Xe);j(this,fe);j(this,_e);j(this,Zn);j(this,zr);j(this,qe);j(this,En);j(this,vn);j(this,Lt);j(this,Hs);j(this,_n);h(this,"id");h(this,"status");h(this,"IPFS");h(this,"address");h(this,"peers");j(this,Wr,()=>{});h(this,"onConnect",t=>ee(this,Wr,t));j(this,go,()=>{});h(this,"onDisconnect",t=>ee(this,go,t));h(this,"joinRoom",t=>{if(E(this,fe)[t])return[E(this,fe)[t].sendMessage,E(this,fe)[t].listenMessage,E(this,fe)[t].onMembersChange];if(!t)throw eg("room is required");{const e=ko;E(this,fe)[t]={onMessage:()=>{},listenMessage:r=>E(this,fe)[t]={...E(this,fe)[t],onMessage:r},sendMessage:async r=>{const s=new Date().getTime(),i=JSON.stringify({prefix:xi,room:t,message:r,id:E(this,oe).peerId.toString(),msgId:s}),o={publicKey:E(this,oe).peerId.publicKey,addrs:[Ii(i)]},a=Rs.encode(o);for(const c of e)await E(this,oe).services.pubsub.publish(c,a)},members:[this.id],onMembers:()=>{},onMembersChange:r=>{E(this,fe)[t]={...E(this,fe)[t],onMembers:r},E(this,fe)[t].onMembers(E(this,fe)[t].members),O(this,U,Li).call(this)}}}return[E(this,fe)[t].sendMessage,E(this,fe)[t].listenMessage,E(this,fe)[t].onMembersChange]});ee(this,oe,t),ee(this,Hr,e),ee(this,$e,new Map),ee(this,wn,new Map),ee(this,nt,[]),ee(this,Ks,new Map),ee(this,Ir,new Map),ee(this,bn,!1),ee(this,Xe,new Map),this.address=[],ee(this,fe,{}),ee(this,_e,new Map),ee(this,Zn,[]),ee(this,zr,new Map),ee(this,qe,new Map),ee(this,En,new Map),ee(this,vn,[]),ee(this,Lt,!0),ee(this,Hs,[]),ee(this,_n,new Map),this.peers=function(s){return s}(E(this,Zn)),this.status=function(s){return s.status}(E(this,oe)),this.status="unconnected",this.IPFS=function(s,i){return{libp2p:s,discoveredPeers:i}}(E(this,oe),E(this,wn)),this.id=E(this,oe).peerId.toString();for(const s of ko)E(this,oe).services.pubsub.subscribe(s);E(this,oe).addEventListener("peer:connect",async s=>{s.detail;const i=s.detail.toString(),c=E(this,oe).getConnections().map(l=>({id:l.remotePeer.toString(),addr:l.remoteAddr.toString()})).find(l=>l.id==i).addr;if(Mr.includes(i)&&(!E(this,qe).has(i)||E(this,qe).get(i).includes("/wss/"))&&c.includes("webtransport")&&await E(this,Hr).put(new Be(i),new TextEncoder().encode(c)),E(this,qe).set(i,c),Ci.includes(i)&&setTimeout(()=>{O(this,U,y1).call(this),setTimeout(()=>{O(this,U,y1).call(this)},5e3)},1e3),E(this,nt).includes(i)){let l=[c];if(E(this,_e).has(i)){const u=new Date().getTime(),d={addrs:l,last:u};E(this,_e).set(i,d)}else{E(this,Wr).call(this,i);const u=new Date().getTime(),d={addrs:l,last:u};E(this,_e).set(i,d),O(this,U,zn).call(this)}}}),E(this,oe).services.pubsub.addEventListener("message",s=>{if(s.detail.type==="signed"){s.detail.topic;const i=s.detail.from.toString();try{if(E(this,nt).includes(i)){if(E(this,_e).has(i)){const w=E(this,_e).get(i).addrs,_=new Date().getTime(),b={addrs:w,last:_};E(this,_e).set(i,b)}else{E(this,Wr).call(this,i);const w=E(this,Ks).get(i),_=new Date().getTime(),b={addrs:w,last:_};E(this,_e).set(i,b),O(this,U,zn).call(this)}if(!O(this,U,ut).call(this,i)){if(E(this,qe).has(i)){let w=[];const _=E(this,qe).get(i),b=G(_);w.push(b),O(this,U,Ne).call(this,w)}else if(E(this,wn).has(i)){const w=E(this,wn).get(i);let _=[];for(const b of w){if(!b.includes("webrtc"))continue;const S=G(b);_.push(S)}O(this,U,Ne).call(this,_)}else if(E(this,_e).has(i)){const w=E(this,_e).get(i).addrs;let _=[];for(const b of w){if(!b.includes("webrtc"))continue;const S=G(b);_.push(S)}O(this,U,Ne).call(this,_)}}}const o=Rs.decode(s.detail.data),a=Kc(o.addrs[0]),c=JSON.parse(a),l=c.prefix,u=c.room,d=c.rooms,f=c.message,p=c.msgId,y=c.signal,g=c.id;if(g!=i)return;let m=c.address;if(l===xi){if(E(this,nt).includes(g)||E(this,nt).push(g),!E(this,_e).has(g)){E(this,Wr).call(this,g),m=[];const w=new Date().getTime(),_={addrs:m,last:w};E(this,_e).set(g,_),E(this,Ks).set(g,m),O(this,U,zn).call(this)}if(u&&E(this,fe)[u]&&(E(this,fe)[u].members.includes(g)||E(this,_e).has(g)&&(E(this,fe)[u].members.push(g),E(this,fe)[u].onMembers(E(this,fe)[u].members)),f)){const w=p+g;E(this,Hs).includes(w)||(E(this,Hs).push(w),E(this,fe)[u].onMessage(f,g))}if(d)for(const w of d)E(this,fe)[w]&&(E(this,fe)[w].members.includes(g)||E(this,_e).has(g)&&(E(this,fe)[w].members.push(g),E(this,fe)[w].onMembers(E(this,fe)[w].members)));y&&(y=="announce"&&setTimeout(()=>{O(this,U,Li).call(this,"")},1e3),y=="ping")}}catch{}}}),E(this,oe).addEventListener("peer:discovery",s=>{const i=s.detail.multiaddrs,o=s.detail.id;if(i.length!=0){let a=[];for(const c of i){let l;i.toString().includes(s.detail.id.toString())?l=c.toString():l=c.toString()+"/p2p/"+o,a.push(l)}if(E(this,wn).set(o.toString(),a),i.toString().includes("certhash")&&i.toString().includes("webtransport")&&i.toString().includes("p2p-circuit")&&!E(this,qe).has(o)){let c=[];for(const l of a){if(!l.includes("webrtc"))continue;const u=G(l);c.push(u)}O(this,U,Ne).call(this,c)}}}),E(this,oe).addEventListener("peer:disconnect",async s=>{const i=s.detail.string;if(E(this,En).has(i)){let a=E(this,En).get(i);if(a++,E(this,En).set(i,a),a>10&&(E(this,$e).has(i)&&E(this,$e).delete(i),!E(this,nt).includes(i)&&!E(this,Xe).has(i)))return}else E(this,En).set(i,0);let o=[];for(const a of E(this,_n).values())o.push(a.id);if(E(this,nt).includes(i)){const a=E(this,qe).get(i);let c=[];const l=G(a);c.push(l),O(this,U,Ne).call(this,c)}else if(E(this,Xe).has(i)){const a=E(this,qe).get(i);if(a.includes("/wss/"))return;let c=[];const l=G(a);c.push(l),O(this,U,Ne).call(this,c)}else if(o.includes(i)){const a=E(this,qe).get(i);let c=[];const l=G(a);c.push(l),O(this,U,Ne).call(this,c)}else{const a=E(this,qe).get(i);G(a)}}),E(this,oe).addEventListener("self:peer:update",({detail:{peer:s}})=>{const i=s.id.toString(),o=[];s.addresses.forEach(a=>{const c=a.multiaddr.toString()+"/p2p/"+i;c.includes("webtransport")&&c.includes("certhash")&&c.includes("webrtc")&&o.push(c)}),this.address=o,O(this,U,Li).call(this)}),E(this,oe).addEventListener("peer:identify",async s=>{const i=s.detail.peerId.toString();if(c2.includes(i)&&s.detail.connection.remoteAddr.toString().includes("/wss/")){let a=[],c=[];for(const l of s.detail.listenAddrs){if(!l.toString().includes("webtransport"))continue;const u=l.toString()+"/p2p/"+i,d=G(u);a.push(u),c.push(d)}E(this,Xe).set(i,a),await E(this,oe).hangUp(ye(i)),O(this,U,Ne).call(this,c)}if(s.detail.protocols.includes(sn)){const o=s.detail.peerId.toString();let a=[];for(const l of s.detail.listenAddrs){const u=l.toString()+"/p2p/"+o;G(u),u.includes("webtransport")&&a.push(u)}if(E(this,_e).has(o)){const l=new Date().getTime(),u={addrs:a,last:l};E(this,_e).set(o,u)}O(this,U,W6).call(this,o,"peer-exchange")}}),O(this,U,w1).call(this),O(this,U,Q6).call(this),O(this,U,Y6).call(this),O(this,U,G6).call(this),O(this,U,z6).call(this),r(s=>{const i=rg(s);ee(this,Lt,i)}),setTimeout(()=>{O(this,U,m1).call(this),setInterval(()=>{O(this,U,m1).call(this)},5e3)},1e4),setInterval(()=>{O(this,U,q6).call(this)},5e3)}dial(t){let e=[];const r=G(t);e.push(r),O(this,U,Ne).call(this,e)}static async createWebpeer(){const t=new sE(g5);await t.open();const e=Nc;for(const o of e){const a=o.Peers[0].Addrs;o.Peers[0].ID;for(const c of a)c.includes("webtransport")&&c.includes("certhash")}let r=()=>{};const s=o=>r=o,i=await Hb({addresses:{listen:["/webrtc"]},transports:[iv(),Uv(),S_(),dS({discoverRelays:m5,reservationConcurrency:1,maxReservationQueueLength:3})],connectionManager:{maxConnections:zu,minConnections:p5,autoDialInterval:6e4,autoDialConcurrency:0,autoDialMaxQueueLength:0,autoDialPriority:1e3,autoDialDiscoveredPeersDebounce:6e4,maxParallelDials:3,dialTimeout:5e3,maxIncomingPendingConnections:5,maxDialQueueLength:10,inboundConnectionThreshold:3,maxPeerAddrsToDial:2,inboundUpgradeTimeout:5e3},connectionEncryption:[e6()],streamMuxers:[H_({maxInboundStreams:20,maxOutboundStreams:20})],connectionGater:{filterMultiaddrForPeer:async(o,a)=>{const c=a.toString();return!(c.includes("/ip4/127.0.0.1")||c.includes("/ip6/"))},denyDialMultiaddr:async o=>{const a=o.toString();return!!(a.includes("/ip4/127.0.0.1")||a.includes("/ip6/"))}},peerDiscovery:[Y_({interval:1e4,topics:E5,listenOnly:!1})],services:{pubsub:_I({allowPublishToZeroTopicPeers:!0,msgIdFn:tg,ignoreDuplicatePublishError:!0,runOnTransientConnection:!1}),identify:MI(),identifyPush:OI(),aminoDHT:JR({protocol:"/ipfs/kad/1.0.0",peerInfoMapper:F6,clientMode:!1}),dcutr:R_()},peerStore:{persistence:!0,threshold:1},metrics:tA({onMetrics:o=>{r(o)},intervalMs:1e3})});return await i.services.aminoDHT.setMode("server"),new Mu(i,t,s)}};oe=new WeakMap,wn=new WeakMap,nt=new WeakMap,Ks=new WeakMap,Hr=new WeakMap,$e=new WeakMap,Ir=new WeakMap,bn=new WeakMap,Xe=new WeakMap,fe=new WeakMap,_e=new WeakMap,Zn=new WeakMap,zr=new WeakMap,qe=new WeakMap,En=new WeakMap,vn=new WeakMap,Lt=new WeakMap,Hs=new WeakMap,_n=new WeakMap,Wr=new WeakMap,go=new WeakMap,U=new WeakSet,zn=function(){E(this,Zn).length=0;for(const t of E(this,_e)){const e={id:t[0],address:t[1].addrs};E(this,Zn).push(e)}E(this,_e).size>0?this.status="connected":this.status="unconnected",O(this,U,Li).call(this)},z6=async function(){const t=async({connection:e,stream:r,protocol:s})=>{try{const i=await Zt(r.source,u=>kn(u),u=>In(u,d=>Kc(d.subarray())),async function(u){let d="";for await(const f of u)d+=f.toString();return d}),o=e.remotePeer.toString();let a=JSON.parse(i),c={protocol:sn,command:null,data:null};if(a.command==="peer-exchange"){if(a.protocol==sn){const y=[e.remoteAddr.toString()];if(E(this,_e).has(o)){const g=new Date().getTime(),m={addrs:y,last:g};E(this,_e).set(o,m)}else{E(this,nt).includes(o)||E(this,nt).push(o),E(this,Wr).call(this,o);const g=new Date().getTime(),m={addrs:y,last:g};E(this,_e).set(o,m),O(this,U,zn).call(this)}}if(a.data!=null){E(this,_n).set(o,a.data);let y=[];const g=a.data.addr,m=G(g),w=a.data.id;y.push(m),O(this,U,Ne).call(this,y),E(this,$e).has(w)}const u=Array.from(E(this,$e).keys()),d=Math.floor(Math.random()*u.length),f=u[d],p=E(this,$e).get(f);c.command=a.command,c.data={id:f,addr:p}}const l=JSON.stringify(c);Zt(l,u=>In(u,d=>Ii(d)),u=>en(u),r.sink)}catch{}};await E(this,oe).handle(sn,t,{maxInboundStreams:50,maxOutboundStreams:50,runOnTransientConnection:!1}),await E(this,oe).register(sn,{onConnect:(e,r)=>{},onDisconnect:(e,r)=>{}})},W6=async function(t,e){const i=E(this,oe).getConnections().map(l=>({id:l.remotePeer.toString(),addr:l.remoteAddr.toString()})).find(l=>l.id==t).addr,o=G(i);let a={protocol:sn,command:null,data:null};if(e==="peer-exchange"){if(E(this,_n).has(t))return;const l=Array.from(E(this,$e).keys()),u=Math.floor(Math.random()*l.length),d=l[u],f=E(this,$e).get(d);a.command=e,a.data={id:d,addr:f}}const c=JSON.stringify(a);try{const l=await E(this,oe).dialProtocol(o,sn,{runOnTransientConnection:!1}),u=await Zt(c,f=>In(f,p=>Ii(p)),f=>en(f),l,f=>kn(f),f=>In(f,p=>Kc(p.subarray())),async function(f){let p="";for await(const y of f)p+=y.toString();return p}),d=JSON.parse(u);if(d.protocol==sn){const f=[i];if(E(this,_e).has(t)){const p=new Date().getTime(),y={addrs:f,last:p};E(this,_e).set(t,y)}else{E(this,nt).includes(t)||E(this,nt).push(t),E(this,Wr).call(this,t);const p=new Date().getTime(),y={addrs:f,last:p};E(this,_e).set(t,y),O(this,U,zn).call(this)}}if(d.command=="peer-exchange"&&d.data!=null){E(this,_n).set(t,d.data);let f=[];const p=d.data.addr,y=G(p),g=d.data.id;f.push(y),O(this,U,Ne).call(this,f),E(this,$e).has(g)}}catch{}},Is=async function(){if(navigator.onLine&&E(this,Lt)){for(const t of Ci)if(!O(this,U,ut).call(this,t)&&!E(this,qe).has(t)){const e=ye(t);for await(const r of E(this,oe).services.aminoDHT.findPeer(e))if(r.name==="FINAL_PEER"){let s=[],i=[];const o=r.peer.id.toString();for(const a of r.peer.multiaddrs){const c=a.toString()+"/p2p/"+o,l=G(c);i.push(c),s.push(l)}E(this,Xe).set(o,i),O(this,U,ut).call(this,o)||O(this,U,Ne).call(this,s)}}}},q6=function(){const r=new Date().getTime();for(const s of E(this,_e)){const i=s[0],o=s[1].last,a=r-o;if(a>25e3&&!O(this,U,ut).call(this,i)||a>6e4){E(this,_e).delete(i),O(this,U,zn).call(this),E(this,go).call(this,i);const c=Object.keys(E(this,fe));for(const l of c)if(E(this,fe)[l].members.includes(i)){const u=E(this,fe)[l].members.indexOf(i);E(this,fe)[l].members.splice(u,1),E(this,fe)[l].onMembers(E(this,fe)[l].members)}}}},ut=function(t){let e=[];for(const r of E(this,oe).getPeers())e.push(r.toString());return!!e.includes(t)},Ne=function(t){if(t.length>0){const e=t[0].toString().split("/").pop();if(E(this,vn).map(c=>c[0].toString().split("/").pop()).includes(e))return;const s=E(this,_e).size,o=E(this,oe).getPeers().length-s,a=zu/2;if(E(this,nt).includes(e)){if(s>a)return}else if(o>a)return;E(this,nt).includes(e)||Mr.includes(e)||Ci.includes(e)?E(this,vn).unshift(t):E(this,vn).push(t)}},m1=function(){if(!E(this,Lt)||!navigator.onLine)return;const t=5;let e=[];for(const r of E(this,oe).getDialQueue()){const s=r.peerId.string;e.push(s)}if(!(e.length>t))for(let r=0;r<t;r++){const s=E(this,vn).shift();if(s!=null&&s.length>0){const i=s[0].toString().split("/").pop();if(O(this,U,ut).call(this,i)||e.includes(i))continue;O(this,U,n5).call(this,s),E(this,bn)&&O(this,U,b1).call(this,s)}else break}},y1=async function(){const t=ko,e=JSON.stringify({prefix:xi,signal:"announce",id:E(this,oe).peerId.toString(),address:this.address,rooms:Object.keys(E(this,fe))}),r={publicKey:E(this,oe).peerId.publicKey,addrs:[Ii(e)]},s=Rs.encode(r);for(const i of t)await E(this,oe).services.pubsub.publish(i,s)},Li=async function(){const t=ko,e=JSON.stringify({prefix:xi,signal:"ping",id:E(this,oe).peerId.toString(),address:this.address,rooms:Object.keys(E(this,fe))}),r={publicKey:E(this,oe).peerId.publicKey,addrs:[Ii(e)]},s=Rs.encode(r);for(const i of t)await E(this,oe).services.pubsub.publish(i,s)},G6=function(){setInterval(()=>{const t=Mr,e=Math.floor(Math.random()*t.length);let r=[];r.push(t[e]);for(const s of Ci)r.push(s);for(const s of r)if(s!=null&&!O(this,U,ut).call(this,s))if(E(this,qe).has(s)){let i=[];const o=E(this,qe).get(s),a=G(o);i.push(a),O(this,U,Ne).call(this,i)}else if(E(this,Xe).has(s)){let i=[];const o=E(this,Xe).get(s);for(const a of o){const c=G(a);i.push(c)}O(this,U,Ne).call(this,i)}else{const i=Nc,o=i.findIndex(a=>a.Peers[0].ID==s);if(o>-1){const a=i[o].Peers[0].Addrs;let c=[];for(const l of a){const u=l+"/p2p/"+s,d=G(u);c.push(d)}O(this,U,Ne).call(this,c)}}},45*1e3)},Y6=async function(){for await(const{key:t,value:e}of E(this,Hr).query({})){const r=t.toString().split("/")[1],s=new TextDecoder().decode(e);E(this,$e).set(r,s)}setInterval(async()=>{const t=E(this,oe).getConnections();for(const r of t){const s=r.remotePeer,i=r.remoteAddr,o=r.timeline.upgraded,a=5*60*1e3,c=new Date().getTime();if(c-o>a){const f=i.toString(),p=s.toString();!E(this,nt).includes(p)&&!Mr.includes(p)&&!E(this,$e).has(p)&&!f.includes("p2p-circuit")&&f.includes("webtransport")&&(await E(this,Hr).put(new Be(p),new TextEncoder().encode(f)),E(this,$e).set(p,f))}const u=60*1e3;if(c-o>u){const f=s.toString();E(this,Ir).has(f)||E(this,Ir).set(f,0)}}for(const r of E(this,$e)){const s=r[0],i=r[1];if(O(this,U,ut).call(this,s)){E(this,zr).set(s,0);continue}else{if(E(this,zr).has(s)){let c=E(this,zr).get(s);if(c++,E(this,zr).set(s,c),c>5){!E(this,qe).has(s)&&!Mr.includes(s)&&navigator.onLine&&setTimeout(async()=>{E(this,$e).has(s)&&!E(this,qe).has(s)&&(E(this,$e).delete(s),await E(this,Hr).delete(new Be(s)))},60*1e3);continue}}else E(this,zr).set(s,0);let o=[];const a=G(i);o.push(a),O(this,U,Ne).call(this,o)}}const e=Array.from(E(this,Ir).keys());for(const r of e)if(O(this,U,ut).call(this,r)){E(this,Ir).set(r,0);continue}else{let s=E(this,Ir).get(r);if(s<15||s<25&&E(this,Xe).has(r)){const i=E(this,qe).get(r);let o=[];const a=G(i);o.push(a),O(this,U,Ne).call(this,o),s++,E(this,Ir).set(r,s)}}},15*1e3)},Q6=function(){setInterval(()=>{E(this,oe).getPeers().length==0&&O(this,U,w1).call(this)},120*1e3)},w1=function(){setTimeout(()=>{O(this,U,X6).call(this),setTimeout(()=>{O(this,U,Z6).call(this)},5e4),setTimeout(()=>{O(this,U,Is).call(this)},6e4),setTimeout(()=>{E(this,oe).getPeers().length==0&&(O(this,U,J6).call(this),setTimeout(()=>{O(this,U,Is).call(this)},6e4),setTimeout(()=>{E(this,oe).getPeers().length==0&&(O(this,U,j6).call(this),setTimeout(()=>{O(this,U,Is).call(this)},15e3),setTimeout(()=>{E(this,oe).getPeers().length==0&&(O(this,U,e5).call(this),setTimeout(()=>{O(this,U,Is).call(this)},15e3),setTimeout(()=>{E(this,oe).getPeers().length==0&&(O(this,U,t5).call(this),setTimeout(()=>{O(this,U,Is).call(this)},15e3))},Mo))},Mo))},Mo))},Mo)},5e3)},X6=async function(){if(!navigator.onLine||!E(this,Lt))return;let t=!0;for(const e of Mr)if(E(this,$e).has(e)){t=!1;let r=[],s=[];const i=e,o=E(this,$e).get(e),a=G(o);s.push(o),r.push(a),E(this,Xe).set(i,s),O(this,U,ut).call(this,i)||O(this,U,Ne).call(this,r)}if(t)for(const e of Mr){const s=Wo(No),i=await Fo(s.getPeers(ye(e)));if(!i)continue;const o=i.Addrs,a=i.ID;let c=[],l=[];for(const u of o){const d=u.toString()+"/p2p/"+a.toString(),f=G(d);l.push(d),c.push(f)}E(this,Xe).set(a,l),O(this,U,ut).call(this,a)||O(this,U,Ne).call(this,c)}},Z6=async function(){if(!navigator.onLine||!E(this,Lt))return;let t=!0;for(const e of Mr)if(E(this,$e).has(e)&&(t=!1),!E(this,qe).has(e)&&(E(this,$e).has(e)||t)){const s=Wo(No),i=await Fo(s.getPeers(ye(e)));if(!i){navigator.onLine&&await E(this,Hr).delete(new Be(e));continue}const o=i.Addrs,a=i.ID;let c=[],l=[];for(const u of o){const d=u.toString()+"/p2p/"+a.toString(),f=G(d);l.push(d),c.push(f)}E(this,Xe).set(a,l),O(this,U,ut).call(this,a)||O(this,U,Ne).call(this,c)}},J6=async function(){if(!navigator.onLine||!E(this,Lt))return;const e=Wo(No),r=Mr,s=await Promise.all(r.map(i=>Fo(e.getPeers(ye(i)))));for(const i of s){if(!i)return;const o=i.Addrs,a=i.ID;let c=[],l=[];for(const u of o){const d=u.toString()+"/p2p/"+a.toString(),f=G(d);l.push(d),c.push(f)}E(this,Xe).set(a,l),O(this,U,ut).call(this,a)||O(this,U,Ne).call(this,c)}},j6=function(){if(!navigator.onLine||!E(this,Lt))return;const t=Nc;for(const e of t){const r=e.Peers[0].Addrs,s=e.Peers[0].ID;let i=[],o=[];for(const a of r){if(!a.includes("wss"))continue;const c=a+"/p2p/"+s,l=G(c);o.push(c),i.push(l)}E(this,Xe).set(s,o),ee(this,bn,!0),O(this,U,ut).call(this,s)||O(this,U,Ne).call(this,i)}},e5=async function(){if(!navigator.onLine||!E(this,Lt))return;const t=kc,e=Wu,i=(await(await fetch(t+"?name="+e+"&type=txt")).json()).Answer,o=[];for(const u of i){const d=u.data.split("/").pop();o.push(d)}const c=Wo(No),l=await Promise.all(o.map(u=>Fo(c.getPeers(ye(u)))));for(const u of l){const d=u.Addrs,f=u.ID;let p=[],y=[];for(const g of d){const m=g.toString()+"/p2p/"+f.toString(),w=G(m);y.push(m),p.push(w)}E(this,Xe).set(f,y),ee(this,bn,!0),O(this,U,ut).call(this,f)||O(this,U,Ne).call(this,p)}},t5=async function(){if(!navigator.onLine||!E(this,Lt))return;const t=kc,e=Wu,i=(await(await fetch(t+"?name="+e+"&type=txt")).json()).Answer;for(const o of i){const a=o.data.split("/"),c=a.pop(),l="_dnsaddr."+a[2];O(this,U,r5).call(this,c,l)}},r5=async function(t,e){const o=(await(await fetch(kc+"?name="+e+"&type=txt")).json()).Answer;let a=[],c=[];for(const l of o){const d=l.data.split("=")[1],f=G(d);a.push(f),c.push(d)}ee(this,bn,!0),E(this,Xe).set(t,c),E(this,Xe).set(t,c),O(this,U,ut).call(this,t)||(O(this,U,Ne).call(this,a),O(this,U,b1).call(this,a))},n5=async function(t){const e=t.filter(r=>r.protoNames().includes("webtransport")&&r.protoNames().includes("certhash"));for(const r of e)try{await E(this,oe).dial(r);return}catch{}},b1=async function(t){const e=t.filter(r=>r.protoNames().includes("wss"));for(const r of e)try{await E(this,oe).dial(r);return}catch{}};let p1=Mu;(async function(){const t=await p1.createWebpeer();console.log(`My node id : ${t.id}`);const[e,r,s]=t.joinRoom("globalroom");r((i,o)=>{console.log(`Message from ${o} : ${i}`);const a=o.slice(-5);document.getElementById("message").innerHTML+=`<br>Message from ${a} : ${i}`}),s(i=>{console.log(`Members : ${i}`),document.getElementById("circle").innerHTML=i.length,e("hello")}),document.getElementById("sendnow").onclick=function(){const i=document.getElementById("typing").value;document.getElementById("message").innerHTML+="<br>me :"+i,document.getElementById("typing").value="",e(i)}})();
